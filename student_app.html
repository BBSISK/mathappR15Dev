<!-- Revision 2.13 - 2025-12-04 - Revision Slides working, diagnostics removed -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgentMath.app - Student</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Quiz Milestone Celebration System -->
    <script src="{{ url_for('static', filename='quiz_milestones.js') }}"></script>
    <!-- WHO AM I: CSS for reveal grid -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/who_am_i.css') }}">
    <!-- AVATAR: CSS for avatar display -->
    {% if feature_flags.AVATAR_SYSTEM_ENABLED %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/avatar.css') }}">
    {% endif %}
    <style>
        /* AgentMath Header Banner */
        .agentmath-header-banner {
            width: 100%;
            overflow: hidden;
            line-height: 0;
        }
        
        .header-banner-img {
            width: 100%;
            height: auto;
            object-fit: cover;
            max-height: 120px;
        }
        
        @media (max-width: 768px) {
            .header-banner-img {
                max-height: 80px;
            }
        }
        
        /* ==================== COMPACT QUIZ MODE ==================== */
        
        /* Hide main header during quiz */
        body.quiz-active #mainHeader {
            display: none !important;
        }
        
        body.quiz-active #guestBanner {
            display: none !important;
        }
        
        body.quiz-active #badge-widget {
            display: none !important;
        }
        
        /* Compact Quiz Header Bar */
        .compact-quiz-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 10px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .compact-quiz-header .quiz-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .compact-quiz-header .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: background 0.2s;
        }
        
        .compact-quiz-header .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .compact-quiz-header .topic-title {
            color: white;
            font-weight: 600;
            font-size: 16px;
        }
        
        .compact-quiz-header .question-badge {
            background: rgba(255,255,255,0.25);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }
        
        .compact-quiz-header .score-badge {
            background: white;
            color: #667eea;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .compact-quiz-header .streak-badge {
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: none;
            animation: pulse-badge 1s infinite;
        }
        
        .compact-quiz-header .streak-badge.visible {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        @keyframes pulse-badge {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* ==================== HOT STREAK INDICATOR ==================== */
        .hot-streak-display {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .hot-streak-display.streak-cold {
            background: rgba(255,255,255,0.15);
            color: rgba(255,255,255,0.7);
        }
        
        .hot-streak-display.streak-warming {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            /* No animation - subtle */
        }
        
        .hot-streak-display.streak-hot {
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            color: white;
            /* Gentle pulse only */
            animation: streak-pulse 2s ease-in-out infinite;
        }
        
        .hot-streak-display.streak-fire {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            animation: streak-pulse 1.5s ease-in-out infinite;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }
        
        .hot-streak-display.streak-legendary {
            background: linear-gradient(135deg, #dc2626, #9333ea);
            color: white;
            animation: streak-pulse 1s ease-in-out infinite;
            box-shadow: 0 2px 10px rgba(147, 51, 234, 0.4);
        }
        
        @keyframes streak-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }
        
        .streak-flame {
            font-size: 16px;
            display: inline-block;
        }
        
        .streak-multiplier {
            background: rgba(0,0,0,0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-left: 4px;
        }
        
        /* ==================== WHO'S ONLINE COUNTER ==================== */
        .online-counter {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 25px;
            color: white;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(16, 185, 129, 0.3);
        }
        
        .online-counter .pulse-dot {
            width: 10px;
            height: 10px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse-online 2s infinite;
        }
        
        @keyframes pulse-online {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }
        
        .online-counter-mini {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: rgba(16, 185, 129, 0.3);
            border-radius: 15px;
            color: white;
            font-weight: 500;
            font-size: 12px;
        }
        
        .online-counter-mini .pulse-dot {
            width: 6px;
            height: 6px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse-online 2s infinite;
        }
        
        /* ==================== SOUND EFFECTS TOGGLE ==================== */
        .sound-toggle {
            position: relative;
            cursor: pointer;
        }
        
        .sound-toggle.muted i {
            opacity: 0.5;
        }
        
        .sound-toggle.muted::after {
            content: '';
            position: absolute;
            width: 2px;
            height: 24px;
            background: white;
            transform: rotate(45deg);
            top: 6px;
            left: 17px;
        }
        
        /* ==================== DAY 2: QUICK PLAY MODE ==================== */
        .quick-play-card {
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            border-radius: 20px;
            padding: 24px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .quick-play-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(245, 158, 11, 0.4);
        }
        
        .quick-play-card::before {
            content: 'âš¡';
            position: absolute;
            font-size: 120px;
            opacity: 0.1;
            right: -20px;
            bottom: -30px;
        }
        
        .quick-play-badge {
            background: rgba(255,255,255,0.25);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 10px;
        }
        
        .quick-play-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .quick-play-desc {
            opacity: 0.9;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .quick-play-stats {
            display: flex;
            gap: 20px;
            font-size: 13px;
        }
        
        .quick-play-stat {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* ==================== DAY 2: WEEKLY CHALLENGE TRACKER ==================== */
        .weekly-challenge-card {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            border-radius: 20px;
            padding: 24px;
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .weekly-challenge-card::before {
            content: 'ðŸ†';
            position: absolute;
            font-size: 100px;
            opacity: 0.1;
            right: -10px;
            top: -20px;
        }
        
        .challenge-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .challenge-title {
            font-size: 20px;
            font-weight: 700;
        }
        
        .challenge-timer {
            background: rgba(255,255,255,0.2);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .challenge-progress-container {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 3px;
            margin-bottom: 15px;
        }
        
        .challenge-progress-bar {
            height: 20px;
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
            border-radius: 8px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            color: #92400e;
        }
        
        .challenge-goals {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .challenge-goal {
            background: rgba(255,255,255,0.15);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            transition: all 0.2s;
        }
        
        .challenge-goal.completed {
            background: rgba(74, 222, 128, 0.3);
            border: 2px solid rgba(74, 222, 128, 0.5);
        }
        
        .challenge-goal-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .challenge-goal-text {
            font-size: 11px;
            opacity: 0.9;
        }
        
        .challenge-goal-points {
            font-size: 13px;
            font-weight: 700;
            color: #fbbf24;
            margin-top: 4px;
        }
        
        /* ==================== DAY 2: ENHANCED LEADERBOARD ==================== */
        .leaderboard-card {
            background: white;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        .leaderboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .leaderboard-title {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .leaderboard-tabs {
            display: flex;
            gap: 8px;
        }
        
        .leaderboard-tab {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: #f3f4f6;
            color: #6b7280;
        }
        
        .leaderboard-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: #f9fafb;
            border-radius: 12px;
            transition: all 0.2s;
        }
        
        .leaderboard-item:hover {
            background: #f3f4f6;
            transform: translateX(5px);
        }
        
        .leaderboard-item.top-1 {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 2px solid #f59e0b;
        }
        
        .leaderboard-item.top-2 {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            border: 2px solid #9ca3af;
        }
        
        .leaderboard-item.top-3 {
            background: linear-gradient(135deg, #fed7aa, #fdba74);
            border: 2px solid #ea580c;
        }
        
        .leaderboard-item.is-me {
            background: linear-gradient(135deg, #ddd6fe, #c4b5fd);
            border: 2px solid #8b5cf6;
        }
        
        .leaderboard-rank {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            color: #6b7280;
            margin-right: 12px;
        }
        
        .leaderboard-rank.gold { color: #f59e0b; font-size: 24px; }
        .leaderboard-rank.silver { color: #6b7280; font-size: 22px; }
        .leaderboard-rank.bronze { color: #ea580c; font-size: 20px; }
        
        .leaderboard-name {
            flex: 1;
            font-weight: 600;
            color: #1f2937;
        }
        
        .leaderboard-score {
            font-weight: 700;
            color: #8b5cf6;
            font-size: 16px;
        }
        
        .leaderboard-change {
            margin-left: 10px;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
        }
        
        .leaderboard-change.up {
            background: #d1fae5;
            color: #059669;
        }
        
        .leaderboard-change.down {
            background: #fee2e2;
            color: #dc2626;
        }
        
        /* ==================== SIDEBAR CARDS (Day 2 Redesign) ==================== */
        .sidebar-card {
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: all 0.2s;
        }
        
        .sidebar-card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.12);
        }
        
        .sidebar-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .sidebar-card-icon {
            font-size: 24px;
        }
        
        .sidebar-card-title {
            font-weight: 700;
            font-size: 14px;
            color: #1f2937;
        }
        
        .sidebar-card-content {
            flex: 1;
        }
        
        .sidebar-card-desc {
            font-size: 12px;
            color: #6b7280;
        }
        
        .sidebar-card-arrow {
            color: #9ca3af;
            font-size: 12px;
        }
        
        /* Quick Play Mini */
        .quick-play-mini {
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .quick-play-mini:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.3);
        }
        
        .quick-play-mini .sidebar-card-title {
            color: white;
            font-size: 16px;
        }
        
        .quick-play-mini .sidebar-card-desc {
            color: rgba(255,255,255,0.9);
        }
        
        .quick-play-mini .sidebar-card-arrow {
            color: rgba(255,255,255,0.8);
        }
        

        /* Smart Quiz Mini - Adaptive Learning */
        .smart-quiz-mini {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .smart-quiz-mini:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
        }
        
        .smart-quiz-mini .sidebar-card-title {
            color: white;
            font-size: 16px;
        }
        
        .smart-quiz-mini .sidebar-card-desc {
            color: rgba(255,255,255,0.9);
        }
        
        .smart-quiz-mini .sidebar-card-arrow {
            color: rgba(255,255,255,0.8);
        }
        
        .smart-quiz-mini.guest-disabled {
            background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .smart-quiz-mini.guest-disabled:hover {
            transform: none;
            box-shadow: none;
        }
        
        /* Adaptive Quiz Mini - 10-Level Progression */
        .adaptive-quiz-mini {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .adaptive-quiz-mini:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.3);
        }
        
        .adaptive-quiz-mini .sidebar-card-title {
            color: white;
            font-size: 16px;
        }
        
        .adaptive-quiz-mini .sidebar-card-desc {
            color: rgba(255,255,255,0.9);
        }
        
        .adaptive-quiz-mini .sidebar-card-arrow {
            color: rgba(255,255,255,0.8);
        }
        
        .adaptive-quiz-mini.guest-disabled {
            background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%);
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .adaptive-quiz-mini.guest-disabled:hover {
            transform: none;
            box-shadow: none;
        }
        
        /* Adaptive Quiz Level Indicator */
        .adaptive-level-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .adaptive-level-bar {
            display: flex;
            gap: 3px;
            margin-left: 8px;
        }
        
        .adaptive-level-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transition: all 0.3s;
        }
        
        .adaptive-level-dot.active {
            background: #fbbf24;
            box-shadow: 0 0 6px rgba(251, 191, 36, 0.6);
        }
        
        .adaptive-level-dot.completed {
            background: #34d399;
        }
        
        /* Level Up/Down Animation */
        .level-change-toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: white;
            padding: 30px 50px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            z-index: 1000;
            text-align: center;
            animation: levelPopIn 0.5s ease forwards;
        }
        
        .level-change-toast.level-up {
            border: 4px solid #10b981;
        }
        
        .level-change-toast.level-down {
            border: 4px solid #f59e0b;
        }
        
        @keyframes levelPopIn {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        @keyframes levelPopOut {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
        }
        
        /* Adaptive Topic Card in Modal */
        .adaptive-topic-card {
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }
        
        .adaptive-topic-card:hover {
            border-color: #8b5cf6;
            background: #f5f3ff;
        }
        
        .adaptive-topic-card.selected {
            border-color: #8b5cf6;
            background: #ede9fe;
        }
        
        .adaptive-topic-card .topic-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }
        
        .adaptive-topic-card .topic-name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .adaptive-topic-card .topic-questions {
            font-size: 12px;
            color: #6b7280;
        }
        
        .adaptive-topic-card .topic-level {
            font-size: 11px;
            color: #8b5cf6;
            margin-top: 4px;
        }
        
        /* Weekly Challenge Mini */
        .weekly-challenge-mini {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            color: white;
        }
        
        .weekly-challenge-mini .sidebar-card-title {
            color: white;
        }
        
        .challenge-mini-progress {
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            margin-bottom: 8px;
            overflow: hidden;
        }
        
        .challenge-mini-bar {
            height: 100%;
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        .challenge-mini-status {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .challenge-mini-timer {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .challenge-mini-goals {
            display: flex;
            justify-content: center;
            gap: 12px;
        }
        
        .challenge-mini-goal {
            font-size: 20px;
            opacity: 0.5;
            transition: all 0.2s;
            cursor: help;
        }
        
        .challenge-mini-goal.completed {
            opacity: 1;
            transform: scale(1.1);
        }
        
        /* Leaderboard Mini */
        .leaderboard-mini {
            background: white;
        }
        
        .leaderboard-expand-btn {
            margin-left: auto;
            background: #f3f4f6;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #6b7280;
            transition: all 0.2s;
        }
        
        .leaderboard-expand-btn:hover {
            background: #e5e7eb;
        }
        
        .leaderboard-expand-btn.expanded i {
            transform: rotate(180deg);
        }
        
        .leaderboard-tabs-mini {
            display: flex;
            gap: 4px;
            margin-bottom: 12px;
        }
        
        .lb-tab-mini {
            flex: 1;
            padding: 6px 8px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            background: #f3f4f6;
            color: #6b7280;
            transition: all 0.2s;
        }
        
        .lb-tab-mini.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .leaderboard-mini-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .lb-mini-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            background: #f9fafb;
            border-radius: 8px;
            font-size: 12px;
        }
        
        .lb-mini-item.top-1 {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
        }
        
        .lb-mini-item.top-2 {
            background: #f3f4f6;
        }
        
        .lb-mini-item.top-3 {
            background: linear-gradient(135deg, #fed7aa, #fdba74);
        }
        
        .lb-mini-item.is-me {
            background: linear-gradient(135deg, #ddd6fe, #c4b5fd);
        }
        
        .lb-mini-rank {
            width: 20px;
            font-weight: 700;
            font-size: 14px;
        }
        
        .lb-mini-rank.gold { color: #f59e0b; }
        .lb-mini-rank.silver { color: #6b7280; }
        .lb-mini-rank.bronze { color: #ea580c; }
        
        .lb-mini-name {
            flex: 1;
            font-weight: 600;
            color: #374151;
            margin-left: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .lb-mini-score {
            font-weight: 700;
            color: #8b5cf6;
        }
        
        .leaderboard-expanded-list {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #e5e7eb;
        }
        
        .leaderboard-expanded-list.hidden {
            display: none;
        }
        
        .lb-mini-divider {
            text-align: center;
            color: #9ca3af;
            font-size: 12px;
            padding: 4px 0;
        }
        
        /* ==================== MOBILE LAYOUT REORDER ==================== */
        @media (max-width: 1023px) {
            .main-layout {
                display: flex;
                flex-direction: column;
            }
            /* On mobile, we need stats first, then topics, then other sidebar items */
            .main-layout .topics-column {
                order: 2;
            }
            .main-layout .sidebar-column {
                order: 1; /* This won't work as we need to split sidebar items */
                display: contents; /* Allow children to participate in parent flex */
            }
            .stats-card {
                order: 1 !important;
            }
            .quick-play-mini {
                order: 3 !important;
            }
            .weekly-challenge-mini {
                order: 4 !important;
            }
            .leaderboard-mini {
                order: 5 !important;
            }
            .topics-column {
                order: 2 !important;
            }
            /* Add margin since display:contents removes the container spacing */
            .sidebar-column > * {
                margin-bottom: 1rem;
            }
        }
        
        /* ==================== COMPACT ACTION BUTTONS ==================== */
        .action-btn {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        
        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        /* ==================== SIDEBAR STATS CARD ==================== */
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .stats-card .sidebar-card-header {
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .stats-card .sidebar-card-title {
            color: white;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .stat-item {
            text-align: center;
            padding: 8px 4px;
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
        }
        
        .stat-value {
            display: block;
            font-size: 18px;
            font-weight: 700;
            line-height: 1.2;
        }
        
        .stat-label {
            display: block;
            font-size: 10px;
            opacity: 0.9;
            margin-top: 2px;
        }
        
        .recent-badges-mini {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }
        
        .compact-quiz-header .tools {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .compact-quiz-header .tool-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
            position: relative;
        }
        
        .compact-quiz-header .tool-btn:hover {
            background: rgba(255,255,255,0.35);
            transform: scale(1.1);
        }
        
        .compact-quiz-header .tool-btn.active {
            background: white;
            color: #667eea;
        }
        
        .compact-quiz-header .tool-btn.hint-btn {
            background: rgba(251, 191, 36, 0.3);
        }
        
        .compact-quiz-header .tool-btn.hint-btn:hover {
            background: rgba(251, 191, 36, 0.5);
        }
        
        .compact-quiz-header .tool-btn.hint-used {
            background: rgba(251, 191, 36, 0.8);
            color: #92400e;
        }
        
        /* Compact Progress Bar */
        .compact-progress {
            height: 4px;
            background: rgba(255,255,255,0.3);
            width: 100%;
        }
        
        .compact-progress-fill {
            height: 100%;
            background: white;
            transition: width 0.3s ease;
        }
        
        /* Inline Feedback + Next Button */
        .feedback-next-row {
            display: flex;
            align-items: stretch;
            gap: 12px;
            margin-top: 16px;
        }
        
        .feedback-inline {
            flex: 1;
            padding: 12px 16px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .feedback-inline.correct {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            border: 2px solid #10b981;
        }
        
        .feedback-inline.incorrect {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            border: 2px solid #3b82f6;
        }
        
        .feedback-inline .feedback-icon {
            font-size: 24px;
            flex-shrink: 0;
        }
        
        .feedback-inline .feedback-text {
            flex: 1;
            font-weight: 600;
            font-size: 15px;
        }
        
        .feedback-inline .feedback-text.correct {
            color: #065f46;
        }
        
        .feedback-inline .feedback-text.incorrect {
            color: #1e40af;
        }
        
        .feedback-inline .streak-bonus {
            font-size: 12px;
            color: #ea580c;
            font-weight: 600;
        }
        
        .next-btn-inline {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .next-btn-inline:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
        }
        
        /* Explanation Section (collapsible) */
        .explanation-section {
            margin-top: 12px;
            padding: 12px 16px;
            background: #f8fafc;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }
        
        .explanation-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            color: #64748b;
            font-size: 14px;
        }
        
        .explanation-content {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e2e8f0;
            color: #475569;
            font-size: 14px;
            line-height: 1.6;
        }
        
        /* ==================== FLOATING CALCULATOR ==================== */
        .calculator-toggle-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 12px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .calculator-toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .calculator-toggle-btn.active {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }
        
        /* Floating Calculator Overlay - Now transparent to allow interaction */
        .calculator-overlay {
            display: none;
            position: fixed;
            z-index: 1000;
            pointer-events: none; /* Allow clicks through to content behind */
        }
        
        .calculator-overlay.visible {
            display: block;
        }
        
        .calculator-container {
            position: fixed;
            top: 100px;
            right: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            border: 2px solid #e0e7ff;
            max-width: 320px;
            width: 320px;
            animation: calcSlideIn 0.3s ease-out;
            pointer-events: auto; /* Calculator itself is clickable */
            cursor: default;
        }
        
        @keyframes calcSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .calculator-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move; /* Show drag cursor */
            user-select: none; /* Prevent text selection while dragging */
        }
        
        .calculator-header h4 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            pointer-events: none; /* Let drag events pass through to header */
        }
        
        .calculator-header .drag-hint {
            font-size: 10px;
            opacity: 0.7;
            font-weight: normal;
            margin-left: 8px;
        }
        
        .calculator-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .calculator-close:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .calculator-display {
            background: #1e1e2e;
            padding: 16px;
            text-align: right;
        }
        
        .calc-expression {
            color: #888;
            font-size: 14px;
            min-height: 20px;
            font-family: 'Courier New', monospace;
            word-break: break-all;
        }
        
        .calc-result {
            color: white;
            font-size: 32px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            min-height: 40px;
            word-break: break-all;
        }
        
        .calculator-body {
            padding: 12px;
            background: #f8fafc;
        }
        
        .calc-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .calc-row:last-child {
            margin-bottom: 0;
        }
        
        .calc-btn {
            padding: 14px 8px;
            font-size: 18px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .calc-btn:active {
            transform: scale(0.95);
        }
        
        .calc-btn-number {
            background: white;
            color: #333;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .calc-btn-number:hover {
            background: #f0f0f0;
        }
        
        .calc-btn-operator {
            background: #667eea;
            color: white;
        }
        
        .calc-btn-operator:hover {
            background: #5a6fd6;
        }
        
        .calc-btn-function {
            background: #e0e7ff;
            color: #667eea;
        }
        
        .calc-btn-function:hover {
            background: #c7d2fe;
        }
        
        .calc-btn-clear {
            background: #ef4444;
            color: white;
        }
        
        .calc-btn-clear:hover {
            background: #dc2626;
        }
        
        .calc-btn-equals {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .calc-btn-equals:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
        
        .calculator-footer {
            padding: 12px 16px;
            background: #f0f4ff;
            border-top: 1px solid #e0e7ff;
        }
        
        .calc-session-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #666;
            cursor: pointer;
        }
        
        .calc-session-toggle input {
            width: 18px;
            height: 18px;
            accent-color: #667eea;
        }
        
        /* Remove old calculator wrapper styles for desktop side-panel */
        .calculator-wrapper {
            display: none;
        }
        
        .quiz-content-wrapper {
            display: block;
        }
        
        .quiz-main-content {
            width: 100%;
        }
        
        /* Mobile adjustments */
        @media (max-width: 768px) {
            .compact-quiz-header {
                padding: 8px 12px;
            }
            
            .compact-quiz-header .topic-title {
                font-size: 14px;
            }
            
            .compact-quiz-header .question-badge,
            .compact-quiz-header .score-badge {
                font-size: 12px;
                padding: 3px 8px;
            }
            
            .compact-quiz-header .tool-btn {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }
            
            .feedback-next-row {
                flex-direction: column;
            }
            
            .next-btn-inline {
                width: 100%;
                text-align: center;
            }
            
            .calc-btn {
                padding: 12px 6px;
                font-size: 16px;
            }
            
            .calc-result {
                font-size: 28px;
            }
        }
        
        /* ==================== BONUS QUESTION STYLES ==================== */
        .bonus-question-unlock {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 3px solid #f59e0b;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            animation: bonus-pulse 2s ease-in-out infinite;
        }
        
        @keyframes bonus-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
            50% { box-shadow: 0 0 20px 10px rgba(245, 158, 11, 0.2); }
        }
        
        .bonus-question-unlock h3 {
            color: #92400e;
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .bonus-question-unlock p {
            color: #78350f;
            margin-bottom: 16px;
        }
        
        .bonus-question-unlock .bonus-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .bonus-question-unlock .try-btn {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .bonus-question-unlock .try-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(22, 163, 74, 0.4);
        }
        
        .bonus-question-unlock .skip-btn {
            background: #e5e7eb;
            color: #4b5563;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .bonus-question-unlock .skip-btn:hover {
            background: #d1d5db;
        }
        
        /* Bonus Question Modal */
        .bonus-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .bonus-modal-overlay.visible {
            display: flex;
        }
        
        .bonus-modal {
            background: white;
            border-radius: 20px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .bonus-modal-header {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 20px 20px 0 0;
        }
        
        .bonus-modal-header h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .bonus-modal-header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .bonus-modal-body {
            padding: 24px;
        }
        
        .bonus-image-container {
            width: 100%;
            aspect-ratio: 16/10;
            background: #1f2937;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .bonus-image-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .bonus-image-container .loading {
            color: #9ca3af;
            font-size: 14px;
        }
        
        .bonus-question-text {
            text-align: center;
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 20px;
        }
        
        .bonus-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        @media (max-width: 500px) {
            .bonus-options {
                grid-template-columns: 1fr;
            }
        }
        
        .bonus-option-btn {
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            padding: 14px 16px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }
        
        .bonus-option-btn:hover:not(:disabled) {
            background: #e0f2fe;
            border-color: #3b82f6;
            color: #1e40af;
        }
        
        .bonus-option-btn.correct {
            background: #dcfce7;
            border-color: #16a34a;
            color: #166534;
        }
        
        .bonus-option-btn.incorrect {
            background: #fee2e2;
            border-color: #dc2626;
            color: #991b1b;
        }
        
        .bonus-option-btn.reveal-correct {
            background: #dcfce7;
            border-color: #16a34a;
            color: #166534;
        }
        
        .bonus-option-btn:disabled {
            cursor: not-allowed;
            opacity: 0.8;
        }
        
        /* Bonus Result */
        .bonus-result {
            margin-top: 20px;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }
        
        .bonus-result.correct {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border: 2px solid #16a34a;
        }
        
        .bonus-result.incorrect {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border: 2px solid #3b82f6;
        }
        
        .bonus-result h3 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .bonus-result.correct h3 {
            color: #166534;
        }
        
        .bonus-result.incorrect h3 {
            color: #1e40af;
        }
        
        .bonus-result .points-earned {
            font-size: 32px;
            font-weight: 800;
            color: #16a34a;
            margin: 10px 0;
        }
        
        .bonus-result .fun-fact {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
            text-align: left;
        }
        
        .bonus-result .fun-fact-label {
            font-weight: 600;
            color: #f59e0b;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        
        .bonus-result .fun-fact-text {
            color: #4b5563;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .bonus-modal-footer {
            padding: 16px 24px 24px;
            text-align: center;
        }
        
        .bonus-close-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .bonus-close-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        /* ==================== DINO ARCHIVE MODAL ==================== */
        .dino-archive-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
            overflow-y: auto;
        }
        
        .dino-archive-overlay.visible {
            display: flex;
        }
        
        .dino-archive-modal {
            background: white;
            border-radius: 20px;
            max-width: 900px;
            width: 100%;
            margin: 20px auto;
            animation: modalSlideIn 0.3s ease-out;
        }
        
        .dino-archive-header {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 20px 20px 0 0;
            position: relative;
        }
        
        .dino-archive-header h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .dino-archive-header p {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .dino-archive-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .dino-archive-close:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .dino-archive-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            margin-top: 15px;
            border-radius: 10px;
        }
        
        .dino-archive-stat {
            text-align: center;
        }
        
        .dino-archive-stat-value {
            font-size: 28px;
            font-weight: bold;
        }
        
        .dino-archive-stat-label {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .dino-archive-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .dino-archive-empty {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        
        .dino-archive-empty i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .dino-archive-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .dino-archive-card {
            background: #f9fafb;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #e5e7eb;
            transition: all 0.2s;
        }
        
        .dino-archive-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .dino-archive-card.correct {
            border-color: #22c55e;
            background: #f0fdf4;
        }
        
        .dino-archive-card.incorrect {
            border-color: #ef4444;
            background: #fef2f2;
        }
        
        .dino-archive-card-image-wrapper {
            width: 100%;
            height: 150px;
            background: linear-gradient(135deg, #1e1b4b, #312e81);
            overflow: hidden;
        }
        
        .dino-archive-card-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            background: #e5e7eb;
        }
        
        .dino-placeholder {
            width: 100%;
            height: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1e1b4b, #312e81);
            color: white;
        }
        
        .dino-placeholder span {
            font-size: 48px;
            margin-bottom: 8px;
        }
        
        .dino-placeholder small {
            font-size: 12px;
            opacity: 0.8;
            text-align: center;
            padding: 0 10px;
        }
        
        .dino-archive-card-body {
            padding: 12px;
        }
        
        .dino-archive-card-answer {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .dino-archive-card.correct .dino-archive-card-answer {
            color: #16a34a;
        }
        
        .dino-archive-card.incorrect .dino-archive-card-answer {
            color: #dc2626;
        }
        
        .dino-archive-card-meta {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 8px;
        }
        
        .dino-archive-card-fact {
            font-size: 13px;
            color: #4b5563;
            line-height: 1.4;
            background: white;
            padding: 8px;
            border-radius: 6px;
            border-left: 3px solid #f59e0b;
        }
        
        .dino-archive-card-your-answer {
            font-size: 12px;
            color: #dc2626;
            margin-top: 6px;
            font-style: italic;
        }
        
        .dino-archive-footer {
            padding: 15px 20px;
            text-align: center;
            border-top: 1px solid #e5e7eb;
        }
        
        /* WHO AM I: Ensure container fits nicely in side-by-side layout */
        @media (min-width: 1024px) {
            #who-am-i-container {
                position: sticky;
                top: 20px;
                max-height: calc(100vh - 150px);
                overflow-y: auto;
            }
        }
        
        .number-line-container {
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .number-line {
            position: relative;
            margin: 30px 20px;
            height: 80px;
        }

        .number-line-base {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 4px;
            background: #4a5568;
            transform: translateY(-50%);
        }

        .number-line-tick {
            position: absolute;
            top: 50%;
            width: 2px;
            height: 20px;
            background: #4a5568;
            transform: translate(-50%, -50%);
        }

        .number-line-label {
            position: absolute;
            top: 70%;
            transform: translateX(-50%);
            font-size: 14px;
            font-weight: bold;
            color: #2d3748;
        }

        .number-line-arc {
            position: absolute;
            top: 15%;
            border: 3px solid #667eea;
            border-bottom: none;
            border-radius: 50px 50px 0 0;
            height: 25px;
        }

        .number-line-arrow {
            position: absolute;
            font-size: 24px;
            color: #667eea;
            animation: bounce 0.8s infinite;
        }

        .number-line-start-dot {
            position: absolute;
            top: 50%;
            width: 12px;
            height: 12px;
            background: #48bb78;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
        }

        .number-line-end-dot {
            position: absolute;
            top: 50%;
            width: 16px;
            height: 16px;
            background: #f56565;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            border: 3px solid white;
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
            z-index: 10;
            animation: pulse 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* Badge Widget Styles */
        .badge-summary-widget {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 25px;
            color: white;
            margin: 20px auto 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 1200px;
        }

        .badge-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .badge-summary-title {
            font-size: 1.8em;
            font-weight: bold;
            margin: 0;
        }

        .view-badges-btn {
            background: white;
            color: #667eea;
            padding: 10px 25px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .view-badges-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }

        .badge-summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
        }

        .badge-stat-box {
            text-align: center;
            background: rgba(255,255,255,0.2);
            padding: 20px 15px;
            border-radius: 12px;
            transition: all 0.3s;
            /* backdrop-filter: blur(10px); */ /* REMOVED */
        }

        .badge-stat-box:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-3px);
        }

        .badge-stat-value {
            font-size: 2.2em;
            font-weight: bold;
            display: block;
            margin-bottom: 8px;
        }

        .badge-stat-label {
            font-size: 0.9em;
            opacity: 0.95;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .recent-badge-mini {
            display: inline-block;
            background: rgba(255,255,255,0.25);
            padding: 8px 16px;
            border-radius: 20px;
            margin: 5px;
            font-size: 0.9em;
            /* backdrop-filter: blur(5px); */ /* REMOVED */
        }

        .badge-widget-loading {
            text-align: center;
            padding: 20px;
            opacity: 0.8;
        }

        @media (max-width: 640px) {
            .badge-summary-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            .badge-summary-title {
                font-size: 1.4em;
            }
        }

        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }

        .number-line-instruction {
            text-align: center;
            color: #4a5568;
            font-size: 14px;
            margin-top: 10px;
            font-weight: 500;
        }

        /* ============ Mastery Indicator Styles ============ */
        .mastery-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
            padding: 8px 12px;
            border-radius: 50%;
            font-size: 28px;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.6);
            animation: shine 2s infinite;
            z-index: 10;
            line-height: 1;
        }

        .difficulty-mastery {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            box-shadow: 0 3px 10px rgba(255, 215, 0, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            z-index: 10;
            line-height: 1.2;
        }

        .difficulty-mastery .trophy {
            font-size: 20px;
        }

        .difficulty-mastery .score {
            font-size: 10px;
            letter-spacing: 0.3px;
            font-weight: 700;
        }

        /* Mastered difficulty button - dimmed appearance */
        .difficulty-button.mastered {
            opacity: 0.65;
            filter: saturate(0.5);
            position: relative;
        }

        .difficulty-button.mastered::after {
            content: 'âœ“';
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.9);
            color: #22c55e;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .difficulty-button.mastered:hover {
            opacity: 0.85;
            filter: saturate(0.7);
        }

        @keyframes shine {
            0%, 100% {
                box-shadow: 0 4px 15px rgba(255, 215, 0, 0.6);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 6px 25px rgba(255, 215, 0, 0.9);
                transform: scale(1.05);
            }
        }

        .topic-card, .difficulty-button {
            position: relative;
        }

        /* Learning Path Styles */
        .learning-path-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 24px;
            padding: 32px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }

        .learning-path-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: shimmer 10s infinite;
        }

        @keyframes shimmer {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(180deg); }
        }

        .path-header {
            text-align: center;
            margin-bottom: 32px;
            position: relative;
            z-index: 1;
        }

        .path-number {
            display: inline-block;
            background: rgba(255,255,255,0.3);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .path-title {
            color: white;
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .path-description {
            color: rgba(255,255,255,0.9);
            font-size: 16px;
        }

        .path-flow {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 12px;
            position: relative;
            z-index: 1;
        }

        .flow-topic-card {
            background: white;
            border-radius: 16px;
            padding: 24px 20px;
            min-width: 140px;
            max-width: 160px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
            border: 3px solid transparent;
        }

        .flow-topic-card:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 12px 24px rgba(0,0,0,0.2);
            border-color: #667eea;
        }

        .flow-topic-card.mastered {
            border-color: #48bb78;
            background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
            opacity: 0.7;
            filter: saturate(0.6);
        }

        .flow-topic-card.mastered:hover {
            opacity: 0.9;
            filter: saturate(0.8);
        }

        .flow-topic-card.mastered .icon {
            opacity: 0.7;
        }

        .flow-topic-card .icon {
            font-size: 48px;
            margin-bottom: 12px;
            display: block;
        }

        .flow-topic-card .title {
            font-size: 15px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .flow-topic-card .mastery-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.6);
            animation: trophyPulse 2s infinite;
            border: 2px solid white;
        }

        @keyframes trophyPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 4px 12px rgba(255, 215, 0, 0.6); }
            50% { transform: scale(1.1); box-shadow: 0 6px 16px rgba(255, 215, 0, 0.8); }
        }

        .flow-arrow {
            color: white;
            font-size: 32px;
            opacity: 0.6;
            animation: arrowFloat 2s ease-in-out infinite;
        }

        @keyframes arrowFloat {
            0%, 100% { transform: translateX(0); }
            50% { transform: translateX(8px); }
        }

        .flow-topic-card .progress-ring {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            color: #667eea;
            font-weight: 600;
        }

        /* Difficulty progress dots on topic cards */
        .difficulty-progress {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-top: 8px;
        }

        .difficulty-progress .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #e2e8f0;
            border: 2px solid #cbd5e0;
            transition: all 0.3s;
        }

        .difficulty-progress .dot.completed {
            background: linear-gradient(135deg, #48bb78, #38a169);
            border-color: #2f855a;
            box-shadow: 0 2px 4px rgba(72, 187, 120, 0.4);
        }

        .difficulty-progress .dot:nth-child(1).completed { background: linear-gradient(135deg, #48bb78, #38a169); }
        .difficulty-progress .dot:nth-child(2).completed { background: linear-gradient(135deg, #ecc94b, #d69e2e); }
        .difficulty-progress .dot:nth-child(3).completed { background: linear-gradient(135deg, #f56565, #e53e3e); }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .path-flow {
                flex-direction: column;
            }

            .flow-arrow {
                transform: rotate(90deg);
            }

            .flow-topic-card {
                width: 100%;
                max-width: 280px;
            }
        }

        .best-score-display {
            margin-top: 8px;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }

        .mastery-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 9999;
            text-align: center;
            animation: popIn 0.5s ease-out;
        }

        @keyframes popIn {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        /* ==================== GUEST MODE STYLES ==================== */
        .guest-banner {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 16px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 3px solid #2f855a;
        }

        .guest-banner-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
        }

        .guest-banner-text {
            flex: 1;
            min-width: 250px;
        }

        .guest-banner h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .guest-banner p {
            margin: 0;
            font-size: 14px;
            opacity: 0.95;
        }

        .guest-banner-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .guest-register-btn {
            background: white;
            color: #38a169;
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }

        .guest-register-btn:hover {
            background: #f7fafc;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .guest-login-btn {
            background: transparent;
            color: white;
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s;
            border: 2px solid white;
            cursor: pointer;
            font-size: 14px;
        }

        .guest-login-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        @media (max-width: 640px) {
            .guest-banner-content {
                flex-direction: column;
                text-align: center;
            }
            
            .guest-banner-actions {
                width: 100%;
                justify-content: center;
            }
        }

        /* Guest Result Modal Styles */
        .guest-result-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }

        .guest-result-modal {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .guest-result-modal h2 {
            color: #2d3748;
            font-size: 28px;
            margin-bottom: 16px;
        }

        .guest-result-modal .score-display {
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
        }

        .guest-result-modal .message {
            color: #4a5568;
            font-size: 16px;
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .guest-result-modal .benefits {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .guest-result-modal .benefits h3 {
            color: #2d3748;
            font-size: 18px;
            margin-bottom: 12px;
        }

        .guest-result-modal .benefits ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .guest-result-modal .benefits li {
            color: #4a5568;
            padding: 6px 0;
            display: flex;
            align-items: center;
            font-size: 14px;
        }

        .guest-result-modal .benefits li::before {
            content: 'âœ“';
            color: #48bb78;
            font-weight: bold;
            margin-right: 10px;
            font-size: 18px;
        }

        .guest-result-modal .button-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .guest-result-modal .primary-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 32px;
            border-radius: 12px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .guest-result-modal .primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .guest-result-modal .secondary-btn {
            background: #e2e8f0;
            color: #2d3748;
            padding: 16px 32px;
            border-radius: 12px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .guest-result-modal .secondary-btn:hover {
            background: #cbd5e0;
        }

        /* ========================================
           AVATAR SYSTEM STYLES 
           ======================================== */
        
        @keyframes results-glow {
            0%, 100% {
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
            }
            50% {
                box-shadow: 0 0 40px rgba(255, 215, 0, 0.6);
            }
        }
        
        #header-avatar-container:hover #header-avatar {
            transform: scale(1.1);
            transition: transform 0.2s ease;
        }
        
        #results-avatar {
            margin: 0 auto;
        }

        /* ========================================
           MILESTONE CELEBRATION SYSTEM 
           ======================================== */
        
        .milestone-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease-in;
        }

        .milestone-modal {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.5s ease-out;
            position: relative;
        }

        .milestone-modal.perfect-score {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .milestone-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: bounce 1s ease-in-out infinite;
        }

        .milestone-title {
            color: white;
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .milestone-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 18px;
            margin-bottom: 30px;
        }

        .milestone-badges-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
            max-height: 400px;
            overflow-y: auto;
        }

        .milestone-badge {
            background: rgba(255, 255, 255, 1.0);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 15px;
            /* backdrop-filter: blur(10px); */ /* REMOVED - CAUSED BLUR */
            transition: transform 0.2s;
        }

        .milestone-badge:hover {
            transform: scale(1.02);
        }

        .milestone-badge-icon {
            font-size: 40px;
            margin-bottom: 5px;
        }

        .milestone-badge-name {
            color: white;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .milestone-badge-description {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
        }

        .milestone-badge-points {
            color: #ffd700;
            font-size: 16px;
            font-weight: bold;
            margin-top: 8px;
        }

        .milestone-continue-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .milestone-continue-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .confetti-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            border-radius: 20px;
            overflow: hidden;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { 
                transform: translateY(-50px) scale(0.8);
                opacity: 0;
            }
            to { 
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }

    </style>
</head>
<body class="bg-gradient-to-br from-indigo-100 via-purple-50 to-pink-100 min-h-screen">
    <!-- Guest Mode Banner (shown only for guest users) -->
    <div id="guestBanner" class="guest-banner" style="display: none;">
        <div class="guest-banner-content">
            <div class="guest-banner-text">
                <h3>ðŸŽ¯ Guest Mode - Try Unlimited Quizzes!</h3>
                <p>Register to save your progress, earn badges, and track your learning journey</p>
            </div>
            <div class="guest-banner-actions">
                <a href="/register" class="guest-register-btn">Create Free Account</a>
                <a href="/" class="guest-login-btn">Login</a>
            </div>
        </div>
    </div>

    <!-- Header with User Info -->
    <div id="mainHeader" class="bg-white shadow-md">
        <!-- AgentMath Header Banner -->
        <div class="agentmath-header-banner">
            <img src="/static/images/branding/agentmath_header.jpg" alt="AgentMath.app" class="header-banner-img">
        </div>
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800">ðŸ” Agent Dashboard</h1>
            <div class="flex items-center gap-4">
                <!-- AVATAR: Display in header -->
                {% if feature_flags.AVATAR_SYSTEM_ENABLED %}
                <div id="header-avatar-container" class="flex items-center gap-2 cursor-pointer" onclick="window.location.href='/avatar/shop'" title="Customize your avatar">
                    <div id="header-avatar" class="avatar-container avatar-small"></div>
                </div>
                {% endif %}
                <span class="text-gray-700" id="userName"></span>
                <button onclick="openPasswordModal()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-all">
                    <i class="fas fa-key mr-2"></i>Change Password
                </button>
                <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-all">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
        </div>
    </div>

    <div id="app" class="container mx-auto px-4 py-8">
        <!-- Badge Summary Widget -->
        <!-- Compact Action Bar (replaces large badge widget) -->
        <div id="badge-widget" class="bg-white shadow-sm rounded-xl p-3 mb-4" style="display: none;">
            <div class="flex flex-wrap items-center justify-between gap-2">
                <div class="flex items-center gap-3">
                    <!-- Online Counter -->
                    <div class="online-counter" id="onlineCounter" title="Students learning right now!" style="padding: 6px 12px; font-size: 13px;">
                        <span class="pulse-dot"></span>
                        <span id="onlineCount">--</span> online
                    </div>
                    <!-- Sound Toggle -->
                    <button onclick="toggleSoundEffects()" class="sound-toggle p-2 rounded-lg bg-purple-100 hover:bg-purple-200 transition-all" id="soundToggleBtn" title="Toggle Sound Effects">
                        <i class="fas fa-volume-up text-purple-600" id="soundIcon"></i>
                    </button>
                </div>
                <div class="flex flex-wrap gap-2">
                    {% if feature_flags.AVATAR_SYSTEM_ENABLED %}
                    <a href="/avatar/shop" class="action-btn" style="background: linear-gradient(135deg, #ff9a9e, #fecfef);">ðŸŽ¨ Avatar</a>
                    {% endif %}
                    <a href="/racing-car" class="action-btn" style="background: linear-gradient(135deg, #e10600, #ff4444); color: white;">ðŸŽï¸ Race Car</a>
                    <button onclick="openDinoArchive()" class="action-btn" style="background: linear-gradient(135deg, #22c55e, #16a34a); color: white;">ðŸ¦• Dinos</button>
                    {% if feature_flags.PRIZE_SYSTEM_ENABLED %}
                    <a href="/prizes" class="action-btn" style="background: linear-gradient(135deg, #ffd700, #ffb347); color: #333;">ðŸŽ Prizes</a>
                    {% endif %}
                    <a href="/student/badges" class="action-btn" style="background: #f3f4f6; color: #374151;">ðŸ… Badges</a>
                </div>
            </div>
        </div>

        <!-- Loading Screen -->
        <div id="loadingScreen" class="text-center py-20">
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-purple-600 mx-auto"></div>
            <p class="mt-4 text-xl text-gray-700">Loading...</p>
        </div>

        <!-- Topic Selection Screen -->
        <div id="topicScreen" class="hidden">
            <div class="text-center mb-8">
                <h2 class="text-4xl font-bold text-gray-800 mb-2">ðŸš€ Your Learning Journey</h2>
                <p class="text-lg text-gray-600">Choose a topic to practice</p>
            </div>

            <!-- Main Layout: 3/4 Topics, 1/4 Sidebar -->
            <div class="flex flex-col lg:flex-row gap-6 main-layout">
                
                <!-- LEFT: Main Topics Area (3/4) -->
                <div class="w-full lg:w-3/4 topics-column">
                    <!-- Learning Paths Container (Dynamically generated by Junior Cycle strands) -->
                    <div class="space-y-8" id="learningPathsContainer">
                        <!-- Strand cards will be generated dynamically based on database strands -->
                    </div>
                    <!-- Hidden div to maintain progressSummary element for JS compatibility -->
                    <div id="progressSummary" class="hidden"></div>
                </div>

                <!-- RIGHT: Sidebar (1/4) -->
                <div class="w-full lg:w-1/4 space-y-4 sidebar-column">
                    
                    <!-- Your Stats Card -->
                    <div class="sidebar-card stats-card">
                        <div class="sidebar-card-header">
                            <span class="sidebar-card-icon">ðŸ†</span>
                            <span class="sidebar-card-title">Your Stats</span>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span id="stat-level" class="stat-value">-</span>
                                <span class="stat-label">Level</span>
                            </div>
                            <div class="stat-item">
                                <span id="stat-points" class="stat-value">-</span>
                                <span class="stat-label">Points</span>
                            </div>
                            <div class="stat-item">
                                <span id="stat-badges" class="stat-value">-</span>
                                <span class="stat-label">Badges</span>
                            </div>
                            <div class="stat-item">
                                <span id="stat-quizzes" class="stat-value">-</span>
                                <span class="stat-label">Quizzes</span>
                            </div>
                            <div class="stat-item" id="streak-box" title="Complete quizzes on consecutive school days!">
                                <span id="stat-streak" class="stat-value">-</span>
                                <span class="stat-label">ðŸ”¥ Streak</span>
                            </div>
                            <div class="stat-item">
                                <span id="stat-accuracy" class="stat-value">-</span>
                                <span class="stat-label">Accuracy</span>
                            </div>
                        </div>
                        <div id="recent-badges-container" class="recent-badges-mini" style="display: none;">
                            <div class="text-xs text-gray-500 mb-1">Recent:</div>
                            <div id="recent-badges" class="flex flex-wrap gap-1"></div>
                        </div>
                    </div>
                    
                    <!-- Quick Play Mini Card -->
                    <div class="sidebar-card quick-play-mini" onclick="showQuickPlayModal()">
                        <div class="sidebar-card-icon">âš¡</div>
                        <div class="sidebar-card-content">
                            <h4 class="sidebar-card-title">Quick Play</h4>
                            <p class="sidebar-card-desc">10 random questions</p>
                        </div>
                        <i class="fas fa-chevron-right sidebar-card-arrow"></i>
                    </div>


                    <!-- Smart Quiz Mini Card (Adaptive Learning) -->
                    <div class="sidebar-card smart-quiz-mini {% if session.get('is_guest') and not session.get('guest_code') %}guest-disabled{% endif %}" 
                         onclick="{% if session.get('is_guest') and not session.get('guest_code') %}showSmartQuizGuestMessage(){% else %}showSmartQuizModal(){% endif %}"
                         title="{% if session.get('is_guest') and not session.get('guest_code') %}Get a guest code to unlock Smart Quiz!{% else %}AI-powered personalised quiz{% endif %}">
                        <div class="sidebar-card-icon">ðŸ§ </div>
                        <div class="sidebar-card-content">
                            <h4 class="sidebar-card-title">Smart Quiz</h4>
                            <p class="sidebar-card-desc">{% if session.get('is_guest') and not session.get('guest_code') %}Get guest code to unlock{% else %}Personalised for you{% endif %}</p>
                        </div>
                        <i class="fas fa-chevron-right sidebar-card-arrow"></i>
                    </div>

                    <!-- Adaptive Quiz Mini Card (10-Level Progression) -->
                    <div class="sidebar-card adaptive-quiz-mini {% if session.get('is_guest') and not session.get('guest_code') %}guest-disabled{% endif %}" 
                         onclick="{% if session.get('is_guest') and not session.get('guest_code') %}showAdaptiveQuizGuestMessage(){% else %}showAdaptiveQuizModal(){% endif %}"
                         title="{% if session.get('is_guest') and not session.get('guest_code') %}Get a guest code to unlock Adaptive Quiz!{% else %}Level up through 10 difficulty stages{% endif %}">
                        <div class="sidebar-card-icon">ðŸŽ¯</div>
                        <div class="sidebar-card-content">
                            <h4 class="sidebar-card-title">Adaptive Quiz</h4>
                            <p class="sidebar-card-desc">{% if session.get('is_guest') and not session.get('guest_code') %}Get guest code to unlock{% else %}10 levels of progression{% endif %}</p>
                        </div>
                        <i class="fas fa-chevron-right sidebar-card-arrow"></i>
                    </div>

                    <!-- Weekly Challenge Mini Card -->
                    <div class="sidebar-card weekly-challenge-mini">
                        <div class="sidebar-card-header">
                            <span class="sidebar-card-icon">ðŸ“…</span>
                            <span class="sidebar-card-title">Weekly Challenge</span>
                        </div>
                        <div class="challenge-mini-progress">
                            <div class="challenge-mini-bar" id="challengeProgressBarMini" style="width: 0%;"></div>
                        </div>
                        <div class="challenge-mini-status">
                            <span id="challengeProgressTextMini">0/3 Goals</span>
                            <span class="challenge-mini-timer"><i class="fas fa-clock"></i> <span id="challengeTimeLeftMini">--</span></span>
                        </div>
                        <div class="challenge-mini-goals" id="challengeGoalsMini">
                            <div class="challenge-mini-goal" id="goal1Mini" title="Complete 5 quizzes (+50 pts)">ðŸ“</div>
                            <div class="challenge-mini-goal" id="goal2Mini" title="Score 80%+ three times (+75 pts)">ðŸŽ¯</div>
                            <div class="challenge-mini-goal" id="goal3Mini" title="Get a 5-streak (+100 pts)">ðŸ”¥</div>
                        </div>
                    </div>

                    <!-- Leaderboard Mini Card -->
                    <div class="sidebar-card leaderboard-mini">
                        <div class="sidebar-card-header">
                            <span class="sidebar-card-icon">ðŸ†</span>
                            <span class="sidebar-card-title">Top Learners</span>
                            <button class="leaderboard-expand-btn" onclick="toggleLeaderboardExpand()" title="Show more">
                                <i class="fas fa-chevron-down" id="leaderboardExpandIcon"></i>
                            </button>
                        </div>
                        <div class="leaderboard-tabs-mini">
                            <button class="lb-tab-mini active" onclick="switchLeaderboard('weekly', event)">Week</button>
                            <button class="lb-tab-mini" onclick="switchLeaderboard('alltime', event)">All Time</button>
                        </div>
                        <div class="leaderboard-mini-list" id="leaderboardListMini">
                            <!-- Top 3 shown by default -->
                        </div>
                        <div class="leaderboard-expanded-list hidden" id="leaderboardListExpanded">
                            <!-- Positions 4-20 shown when expanded -->
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Difficulty Selection Screen -->
        <div id="difficultyScreen" class="hidden">
            <div class="max-w-4xl mx-auto">
                <button onclick="backToTopics()" class="mb-6 bg-white text-gray-700 px-6 py-2 rounded-lg shadow hover:shadow-md transition-all">
                    â† Back to Topics
                </button>

                <div class="text-center mb-12">
                    <h2 id="selectedTopicTitle" class="text-4xl font-bold text-gray-800 mb-4"></h2>
                    <p class="text-xl text-gray-600">Select your level</p>
                </div>

                <div id="difficultyButtonsContainer" class="grid md:grid-cols-3 gap-6">
                    <!-- Difficulty buttons will be generated dynamically -->
                </div>
            </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quizScreen" class="hidden mx-auto" style="max-width: 1400px;">
            <!-- Compact Quiz Header Bar -->
            <div class="compact-quiz-header">
                <div class="quiz-info">
                    <button onclick="backToDifficulty()" class="back-btn">
                        <i class="fas fa-arrow-left"></i> Exit
                    </button>
                    <span id="compactTopicTitle" class="topic-title"></span>
                    <span id="compactQuestionBadge" class="question-badge">Q1/20</span>
                    <span id="compactScoreBadge" class="score-badge">Score: 0/20</span>
                    <!-- Enhanced Hot Streak Display -->
                    <div id="hotStreakDisplay" class="hot-streak-display streak-cold">
                        <span class="streak-flame">ðŸ”¥</span>
                        <span id="streakCount">0</span>
                        <span id="streakLabel">streak</span>
                        <span id="streakMultiplierBadge" class="streak-multiplier" style="display: none;">1.5x</span>
                    </div>
                    <!-- Mini Online Counter in Quiz -->
                    <div class="online-counter-mini" id="onlineCounterMini" title="Students online now">
                        <span class="pulse-dot"></span>
                        <span id="onlineCountMini">--</span>
                    </div>
                </div>
                <div class="tools">
                    <!-- Sound Toggle in Quiz -->
                    <button onclick="toggleSoundEffects()" class="tool-btn sound-toggle" id="soundToggleBtnQuiz" title="Toggle Sound Effects">
                        <i class="fas fa-volume-up" id="soundIconQuiz"></i>
                    </button>
                    <!-- Hint Button (icon only) -->
                    <button id="compactHintBtn" onclick="showHint()" class="tool-btn hint-btn" title="Show Hint (-50% points)" style="display: none;">
                        <i class="fas fa-lightbulb"></i>
                    </button>
                    <!-- Calculator Button (icon only) -->
                    <button onclick="toggleCalculator()" class="tool-btn" title="Calculator" id="compactCalcBtn">
                        <i class="fas fa-calculator"></i>
                    </button>
                    <!-- Avatar (if enabled) -->
                    {% if feature_flags.AVATAR_SYSTEM_ENABLED %}
                    <div id="quiz-header-avatar" class="avatar-container avatar-small cursor-pointer" onclick="window.location.href='/avatar/shop'" title="Customize your avatar" style="width: 36px; height: 36px;"></div>
                    {% endif %}
                </div>
            </div>
            <!-- Compact Progress Bar -->
            <div class="compact-progress">
                <div id="compactProgressBar" class="compact-progress-fill" style="width: 0%"></div>
            </div>

            <!-- Flex container for side-by-side layout -->
            <div class="flex flex-col lg:flex-row gap-6 px-4 py-4">
                
                <!-- WHO AM I: Reveal Grid - Left side on desktop, BELOW question on mobile -->
                <div id="who-am-i-container" class="who-am-i-container w-full lg:w-5/12 flex-shrink-0 order-2 lg:order-1" style="display: none;">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin fa-2x text-white"></i>
                        <p class="text-white mt-2">Loading mystery image...</p>
                    </div>
                </div>

                <!-- Question Card - Right side on desktop, ABOVE image on mobile -->
                <div id="questionCard" class="bg-white rounded-2xl p-6 shadow-2xl flex-1 order-1 lg:order-2">
                    <!-- Hidden elements for compatibility -->
                    <div class="hidden">
                        <h2 id="quizTopicTitle"></h2>
                        <span id="currentQuestion">1</span>
                        <span id="totalQuestions">20</span>
                        <div id="progressBar"></div>
                        <span id="score">0</span>
                        <span id="total">20</span>
                    </div>
                    
                    <!-- Streak Display (now shown in header, but keep for JS compatibility) -->
                    <div id="streakDisplay" class="hidden">
                        <span id="streakEmoji">ðŸ”¥</span>
                        <span id="streakText"></span>
                        <span id="streakMultiplier"></span>
                    </div>

                    <!-- Question Content -->
                    <div class="quiz-content-wrapper">
                        <div class="quiz-main-content">
                            <!-- Question Image (if present) - SIZE UNCHANGED -->
                            <div id="questionImageContainer" class="hidden mb-4">
                                <img id="questionImage" src="" alt="Question image" class="max-w-full max-h-64 mx-auto rounded-lg shadow-lg border-2 border-gray-200">
                                <p id="questionImageCaption" class="text-sm text-gray-500 text-center mt-2 italic"></p>
                            </div>
                            
                            <!-- Question Text - SIZE UNCHANGED -->
                            <h3 id="questionText" class="text-3xl font-semibold text-gray-800 mb-6" style="white-space: pre-wrap; line-height: 1.8;"></h3>
                            
                            <!-- Hint Container (for compatibility) -->
                            <div id="hintContainer" class="hidden"></div>
                            
                            <!-- Hint Text (shown when hint is revealed) -->
                            <div id="hintText" class="hidden mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-800">
                                <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                                <span id="hintContent"></span>
                            </div>
                            
                            <!-- Answer Options -->
                            <div id="optionsContainer" class="space-y-3"></div>
                            
                            <!-- Inline Feedback + Next Button Row -->
                            <div id="feedbackNextRow" class="feedback-next-row hidden">
                                <div id="feedbackInline" class="feedback-inline correct">
                                    <span class="feedback-icon">âœ…</span>
                                    <div>
                                        <span id="feedbackText" class="feedback-text correct">Correct!</span>
                                        <span id="feedbackStreak" class="streak-bonus"></span>
                                    </div>
                                </div>
                                <button id="nextBtnInline" onclick="nextQuestion()" class="next-btn-inline">
                                    Next â†’
                                </button>
                            </div>
                            
                            <!-- Explanation Section (collapsible) -->
                            <div id="explanationSection" class="explanation-section hidden">
                                <div class="explanation-toggle" onclick="toggleExplanation()">
                                    <span><i class="fas fa-book-open mr-2"></i>View Explanation</span>
                                    <i id="explanationArrow" class="fas fa-chevron-down"></i>
                                </div>
                                <div id="explanationContent" class="explanation-content hidden"></div>
                            </div>
                            
                            <!-- Hidden elements for backwards compatibility -->
                            <div id="feedbackContainer" class="hidden"></div>
                            <button id="nextButton" class="hidden"></button>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>

        <!-- Results Screen -->
        <div id="resultsScreen" class="hidden max-w-2xl mx-auto">
            <div class="bg-white rounded-2xl p-8 shadow-2xl text-center">
                <!-- AVATAR: Show on results screen -->
                {% if feature_flags.AVATAR_SYSTEM_ENABLED %}
                <div id="results-avatar-container" class="mb-4">
                    <div id="results-avatar" class="avatar-container avatar-large mx-auto" style="border: 4px solid #ffd700; animation: results-glow 2s ease-in-out infinite;"></div>
                </div>
                
                <!-- New Item Unlocked Banner -->
                <div id="new-unlock-banner" class="hidden bg-gradient-to-r from-yellow-400 to-orange-400 text-gray-800 rounded-xl p-4 mb-4 animate-pulse">
                    <div class="flex items-center justify-center gap-2">
                        <i class="fas fa-gift text-2xl"></i>
                        <div>
                            <p class="font-bold">New item unlocked!</p>
                            <p id="unlock-message" class="text-sm">You can now afford new items in the Avatar Shop!</p>
                        </div>
                        <a href="/avatar/shop" class="bg-gray-800 text-white px-3 py-1 rounded-lg text-sm hover:bg-gray-700 ml-2">Visit Shop</a>
                    </div>
                </div>
                {% else %}
                <i class="fas fa-trophy text-yellow-500 text-8xl mb-6"></i>
                {% endif %}
                <h2 class="text-4xl font-bold text-gray-800 mb-4">Quiz Complete!</h2>
                <div id="percentage" class="text-6xl font-bold text-purple-600 mb-4"></div>
                <p id="scoreText" class="text-2xl text-gray-700 mb-8"></p>
                <div id="performanceMessage" class="text-xl font-semibold mb-6"></div>

                <!-- WHO AM I: Bonus display -->
                <div id="who-am-i-bonus-display" style="display: none;" class="bg-yellow-100 border-2 border-yellow-500 rounded-xl p-4 mb-6">
                    <div class="flex items-center justify-center">
                        <i class="fas fa-star text-yellow-600 text-3xl mr-3"></i>
                        <div>
                            <p class="font-bold text-lg text-yellow-800">Who Am I? Bonus!</p>
                            <p class="text-yellow-700">+<span id="bonus-points-display">0</span> points</p>
                        </div>
                    </div>
                </div>

                <!-- DINO BONUS: Unlock for 85%+ scores -->
                <div id="dino-bonus-unlock" class="bonus-question-unlock" style="display: none;">
                    <h3>ðŸ¦• Bonus Challenge Unlocked!</h3>
                    <p>Your excellent score (85%+) has unlocked a Dinosaur Challenge!</p>
                    <p class="text-sm mb-3">Identify the dinosaur correctly for <strong>+100 bonus points!</strong></p>
                    <div class="bonus-buttons">
                        <button onclick="startBonusQuestion()" class="try-btn">
                            <i class="fas fa-dragon"></i> Try Bonus Question
                        </button>
                        <button onclick="skipBonusQuestion()" class="skip-btn">
                            Skip
                        </button>
                    </div>
                </div>

                <!-- PUZZLE OF THE WEEK: Answer Reveal Offer -->
                <div id="puzzle-answer-offer" style="display: none;" class="bg-gradient-to-r from-purple-100 to-indigo-100 border-2 border-purple-300 rounded-xl p-4 mb-6">
                    <div class="flex items-center justify-center mb-3">
                        <i class="fas fa-puzzle-piece text-purple-600 text-2xl mr-3"></i>
                        <p class="font-bold text-lg text-purple-800">ðŸ§© Puzzle of the Week</p>
                    </div>
                    <p class="text-purple-700 mb-3">Ready to see the answer to this week's puzzle?</p>
                    <div class="flex justify-center gap-3">
                        <button onclick="revealPuzzleAnswer()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition">
                            <i class="fas fa-eye mr-2"></i>Reveal Answer
                        </button>
                        <button onclick="dismissPuzzleAnswerOffer()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition">
                            Not Now
                        </button>
                    </div>
                </div>

                <div class="space-y-4">
                    <button onclick="retryQuiz()" class="w-full bg-purple-600 text-white py-4 rounded-xl font-semibold hover:bg-purple-700 transition-colors">
                        Try Again
                    </button>
                    <button onclick="refreshAndShowDifficulty()" class="w-full bg-blue-500 text-white py-4 rounded-xl font-semibold hover:bg-blue-600 transition-colors">
                        Try Another Level
                    </button>
                    <button onclick="backToTopics()" class="w-full bg-gray-200 text-gray-800 py-4 rounded-xl font-semibold hover:bg-gray-300 transition-colors">
                        Choose Another Topic
                    </button>
                    {% if feature_flags.AVATAR_SYSTEM_ENABLED %}
                    <a href="/avatar/shop" class="block w-full bg-gradient-to-r from-pink-500 to-purple-500 text-white py-4 rounded-xl font-semibold hover:from-pink-600 hover:to-purple-600 transition-colors">
                        ðŸŽ¨ Avatar Shop
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTopic = '';
        let currentDifficulty = '';
        let questions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let answered = false;
        let startTime = null;
        
        // Milestone Tracking (Client-Side for ALL users)
        let consecutiveCorrect = 0;
        let maxConsecutiveCorrect = 0;
        let questionsAnsweredInQuiz = 0;
        let shownMilestones = new Set(); // Track which milestones shown this quiz
        let totalMilestonePoints = 0; // Track total milestone points earned in this quiz
        
        // WHO AM I: Track quiz attempt ID and enable state
        let currentQuizAttemptId = null;
        let whoAmIEnabled = false;
        
        let masteryData = {}; // Stores mastery status for all topics/difficulties

        // ==================== DAY 1 FEATURES ====================
        // Sound Effects, Online Counter, Hot Streak Indicator
        
        // === SOUND EFFECTS SYSTEM ===
        let soundEnabled = localStorage.getItem('agentmath_sound') !== 'false'; // Default ON
        
        // Sound effect URLs (using Web Audio API for reliability)
        const soundEffects = {
            correct: null,
            incorrect: null,
            streak3: null,
            streak5: null,
            streak10: null,
            levelUp: null
        };
        
        // Initialize audio context and sounds
        let audioContext = null;
        
        function initSoundSystem() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log('ðŸ”Š Sound system initialized');
            } catch (e) {
                console.log('âš ï¸ Web Audio API not supported');
            }
            updateSoundToggleUI();
        }
        
        // Play a tone-based sound effect
        function playSound(type) {
            if (!soundEnabled || !audioContext) return;
            
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Different sounds for different events
                switch(type) {
                    case 'correct':
                        oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                        oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
                        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.3);
                        break;
                        
                    case 'incorrect':
                        oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                        oscillator.frequency.setValueAtTime(150, audioContext.currentTime + 0.1);
                        oscillator.type = 'sawtooth';
                        gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.3);
                        break;
                        
                    case 'streak3':
                        // Rising arpeggio for streak milestones
                        playArpeggio([523.25, 659.25, 783.99], 0.1, 0.3); // C5, E5, G5
                        break;
                        
                    case 'streak5':
                        playArpeggio([523.25, 659.25, 783.99, 1046.50], 0.08, 0.4); // C5, E5, G5, C6
                        break;
                        
                    case 'streak10':
                        playArpeggio([523.25, 659.25, 783.99, 1046.50, 1318.51], 0.06, 0.5); // Extended arpeggio
                        break;
                        
                    case 'levelUp':
                        playArpeggio([261.63, 329.63, 392.00, 523.25, 659.25, 783.99], 0.1, 0.8);
                        break;
                }
            } catch (e) {
                console.log('Sound play error:', e);
            }
        }
        
        function playArpeggio(frequencies, noteLength, totalDuration) {
            if (!audioContext) return;
            
            frequencies.forEach((freq, index) => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                
                osc.frequency.value = freq;
                osc.type = 'sine';
                
                const startTime = audioContext.currentTime + (index * noteLength);
                gain.gain.setValueAtTime(0.2, startTime);
                gain.gain.exponentialRampToValueAtTime(0.01, startTime + noteLength * 1.5);
                
                osc.start(startTime);
                osc.stop(startTime + noteLength * 2);
            });
        }
        
        function toggleSoundEffects() {
            soundEnabled = !soundEnabled;
            localStorage.setItem('agentmath_sound', soundEnabled);
            updateSoundToggleUI();
            
            // Play a test sound when enabling
            if (soundEnabled) {
                // Resume audio context if suspended (browser autoplay policy)
                if (audioContext && audioContext.state === 'suspended') {
                    audioContext.resume();
                }
                playSound('correct');
            }
        }
        
        function updateSoundToggleUI() {
            const btn1 = document.getElementById('soundToggleBtn');
            const btn2 = document.getElementById('soundToggleBtnQuiz');
            const icon1 = document.getElementById('soundIcon');
            const icon2 = document.getElementById('soundIconQuiz');
            
            [btn1, btn2].forEach(btn => {
                if (btn) {
                    if (soundEnabled) {
                        btn.classList.remove('muted');
                    } else {
                        btn.classList.add('muted');
                    }
                }
            });
            
            [icon1, icon2].forEach(icon => {
                if (icon) {
                    icon.className = soundEnabled ? 'fas fa-volume-up' : 'fas fa-volume-mute';
                }
            });
        }
        
        // === WHO'S ONLINE COUNTER ===
        let onlineCountInterval = null;
        
        async function fetchOnlineCount() {
            try {
                const response = await fetch('/api/online-count');
                if (response.ok) {
                    const data = await response.json();
                    updateOnlineDisplay(data.count || data.online_count || 0);
                }
            } catch (e) {
                console.log('Could not fetch online count');
            }
        }
        
        function updateOnlineDisplay(count) {
            const el1 = document.getElementById('onlineCount');
            const el2 = document.getElementById('onlineCountMini');
            
            if (el1) el1.textContent = count;
            if (el2) el2.textContent = count;
        }
        
        function startOnlineCounter() {
            fetchOnlineCount(); // Fetch immediately
            onlineCountInterval = setInterval(fetchOnlineCount, 30000); // Update every 30 seconds
        }
        
        function stopOnlineCounter() {
            if (onlineCountInterval) {
                clearInterval(onlineCountInterval);
                onlineCountInterval = null;
            }
        }
        
        // === ENHANCED HOT STREAK INDICATOR ===
        let currentStreak = 0;
        
        function updateHotStreakDisplay(streak) {
            currentStreak = streak;
            const display = document.getElementById('hotStreakDisplay');
            const countEl = document.getElementById('streakCount');
            const labelEl = document.getElementById('streakLabel');
            const multiplierEl = document.getElementById('streakMultiplierBadge');
            
            if (!display) return;
            
            countEl.textContent = streak;
            
            // Remove all streak classes
            display.classList.remove('streak-cold', 'streak-warming', 'streak-hot', 'streak-fire', 'streak-legendary');
            
            // Apply appropriate class based on streak level
            if (streak === 0) {
                display.classList.add('streak-cold');
                labelEl.textContent = 'streak';
                multiplierEl.style.display = 'none';
            } else if (streak < 3) {
                display.classList.add('streak-warming');
                labelEl.textContent = 'in a row!';
                multiplierEl.style.display = 'none';
            } else if (streak < 5) {
                display.classList.add('streak-hot');
                labelEl.textContent = 'HOT!';
                multiplierEl.textContent = '1.5x';
                multiplierEl.style.display = 'inline';
                // Play streak sound on reaching 3
                if (streak === 3) playSound('streak3');
            } else if (streak < 10) {
                display.classList.add('streak-fire');
                labelEl.textContent = 'ON FIRE!';
                multiplierEl.textContent = '2x';
                multiplierEl.style.display = 'inline';
                // Play streak sound on reaching 5
                if (streak === 5) playSound('streak5');
            } else {
                display.classList.add('streak-legendary');
                labelEl.textContent = 'LEGENDARY!';
                multiplierEl.textContent = '3x';
                multiplierEl.style.display = 'inline';
                // Play streak sound on reaching 10
                if (streak === 10) playSound('streak10');
            }
            
            // Update the old streak badge for compatibility
            const oldBadge = document.getElementById('compactStreakBadge');
            if (oldBadge) {
                if (streak >= 3) {
                    let multiplier = streak >= 10 ? '3x' : (streak >= 5 ? '2x' : '1.5x');
                    oldBadge.innerHTML = `ðŸ”¥ ${multiplier}`;
                    oldBadge.classList.add('visible');
                } else {
                    oldBadge.classList.remove('visible');
                }
            }
        }
        
        // Initialize Day 1 features on page load
        function initDay1Features() {
            initSoundSystem();
            startOnlineCounter();
            updateHotStreakDisplay(0);
            console.log('ðŸš€ Day 1 features initialized: Sound Effects, Online Counter, Hot Streak');
        }
        
        // ==================== END DAY 1 FEATURES ====================
        
        // ==================== DAY 2 FEATURES ====================
        // Quick Play, Weekly Challenge, Enhanced Leaderboard
        
        // === QUICK PLAY MODE ===
        let quickPlayDifficulty = 'intermediate';
        let isQuickPlayMode = false;
        
        function showQuickPlayModal() {
            document.getElementById('quickPlayModal').classList.remove('hidden');
            document.getElementById('quickPlayModal').classList.add('flex');
        }
        
        function closeQuickPlayModal() {
            document.getElementById('quickPlayModal').classList.add('hidden');
            document.getElementById('quickPlayModal').classList.remove('flex');
        }
        

        // === SMART QUIZ SYSTEM (Adaptive Learning) ===
        let smartQuizMode = 'auto';  // auto, review, practice, challenge
        let smartQuizData = null;
        
        function showSmartQuizGuestMessage() {
            alert('ðŸ”’ Smart Quiz requires a Guest Code!\n\nSmart Quiz uses AI to personalise your learning based on your quiz history.\n\nClick "Return with Code" on the home page to get your personal guest code, or register for a full account!');
        }
        
        function showSmartQuizModal() {
            // First fetch the recommendation
            fetchSmartQuizRecommendation('auto');
            document.getElementById('smartQuizModal').classList.remove('hidden');
            document.getElementById('smartQuizModal').classList.add('flex');
        }
        
        function closeSmartQuizModal() {
            document.getElementById('smartQuizModal').classList.add('hidden');
            document.getElementById('smartQuizModal').classList.remove('flex');
        }
        
        function setSmartQuizMode(mode) {
            smartQuizMode = mode;
            // Update button states
            document.querySelectorAll('.smart-mode-btn').forEach(btn => {
                if (btn.dataset.mode === mode) {
                    btn.classList.add('border-green-400', 'bg-green-50');
                    btn.classList.remove('border-gray-200');
                } else {
                    btn.classList.remove('border-green-400', 'bg-green-50');
                    btn.classList.add('border-gray-200');
                }
            });
            // Fetch new recommendation for this mode
            fetchSmartQuizRecommendation(mode);
        }
        
        async function fetchSmartQuizRecommendation(mode) {
            const loadingEl = document.getElementById('smartQuizLoading');
            const contentEl = document.getElementById('smartQuizContent');
            const errorEl = document.getElementById('smartQuizError');
            
            loadingEl.classList.remove('hidden');
            contentEl.classList.add('hidden');
            errorEl.classList.add('hidden');
            
            try {
                const response = await fetch('/api/adaptive/smart-quiz', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: mode })
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Failed to get recommendation');
                }
                
                smartQuizData = await response.json();
                
                // Update the UI
                document.getElementById('smartQuizTopic').textContent = formatTopicName(smartQuizData.topic);
                document.getElementById('smartQuizDifficulty').textContent = capitalise(smartQuizData.difficulty);
                document.getElementById('smartQuizReason').textContent = smartQuizData.reason || 'Recommended for you';
                
                // Set difficulty badge color
                const diffBadge = document.getElementById('smartQuizDifficulty');
                diffBadge.className = 'px-3 py-1 rounded-full text-sm font-medium';
                if (smartQuizData.difficulty === 'beginner') {
                    diffBadge.classList.add('bg-green-100', 'text-green-700');
                } else if (smartQuizData.difficulty === 'intermediate') {
                    diffBadge.classList.add('bg-yellow-100', 'text-yellow-700');
                } else {
                    diffBadge.classList.add('bg-red-100', 'text-red-700');
                }
                
                // Show mastery if available
                if (smartQuizData.mastery_level !== undefined) {
                    document.getElementById('smartQuizMastery').textContent = 
                        `Current mastery: ${Math.round(smartQuizData.mastery_level)}%`;
                    document.getElementById('smartQuizMasteryContainer').classList.remove('hidden');
                } else {
                    document.getElementById('smartQuizMasteryContainer').classList.add('hidden');
                }
                
                loadingEl.classList.add('hidden');
                contentEl.classList.remove('hidden');
                
            } catch (error) {
                console.error('Smart Quiz error:', error);
                loadingEl.classList.add('hidden');
                errorEl.textContent = error.message || 'Could not load recommendation';
                errorEl.classList.remove('hidden');
            }
        }
        
        function formatTopicName(topic) {
            if (!topic) return 'Unknown Topic';
            return topic.split('_').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }
        
        function capitalise(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
        
        async function startSmartQuiz() {
            if (!smartQuizData || !smartQuizData.topic) {
                alert('Please wait for the recommendation to load.');
                return;
            }
            
            closeSmartQuizModal();
            
            // Store the topic and difficulty
            currentTopic = smartQuizData.topic;
            currentDifficulty = smartQuizData.difficulty;
            
            // Show loading
            document.getElementById('topicScreen').classList.add('hidden');
            document.getElementById('loadingScreen').classList.remove('hidden');
            
            try {
                // Fetch questions for the recommended topic/difficulty
                const response = await fetch(`/api/questions/${currentTopic}/${currentDifficulty}`);
                
                if (!response.ok) {
                    throw new Error('Failed to load questions');
                }
                
                questions = await response.json();
                
                if (questions.length === 0) {
                    alert('No questions available for this topic. Try another!');
                    document.getElementById('loadingScreen').classList.add('hidden');
                    document.getElementById('topicScreen').classList.remove('hidden');
                    return;
                }
                
                // Shuffle and limit to quiz size
                questions = questions.sort(() => Math.random() - 0.5).slice(0, 20);
                
                // Set up quiz state
                currentQuestionIndex = 0;
                score = 0;
                answered = false;
                startTime = Date.now();
                isQuickPlayMode = false;
                
                // Reset tracking
                consecutiveCorrect = 0;
                maxConsecutiveCorrect = 0;
                questionsAnsweredInQuiz = 0;
                shownMilestones.clear();
                totalMilestonePoints = 0;
                currentStreak = 0;
                hintUsedThisQuestion = false;
                updateHotStreakDisplay(0);
                
                // Show quiz
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('quizScreen').classList.remove('hidden');
                document.body.classList.add('quiz-active');
                
                // Update header with Smart Quiz indicator
                document.getElementById('compactTopicTitle').textContent = 
                    'ðŸ§  ' + formatTopicName(currentTopic);
                
                showQuestion();
                
            } catch (error) {
                console.error('Smart Quiz start error:', error);
                alert('Could not start Smart Quiz. Please try again.');
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('topicScreen').classList.remove('hidden');
            }
        }
        
        function setQuickPlayDifficulty(diff) {
            quickPlayDifficulty = diff;
            // Update button states
            document.querySelectorAll('.quick-diff-btn').forEach(btn => {
                if (btn.dataset.diff === diff) {
                    btn.classList.add('border-orange-400', 'bg-orange-50');
                    btn.classList.remove('border-gray-200');
                } else {
                    btn.classList.remove('border-orange-400', 'bg-orange-50');
                    btn.classList.add('border-gray-200');
                }
            });
        }
        
        async function startQuickPlay() {
            closeQuickPlayModal();
            isQuickPlayMode = true;
            
            // Show loading
            document.getElementById('topicScreen').classList.add('hidden');
            document.getElementById('loadingScreen').classList.remove('hidden');
            
            try {
                // Fetch 10 random questions from various topics
                const response = await fetch(`/api/quick-play/${quickPlayDifficulty}`);
                
                if (!response.ok) {
                    throw new Error('Failed to load quick play questions');
                }
                
                questions = await response.json();
                
                if (questions.length === 0) {
                    alert('No questions available for Quick Play. Try a regular quiz!');
                    document.getElementById('loadingScreen').classList.add('hidden');
                    document.getElementById('topicScreen').classList.remove('hidden');
                    isQuickPlayMode = false;
                    return;
                }
                
                // Set up quiz state
                currentTopic = 'quick_play';
                currentDifficulty = quickPlayDifficulty;
                currentQuestionIndex = 0;
                score = 0;
                answered = false;
                startTime = Date.now();
                
                // Reset tracking
                consecutiveCorrect = 0;
                maxConsecutiveCorrect = 0;
                questionsAnsweredInQuiz = 0;
                shownMilestones.clear();
                totalMilestonePoints = 0;
                currentStreak = 0;
                hintUsedThisQuestion = false;
                updateHotStreakDisplay(0);
                
                // Show quiz
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('quizScreen').classList.remove('hidden');
                document.body.classList.add('quiz-active');
                
                // Update header
                document.getElementById('compactTopicTitle').textContent = 'âš¡ Quick Play';
                
                showQuestion();
                
            } catch (error) {
                console.error('Quick Play error:', error);
                alert('Could not start Quick Play. Please try again.');
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('topicScreen').classList.remove('hidden');
                isQuickPlayMode = false;
            }
        }
        
        // === WEEKLY CHALLENGE SYSTEM ===
        let weeklyChallenge = {
            quizzesCompleted: 0,
            highScoreCount: 0,
            maxStreak: 0,
            goals: [
                { id: 'goal1', target: 5, current: 0, points: 50, type: 'quizzes' },
                { id: 'goal2', target: 3, current: 0, points: 75, type: 'highscores' },
                { id: 'goal3', target: 5, current: 0, points: 100, type: 'streak' }
            ]
        };
        
        async function loadWeeklyChallenge() {
            try {
                const response = await fetch('/api/weekly-challenge/status');
                if (response.ok) {
                    const data = await response.json();
                    weeklyChallenge = data.challenge || weeklyChallenge;
                }
            } catch (e) {
                console.log('Weekly challenge status not available');
            }
            updateWeeklyChallengeUI();
        }
        
        function updateWeeklyChallengeUI() {
            // Update progress bar
            const completedGoals = weeklyChallenge.goals.filter(g => g.current >= g.target).length;
            const progressPercent = (completedGoals / 3) * 100;
            
            // Update mini sidebar version
            const progressBarMini = document.getElementById('challengeProgressBarMini');
            const progressTextMini = document.getElementById('challengeProgressTextMini');
            
            if (progressBarMini) {
                progressBarMini.style.width = progressPercent + '%';
            }
            if (progressTextMini) {
                progressTextMini.textContent = `${completedGoals}/3 Goals`;
            }
            
            // Update individual goals (mini version)
            weeklyChallenge.goals.forEach((goal, index) => {
                const goalEl = document.getElementById(`goal${index + 1}Mini`);
                if (goalEl) {
                    if (goal.current >= goal.target) {
                        goalEl.classList.add('completed');
                    }
                }
            });
            
            // Update timer
            updateChallengeTimer();
        }
        
        function updateChallengeTimer() {
            const now = new Date();
            const endOfWeek = new Date();
            endOfWeek.setDate(now.getDate() + (7 - now.getDay())); // Next Sunday
            endOfWeek.setHours(23, 59, 59, 999);
            
            const diff = endOfWeek - now;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            
            const timerStr = days > 0 ? `${days}d ${hours}h` : `${hours}h`;
            
            // Update mini version
            const timerElMini = document.getElementById('challengeTimeLeftMini');
            if (timerElMini) {
                timerElMini.textContent = timerStr;
            }
        }
        
        // Update challenge progress after quiz completion
        function updateChallengeProgress(quizScore, percentage, maxStreakAchieved) {
            // Goal 1: Complete quizzes
            weeklyChallenge.goals[0].current++;
            
            // Goal 2: Score 80%+
            if (percentage >= 80) {
                weeklyChallenge.goals[1].current++;
            }
            
            // Goal 3: Get 5-streak
            if (maxStreakAchieved >= 5) {
                weeklyChallenge.goals[2].current = Math.max(weeklyChallenge.goals[2].current, maxStreakAchieved);
            }
            
            updateWeeklyChallengeUI();
            
            // Save to server
            fetch('/api/weekly-challenge/update', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    quizzes: weeklyChallenge.goals[0].current,
                    highscores: weeklyChallenge.goals[1].current,
                    max_streak: weeklyChallenge.goals[2].current
                })
            }).catch(e => console.log('Could not save challenge progress'));
        }
        
        // === ENHANCED LEADERBOARD ===
        let currentLeaderboardType = 'weekly';
        let leaderboardExpanded = false;
        let fullLeaderboardData = [];
        
        async function loadLeaderboard(type = 'weekly') {
            currentLeaderboardType = type;
            const listEl = document.getElementById('leaderboardListMini');
            
            if (!listEl) return;
            
            listEl.innerHTML = '<div class="text-center text-gray-400 py-2" style="font-size:11px;"><i class="fas fa-spinner fa-spin"></i></div>';
            
            try {
                const response = await fetch(`/api/leaderboard/${type}`);
                if (!response.ok) throw new Error('Failed to load');
                
                const data = await response.json();
                fullLeaderboardData = data.leaderboard || [];
                renderLeaderboardMini(fullLeaderboardData, data.my_position);
            } catch (e) {
                console.log('Leaderboard load error:', e);
                listEl.innerHTML = '<div class="text-center text-gray-400 py-2" style="font-size:11px;">Could not load</div>';
            }
        }
        
        function renderLeaderboardMini(leaderboard, myPosition) {
            const listEl = document.getElementById('leaderboardListMini');
            const expandedEl = document.getElementById('leaderboardListExpanded');
            if (!listEl) return;
            
            if (leaderboard.length === 0) {
                listEl.innerHTML = '<div class="text-center text-gray-400 py-2" style="font-size:11px;">No data yet</div>';
                return;
            }
            
            // Get current user's guest code for highlighting
            const myGuestCode = document.body.dataset.guestCode || '';
            
            // Render top 3
            let topHtml = '';
            leaderboard.slice(0, 3).forEach((player, index) => {
                const rank = index + 1;
                const isMe = player.guest_code === myGuestCode || player.is_current_user;
                
                let rankClass = rank === 1 ? 'gold' : (rank === 2 ? 'silver' : 'bronze');
                let rankDisplay = rank === 1 ? 'ðŸ¥‡' : (rank === 2 ? 'ðŸ¥ˆ' : 'ðŸ¥‰');
                let itemClass = `lb-mini-item top-${rank}${isMe ? ' is-me' : ''}`;
                
                topHtml += `
                    <div class="${itemClass}">
                        <span class="lb-mini-rank ${rankClass}">${rankDisplay}</span>
                        <span class="lb-mini-name">${player.name || player.guest_code || 'Anon'}${isMe ? ' (You)' : ''}</span>
                        <span class="lb-mini-score">${player.points || player.total_score || 0}</span>
                    </div>
                `;
            });
            
            // If user is not in top 3 but we have their position, show it
            const userInTop3 = leaderboard.slice(0, 3).some(p => p.is_current_user || p.guest_code === myGuestCode);
            if (!userInTop3 && myPosition) {
                topHtml += `
                    <div class="lb-mini-divider">Â·Â·Â·</div>
                    <div class="lb-mini-item is-me">
                        <span class="lb-mini-rank">#${myPosition.rank}</span>
                        <span class="lb-mini-name">${myPosition.name} (You)</span>
                        <span class="lb-mini-score">${myPosition.points || 0}</span>
                    </div>
                `;
            }
            
            listEl.innerHTML = topHtml;
            
            // Render expanded (4-20)
            if (expandedEl && leaderboard.length > 3) {
                let expandedHtml = '';
                leaderboard.slice(3, 20).forEach((player, index) => {
                    const rank = index + 4;
                    const isMe = player.guest_code === myGuestCode || player.is_current_user;
                    let itemClass = `lb-mini-item${isMe ? ' is-me' : ''}`;
                    
                    expandedHtml += `
                        <div class="${itemClass}">
                            <span class="lb-mini-rank">${rank}</span>
                            <span class="lb-mini-name">${player.name || player.guest_code || 'Anon'}${isMe ? ' (You)' : ''}</span>
                            <span class="lb-mini-score">${player.points || player.total_score || 0}</span>
                        </div>
                    `;
                });
                
                // If user is not in top 20 but we have their position, show at bottom of expanded
                const userInTop20 = leaderboard.some(p => p.is_current_user || p.guest_code === myGuestCode);
                if (!userInTop20 && myPosition && myPosition.rank > 20) {
                    expandedHtml += `
                        <div class="lb-mini-divider">Â·Â·Â·</div>
                        <div class="lb-mini-item is-me">
                            <span class="lb-mini-rank">#${myPosition.rank}</span>
                            <span class="lb-mini-name">${myPosition.name} (You)</span>
                            <span class="lb-mini-score">${myPosition.points || 0}</span>
                        </div>
                    `;
                }
                
                expandedEl.innerHTML = expandedHtml;
            }
        }
        
        function toggleLeaderboardExpand() {
            leaderboardExpanded = !leaderboardExpanded;
            const expandedEl = document.getElementById('leaderboardListExpanded');
            const btn = document.querySelector('.leaderboard-expand-btn');
            
            if (expandedEl) {
                if (leaderboardExpanded) {
                    expandedEl.classList.remove('hidden');
                    btn?.classList.add('expanded');
                } else {
                    expandedEl.classList.add('hidden');
                    btn?.classList.remove('expanded');
                }
            }
        }
        
        function switchLeaderboard(type, event) {
            // Update tabs
            document.querySelectorAll('.lb-tab-mini').forEach(tab => {
                tab.classList.remove('active');
            });
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            loadLeaderboard(type);
        }
        
        // Initialize Day 2 features
        function initDay2Features() {
            loadWeeklyChallenge();
            loadLeaderboard('weekly');
            console.log('ðŸ“Š Day 2 features initialized: Quick Play, Weekly Challenge, Leaderboard');
        }
        
        // ==================== END DAY 2 FEATURES ====================

        const iconMap = {
            'calculator': 'fa-calculator',
            'divide': 'fa-divide',
            'book': 'fa-book',
            'chart': 'fa-chart-line',
            'dice': 'fa-dice',
            'layers': 'fa-layer-group'
        };

        // Load mastery data from API
        async function loadMasteryData() {
            try {
                const response = await fetch('/api/student/mastery');
                masteryData = await response.json();
                console.log('âœ¨ Mastery data loaded:', masteryData);
            } catch (error) {
                console.error('Error loading mastery data:', error);
                masteryData = {};
            }
        }

        
        // ==================== SESSION VALIDATION ====================
        // Prevent cached pages from resuming after logout
        
        // Check if session is still valid
        async function validateSession() {
            try {
                const response = await fetch('/api/current-user', {
                    method: 'GET',
                    credentials: 'include',
                    cache: 'no-store'
                });
                
                if (!response.ok) {
                    // Session expired or user logged out
                    console.log('Session invalid, redirecting to login...');
                    window.location.href = '/login?session_expired=1';
                    return false;
                }
                
                const user = await response.json();
                if (!user || (!user.id && !user.is_guest)) {
                    console.log('No valid user session, redirecting to login...');
                    window.location.href = '/login?session_expired=1';
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('Session validation error:', error);
                window.location.href = '/login?session_expired=1';
                return false;
            }
        }
        
        // Validate session when page is shown (catches back button navigation)
        window.addEventListener('pageshow', function(event) {
            // If page was restored from bfcache (back-forward cache)
            if (event.persisted) {
                console.log('Page restored from cache, validating session...');
                validateSession();
            }
        });
        
        // Also validate when tab becomes visible (catches tab switching)
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                // Add small delay to avoid too many checks
                setTimeout(validateSession, 500);
            }
        });
        
        // Check for logged_out parameter in URL (set by logout redirect)
        if (window.location.search.includes('logged_out=1')) {
            // Clear any cached state and redirect to clean login
            sessionStorage.clear();
            localStorage.removeItem('mathmaster_session');
            window.location.href = '/login';
        }
        
        // ==================== END SESSION VALIDATION ====================

        window.onload = async function() {
            await loadCurrentUser();
            await loadMasteryData(); // Load mastery data BEFORE topics
            await loadTopics();
            await loadProgress();
            await loadBadgeWidget(); // Load badge widget
            initDay1Features(); // Initialize Day 1: Sound, Online Counter, Hot Streak
            initDay2Features(); // Initialize Day 2: Quick Play, Weekly Challenge, Leaderboard
        };

        // Generate BLANK number line (for questions - no solution shown)
        function generateBlankNumberLine(questionText) {
            const match = questionText.match(/(\d+)\s*([+\-])\s*(\d+)/);
            if (!match) return null;

            const num1 = parseInt(match[1]);
            const num2 = parseInt(match[3]);
            const operation = match[2] === '+' ? 'addition' : 'subtraction';
            const result = operation === 'addition' ? num1 + num2 : num1 - num2;

            // Determine range
            let minNum, maxNum, stepSize;
            if (Math.max(num1, num2, result) > 30) {
                if (num2 <= 10) {
                    minNum = Math.max(0, Math.min(num1, result) - 3);
                    maxNum = Math.max(num1, result) + 3;
                    stepSize = 1;
                } else if (num2 <= 20) {
                    minNum = Math.max(0, Math.min(num1, result) - 5);
                    maxNum = Math.max(num1, result) + 5;
                    stepSize = 2;
                } else {
                    const padding = Math.ceil(num2 * 0.2);
                    minNum = Math.max(0, Math.floor((Math.min(num1, result) - padding) / 5) * 5);
                    maxNum = Math.ceil((Math.max(num1, result) + padding) / 5) * 5;
                    stepSize = (maxNum - minNum > 50) ? 10 : 5;
                }
            } else {
                minNum = Math.max(0, Math.min(num1, result) - 2);
                maxNum = Math.max(num1, result) + 2;
                stepSize = 1;
            }

            const range = maxNum - minNum;

            // Generate BLANK number line (no solution)
            let html = '<div class="number-line-container">';
            html += '<div class="number-line"><div class="number-line-base"></div>';

            for (let i = minNum; i <= maxNum; i += stepSize) {
                const position = ((i - minNum) / range) * 100;
                html += `<div class="number-line-tick" style="left: ${position}%"></div>`;
                html += `<div class="number-line-label" style="left: ${position}%">${i}</div>`;
            }

            html += '</div>';
            html += `<div class="number-line-instruction">ðŸ’¡ Use the number line to help solve: ${questionText}</div>`;
            html += '</div>';

            return html;
        }

        // Generate SOLUTION number line (for explanations - shows complete solution)
        function generateSolutionNumberLine(questionText) {
            const match = questionText.match(/(\d+)\s*([+\-])\s*(\d+)/);
            if (!match) return null;

            const num1 = parseInt(match[1]);
            const num2 = parseInt(match[3]);
            const operation = match[2] === '+' ? 'addition' : 'subtraction';
            const result = operation === 'addition' ? num1 + num2 : num1 - num2;

            // Same range logic as blank version
            let minNum, maxNum, stepSize;
            if (Math.max(num1, num2, result) > 30) {
                if (num2 <= 10) {
                    minNum = Math.max(0, Math.min(num1, result) - 3);
                    maxNum = Math.max(num1, result) + 3;
                    stepSize = 1;
                } else if (num2 <= 20) {
                    minNum = Math.max(0, Math.min(num1, result) - 5);
                    maxNum = Math.max(num1, result) + 5;
                    stepSize = 2;
                } else {
                    const padding = Math.ceil(num2 * 0.2);
                    minNum = Math.max(0, Math.floor((Math.min(num1, result) - padding) / 5) * 5);
                    maxNum = Math.ceil((Math.max(num1, result) + padding) / 5) * 5;
                    stepSize = (maxNum - minNum > 50) ? 10 : 5;
                }
            } else {
                minNum = Math.max(0, Math.min(num1, result) - 2);
                maxNum = Math.max(num1, result) + 2;
                stepSize = 1;
            }

            const range = maxNum - minNum;
            const startPos = ((num1 - minNum) / range) * 100;
            const endPos = ((result - minNum) / range) * 100;

            // Generate SOLUTION number line (with answer)
            let html = '<div class="number-line-container" style="margin-top:16px;background:linear-gradient(135deg,#f0f9ff 0%,#e0f2fe 100%);">';
            html += '<div class="number-line"><div class="number-line-base"></div>';

            // Ticks and labels
            for (let i = minNum; i <= maxNum; i += stepSize) {
                const position = ((i - minNum) / range) * 100;
                html += `<div class="number-line-tick" style="left:${position}%"></div>`;
                html += `<div class="number-line-label" style="left:${position}%">${i}</div>`;
            }

            // Special ticks for start and end
            if (num1 % stepSize !== 0 && num1 >= minNum && num1 <= maxNum) {
                const position = ((num1 - minNum) / range) * 100;
                html += `<div class="number-line-tick" style="left:${position}%;height:15px"></div>`;
                html += `<div class="number-line-label" style="left:${position}%;font-weight:bold">${num1}</div>`;
            }
            if (result % stepSize !== 0 && result >= minNum && result <= maxNum) {
                const position = ((result - minNum) / range) * 100;
                html += `<div class="number-line-tick" style="left:${position}%;height:15px"></div>`;
                html += `<div class="number-line-label" style="left:${position}%;font-weight:bold;color:#48bb78">${result}</div>`;
            }

            // Dots
            html += `<div class="number-line-start-dot" style="left:${startPos}%"></div>`;
            html += `<div class="number-line-end-dot" style="left:${endPos}%"></div>`;

            // Arc and arrow
            if (operation === 'addition') {
                const arcWidth = ((num2) / range) * 100;
                html += `<div class="number-line-arc" style="left:${startPos}%;width:${arcWidth}%"></div>`;
                const arrowPos = startPos + arcWidth / 2;
                html += `<div class="number-line-arrow" style="left:${arrowPos}%;top:5%">â†’</div>`;
                html += '</div>';
                html += `<div class="number-line-instruction" style="background:rgba(72,187,120,0.1);border-left:4px solid #48bb78;padding:12px">`;
                html += `âœ… <strong>Solution:</strong> Start at <strong>${num1}</strong> (ðŸŸ¢), add <strong>${num2}</strong> by jumping forward â†’ to reach <strong>${result}</strong> (ðŸ”´)`;
                html += '</div>';
            } else {
                const arcWidth = ((num2) / range) * 100;
                html += `<div class="number-line-arc" style="left:${startPos - arcWidth}%;width:${arcWidth}%;border-color:#f56565"></div>`;
                const arrowPos = startPos - arcWidth / 2;
                html += `<div class="number-line-arrow" style="left:${arrowPos}%;top:5%;color:#f56565">â†</div>`;
                html += '</div>';
                html += `<div class="number-line-instruction" style="background:rgba(72,187,120,0.1);border-left:4px solid #48bb78;padding:12px">`;
                html += `âœ… <strong>Solution:</strong> Start at <strong>${num1}</strong> (ðŸŸ¢), subtract <strong>${num2}</strong> by jumping back â† to reach <strong>${result}</strong> (ðŸ”´)`;
                html += '</div>';
            }

            html += '</div>';
            return html;
        }

        async function loadCurrentUser() {
            try {
                const response = await fetch('/api/current-user');
                const user = await response.json();
                
                // Check if user is a guest
                if (user.is_guest) {
                    document.getElementById('userName').textContent = 'Guest User';
                    
                    // Show guest banner
                    const guestBanner = document.getElementById('guestBanner');
                    if (guestBanner) {
                        guestBanner.style.display = 'block';
                    }
                    
                    // Hide features not available for guests
                    const changePasswordBtn = document.querySelector('button[onclick="openPasswordModal()"]');
                    if (changePasswordBtn) {
                        changePasswordBtn.style.display = 'none';
                    }
                    
                    // Hide badge widget for guests
                    const badgeWidget = document.getElementById('badge-widget');
                    if (badgeWidget) {
                        badgeWidget.style.display = 'none';
                    }
                } else {
                    document.getElementById('userName').textContent = user.full_name;
                }
            } catch (error) {
                console.error('Error loading user:', error);
                // If we can't load user, session may have expired
                if (error.message && error.message.includes('401')) {
                    window.location.href = '/login?session_expired=1';
                }
            }
        }

        async function loadTopics() {
            try {
                const response = await fetch('/api/topics');
                const data = await response.json();
                topics = data.topics;
                const strands = data.strands || {};
                const strandInfo = data.strand_info || {};

                // Get mastery data
                const masteryResponse = await fetch('/api/student/mastery');
                masteryData = await masteryResponse.json();

                // Icon mapping
                const iconMap = {
                    'calculator': 'fa-calculator',
                    'divide': 'fa-divide',
                    'percent': 'fa-percent',
                    'x': 'fa-xmark',
                    'hash': 'fa-hashtag',
                    'book': 'fa-book',
                    'chart': 'fa-chart-line',
                    'dice': 'fa-dice',
                    'layers': 'fa-layer-group',
                    'radical': 'fa-square-root-alt',
                    'infinity': 'fa-infinity',
                    'rotate': 'fa-rotate'
                };

                // Revision Slides - Thanks to Mr Notaro (Palmerstown CS)
                const revisionSlides = {
                    'Number': [
                        { title: 'Financial Maths', url: 'https://palmerstowncs-my.sharepoint.com/:p:/g/personal/anthony_notaro_palmerstowncs_ie/Eatb7k0qPBVDn14s_J4LNsIBYKXcieOEpYWJeW2y-2imQA?e=4RG012' },
                        { title: 'Sets & Venn Diagrams', url: 'https://palmerstowncs-my.sharepoint.com/:p:/g/personal/anthony_notaro_palmerstowncs_ie/Eap-N1PhTXRNpm4zPs1p1BUBcLnudS4KG2ywFQvnb-MxTw?e=Yxisb2' }
                    ],
                    'Algebra and Functions': [
                        { title: 'Algebra 1', url: 'https://palmerstowncs-my.sharepoint.com/:p:/g/personal/anthony_notaro_palmerstowncs_ie/EaqmYVzyKoBOp1yUuyJHTUIBOU-_1hGeENx2MbsR_0yaBw?e=PSnwt5' },
                        { title: 'Algebra 2', url: 'https://palmerstowncs-my.sharepoint.com/:p:/g/personal/anthony_notaro_palmerstowncs_ie/EQwc1csFFa9PnqstEeP5dsEBE5JF5Z82Br92PZoNWqYaLg?e=VOYikd' },
                        { title: 'Patterns & Sequences', url: 'https://palmerstowncs-my.sharepoint.com/:p:/g/personal/anthony_notaro_palmerstowncs_ie/ETvATshTfsFPsjtrG4h8hNUBeUXlPyThjrJEO0ES0PrnoA?e=vIUTJs' },
                        { title: 'Functions', url: 'https://palmerstowncs-my.sharepoint.com/:p:/g/personal/anthony_notaro_palmerstowncs_ie/EfL8_tLbb7JMh0-pmKQhrQEB8cmWIkgtm84UrXAEK3CFYw?e=c2TXMU' },
                        { title: 'Area & Volume', url: 'https://palmerstowncs-my.sharepoint.com/:p:/g/personal/anthony_notaro_palmerstowncs_ie/EdnyJMpNvlJGvWE0vY4NEVMBEDyJcFmOmSPdSoj1Nb4OsA?e=RPGemu' }
                    ],
                    'Statistics and Probability': [
                        { title: 'Probability', url: 'https://palmerstowncs-my.sharepoint.com/:p:/g/personal/anthony_notaro_palmerstowncs_ie/ESvWVFUaOPlCsx4V19UgVBABT_Xip2WnwHg3qo4GgwKQTw?e=QG7df9' },
                        { title: 'Statistics', url: 'https://palmerstowncs-my.sharepoint.com/:p:/g/personal/anthony_notaro_palmerstowncs_ie/Ebe_0FMGUR1Gr7LxXGPMFHcBh1V4lIgvh_bXRyg0wudLnQ?e=p3bW5i' }
                    ],
                    'Geometry and Trigonometry': [
                        { title: 'Coordinate Geometry', url: 'https://palmerstowncs-my.sharepoint.com/:p:/g/personal/anthony_notaro_palmerstowncs_ie/EfjWpSzzfkxDudQNA2qGo-4BP9qeA0LvpgLhdupk56vf3w?e=ENzJCo' },
                        { title: 'Geometry', url: 'https://palmerstowncs-my.sharepoint.com/:p:/g/personal/anthony_notaro_palmerstowncs_ie/EVE-3tnh5LhIhDwkRsgoNc4B-euRP31_rCsNm4WZzpXRMg?e=JisGOD' },
                        { title: 'Trigonometry', url: 'https://palmerstowncs-my.sharepoint.com/:p:/g/personal/anthony_notaro_palmerstowncs_ie/ERt6YHrKvvtMkIrFu8mQjXUBYnD3aZoMcSAUVxEmwixKRA?e=IH0z4J' }
                    ]
                };

                // Clear and build strands dynamically
                const container = document.getElementById('learningPathsContainer');
                container.innerHTML = '';

                // Sort strands: Junior Cycle first, Senior Cycle last
                const sortedStrands = Object.entries(strands).sort((a, b) => {
                    const aIsSenior = a[0].toLowerCase().includes('senior');
                    const bIsSenior = b[0].toLowerCase().includes('senior');
                    if (aIsSenior && !bIsSenior) return 1;  // a goes after b
                    if (!aIsSenior && bIsSenior) return -1; // a goes before b
                    return 0; // keep original order
                });

                // Iterate through strands in sorted order
                sortedStrands.forEach(([strandName, strandTopics], strandIndex) => {
                    const info = strandInfo[strandName] || {
                        icon: 'ðŸ“š',
                        color: '#667eea',
                        description: 'Learn and master these topics'
                    };
                    
                    const isSeniorCycle = strandName.toLowerCase().includes('senior');

                    // Create strand card
                    const strandCard = document.createElement('div');
                    strandCard.className = 'learning-path-card';
                    strandCard.style.borderTop = `4px solid ${info.color}`;

                    // Strand header
                    const header = document.createElement('div');
                    header.className = 'path-header';
                    header.innerHTML = `
                        <div class="path-number" style="background: ${info.color}">${isSeniorCycle ? 'Senior Cycle' : 'Junior Cycle'}</div>
                        <h3 class="path-title">${info.icon} ${strandName}</h3>
                        <p class="path-description">${info.description}</p>
                    `;
                    strandCard.appendChild(header);

                    // Topics flow container
                    const flow = document.createElement('div');
                    flow.className = 'path-flow';

                    strandTopics.forEach((topicKey, index) => {
                        if (topics[topicKey]) {
                            const topic = topics[topicKey];
                            const iconClass = iconMap[topic.icon] || 'fa-book';
                            const topicMastered = masteryData[topicKey]?.topic_mastered || false;
                            
                            // Count mastered difficulties
                            const difficulties = masteryData[topicKey]?.difficulties || {};
                            const beginnerMastered = difficulties.beginner?.mastered || false;
                            const intermediateMastered = difficulties.intermediate?.mastered || false;
                            const advancedMastered = difficulties.advanced?.mastered || false;
                            const masteredCount = [beginnerMastered, intermediateMastered, advancedMastered].filter(Boolean).length;

                            const card = document.createElement('div');
                            card.className = `flow-topic-card ${topicMastered ? 'mastered' : ''}`;
                            card.onclick = () => selectTopic(topicKey, topic.title);

                            // Progress dots showing difficulty completion
                            const progressDots = `
                                <div class="difficulty-progress">
                                    <span class="dot ${beginnerMastered ? 'completed' : ''}" title="Beginner"></span>
                                    <span class="dot ${intermediateMastered ? 'completed' : ''}" title="Intermediate"></span>
                                    <span class="dot ${advancedMastered ? 'completed' : ''}" title="Advanced"></span>
                                </div>
                            `;

                            card.innerHTML = `
                                ${topicMastered ? '<div class="mastery-badge">ðŸ†</div>' : ''}
                                <i class="fas ${iconClass} icon" style="color: ${info.color}"></i>
                                <div class="title">${topic.title}</div>
                                ${masteredCount > 0 ? progressDots : ''}
                            `;

                            flow.appendChild(card);

                            // Add arrow between topics (except after last one)
                            if (index < strandTopics.length - 1) {
                                const arrow = document.createElement('div');
                                arrow.className = 'flow-arrow';
                                arrow.innerHTML = 'â†’';
                                flow.appendChild(arrow);
                            }
                        }
                    });

                    strandCard.appendChild(flow);
                    
                    // Add Revision Slides section if available for this strand
                    const strandRevision = revisionSlides[strandName];
                    if (strandRevision && strandRevision.length > 0 && !isSeniorCycle) {
                        // Divider
                        const divider = document.createElement('div');
                        divider.className = 'revision-divider';
                        divider.innerHTML = `
                            <div style="border-top: 2px dashed #d1d5db; margin: 20px 0 15px 0;"></div>
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                                <span style="font-size: 1.25rem;">ðŸ“–</span>
                                <span style="font-weight: 600; color: #374151;">Revision Slides (Thanks to Mr Notaro) - Click to view in a separate window</span>
                            </div>
                        `;
                        strandCard.appendChild(divider);
                        
                        // Revision buttons container
                        const revisionContainer = document.createElement('div');
                        revisionContainer.style.cssText = 'display: flex; flex-wrap: wrap; gap: 10px; padding: 0 10px 10px 10px;';
                        
                        let buttonsHtml = '';
                        strandRevision.forEach((slide, index) => {
                            const escapedUrl = slide.url.replace(/'/g, "\\'");
                            buttonsHtml += `
                                <button type="button" 
                                    onclick="event.stopPropagation(); window.open('${escapedUrl}', '_blank'); return false;"
                                    style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 1px solid #86efac; border-radius: 8px; color: #166534; font-size: 0.85rem; font-weight: 500; cursor: pointer; position: relative; z-index: 1000;"
                                    onmouseover="this.style.background='linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';"
                                    onmouseout="this.style.background='linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%)'; this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                    <i class="fas fa-external-link-alt" style="font-size: 0.75rem;"></i> ${slide.title}
                                </button>
                            `;
                        });
                        revisionContainer.innerHTML = buttonsHtml;
                        
                        strandCard.appendChild(revisionContainer);
                    }
                    
                    container.appendChild(strandCard);
                });

                // Show verification in console
                console.log('âœ… Student dashboard loaded successfully');

                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('topicScreen').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading topics:', error);
            }
        }

        // Helper function to get consistent icon colors
        function getIconColor(topicKey) {
            const colors = {
                'arithmetic': '#ef4444',
                'multiplication_division': '#3b82f6',
                'number_systems': '#06b6d4',
                'bodmas': '#10b981',
                'fractions': '#f59e0b',
                'decimals': '#14b8a6',
                'probability': '#eab308',
                'descriptive_statistics': '#06b6d4',
                'patterns': '#8b5cf6',
                'sets': '#f97316',
                'functions': '#8b5cf6',
                'surds': '#a855f7',
                'complex_numbers_intro': '#ec4899',
                'complex_numbers_expanded': '#d946ef'
            };
            return colors[topicKey] || '#6b7280';
        }

        async function loadProgress() {
            try {
                const response = await fetch('/api/my-progress');
                const attempts = await response.json();

                const summary = document.getElementById('progressSummary');
                if (attempts.length === 0) {
                    summary.innerHTML = '<p>No quizzes completed yet. Start learning!</p>';
                } else {
                    const total = attempts.length;
                    const avgScore = (attempts.reduce((sum, a) => sum + a.percentage, 0) / total).toFixed(1);

                    summary.innerHTML = `
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div>
                                <div class="text-3xl font-bold text-purple-600">${total}</div>
                                <div class="text-sm">Quizzes Completed</div>
                            </div>
                            <div>
                                <div class="text-3xl font-bold text-green-600">${avgScore}%</div>
                                <div class="text-sm">Average Score</div>
                            </div>
                            <div>
                                <div class="text-3xl font-bold text-blue-600">${attempts[0].topic}</div>
                                <div class="text-sm">Last Topic</div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading progress:', error);
            }
        }

        async function loadBadgeWidget() {
            try {
                console.log('ðŸ”„ Loading badge widget...');
                
                // Fetch badge and stats data in parallel
                const [badgesResponse, statsResponse] = await Promise.all([
                    fetch('/api/student/badges'),
                    fetch('/api/student/stats')
                ]);

                console.log('ðŸ“Š Badge response status:', badgesResponse.status);
                console.log('ðŸ“Š Stats response status:', statsResponse.status);

                const badgesData = await badgesResponse.json();
                const statsData = await statsResponse.json();

                console.log('ðŸŽ¯ Badges data received:', badgesData);
                console.log('ðŸ“ˆ Stats data received:', statsData);
                console.log('ðŸ’° Total points from API:', badgesData.total_points);
                console.log('ðŸ† Level from API:', badgesData.level);
                console.log('ðŸŽ–ï¸ Quizzes from API:', statsData.stats.total_quizzes);

                // Update widget values
                document.getElementById('stat-level').textContent = badgesData.level;
                document.getElementById('stat-points').textContent = badgesData.total_points;
                document.getElementById('stat-badges').textContent = badgesData.earned.length + '/' + (badgesData.earned.length + badgesData.available.length);
                document.getElementById('stat-quizzes').textContent = statsData.stats.total_quizzes;
                document.getElementById('stat-streak').textContent = statsData.stats.current_streak_days;
                document.getElementById('stat-accuracy').textContent = statsData.stats.overall_accuracy + '%';
                
                // Show next streak milestone if available
                const streakInfo = statsData.stats.streak_info;
                const streakMilestoneEl = document.getElementById('streak-next-milestone');
                if (streakInfo && streakInfo.days_until_next && streakMilestoneEl) {
                    streakMilestoneEl.textContent = `${streakInfo.days_until_next} more for +${streakInfo.next_milestone_points}pts`;
                    streakMilestoneEl.style.display = 'block';
                }
                
                // Add streak fire animation if streak > 0
                const streakBox = document.getElementById('streak-box');
                if (statsData.stats.current_streak_days >= 3 && streakBox) {
                    streakBox.style.background = 'linear-gradient(135deg, #ff6b35, #ff8c42)';
                    streakBox.style.color = 'white';
                }

                console.log('âœ… Badge widget updated successfully');
                console.log('   - Points displayed:', document.getElementById('stat-points').textContent);
                console.log('   - Level displayed:', document.getElementById('stat-level').textContent);
                console.log('   - Quizzes displayed:', document.getElementById('stat-quizzes').textContent);

                // Show recent badges if any
                if (badgesData.earned.length > 0) {
                    const recentBadges = badgesData.earned.slice(-3).reverse(); // Last 3 badges
                    const recentBadgesHtml = recentBadges.map(badge => {
                        const emoji = getBadgeEmoji(badge.icon);
                        return `<span class="recent-badge-mini">${emoji} ${badge.name}</span>`;
                    }).join('');

                    document.getElementById('recent-badges').innerHTML = recentBadgesHtml;
                    document.getElementById('recent-badges-container').style.display = 'block';
                }

                // Show the widget
                document.getElementById('badge-widget').style.display = 'block';

            } catch (error) {
                console.error('âŒ Error loading badge widget:', error);
                console.error('Error details:', error.message, error.stack);
                // Hide widget if there's an error
                document.getElementById('badge-widget').style.display = 'none';
            }
        }

        function getBadgeEmoji(iconClass) {
            const iconMap = {
                'fa-star': 'â­', 'fa-book': 'ðŸ“š', 'fa-graduation-cap': 'ðŸŽ“',
                'fa-heart': 'â¤ï¸', 'fa-trophy': 'ðŸ†', 'fa-bullseye': 'ðŸŽ¯',
                'fa-crown': 'ðŸ‘‘', 'fa-medal': 'ðŸ¥ˆ', 'fa-gem': 'ðŸ’Ž',
                'fa-fire': 'ðŸ”¥', 'fa-bolt': 'âš¡', 'fa-rocket': 'ðŸš€',
                'fa-certificate': 'ðŸ“œ', 'fa-brain': 'ðŸ§ ', 'fa-infinity': 'â™¾ï¸'
            };
            return iconMap[iconClass] || 'ðŸ…';
        }

        function selectTopic(topic, title) {
            currentTopic = topic;
            document.getElementById('selectedTopicTitle').textContent = title;

            // Generate difficulty/section buttons based on topic
            const container = document.getElementById('difficultyButtonsContainer');
            container.innerHTML = '';

            // All topics now use standard 3 difficulty levels
            const difficulties = [
                {level: 'beginner', title: 'Beginner', icon: 'fa-seedling', color: 'bg-green-500', desc: 'Start with the basics'},
                {level: 'intermediate', title: 'Intermediate', icon: 'fa-chart-line', color: 'bg-yellow-500', desc: 'Challenge yourself more'},
                {level: 'advanced', title: 'Advanced', icon: 'fa-trophy', color: 'bg-red-500', desc: 'Master the topic'}
            ];

            // Use 3-column grid for standard difficulties
            container.className = 'grid md:grid-cols-3 gap-6';

            difficulties.forEach(diff => {
                const button = document.createElement('button');
                button.onclick = () => startQuiz(diff.level);

                // Check if this difficulty is mastered (>80%)
                const difficultyData = masteryData[topic]?.difficulties?.[diff.level];
                const isMastered = difficultyData?.mastered || false;
                const bestScore = difficultyData?.best_score || 0;

                // Add mastered class for dimmed styling
                button.className = `difficulty-button ${diff.color} hover:opacity-90 text-white rounded-2xl p-8 shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all ${isMastered ? 'mastered' : ''}`;

                // Add trophy badge if mastered
                const masteryBadge = isMastered ? `
                    <div class="difficulty-mastery" title="Mastered with ${bestScore}%!">
                        <div class="trophy">ðŸ†</div>
                        <div class="score">${bestScore}%</div>
                    </div>
                ` : '';

                // Show best score if attempted but not mastered
                const scoreDisplay = (bestScore > 0 && !isMastered) ?
                    `<div class="best-score-display">Best: ${bestScore}%</div>` : '';

                button.innerHTML = `
                    ${masteryBadge}
                    <i class="fas ${diff.icon} text-6xl mb-4"></i>
                    <h3 class="text-2xl font-bold mb-2">${diff.title}</h3>
                    <p class="text-white text-opacity-90">${diff.desc}</p>
                    <p class="mt-2 text-sm">25 questions</p>
                    ${scoreDisplay}
                `;
                container.appendChild(button);
            });

            document.getElementById('topicScreen').classList.add('hidden');
            document.getElementById('difficultyScreen').classList.remove('hidden');
        }

        async function startQuiz(difficulty) {
            currentDifficulty = difficulty;
            currentQuestionIndex = 0;
            score = 0;
            answered = false;
            startTime = Date.now();

            // Reset milestone tracking for new quiz
            consecutiveCorrect = 0;
            maxConsecutiveCorrect = 0;
            questionsAnsweredInQuiz = 0;
            shownMilestones.clear();
            totalMilestonePoints = 0;  // Reset milestone points
            
            // Reset streak tracking
            currentStreak = 0;
            hintUsedThisQuestion = false;
            
            // Reset hot streak display
            updateHotStreakDisplay(0);
            
            console.log('âœ… Milestone and streak tracking reset for new quiz');
            
            // AVATAR: Store points before quiz for unlock detection (if function exists)
            if (typeof getPointsBeforeQuiz === 'function') {
                getPointsBeforeQuiz(); // Don't await - let it run in background
            }

            document.getElementById('difficultyScreen').classList.add('hidden');
            document.getElementById('loadingScreen').classList.remove('hidden');

            try {
                const response = await fetch(`/api/questions/${currentTopic}/${difficulty}`);
                questions = await response.json();

                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('quizScreen').classList.remove('hidden');
                
                // ===== ACTIVATE COMPACT QUIZ MODE =====
                document.body.classList.add('quiz-active');
                
                // Update compact header
                const topicDisplay = currentTopic.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                document.getElementById('compactTopicTitle').textContent = topicDisplay;
                document.getElementById('compactQuestionBadge').textContent = `Q1/${questions.length}`;
                document.getElementById('compactScoreBadge').textContent = `Score: 0/${questions.length}`;
                document.getElementById('compactProgressBar').style.width = '0%';

                // Initialize calculator for quiz
                if (typeof initCalculator === 'function') {
                    initCalculator();
                }

                document.getElementById('quizTopicTitle').textContent = currentTopic.charAt(0).toUpperCase() + currentTopic.slice(1);
                document.getElementById('total').textContent = questions.length;
                document.getElementById('totalQuestions').textContent = questions.length;
                
                // Render avatar in quiz header (compact)
                const quizHeaderAvatar = document.getElementById('quiz-header-avatar');
                if (quizHeaderAvatar && typeof AvatarRenderer !== 'undefined' && window.currentAvatarConfig) {
                    AvatarRenderer.render(quizHeaderAvatar, window.currentAvatarConfig, 'small');
                }

                // Initialize tutorial system for ALL topics (shows splash screen on first visit, help button on subsequent)
                const tutorialTopics = [
                    'introductory_algebra', 'solving_equations', 'simplifying_expressions',
                    'expanding_factorising', 'functions', 'patterns', 'arithmetic',
                    'bodmas', 'fractions', 'decimals', 'multiplication_division',
                    'number_systems', 'surds', 'complex_numbers_intro', 'complex_numbers_expanded',
                    'descriptive_statistics', 'probability', 'sets'
                ];
                
                if (tutorialTopics.includes(currentTopic)) {
                    initTutorial(currentTopic, difficulty);
                }

                showQuestion();
                
                // WHO AM I: Enable for ALL topics (backend will check if images exist)
                whoAmIEnabled = true;  // Changed from checking specific topic
                if (whoAmIEnabled && typeof initializeWhoAmI === 'function') {
                    // Show the container
                    const container = document.getElementById('who-am-i-container');
                    if (container) {
                        container.style.display = 'block';
                        
                        // Create quiz attempt and initialize
                        fetch('/api/create-quiz-attempt', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                topic: currentTopic,
                                difficulty: currentDifficulty
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.quiz_attempt_id) {
                                currentQuizAttemptId = data.quiz_attempt_id;
                                initializeWhoAmI(currentTopic, currentDifficulty, currentQuizAttemptId);
                                console.log('âœ… Who Am I initialized for quiz attempt:', currentQuizAttemptId);
                            }
                        })
                        .catch(error => console.error('Error creating quiz attempt:', error));
                    }
                } else {
                    // Hide container for non-Who Am I topics
                    const container = document.getElementById('who-am-i-container');
                    if (container) {
                        container.style.display = 'none';
                    }
                }
                
            } catch (error) {
                console.error('Error loading questions:', error);
                alert('Error loading questions. Please try again.');
                backToDifficulty();
            }
        }

        // Streak tracking for bonus points (currentStreak defined in Day 1 features above)
        // let currentStreak = 0;  // REMOVED - duplicate declaration
        let hintUsedThisQuestion = false;
        let currentHintPenalty = 50;

        function showQuestion() {
            const question = questions[currentQuestionIndex];
            answered = false;
            hintUsedThisQuestion = false;
            
            // ===== AUTO-SCROLL TO TOP =====
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // ===== UPDATE COMPACT HEADER =====
            document.getElementById('compactQuestionBadge').textContent = `Q${currentQuestionIndex + 1}/${questions.length}`;
            document.getElementById('compactScoreBadge').textContent = `Score: ${score}/${questions.length}`;
            const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
            document.getElementById('compactProgressBar').style.width = progress + '%';
            
            // Update streak badge in header (use new hot streak display)
            const streakBadge = document.getElementById('compactStreakBadge');
            if (streakBadge) {
                if (currentStreak >= 3) {
                    const multiplier = getStreakMultiplier();
                    streakBadge.innerHTML = `ðŸ”¥ ${multiplier}x`;
                    streakBadge.classList.add('visible');
                } else {
                    streakBadge.classList.remove('visible');
                }
            }
            // Also update the new hot streak display
            if (typeof updateHotStreakDisplay === 'function') {
                updateHotStreakDisplay(currentStreak);
            }

            document.getElementById('questionText').innerHTML = question.question;
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            document.getElementById('score').textContent = score;

            document.getElementById('progressBar').style.width = progress + '%';

            // Handle question image
            const imageContainer = document.getElementById('questionImageContainer');
            const imageEl = document.getElementById('questionImage');
            const captionEl = document.getElementById('questionImageCaption');
            
            if (question.image_url) {
                imageEl.src = question.image_url;
                imageContainer.classList.remove('hidden');
                if (question.image_caption) {
                    captionEl.textContent = question.image_caption;
                    captionEl.classList.remove('hidden');
                } else {
                    captionEl.classList.add('hidden');
                }
            } else {
                imageContainer.classList.add('hidden');
            }

            // Handle hint - update compact header hint button
            const hintContainer = document.getElementById('hintContainer');
            const hintTextEl = document.getElementById('hintText');
            const compactHintBtn = document.getElementById('compactHintBtn');
            
            if (question.hint_text) {
                hintContainer.classList.remove('hidden');
                hintTextEl.classList.add('hidden');
                currentHintPenalty = question.hint_penalty || 50;
                document.getElementById('hintContent').textContent = question.hint_text;
                // Show hint button in compact header
                if (compactHintBtn) {
                    compactHintBtn.style.display = 'flex';
                    compactHintBtn.classList.remove('hint-used');
                    compactHintBtn.title = `Show Hint (-${currentHintPenalty}% points)`;
                }
            } else {
                hintContainer.classList.add('hidden');
                // Hide hint button in compact header
                if (compactHintBtn) {
                    compactHintBtn.style.display = 'none';
                }
            }

            // Update streak display (for compatibility)
            updateStreakDisplay();

            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';

            // Add number line ONLY for arithmetic questions (addition/subtraction)
            // Do NOT show number line for complex numbers or other topics
            if (currentTopic === 'arithmetic') {
                const numberLineHtml = generateBlankNumberLine(question.question);
                if (numberLineHtml) {
                    const numberLineDiv = document.createElement('div');
                    numberLineDiv.innerHTML = numberLineHtml;
                    optionsContainer.appendChild(numberLineDiv);
                }
            }

            // Add answer options
            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'w-full p-4 rounded-xl text-left text-lg font-medium transition-all bg-gray-50 hover:bg-purple-50 border-2 border-gray-200 hover:border-purple-300 text-gray-800';
                button.textContent = option;
                button.onclick = () => handleAnswer(index);
                optionsContainer.appendChild(button);
            });

            // Add flag button
            const flagButton = document.createElement('button');
            flagButton.className = 'w-full mt-4 p-3 rounded-lg text-center text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-700 transition-all';
            flagButton.innerHTML = '<i class="fas fa-flag mr-2"></i>Report an issue with this question';
            flagButton.onclick = () => showFlagQuestionModal(question.id);
            optionsContainer.appendChild(flagButton);

            // ===== HIDE FEEDBACK ROW =====
            document.getElementById('feedbackNextRow').classList.add('hidden');
            document.getElementById('explanationSection').classList.add('hidden');
            document.getElementById('feedbackContainer').classList.add('hidden');
            document.getElementById('nextButton').classList.add('hidden');
        }

        // ==================== HINT SYSTEM ====================
        function showHint() {
            if (hintUsedThisQuestion) return;
            hintUsedThisQuestion = true;
            
            document.getElementById('hintText').classList.remove('hidden');
            
            // Update compact header hint button
            const compactHintBtn = document.getElementById('compactHintBtn');
            if (compactHintBtn) {
                compactHintBtn.classList.add('hint-used');
                compactHintBtn.title = 'Hint shown';
            }
        }

        // ==================== STREAK DISPLAY ====================
        function updateStreakDisplay() {
            const streakDisplay = document.getElementById('streakDisplay');
            const streakEmoji = document.getElementById('streakEmoji');
            const streakText = document.getElementById('streakText');
            const streakMultiplier = document.getElementById('streakMultiplier');
            
            if (currentStreak >= 3) {
                streakDisplay.classList.remove('hidden');
                
                // Set emoji based on streak length
                if (currentStreak >= 10) {
                    streakEmoji.textContent = 'ðŸŒŸ';
                } else if (currentStreak >= 7) {
                    streakEmoji.textContent = 'ðŸ’¥';
                } else if (currentStreak >= 5) {
                    streakEmoji.textContent = 'ðŸ”¥ðŸ”¥';
                } else {
                    streakEmoji.textContent = 'ðŸ”¥';
                }
                
                streakText.textContent = `${currentStreak} in a row!`;
                
                // Calculate and display multiplier
                const multiplier = getStreakMultiplier();
                streakMultiplier.textContent = `${multiplier}x`;
            } else {
                streakDisplay.classList.add('hidden');
            }
        }

        function getStreakMultiplier() {
            if (currentStreak >= 10) return 2.5;
            if (currentStreak >= 7) return 2.0;
            if (currentStreak >= 5) return 1.75;
            if (currentStreak >= 3) return 1.5;
            return 1.0;
        }

        function calculateQuestionPoints(isCorrect) {
            if (!isCorrect) return 0;
            
            let basePoints = 10; // Base points per correct answer
            
            // Apply hint penalty
            if (hintUsedThisQuestion) {
                basePoints = Math.floor(basePoints * (1 - currentHintPenalty / 100));
            }
            
            // Apply streak multiplier
            const multiplier = getStreakMultiplier();
            const totalPoints = Math.floor(basePoints * multiplier);
            
            return totalPoints;
        }

        function handleAnswer(selectedIndex) {
            if (answered) return;
            answered = true;

            const question = questions[currentQuestionIndex];
            const correct = selectedIndex === question.correct;

            // Track answer for milestone detection
            questionsAnsweredInQuiz++;
            
            // Update streak tracking
            if (correct) {
                currentStreak++;
                consecutiveCorrect++;
                maxConsecutiveCorrect = Math.max(maxConsecutiveCorrect, consecutiveCorrect);
                console.log(`âœ… Correct! Streak: ${currentStreak}, Multiplier: ${getStreakMultiplier()}x`);
                
                // Play correct sound
                playSound('correct');
                
                // Update hot streak display
                updateHotStreakDisplay(currentStreak);
                
                // Check for "10 in a Row" milestone
                if (consecutiveCorrect === 10 && !shownMilestones.has('ten_streak')) {
                    shownMilestones.add('ten_streak');
                    setTimeout(() => {
                        showAchievementPopup({
                            icon: 'ðŸ”¥',
                            title: '10 in a Row!',
                            description: "Incredible! You've answered 10 questions correctly in a row!",
                            points: 50
                        });
                    }, 800);
                }
            } else {
                currentStreak = 0; // Reset streak on wrong answer
                consecutiveCorrect = 0;
                console.log(`âŒ Incorrect. Streak reset.`);
                
                // Play incorrect sound
                playSound('incorrect');
                
                // Update hot streak display
                updateHotStreakDisplay(0);
            }

            // Check for "20 Questions Completed" milestone
            if (questionsAnsweredInQuiz === 20 && !shownMilestones.has('twenty_questions')) {
                shownMilestones.add('twenty_questions');
                setTimeout(() => {
                    showAchievementPopup({
                        icon: 'ðŸŽ¯',
                        title: '20 Questions!',
                        description: "You've answered 20 questions! Keep up the excellent work!",
                        points: 30
                    });
                }, 800);
            }

            if (correct) {
                score++;
                document.getElementById('score').textContent = score;
                
                // WHO AM I: Reveal tile on correct answer
                if (whoAmIEnabled && typeof onCorrectAnswer === 'function') {
                    onCorrectAnswer();
                }
            }

            const allChildren = document.getElementById('optionsContainer').children;

            // CRITICAL FIX: Find the offset by checking if first child is number line
            // Number line div doesn't have onclick, buttons do
            let buttonOffset = 0;
            if (allChildren.length > 0 && !allChildren[0].onclick) {
                buttonOffset = 1; // First child is number line, so buttons start at index 1
            }

            // Calculate where option buttons end (before flag button)
            // There are always 4 option buttons, plus potentially 1 number line at start
            const optionButtonCount = 4;
            const optionButtonsEnd = buttonOffset + optionButtonCount;

            // Now loop through actual option buttons only (NOT the flag button at the end)
            for (let i = buttonOffset; i < optionButtonsEnd; i++) {
                const button = allChildren[i];
                const optionIndex = i - buttonOffset; // Convert container index to option index

                button.disabled = true;

                if (optionIndex === question.correct) {
                    button.className = 'w-full p-4 rounded-xl text-left text-lg font-medium bg-green-100 border-2 border-green-500 text-green-800';
                    button.innerHTML += ' <i class="fas fa-check float-right text-green-600"></i>';
                } else if (optionIndex === selectedIndex && !correct) {
                    button.className = 'w-full p-4 rounded-xl text-left text-lg font-medium bg-red-100 border-2 border-red-500 text-red-800';
                    button.innerHTML += ' <i class="fas fa-times float-right text-red-600"></i>';
                } else if (button.onclick) { // Only style actual option buttons
                    button.className = 'w-full p-4 rounded-xl text-left text-lg font-medium bg-gray-100 text-gray-600';
                }
            }

            // Keep the flag button enabled and clickable (it's the last child)
            // No need to disable it - students should be able to report issues after seeing the answer

            // Generate solution number line for arithmetic questions
            let solutionNumberLine = '';
            if (currentTopic === 'arithmetic') {
                solutionNumberLine = generateSolutionNumberLine(question.question) || '';
            }

            // Calculate bonus text for streak
            let streakBonus = '';
            if (correct && currentStreak >= 3) {
                const multiplier = getStreakMultiplier();
                streakBonus = `ðŸ”¥ ${multiplier}x streak!`;
            }
            
            // Show hint penalty if used
            let hintPenalty = '';
            if (correct && hintUsedThisQuestion) {
                hintPenalty = `ðŸ’¡ -${currentHintPenalty}%`;
            }

            // ===== SHOW INLINE FEEDBACK ROW =====
            const feedbackRow = document.getElementById('feedbackNextRow');
            const feedbackInline = document.getElementById('feedbackInline');
            const feedbackIcon = feedbackInline.querySelector('.feedback-icon');
            const feedbackText = document.getElementById('feedbackText');
            const feedbackStreak = document.getElementById('feedbackStreak');
            
            // Update inline feedback
            if (correct) {
                feedbackInline.className = 'feedback-inline correct';
                feedbackIcon.textContent = 'âœ…';
                feedbackText.className = 'feedback-text correct';
                feedbackText.textContent = 'Correct!';
            } else {
                feedbackInline.className = 'feedback-inline incorrect';
                feedbackIcon.textContent = 'ðŸ“–';
                feedbackText.className = 'feedback-text incorrect';
                feedbackText.textContent = 'Let\'s learn!';
            }
            
            // Show streak/hint info
            let bonusInfo = [streakBonus, hintPenalty].filter(x => x).join(' ');
            feedbackStreak.textContent = bonusInfo;
            
            feedbackRow.classList.remove('hidden');
            
            // ===== SHOW EXPLANATION SECTION =====
            const explanationSection = document.getElementById('explanationSection');
            const explanationContent = document.getElementById('explanationContent');
            
            if (question.explanation || solutionNumberLine) {
                explanationContent.innerHTML = `
                    <p>${question.explanation || ''}</p>
                    ${solutionNumberLine}
                `;
                explanationSection.classList.remove('hidden');
                // Auto-expand if incorrect
                if (!correct) {
                    explanationContent.classList.remove('hidden');
                    document.getElementById('explanationArrow').classList.add('fa-chevron-up');
                    document.getElementById('explanationArrow').classList.remove('fa-chevron-down');
                } else {
                    explanationContent.classList.add('hidden');
                    document.getElementById('explanationArrow').classList.remove('fa-chevron-up');
                    document.getElementById('explanationArrow').classList.add('fa-chevron-down');
                }
            } else {
                explanationSection.classList.add('hidden');
            }
            
            // Update compact header with new score
            document.getElementById('compactScoreBadge').textContent = `Score: ${score}/${questions.length}`;
            
            // Update streak badge (with null check for new UI)
            const streakBadge = document.getElementById('compactStreakBadge');
            if (streakBadge) {
                if (currentStreak >= 3) {
                    const multiplier = getStreakMultiplier();
                    streakBadge.innerHTML = `ðŸ”¥ ${multiplier}x`;
                    streakBadge.classList.add('visible');
                } else {
                    streakBadge.classList.remove('visible');
                }
            }

            // Legacy feedback (hidden but kept for compatibility)
            const feedback = document.getElementById('feedbackContainer');
            feedback.innerHTML = '';
            document.getElementById('nextButton').classList.add('hidden');
        }
        
        // Toggle explanation visibility
        function toggleExplanation() {
            const content = document.getElementById('explanationContent');
            const arrow = document.getElementById('explanationArrow');
            content.classList.toggle('hidden');
            arrow.classList.toggle('fa-chevron-down');
            arrow.classList.toggle('fa-chevron-up');
        }

        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < questions.length) {
                showQuestion();
            } else {
                submitAndShowResults();
            }
        }

        function showGuestResultModal(score, total, percentage) {
            const performanceMessages = {
                100: { emoji: 'ðŸ†', title: 'Perfect Score!', message: 'Outstanding! You got every question right!' },
                90: { emoji: 'â­', title: 'Excellent Work!', message: 'You scored 90% or higher - fantastic!' },
                70: { emoji: 'ðŸ‘', title: 'Good Job!', message: 'You\'re doing well! Keep practicing!' },
                50: { emoji: 'ðŸ’ª', title: 'Keep Trying!', message: 'You\'re learning! Practice makes perfect!' },
                0: { emoji: 'ðŸ“š', title: 'Room to Grow', message: 'Don\'t give up! Every expert was once a beginner.' }
            };

            const messageKey = Object.keys(performanceMessages)
                .map(Number)
                .reverse()
                .find(threshold => percentage >= threshold) || 0;
            
            const performance = performanceMessages[messageKey];

            const modal = document.createElement('div');
            modal.className = 'guest-result-overlay';
            modal.innerHTML = `
                <div class="guest-result-modal">
                    <div style="text-align: center;">
                        <div style="font-size: 64px; margin-bottom: 16px;">${performance.emoji}</div>
                        <h2>${performance.title}</h2>
                        <div class="score-display">${percentage}%</div>
                        <div class="message">${performance.message}</div>
                        <div class="message">You got <strong>${score} out of ${total}</strong> questions correct!</div>
                    </div>

                    <div class="benefits">
                        <h3>ðŸŒŸ Create a free account to:</h3>
                        <ul>
                            <li>Save your quiz scores and progress</li>
                            <li>Earn badges and achievements</li>
                            <li>Track your learning journey</li>
                            <li>Compete on leaderboards</li>
                            <li>Get detailed performance analytics</li>
                        </ul>
                    </div>

                    <div class="button-group">
                        <a href="/register" class="primary-btn">Create Free Account</a>
                        <button onclick="closeGuestModal()" class="secondary-btn">Continue as Guest</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            
            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeGuestModal();
                }
            });
        }

        function closeGuestModal() {
            const modal = document.querySelector('.guest-result-overlay');
            if (modal) {
                modal.remove();
            }
            backToTopics();
        }

        async function submitAndShowResults() {
            const percentage = Math.round((score / questions.length) * 100);
            const timeTaken = Math.floor((Date.now() - startTime) / 1000);

            // Check for quiz completion milestones (FOR ALL USERS including guests)
            const milestones = [];

            // Perfect Score
            if (percentage === 100 && !shownMilestones.has('perfect_score')) {
                milestones.push({
                    icon: 'ðŸ’¯',
                    title: 'Perfect Score!',
                    description: 'Flawless! You got every single question correct!',
                    points: 100
                });
                shownMilestones.add('perfect_score');
            }

            // First Quiz (always show for first quiz of session)
            if (!shownMilestones.has('first_quiz')) {
                milestones.push({
                    icon: 'ðŸŒŸ',
                    title: 'First Quiz Complete!',
                    description: 'Congratulations on completing your first quiz!',
                    points: 25
                });
                shownMilestones.add('first_quiz');
            }

            // Quick Learner (under 5 minutes with 80%+)
            const timeInMinutes = timeTaken / 60;
            if (timeInMinutes < 5 && percentage >= 80 && !shownMilestones.has('quick_learner')) {
                milestones.push({
                    icon: 'âš¡',
                    title: 'Quick Learner!',
                    description: 'Amazing! You completed this quiz in under 5 minutes with a great score!',
                    points: 40
                });
                shownMilestones.add('quick_learner');
            }

            // Show milestones if any were earned (with delays between multiple milestones)
            if (milestones.length > 0) {
                console.log('ðŸŽ‰ Quiz completion milestones earned:', milestones);
                for (let i = 0; i < milestones.length; i++) {
                    setTimeout(() => {
                        showAchievementPopup(milestones[i]);
                    }, i * 2500); // Show each milestone 2.5 seconds apart
                }
            }

            // WHO AM I: Get bonus points if enabled
            let whoAmIBonus = 0;
            if (whoAmIEnabled && typeof getWhoAmIBonusPoints === 'function') {
                whoAmIBonus = getWhoAmIBonusPoints();
                console.log('ðŸŽ¯ Who Am I bonus points to submit:', whoAmIBonus);
            }

            // Submit to backend
            try {
                console.log('ðŸ“¤ Submitting quiz with data:', {
                    topic: currentTopic,
                    difficulty: currentDifficulty,
                    score: score,
                    total_questions: questions.length,
                    percentage: percentage,
                    time_taken: timeTaken,
                    quiz_attempt_id: currentQuizAttemptId,
                    who_am_i_bonus: whoAmIBonus,
                    milestone_points: totalMilestonePoints  // Include milestone points!
                });
                
                const response = await fetch('/api/submit-quiz', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        topic: currentTopic,
                        difficulty: currentDifficulty,
                        score: score,
                        total_questions: questions.length,
                        percentage: percentage,
                        time_taken: timeTaken,
                        quiz_attempt_id: currentQuizAttemptId,
                        who_am_i_bonus: whoAmIBonus,
                        milestone_points: totalMilestonePoints  // Include milestone points!
                    })
                });

                console.log('ðŸ“¥ Submit quiz response status:', response.status);
                const result = await response.json();
                console.log('ðŸ“¥ Submit quiz result:', result);
                
                // Check if user is a guest
                if (result.is_guest || result.prompt_register) {
                    console.log('âš ï¸ User is guest - showing guest modal');
                    // Show guest modal with registration prompt
                    showGuestResultModal(score, questions.length, percentage);
                    return;
                }
                
                console.log('âœ… Quiz submitted for registered user');
                
                // âœ¨ NEW: Show milestone celebration if badges were earned
                if (result.newly_earned_badges && result.newly_earned_badges.length > 0) {
                    console.log('ðŸŽ‰ Badges earned:', result.newly_earned_badges);
                    // Show milestone modal BEFORE results screen
                    showMilestoneModal(result.newly_earned_badges);
                    
                    // Wait a moment for user to see the celebration
                    // The user will click "Continue" to proceed
                } else {
                    console.log('No new badges earned this time');
                }
                
                // Regular user - reload progress and show results
                await loadProgress();
                await loadBadgeWidget();
                
            } catch (error) {
                console.error('Error submitting quiz:', error);
            }

            showResults(percentage);
        }

        function showResults(percentage) {
            // ===== DEACTIVATE QUIZ MODE =====
            document.body.classList.remove('quiz-active');
            
            document.getElementById('quizScreen').classList.add('hidden');
            document.getElementById('resultsScreen').classList.remove('hidden');

            document.getElementById('percentage').textContent = percentage + '%';
            document.getElementById('scoreText').textContent = `You scored ${score} out of ${questions.length}`;

            const messageEl = document.getElementById('performanceMessage');
            if (percentage === 100) {
                messageEl.className = 'text-xl text-green-600 font-semibold mb-6';
                messageEl.textContent = 'ðŸŒŸ Perfect score! Amazing work!';
            } else if (percentage >= 80) {
                messageEl.className = 'text-xl text-blue-600 font-semibold mb-6';
                messageEl.textContent = 'ðŸŽ‰ Great job! You\'re really getting it!';
            } else if (percentage >= 60) {
                messageEl.className = 'text-xl text-orange-600 font-semibold mb-6';
                messageEl.textContent = 'ðŸ‘ Good effort! Keep practicing!';
            } else {
                messageEl.className = 'text-xl text-red-600 font-semibold mb-6';
                messageEl.textContent = 'ðŸ’ª Keep trying! Practice makes perfect!';
            }
            
            // WHO AM I: Show bonus if earned
            if (whoAmIEnabled && typeof getWhoAmIBonusPoints === 'function') {
                const whoAmIBonus = getWhoAmIBonusPoints();
                if (whoAmIBonus > 0) {
                    const bonusDisplay = document.getElementById('who-am-i-bonus-display');
                    const bonusPoints = document.getElementById('bonus-points-display');
                    if (bonusDisplay && bonusPoints) {
                        bonusPoints.textContent = whoAmIBonus;
                        bonusDisplay.style.display = 'block';
                    }
                }
            }
            
            // AVATAR: Check for new item unlocks after a delay to let points update
            if (typeof checkForNewUnlocks === 'function') {
                setTimeout(() => {
                    // Fetch updated points and check for unlocks
                    fetch('/api/avatar/inventory')
                        .then(r => r.json())
                        .then(data => {
                            if (data.points !== undefined) {
                                checkForNewUnlocks(data.points);
                            }
                        })
                        .catch(e => console.log('Could not check unlocks:', e));
                }, 1000); // Wait 1 second for points to update
            }
            
            // AVATAR: Hide the unlock banner initially (will show if items unlocked)
            const unlockBanner = document.getElementById('new-unlock-banner');
            if (unlockBanner) {
                unlockBanner.classList.add('hidden');
            }
            
            // DINO BONUS: Show unlock for 85%+ scores
            const dinoBonusUnlock = document.getElementById('dino-bonus-unlock');
            if (dinoBonusUnlock) {
                if (percentage >= 85) {
                    dinoBonusUnlock.style.display = 'block';
                    // Store quiz info for bonus submission
                    window.bonusQuizInfo = {
                        topic: currentTopic,
                        score: percentage
                    };
                } else {
                    dinoBonusUnlock.style.display = 'none';
                }
            }
        }
        
        // ==================== DINO BONUS QUESTION FUNCTIONS ====================
        
        let currentBonusQuestion = null;
        let bonusAnswered = false;
        
        function skipBonusQuestion() {
            const dinoBonusUnlock = document.getElementById('dino-bonus-unlock');
            if (dinoBonusUnlock) {
                dinoBonusUnlock.style.display = 'none';
            }
        }
        
        async function startBonusQuestion() {
            // Hide the unlock card
            const dinoBonusUnlock = document.getElementById('dino-bonus-unlock');
            if (dinoBonusUnlock) {
                dinoBonusUnlock.style.display = 'none';
            }
            
            // Show modal
            const modal = document.getElementById('bonusQuestionModal');
            modal.classList.add('visible');
            
            // Reset state
            bonusAnswered = false;
            document.getElementById('bonusResult').style.display = 'none';
            document.getElementById('bonusFooter').style.display = 'none';
            document.getElementById('bonusImage').style.display = 'none';
            document.getElementById('bonusImageLoading').style.display = 'block';
            document.getElementById('bonusOptions').innerHTML = '<p class="text-center text-gray-500">Loading options...</p>';
            
            // Fetch random bonus question
            try {
                const response = await fetch('/api/bonus-question/random?category=dinosaurs');
                if (!response.ok) {
                    throw new Error('No bonus questions available');
                }
                
                currentBonusQuestion = await response.json();
                
                // Load image
                const img = document.getElementById('bonusImage');
                img.onload = function() {
                    document.getElementById('bonusImageLoading').style.display = 'none';
                    img.style.display = 'block';
                };
                img.onerror = function() {
                    document.getElementById('bonusImageLoading').innerHTML = '<p class="text-red-400">Image failed to load</p>';
                };
                img.src = currentBonusQuestion.image_url;
                
                // Render options
                const optionsContainer = document.getElementById('bonusOptions');
                optionsContainer.innerHTML = '';
                
                currentBonusQuestion.options.forEach((option, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'bonus-option-btn';
                    btn.textContent = option;
                    btn.onclick = () => selectBonusAnswer(option, btn);
                    optionsContainer.appendChild(btn);
                });
                
            } catch (error) {
                console.error('Error loading bonus question:', error);
                document.getElementById('bonusOptions').innerHTML = `
                    <p class="text-center text-red-500">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        Could not load bonus question. Please try again later.
                    </p>
                `;
            }
        }
        
        async function selectBonusAnswer(selectedAnswer, btnElement) {
            if (bonusAnswered) return;
            bonusAnswered = true;
            
            // Disable all buttons
            document.querySelectorAll('.bonus-option-btn').forEach(btn => {
                btn.disabled = true;
            });
            
            // Submit answer
            try {
                const response = await fetch('/api/bonus-question/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question_id: currentBonusQuestion.id,
                        selected_answer: selectedAnswer,
                        quiz_topic: window.bonusQuizInfo?.topic || currentTopic,
                        quiz_score: window.bonusQuizInfo?.score || 0
                    })
                });
                
                const result = await response.json();
                
                // Highlight correct/incorrect
                document.querySelectorAll('.bonus-option-btn').forEach(btn => {
                    if (btn.textContent === result.correct_answer) {
                        btn.classList.add('reveal-correct');
                    }
                    if (btn.textContent === selectedAnswer) {
                        if (result.correct) {
                            btn.classList.add('correct');
                        } else {
                            btn.classList.add('incorrect');
                        }
                    }
                });
                
                // Show result
                const resultDiv = document.getElementById('bonusResult');
                resultDiv.className = 'bonus-result ' + (result.correct ? 'correct' : 'incorrect');
                
                if (result.correct) {
                    resultDiv.innerHTML = `
                        <h3>ðŸŽ‰ Correct!</h3>
                        <div class="points-earned">+${result.points_earned} points!</div>
                        <div class="fun-fact">
                            <div class="fun-fact-label">ðŸ¦• Did You Know?</div>
                            <div class="fun-fact-text">${result.fun_fact || 'Amazing work!'}</div>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <h3>Not quite!</h3>
                        <p style="color: #4b5563; margin-bottom: 8px;">The correct answer was <strong>${result.correct_answer}</strong></p>
                        <div class="fun-fact">
                            <div class="fun-fact-label">ðŸ¦• Did You Know?</div>
                            <div class="fun-fact-text">${result.fun_fact || 'Better luck next time!'}</div>
                        </div>
                    `;
                }
                
                resultDiv.style.display = 'block';
                document.getElementById('bonusFooter').style.display = 'block';
                
            } catch (error) {
                console.error('Error submitting bonus answer:', error);
                alert('Error submitting answer. Please try again.');
                bonusAnswered = false;
                document.querySelectorAll('.bonus-option-btn').forEach(btn => {
                    btn.disabled = false;
                });
            }
        }
        
        function closeBonusOnOverlay(event) {
            if (event.target.id === 'bonusQuestionModal' && bonusAnswered) {
                closeBonusModal();
            }
        }
        
        function closeBonusModal() {
            document.getElementById('bonusQuestionModal').classList.remove('visible');
            currentBonusQuestion = null;
        }

        // ==================== DINO ARCHIVE FUNCTIONS ====================
        
        async function openDinoArchive() {
            const modal = document.getElementById('dinoArchiveModal');
            const body = document.getElementById('dinoArchiveBody');
            
            modal.classList.add('visible');
            body.innerHTML = `
                <div class="dino-archive-empty">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading your archive...</p>
                </div>
            `;
            
            try {
                const response = await fetch('/api/bonus-question/archive');
                const data = await response.json();
                
                // Update stats
                document.getElementById('archiveTotalCount').textContent = data.total || 0;
                document.getElementById('archiveCorrectCount').textContent = data.correct || 0;
                const accuracy = data.total > 0 ? Math.round((data.correct / data.total) * 100) : 0;
                document.getElementById('archiveAccuracy').textContent = accuracy + '%';
                
                if (!data.attempts || data.attempts.length === 0) {
                    body.innerHTML = `
                        <div class="dino-archive-empty">
                            <i class="fas fa-egg"></i>
                            <h3 style="margin-bottom: 10px; color: #374151;">No Dinosaurs Yet!</h3>
                            <p>Complete quizzes with 80%+ score to unlock Dino Challenges.</p>
                            <p style="margin-top: 10px;">Your discovered dinosaurs will appear here.</p>
                        </div>
                    `;
                    return;
                }
                
                // Render archive cards
                body.innerHTML = `
                    <div class="dino-archive-grid">
                        ${data.attempts.map(attempt => `
                            <div class="dino-archive-card ${attempt.is_correct ? 'correct' : 'incorrect'}">
                                <div class="dino-archive-card-image-wrapper">
                                    ${attempt.image_url ? `
                                        <img src="${attempt.image_url}" alt="${attempt.correct_answer}" class="dino-archive-card-image" 
                                             onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'dino-placeholder\\'><span>ðŸ¦•</span><small>${attempt.correct_answer}</small></div>';">
                                    ` : `
                                        <div class="dino-placeholder"><span>ðŸ¦•</span><small>${attempt.correct_answer}</small></div>
                                    `}
                                </div>
                                <div class="dino-archive-card-body">
                                    <div class="dino-archive-card-answer">
                                        ${attempt.is_correct ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-times-circle"></i>'}
                                        ${attempt.correct_answer}
                                    </div>
                                    <div class="dino-archive-card-meta">
                                        ${attempt.era_or_region ? `<span>${attempt.era_or_region}</span> â€¢ ` : ''}
                                        <span>${formatArchiveDate(attempt.attempted_at)}</span>
                                        ${attempt.quiz_topic ? ` â€¢ <span>${formatTopicName(attempt.quiz_topic)}</span>` : ''}
                                    </div>
                                    ${attempt.fun_fact ? `
                                        <div class="dino-archive-card-fact">
                                            <strong>ðŸ¦´ Fun Fact:</strong> ${attempt.fun_fact}
                                        </div>
                                    ` : ''}
                                    ${!attempt.is_correct ? `
                                        <div class="dino-archive-card-your-answer">
                                            Your answer: ${attempt.selected_answer}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading archive:', error);
                body.innerHTML = `
                    <div class="dino-archive-empty">
                        <i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i>
                        <p>Error loading archive. Please try again.</p>
                    </div>
                `;
            }
        }
        
        function closeDinoArchive() {
            document.getElementById('dinoArchiveModal').classList.remove('visible');
        }
        
        function closeDinoArchiveOnOverlay(event) {
            if (event.target.id === 'dinoArchiveModal') {
                closeDinoArchive();
            }
        }
        
        function formatArchiveDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
            
            return date.toLocaleDateString('en-IE', { day: 'numeric', month: 'short' });
        }
        
        function formatTopicName(topic) {
            if (!topic) return '';
            return topic.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        }
        
        // ==================== END DINO ARCHIVE ====================

        function retryQuiz() {
            document.getElementById('resultsScreen').classList.add('hidden');
            startQuiz(currentDifficulty);
        }

        async function backToTopics() {
            document.getElementById('difficultyScreen').classList.add('hidden');
            document.getElementById('resultsScreen').classList.add('hidden');
            document.getElementById('quizScreen').classList.add('hidden');
            document.getElementById('topicScreen').classList.remove('hidden');
            
            // Refresh mastery data AND progress after quiz completion
            await loadMasteryData();
            await loadTopics(); // Rebuild topic cards with updated mastery
            loadProgress();
        }

        function backToDifficulty() {
            // Refresh mastery data before showing difficulty screen
            refreshAndShowDifficulty();
        }
        
        async function refreshAndShowDifficulty() {
            // ===== DEACTIVATE QUIZ MODE =====
            document.body.classList.remove('quiz-active');
            
            await loadMasteryData(); // Get updated mastery after quiz
            document.getElementById('quizScreen').classList.add('hidden');
            document.getElementById('resultsScreen').classList.add('hidden');
            // Re-render difficulty buttons with updated mastery
            selectTopic(currentTopic, document.getElementById('selectedTopicTitle').textContent);
        }

        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (error) {
                console.error('Error logging out:', error);
            }
        }

        // ==================== QUESTION FLAGGING ====================

        let currentFlagQuestionId = null;

        function showFlagQuestionModal(questionId) {
            currentFlagQuestionId = questionId;
            const question = questions[currentQuestionIndex];

            document.getElementById('flagQuestionText').textContent = question.question;
            document.getElementById('flagQuestionModal').classList.remove('hidden');
            document.getElementById('flagQuestionModal').classList.add('flex');

            document.getElementById('flagForm').reset();
        }

        function hideFlagModal() {
            document.getElementById('flagQuestionModal').classList.add('hidden');
            document.getElementById('flagQuestionModal').classList.remove('flex');
            currentFlagQuestionId = null;
        }

        document.addEventListener('DOMContentLoaded', function() {
            const flagForm = document.getElementById('flagForm');
            if (flagForm) {
                flagForm.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    const flagType = document.getElementById('flagType').value;
                    const description = document.getElementById('flagDescription').value;

                    if (!flagType || !description.trim()) {
                        alert('Please fill in all fields');
                        return;
                    }

                    try {
                        const response = await fetch('/api/student/flag-question', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                question_id: currentFlagQuestionId,
                                flag_type: flagType,
                                description: description
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            alert('Thank you! Your report has been submitted to the administrator.');
                            hideFlagModal();
                        } else {
                            alert(data.error || 'Failed to submit report');
                        }
                    } catch (error) {
                        console.error('Error submitting flag:', error);
                        alert('Error submitting report. Please try again.');
                    }
                });
            }
        });
        
        // ==================== CALCULATOR FUNCTIONS ====================
        
        let calcExpression = '';
        let calcCurrentValue = '0';
        let calcLastResult = null;
        let calcIsOpen = false;
        
        // Initialize calculator state from session preference
        function initCalculator() {
            const keepOpen = localStorage.getItem('calcKeepOpen') === 'true';
            const checkbox = document.getElementById('calcKeepOpen');
            if (checkbox) {
                checkbox.checked = keepOpen;
            }
        }
        
        function toggleCalculator() {
            const overlay = document.getElementById('calculatorOverlay');
            const calcBtn = document.getElementById('compactCalcBtn');
            
            if (overlay.classList.contains('visible')) {
                hideCalculator();
            } else {
                showCalculator();
            }
        }
        
        function showCalculator() {
            const overlay = document.getElementById('calculatorOverlay');
            const calcBtn = document.getElementById('compactCalcBtn');
            
            overlay.classList.add('visible');
            if (calcBtn) calcBtn.classList.add('active');
            calcIsOpen = true;
        }
        
        function hideCalculator() {
            const overlay = document.getElementById('calculatorOverlay');
            const calcBtn = document.getElementById('compactCalcBtn');
            const keepOpen = document.getElementById('calcKeepOpen');
            
            // Don't hide if "keep open" is checked (unless forced)
            if (keepOpen && keepOpen.checked) return;
            
            overlay.classList.remove('visible');
            if (calcBtn) calcBtn.classList.remove('active');
            calcIsOpen = false;
        }
        
        function closeCalculatorOnOverlay(event) {
            // Only close if clicking on the overlay background
            if (event.target.id === 'calculatorOverlay') {
                const keepOpen = document.getElementById('calcKeepOpen');
                if (!keepOpen || !keepOpen.checked) {
                    hideCalculator();
                }
            }
        }
        
        // ========== CALCULATOR DRAG FUNCTIONALITY ==========
        let calcDragActive = false;
        let calcDragStartX = 0;
        let calcDragStartY = 0;
        let calcInitialLeft = 0;
        let calcInitialTop = 0;
        
        function initCalculatorDrag() {
            const header = document.getElementById('calculatorHeader');
            const container = document.getElementById('calculatorContainer');
            
            if (!header || !container) return;
            
            // Mouse events
            header.addEventListener('mousedown', startCalcDrag);
            document.addEventListener('mousemove', doCalcDrag);
            document.addEventListener('mouseup', stopCalcDrag);
            
            // Touch events for mobile
            header.addEventListener('touchstart', startCalcDragTouch, { passive: false });
            document.addEventListener('touchmove', doCalcDragTouch, { passive: false });
            document.addEventListener('touchend', stopCalcDrag);
        }
        
        function startCalcDrag(e) {
            // Don't drag if clicking the close button
            if (e.target.closest('.calculator-close')) return;
            
            const container = document.getElementById('calculatorContainer');
            calcDragActive = true;
            calcDragStartX = e.clientX;
            calcDragStartY = e.clientY;
            
            const rect = container.getBoundingClientRect();
            calcInitialLeft = rect.left;
            calcInitialTop = rect.top;
            
            container.style.transition = 'none';
        }
        
        function startCalcDragTouch(e) {
            if (e.target.closest('.calculator-close')) return;
            
            const touch = e.touches[0];
            const container = document.getElementById('calculatorContainer');
            calcDragActive = true;
            calcDragStartX = touch.clientX;
            calcDragStartY = touch.clientY;
            
            const rect = container.getBoundingClientRect();
            calcInitialLeft = rect.left;
            calcInitialTop = rect.top;
            
            container.style.transition = 'none';
            e.preventDefault();
        }
        
        function doCalcDrag(e) {
            if (!calcDragActive) return;
            
            const container = document.getElementById('calculatorContainer');
            const deltaX = e.clientX - calcDragStartX;
            const deltaY = e.clientY - calcDragStartY;
            
            let newLeft = calcInitialLeft + deltaX;
            let newTop = calcInitialTop + deltaY;
            
            // Keep calculator within viewport bounds
            const maxLeft = window.innerWidth - container.offsetWidth - 10;
            const maxTop = window.innerHeight - container.offsetHeight - 10;
            
            newLeft = Math.max(10, Math.min(newLeft, maxLeft));
            newTop = Math.max(10, Math.min(newTop, maxTop));
            
            container.style.left = newLeft + 'px';
            container.style.top = newTop + 'px';
            container.style.right = 'auto';
        }
        
        function doCalcDragTouch(e) {
            if (!calcDragActive) return;
            
            const touch = e.touches[0];
            const container = document.getElementById('calculatorContainer');
            const deltaX = touch.clientX - calcDragStartX;
            const deltaY = touch.clientY - calcDragStartY;
            
            let newLeft = calcInitialLeft + deltaX;
            let newTop = calcInitialTop + deltaY;
            
            // Keep calculator within viewport bounds
            const maxLeft = window.innerWidth - container.offsetWidth - 10;
            const maxTop = window.innerHeight - container.offsetHeight - 10;
            
            newLeft = Math.max(10, Math.min(newLeft, maxLeft));
            newTop = Math.max(10, Math.min(newTop, maxTop));
            
            container.style.left = newLeft + 'px';
            container.style.top = newTop + 'px';
            container.style.right = 'auto';
            
            e.preventDefault();
        }
        
        function stopCalcDrag() {
            if (calcDragActive) {
                const container = document.getElementById('calculatorContainer');
                container.style.transition = '';
            }
            calcDragActive = false;
        }
        
        // Initialize drag on page load
        document.addEventListener('DOMContentLoaded', initCalculatorDrag);
        // ========== END CALCULATOR DRAG ==========
        
        function saveCalcPreference() {
            const keepOpen = document.getElementById('calcKeepOpen').checked;
            localStorage.setItem('calcKeepOpen', keepOpen);
            
            if (keepOpen && !calcIsOpen) {
                showCalculator();
            }
        }
        
        function updateCalcDisplay() {
            document.getElementById('calcExpression').textContent = calcExpression;
            document.getElementById('calcResult').textContent = calcCurrentValue;
        }
        
        function calcInput(value) {
            if (calcCurrentValue === '0' && value !== '.') {
                calcCurrentValue = value;
            } else if (calcCurrentValue === 'Error') {
                calcCurrentValue = value;
                calcExpression = '';
            } else {
                calcCurrentValue += value;
            }
            updateCalcDisplay();
        }
        
        function calcClear() {
            calcExpression = '';
            calcCurrentValue = '0';
            calcLastResult = null;
            updateCalcDisplay();
        }
        
        function calcBackspace() {
            if (calcCurrentValue.length > 1) {
                calcCurrentValue = calcCurrentValue.slice(0, -1);
            } else {
                calcCurrentValue = '0';
            }
            updateCalcDisplay();
        }
        
        function calcEquals() {
            try {
                // Store expression for display
                calcExpression = calcCurrentValue;
                
                // Convert display operators to JavaScript operators
                let expression = calcCurrentValue
                    .replace(/Ã—/g, '*')
                    .replace(/Ã·/g, '/')
                    .replace(/âˆ’/g, '-')
                    .replace(/Ï€/g, Math.PI.toString());
                
                // Evaluate safely
                let result = Function('"use strict"; return (' + expression + ')')();
                
                // Format result
                if (isNaN(result) || !isFinite(result)) {
                    calcCurrentValue = 'Error';
                } else {
                    // Round to reasonable precision
                    if (Number.isInteger(result)) {
                        calcCurrentValue = result.toString();
                    } else {
                        calcCurrentValue = parseFloat(result.toPrecision(10)).toString();
                    }
                    calcLastResult = result;
                }
            } catch (e) {
                calcCurrentValue = 'Error';
            }
            updateCalcDisplay();
        }
        
        function calcSquare() {
            try {
                let val = parseFloat(calcCurrentValue.replace(/Ã—/g, '*').replace(/Ã·/g, '/').replace(/âˆ’/g, '-'));
                if (!isNaN(val)) {
                    calcExpression = `(${calcCurrentValue})Â²`;
                    calcCurrentValue = (val * val).toString();
                    updateCalcDisplay();
                }
            } catch (e) {
                calcCurrentValue = 'Error';
                updateCalcDisplay();
            }
        }
        
        function calcSquareRoot() {
            try {
                let val = parseFloat(calcCurrentValue);
                if (!isNaN(val) && val >= 0) {
                    calcExpression = `âˆš(${calcCurrentValue})`;
                    let result = Math.sqrt(val);
                    calcCurrentValue = Number.isInteger(result) ? result.toString() : parseFloat(result.toPrecision(10)).toString();
                    updateCalcDisplay();
                } else {
                    calcCurrentValue = 'Error';
                    updateCalcDisplay();
                }
            } catch (e) {
                calcCurrentValue = 'Error';
                updateCalcDisplay();
            }
        }
        
        function calcPi() {
            if (calcCurrentValue === '0' || calcCurrentValue === 'Error') {
                calcCurrentValue = 'Ï€';
            } else {
                calcCurrentValue += 'Ï€';
            }
            updateCalcDisplay();
        }
        
        function calcNegate() {
            if (calcCurrentValue !== '0' && calcCurrentValue !== 'Error') {
                if (calcCurrentValue.startsWith('-')) {
                    calcCurrentValue = calcCurrentValue.slice(1);
                } else {
                    calcCurrentValue = '-' + calcCurrentValue;
                }
                updateCalcDisplay();
            }
        }
        
        // Keyboard support for calculator
        document.addEventListener('keydown', function(e) {
            // Only handle if calculator is open
            if (!calcIsOpen) return;
            
            // Prevent interference with other inputs
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            const key = e.key;
            
            if (/[0-9]/.test(key)) {
                calcInput(key);
            } else if (key === '.') {
                calcInput('.');
            } else if (key === '+') {
                calcInput('+');
            } else if (key === '-') {
                calcInput('-');
            } else if (key === '*') {
                calcInput('Ã—');
            } else if (key === '/') {
                e.preventDefault(); // Prevent browser search
                calcInput('Ã·');
            } else if (key === 'Enter' || key === '=') {
                e.preventDefault();
                calcEquals();
            } else if (key === 'Escape') {
                hideCalculator();
            } else if (key === 'Backspace') {
                e.preventDefault();
                calcBackspace();
            } else if (key === 'c' || key === 'C') {
                calcClear();
            } else if (key === '(') {
                calcInput('(');
            } else if (key === ')') {
                calcInput(')');
            }
        });
        
        // Initialize calculator when quiz starts
        const originalStartQuiz = window.startQuiz;
        if (typeof originalStartQuiz === 'function') {
            window.startQuiz = function(...args) {
                initCalculator();
                return originalStartQuiz.apply(this, args);
            };
        } else {
            // If startQuiz not defined yet, init on DOM ready
            document.addEventListener('DOMContentLoaded', initCalculator);
        }
    </script>

    <!-- Flag Question Modal -->
    <div id="flagQuestionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Report Question Issue</h2>
                <button onclick="hideFlagModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div id="flagQuestionContent" class="mb-6">
                <p class="text-gray-700 mb-4" id="flagQuestionText"></p>
            </div>

            <form id="flagForm" class="space-y-4">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Issue Type:</label>
                    <select id="flagType" required class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="">-- Select issue type --</option>
                        <option value="incorrect">Incorrect Answer</option>
                        <option value="ambiguous">Ambiguous/Unclear Question</option>
                        <option value="typo">Typo or Grammar Error</option>
                        <option value="other">Other Issue</option>
                    </select>
                </div>

                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Description:</label>
                    <textarea id="flagDescription" required rows="4"
                              class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                              placeholder="Please describe the issue in detail..."></textarea>
                </div>

                <div class="flex gap-4">
                    <button type="submit" class="flex-1 bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 font-semibold">
                        <i class="fas fa-flag mr-2"></i>Submit Report
                    </button>
                    <button type="button" onclick="hideFlagModal()" class="flex-1 bg-gray-300 text-gray-800 py-3 rounded-lg hover:bg-gray-400 font-semibold">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
    <!-- Password Change Modal -->
    <div id="passwordModal" class="password-modal hidden">
        <div class="password-modal-content">
            <div class="password-modal-header">
                <h2><i class="fas fa-key mr-2"></i>Change Password</h2>
                <button onclick="closePasswordModal()" class="close-btn">&times;</button>
            </div>
            <form id="passwordForm" onsubmit="changePassword(event)" class="password-form">
                <div class="form-group">
                    <label for="currentPassword">
                        <i class="fas fa-lock mr-2"></i>Current Password
                    </label>
                    <input
                        type="password"
                        id="currentPassword"
                        required
                        minlength="6"
                        class="form-input"
                        placeholder="Enter current password"
                    >
                </div>
                <div class="form-group">
                    <label for="newPassword">
                        <i class="fas fa-key mr-2"></i>New Password
                    </label>
                    <input
                        type="password"
                        id="newPassword"
                        required
                        minlength="6"
                        class="form-input"
                        placeholder="Enter new password (min 6 characters)"
                    >
                    <small class="form-hint">Minimum 6 characters</small>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">
                        <i class="fas fa-check-circle mr-2"></i>Confirm New Password
                    </label>
                    <input
                        type="password"
                        id="confirmPassword"
                        required
                        minlength="6"
                        class="form-input"
                        placeholder="Confirm new password"
                    >
                </div>
                <div id="passwordError" class="error-message hidden"></div>
                <div id="passwordSuccess" class="success-message hidden"></div>
                <div class="form-actions">
                    <button type="button" onclick="closePasswordModal()" class="btn-cancel">
                        Cancel
                    </button>
                    <button type="submit" class="btn-submit">
                        <i class="fas fa-check mr-2"></i>Change Password
                    </button>
                </div>
            </form>
        </div>
    </div>

    <style>
        /* Password Modal Styles */
        .password-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            /* backdrop-filter: blur(4px); */ /* REMOVED */
        }

        .password-modal.hidden {
            display: none;
        }

        .password-modal-content {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .password-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .password-modal-header h2 {
            margin: 0;
            font-size: 24px;
            font-weight: 700;
        }

        .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 32px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .password-form {
            padding: 32px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-hint {
            display: block;
            margin-top: 6px;
            font-size: 12px;
            color: #718096;
        }

        .error-message {
            background: #fee;
            border: 2px solid #fcc;
            color: #c33;
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 16px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .error-message::before {
            content: "âš ï¸";
            font-size: 18px;
        }

        .success-message {
            background: #efe;
            border: 2px solid #cfc;
            color: #3c3;
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 16px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .success-message::before {
            content: "âœ“";
            font-size: 18px;
            font-weight: bold;
        }

        .error-message.hidden,
        .success-message.hidden {
            display: none;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 32px;
        }

        .btn-cancel,
        .btn-submit {
            flex: 1;
            padding: 14px 24px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }

        .btn-cancel {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-cancel:hover {
            background: #cbd5e0;
        }

        .btn-submit {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-submit:active {
            transform: translateY(0);
        }

        /* ========================================
           MILESTONE CELEBRATION SYSTEM 
           ======================================== */
        
        .milestone-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease-in;
        }

        .milestone-modal {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.5s ease-out;
            position: relative;
        }

        .milestone-modal.perfect-score {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .milestone-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: bounce 1s ease-in-out infinite;
        }

        .milestone-title {
            color: white;
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .milestone-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 18px;
            margin-bottom: 30px;
        }

        .milestone-badges-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
            max-height: 400px;
            overflow-y: auto;
        }

        .milestone-badge {
            background: rgba(255, 255, 255, 1.0);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 15px;
            /* backdrop-filter: blur(10px); */ /* REMOVED - CAUSED BLUR */
            transition: transform 0.2s;
        }

        .milestone-badge:hover {
            transform: scale(1.02);
        }

        .milestone-badge-icon {
            font-size: 40px;
            margin-bottom: 5px;
        }

        .milestone-badge-name {
            color: white;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .milestone-badge-description {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
        }

        .milestone-badge-points {
            color: #ffd700;
            font-size: 16px;
            font-weight: bold;
            margin-top: 8px;
        }

        .milestone-continue-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .milestone-continue-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .confetti-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            border-radius: 20px;
            overflow: hidden;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { 
                transform: translateY(-50px) scale(0.8);
                opacity: 0;
            }
            to { 
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }

    </style>

    <script>
        // Password Modal Functions
        function openPasswordModal() {
            document.getElementById('passwordModal').classList.remove('hidden');
            document.getElementById('currentPassword').focus();
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').classList.add('hidden');
            document.getElementById('passwordForm').reset();
            document.getElementById('passwordError').classList.add('hidden');
            document.getElementById('passwordSuccess').classList.add('hidden');
        }

        async function changePassword(event) {
            event.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            const errorDiv = document.getElementById('passwordError');
            const successDiv = document.getElementById('passwordSuccess');

            // Clear previous messages
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');

            // Validate passwords match
            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'New passwords do not match';
                errorDiv.classList.remove('hidden');
                return;
            }

            // Validate password length
            if (newPassword.length < 6) {
                errorDiv.textContent = 'Password must be at least 6 characters long';
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                const response = await fetch('/api/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword,
                        confirm_password: confirmPassword
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    successDiv.textContent = data.message;
                    successDiv.classList.remove('hidden');
                    document.getElementById('passwordForm').reset();

                    // Auto-close after 2 seconds
                    setTimeout(() => {
                        closePasswordModal();
                    }, 2000);
                } else {
                    errorDiv.textContent = data.error || 'Failed to change password';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error changing password:', error);
                errorDiv.textContent = 'An error occurred. Please try again.';
                errorDiv.classList.remove('hidden');
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('passwordModal');
            if (event.target === modal) {
                closePasswordModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('passwordModal');
                if (!modal.classList.contains('hidden')) {
                    closePasswordModal();
                }
            }
        });

        // ========================================
        // MILESTONE CELEBRATION SYSTEM
        // ========================================

        function createConfetti(container) {
            const canvas = document.createElement('canvas');
            canvas.className = 'confetti-canvas';
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;
            
            const ctx = canvas.getContext('2d');
            const pieces = [];
            const numberOfPieces = 100;
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#feca57', '#ee5a6f', '#c7ecee', '#ffd700', '#ff85c0'];
            
            class ConfettiPiece {
                constructor() {
                    this.x = Math.random() * canvas.width;
                    this.y = Math.random() * canvas.height - canvas.height;
                    this.size = Math.random() * 8 + 4;
                    this.speedY = Math.random() * 3 + 2;
                    this.speedX = Math.random() * 2 - 1;
                    this.color = colors[Math.floor(Math.random() * colors.length)];
                    this.rotation = Math.random() * 360;
                    this.rotationSpeed = Math.random() * 10 - 5;
                }
                
                update() {
                    this.y += this.speedY;
                    this.x += this.speedX;
                    this.rotation += this.rotationSpeed;
                    
                    if (this.y > canvas.height) {
                        this.y = -10;
                        this.x = Math.random() * canvas.width;
                    }
                }
                
                draw() {
                    ctx.save();
                    ctx.translate(this.x, this.y);
                    ctx.rotate(this.rotation * Math.PI / 180);
                    ctx.fillStyle = this.color;
                    ctx.fillRect(-this.size/2, -this.size/2, this.size, this.size);
                    ctx.restore();
                }
            }
            
            for (let i = 0; i < numberOfPieces; i++) {
                pieces.push(new ConfettiPiece());
            }
            
            let animationId;
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                pieces.forEach(piece => {
                    piece.update();
                    piece.draw();
                });
                animationId = requestAnimationFrame(animate);
            }
            
            animate();
            
            // Stop after 5 seconds
            setTimeout(() => {
                cancelAnimationFrame(animationId);
                canvas.remove();
            }, 5000);
            
            return canvas;
        }

        function showMilestoneModal(badges) {
            if (!badges || badges.length === 0) return;
            
            console.log('ðŸŽ‰ Showing milestone modal for badges:', badges);
            
            // Create overlay
            const overlay = document.createElement('div');
            overlay.className = 'milestone-overlay';
            overlay.id = 'milestone-overlay';
            
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'milestone-modal';
            
            // Check if this is a special achievement (perfect score, mastery, etc)
            const isSpecial = badges.some(b => 
                b.name.includes('Perfect') || 
                b.name.includes('Flawless') ||
                b.name.includes('Master') || 
                b.name.includes('Genius') ||
                b.name.includes('Excellence')
            );
            
            if (isSpecial) {
                modal.classList.add('perfect-score');
            }
            
            // Get appropriate icon
            const getIcon = (badge) => {
                if (badge.icon && badge.icon !== 'null') return badge.icon;
                // Default icons based on badge name
                if (badge.name.includes('Perfect') || badge.name.includes('Flawless')) return 'ðŸ’¯';
                if (badge.name.includes('Master') || badge.name.includes('Genius')) return 'ðŸŽ“';
                if (badge.name.includes('Streak') || badge.name.includes('Warrior')) return 'ðŸ”¥';
                if (badge.name.includes('First')) return 'ðŸŒŸ';
                if (badge.name.includes('Sharp')) return 'ðŸŽ¯';
                return 'ðŸ†';
            };
            
            const mainIcon = badges.length === 1 ? getIcon(badges[0]) : (badges.length > 1 ? 'ðŸŽ‰' : 'ðŸ†');
            
            // Build modal content
            modal.innerHTML = `
                <div class="milestone-icon">${mainIcon}</div>
                <div class="milestone-title">
                    ${badges.length === 1 ? 'Achievement Unlocked!' : badges.length + ' Achievements!'}
                </div>
                <div class="milestone-subtitle">
                    You've earned ${badges.length === 1 ? 'a new badge' : badges.length + ' new badges'}!
                </div>
                
                <div class="milestone-badges-container">
                    ${badges.map(badge => `
                        <div class="milestone-badge">
                            <div class="milestone-badge-icon">${getIcon(badge)}</div>
                            <div class="milestone-badge-name">${badge.name}</div>
                            <div class="milestone-badge-description">${badge.description}</div>
                            <div class="milestone-badge-points">+${badge.points} points</div>
                        </div>
                    `).join('')}
                </div>
                
                <button class="milestone-continue-btn" onclick="closeMilestoneModal()">
                    Continue
                </button>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // Add confetti for special achievements
            if (isSpecial) {
                const confettiCanvas = createConfetti(modal);
                modal.insertBefore(confettiCanvas, modal.firstChild);
            }
            
            // Play achievement sound (optional)
            playAchievementSound();
        }

        function closeMilestoneModal() {
            const overlay = document.getElementById('milestone-overlay');
            if (overlay) {
                overlay.style.animation = 'fadeIn 0.3s ease-out reverse';
                setTimeout(() => overlay.remove(), 300);
            }
        }

        function playAchievementSound() {
            // Optional: Add achievement sound
            // You can add an audio file and play it here
            try {
                // const audio = new Audio('/static/achievement.mp3');
                // audio.volume = 0.3;
                // audio.play().catch(e => console.log('Could not play sound:', e));
            } catch (e) {
                // Sound playback failed, that's okay
            }
        }

        // ==================== CLIENT-SIDE ACHIEVEMENT POPUPS ====================
        // High-contrast celebration popups for ALL users (guests and logged-in)

        function showAchievementPopup(achievement) {
            console.log('ðŸŽ‰ Showing achievement popup:', achievement);
            
            // Track milestone points
            if (achievement.points) {
                totalMilestonePoints += achievement.points;
                console.log(`ðŸ’° Milestone points earned: +${achievement.points} (Total milestones: ${totalMilestonePoints})`);
            }
            
            // Create overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.85);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.3s ease-out;
            `;
            
            // Create modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 20px;
                padding: 40px;
                max-width: 500px;
                width: 90%;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
                text-align: center;
                position: relative;
                animation: slideUp 0.5s ease-out;
                color: #ffffff;
            `;
            
            modal.innerHTML = `
                <div style="font-size: 80px; margin-bottom: 20px; animation: bounce 1s ease-in-out infinite;">
                    ${achievement.icon}
                </div>
                <h2 style="
                    color: #ffffff;
                    font-size: 32px;
                    font-weight: bold;
                    margin: 20px 0;
                    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
                ">
                    ${achievement.title}
                </h2>
                <p style="
                    color: #ffffff;
                    font-size: 18px;
                    margin: 15px 0;
                    line-height: 1.6;
                    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
                ">
                    ${achievement.description}
                </p>
                <div style="
                    background: rgba(255, 255, 255, 0.2);
                    border-radius: 10px;
                    padding: 15px;
                    margin: 20px 0;
                ">
                    <div style="
                        color: #ffffff;
                        font-size: 16px;
                        font-weight: 600;
                        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
                    ">
                        Achievement Points
                    </div>
                    <div style="
                        color: #ffd700;
                        font-size: 36px;
                        font-weight: bold;
                        margin-top: 5px;
                        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
                    ">
                        +${achievement.points}
                    </div>
                </div>
                <button onclick="this.closest('.achievement-overlay').remove()" style="
                    background: rgba(255, 255, 255, 0.9);
                    color: #667eea;
                    border: none;
                    padding: 12px 30px;
                    font-size: 16px;
                    font-weight: 600;
                    border-radius: 25px;
                    cursor: pointer;
                    margin-top: 10px;
                    transition: all 0.3s ease;
                    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                " 
                onmouseover="this.style.background='#ffffff'; this.style.transform='scale(1.05)';"
                onmouseout="this.style.background='rgba(255, 255, 255, 0.9)'; this.style.transform='scale(1)';">
                    Awesome! âœ¨
                </button>
            `;
            
            overlay.className = 'achievement-overlay';
            overlay.appendChild(modal);
            
            // Add confetti
            createAchievementConfetti(overlay);
            
            document.body.appendChild(overlay);
            
            // Add animations if not already added
            if (!document.getElementById('achievement-animations')) {
                const style = document.createElement('style');
                style.id = 'achievement-animations';
                style.textContent = `
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideUp {
                        from {
                            transform: translateY(50px);
                            opacity: 0;
                        }
                        to {
                            transform: translateY(0);
                            opacity: 1;
                        }
                    }
                    @keyframes bounce {
                        0%, 100% { transform: translateY(0); }
                        50% { transform: translateY(-20px); }
                    }
                    @keyframes confettiFall {
                        to {
                            transform: translateY(100vh) rotate(360deg);
                            opacity: 0;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        function createAchievementConfetti(container) {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#ff9ff3'];
            const confettiCount = 50;
            
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.style.cssText = `
                    position: fixed;
                    width: 10px;
                    height: 10px;
                    background: ${colors[Math.floor(Math.random() * colors.length)]};
                    top: -10px;
                    left: ${Math.random() * 100}%;
                    opacity: ${Math.random() * 0.7 + 0.3};
                    animation: confettiFall ${Math.random() * 3 + 2}s linear forwards;
                    animation-delay: ${Math.random() * 0.5}s;
                    border-radius: ${Math.random() > 0.5 ? '50%' : '0'};
                    z-index: 9999;
                `;
                container.appendChild(confetti);
                
                // Remove confetti after animation
                setTimeout(() => confetti.remove(), 5000);
            }
        }

        console.log('âœ… Client-side achievement system loaded!');

    </script>



<!-- ========================================== -->
<!-- TUTORIAL SYSTEM - Added for splash screens -->
<!-- ========================================== -->

<!-- Tutorial Data -->
<script>
/**
 * TUTORIAL DATA STRUCTURE
 * 
 * This file contains all tutorial content for topics.
 * To add a new topic tutorial, simply add a new entry to the TUTORIALS object.
 * 
 * Structure:
 * TUTORIALS = {
 *   'topic_name': {
 *     'beginner': { title, introduction, principles, examples, tips },
 *     'intermediate': { ... },
 *     'advanced': { ... }
 *   }
 * }
 */

const TUTORIALS = {
    // Introductory Algebra Tutorial Content
    'introductory_algebra': {
        'beginner': {
            title: 'Collecting Like Terms',
            introduction: 'In this level, you\'ll learn to <strong>collect like terms</strong> - combining terms that have the same letter.',
            
            principles: [
                {
                    title: 'Like Terms',
                    content: '<strong>Like terms</strong> have exactly the same letter part.<br>â€¢ 3x and 5x are like terms (both have \'x\')<br>â€¢ 4y and 2y are like terms (both have \'y\')<br>â€¢ 3x and 5y are NOT like terms (different letters)'
                },
                {
                    title: 'How to Collect',
                    content: 'Think of it like fruit: 3 apples + 5 apples = 8 apples<br>Just add the numbers, keep the letter!'
                }
            ],
            
            examples: [
                {
                    question: 'Simplify: 4x + 3x',
                    steps: [
                        'Both terms have \'x\' - they are like terms âœ“',
                        'Add the numbers: 4 + 3 = 7',
                        'Keep the letter: x'
                    ],
                    answer: '7x'
                },
                {
                    question: 'Simplify: 5y + 2y',
                    steps: [
                        'Both terms have \'y\' - they are like terms âœ“',
                        'Add the numbers: 5 + 2 = 7',
                        'Keep the letter: y'
                    ],
                    answer: '7y'
                }
            ],
            
            tips: [
                'âœ… Always keep the letter - it doesn\'t change!',
                'âœ… Just add the numbers - ignore the letters when adding',
                'âš ï¸ Don\'t forget the letter: 4x + 3x = 7x (not 7)',
                'âš ï¸ Don\'t multiply: 2y + 3y = 5y (not 6y)'
            ]
        },
        
        'intermediate': {
            title: 'Substitution (One Variable)',
            introduction: 'In this level, you\'ll learn <strong>substitution</strong> - finding the value of expressions when you know what x equals.',
            
            principles: [
                {
                    title: 'What is Substitution?',
                    content: '<strong>Substitution</strong> means replacing a letter with its number value.<br>Example: If x = 5, then x + 3 means 5 + 3 = 8'
                },
                {
                    title: 'Use Brackets!',
                    content: 'Always use brackets when substituting.<br>If x = 4, write 3(4) not 34'
                }
            ],
            
            examples: [
                {
                    question: 'If x = 4, find the value of x + 7',
                    steps: [
                        'Write the expression: x + 7',
                        'Replace x with 4: (4) + 7',
                        'Calculate: 4 + 7'
                    ],
                    answer: '11'
                },
                {
                    question: 'If x = 5, find the value of 2x',
                    steps: [
                        'Write the expression: 2x (means 2 times x)',
                        'Replace x with 5 (use brackets!): 2(5)',
                        'Calculate: 2 Ã— 5'
                    ],
                    answer: '10'
                }
            ],
            
            tips: [
                'âœ… Always use brackets when substituting',
                'âœ… Remember 2x means 2 Ã— x (multiply!)',
                'âœ… Follow BOMDAS - multiply before adding',
                'âš ï¸ Don\'t just stick numbers together: 3x when x=4 is 12, not 34'
            ]
        },
        
        'advanced': {
            title: 'Substitution (Two Variables)',
            introduction: 'In this level, you\'ll substitute <strong>two different variables</strong> (like x and y) in the same expression.',
            
            principles: [
                {
                    title: 'Multiple Variables',
                    content: 'Each letter can represent a different number!<br>Example: If x = 3 and y = 5, then x + y means 3 + 5 = 8'
                },
                {
                    title: 'Multiply First',
                    content: 'When you see 2x or 3y, multiply BEFORE adding/subtracting (BOMDAS!)'
                }
            ],
            
            examples: [
                {
                    question: 'If x = 4 and y = 3, find x + y',
                    steps: [
                        'Write: x + y',
                        'Replace both letters: (4) + (3)',
                        'Calculate: 4 + 3'
                    ],
                    answer: '7'
                },
                {
                    question: 'If x = 5 and y = 4, find 2x + y',
                    steps: [
                        'Write: 2x + y',
                        'Replace: 2(5) + (4)',
                        'Multiply first: 10 + 4',
                        'Then add: 14'
                    ],
                    answer: '14'
                }
            ],
            
            tips: [
                'âœ… Keep track of which value goes with which letter',
                'âœ… Use brackets for both variables',
                'âœ… Multiply before you add/subtract (BOMDAS!)',
                'âš ï¸ Don\'t mix up the values: x=4, y=3 means x+y = 4+3, not 3+4... well, same answer, but you get the idea!'
            ]
        }
    },
    
    // ============================================
    // SOLVING EQUATIONS
    // ============================================
    'solving_equations': {
        'beginner': {
            title: 'One-Step Equations',
            introduction: 'Learn to solve <strong>one-step equations</strong> like x + 5 = 12. You\'ll discover how to "undo" addition to find the value of x.',
            
            principles: [
                {
                    title: 'What is an Equation?',
                    content: 'An <strong>equation</strong> is like a balance scale - both sides must be equal.<br>Example: x + 3 = 10 means "something plus 3 equals 10"<br>Our job is to find what that "something" (x) is!'
                },
                {
                    title: 'The Golden Rule',
                    content: '<strong>Whatever you do to one side, do to the other!</strong><br>Think of it like a seesaw - if you take weight off one side, you must take the same weight off the other side to keep it balanced.'
                },
                {
                    title: 'Undoing Addition',
                    content: 'To solve x + 3 = 10, we need to <strong>undo</strong> the +3<br>â€¢ Addition is undone by subtraction<br>â€¢ Subtract 3 from BOTH sides<br>â€¢ x + 3 - 3 = 10 - 3<br>â€¢ x = 7'
                }
            ],
            
            examples: [
                {
                    question: 'Solve: x + 3 = 10',
                    steps: [
                        'We need to get x by itself (isolate x)',
                        'The +3 is attached to x, so we undo it',
                        'Subtract 3 from BOTH sides: x + 3 - 3 = 10 - 3',
                        'Left side: x + 3 - 3 = x (the 3s cancel out!)',
                        'Right side: 10 - 3 = 7',
                        'Therefore: x = 7'
                    ],
                    answer: 'x = 7'
                },
                {
                    question: 'Solve: x + 9 = 29',
                    steps: [
                        'We need to remove the +9 to isolate x',
                        'Subtract 9 from BOTH sides: x + 9 - 9 = 29 - 9',
                        'Left side: x + 9 - 9 = x',
                        'Right side: 29 - 9 = 20',
                        'Therefore: x = 20'
                    ],
                    answer: 'x = 20'
                },
                {
                    question: 'Solve: x + 14 = 18',
                    steps: [
                        'Subtract 14 from BOTH sides: x + 14 - 14 = 18 - 14',
                        'Left side simplifies to: x',
                        'Right side: 18 - 14 = 4',
                        'Therefore: x = 4'
                    ],
                    answer: 'x = 4'
                }
            ],
            
            tips: [
                'âœ… Always do the SAME thing to both sides of the equation',
                'âœ… Check your answer by substituting back: if x = 7, does 7 + 3 = 10? Yes! âœ“',
                'âœ… Think: "What number + [this number] = [that number]?"',
                'âš ï¸ Don\'t just subtract from the right side - do BOTH sides!',
                'âš ï¸ Remember to actually subtract - don\'t just remove the number'
            ]
        },
        
        'intermediate': {
            title: 'Two-Step Equations',
            introduction: 'Master <strong>two-step equations</strong> like 2x + 4 = 18. These need TWO operations to solve - but don\'t worry, we\'ll take it step by step!',
            
            principles: [
                {
                    title: 'Two Steps to Freedom!',
                    content: 'In 2x + 4 = 18, x is trapped by TWO operations:<br>1. It\'s being <strong>multiplied</strong> by 2<br>2. Then 4 is being <strong>added</strong><br><br>We need to undo BOTH operations to free x!'
                },
                {
                    title: 'Order Matters - Work Backwards!',
                    content: 'Use <strong>reverse BOMDAS</strong>:<br>â€¢ Addition/Subtraction was done LAST, so undo it FIRST<br>â€¢ Multiplication/Division was done FIRST, so undo it LAST<br><br>Think of getting dressed: you put socks on first, then shoes. To undress, you take shoes off FIRST, then socks!'
                },
                {
                    title: 'The Two-Step Process',
                    content: '<strong>Step 1:</strong> Undo addition/subtraction (get 2x = something)<br><strong>Step 2:</strong> Undo multiplication/division (get x = something)'
                }
            ],
            
            examples: [
                {
                    question: 'Solve: 2x + 4 = 18',
                    steps: [
                        '<strong>STEP 1 - Remove the +4:</strong>',
                        'Subtract 4 from both sides: 2x + 4 - 4 = 18 - 4',
                        'Simplifies to: 2x = 14',
                        '',
                        '<strong>STEP 2 - Remove the Ã—2:</strong>',
                        'Divide both sides by 2: 2x Ã· 2 = 14 Ã· 2',
                        'Simplifies to: x = 7',
                        '',
                        '<strong>CHECK:</strong> Does 2(7) + 4 = 18? â†’ 14 + 4 = 18 âœ“'
                    ],
                    answer: 'x = 7'
                },
                {
                    question: 'Solve: 6x + 6 = 72',
                    steps: [
                        '<strong>STEP 1 - Remove the +6:</strong>',
                        'Subtract 6 from both sides: 6x + 6 - 6 = 72 - 6',
                        'Simplifies to: 6x = 66',
                        '',
                        '<strong>STEP 2 - Remove the Ã—6:</strong>',
                        'Divide both sides by 6: 6x Ã· 6 = 66 Ã· 6',
                        'Simplifies to: x = 11',
                        '',
                        '<strong>CHECK:</strong> Does 6(11) + 6 = 72? â†’ 66 + 6 = 72 âœ“'
                    ],
                    answer: 'x = 11'
                },
                {
                    question: 'Solve: 4x + 1 = 45',
                    steps: [
                        '<strong>STEP 1:</strong> Subtract 1 from both sides',
                        '4x = 44',
                        '',
                        '<strong>STEP 2:</strong> Divide both sides by 4',
                        'x = 11',
                        '',
                        '<strong>CHECK:</strong> 4(11) + 1 = 44 + 1 = 45 âœ“'
                    ],
                    answer: 'x = 11'
                }
            ],
            
            tips: [
                'âœ… ALWAYS do addition/subtraction FIRST, multiplication/division SECOND',
                'âœ… Write out each step clearly - rushing causes mistakes!',
                'âœ… Check your answer by substituting back into the original equation',
                'âš ï¸ Don\'t divide before subtracting - order matters!',
                'âš ï¸ Remember: "Undo" means do the opposite operation'
            ]
        },
        
        'advanced': {
            title: 'Equations with Brackets',
            introduction: 'Tackle <strong>equations with brackets</strong> like 2(x + 3) = 14. You\'ll learn to expand brackets first, then solve the resulting two-step equation.',
            
            principles: [
                {
                    title: 'Brackets First - Always!',
                    content: 'When you see brackets like 2(x + 3), you MUST expand them first.<br><strong>Expanding</strong> means multiplying everything inside the bracket by the number outside.<br>2(x + 3) becomes 2Ã—x + 2Ã—3 = 2x + 6'
                },
                {
                    title: 'The Three-Step Process',
                    content: '<strong>Step 1:</strong> Expand the brackets (multiply out)<br><strong>Step 2:</strong> Subtract/add to isolate the x term<br><strong>Step 3:</strong> Divide/multiply to find x'
                },
                {
                    title: 'Expanding Brackets',
                    content: 'Multiply the number OUTSIDE by EVERY term inside:<br>â€¢ 2(x + 3) = 2Ã—x + 2Ã—3 = 2x + 6<br>â€¢ 5(x + 2) = 5Ã—x + 5Ã—2 = 5x + 10<br>â€¢ 4(x + 1) = 4Ã—x + 4Ã—1 = 4x + 4'
                }
            ],
            
            examples: [
                {
                    question: 'Solve: 2(x + 3) = 14',
                    steps: [
                        '<strong>STEP 1 - Expand the brackets:</strong>',
                        'Multiply 2 by everything inside: 2Ã—x + 2Ã—3',
                        'This gives us: 2x + 6 = 14',
                        '',
                        '<strong>STEP 2 - Remove the +6:</strong>',
                        'Subtract 6 from both sides: 2x + 6 - 6 = 14 - 6',
                        'Simplifies to: 2x = 8',
                        '',
                        '<strong>STEP 3 - Remove the Ã—2:</strong>',
                        'Divide both sides by 2: 2x Ã· 2 = 8 Ã· 2',
                        'Therefore: x = 4',
                        '',
                        '<strong>CHECK:</strong> Does 2(4 + 3) = 14? â†’ 2(7) = 14 âœ“'
                    ],
                    answer: 'x = 4'
                },
                {
                    question: 'Solve: 5(x + 2) = 20',
                    steps: [
                        '<strong>STEP 1 - Expand brackets:</strong>',
                        '5Ã—x + 5Ã—2 = 5x + 10',
                        'Equation becomes: 5x + 10 = 20',
                        '',
                        '<strong>STEP 2 - Subtract 10:</strong>',
                        '5x + 10 - 10 = 20 - 10',
                        '5x = 10',
                        '',
                        '<strong>STEP 3 - Divide by 5:</strong>',
                        'x = 2',
                        '',
                        '<strong>CHECK:</strong> 5(2 + 2) = 5(4) = 20 âœ“'
                    ],
                    answer: 'x = 2'
                },
                {
                    question: 'Solve: 4(x + 1) = 32',
                    steps: [
                        '<strong>STEP 1:</strong> Expand: 4x + 4 = 32',
                        '',
                        '<strong>STEP 2:</strong> Subtract 4: 4x = 28',
                        '',
                        '<strong>STEP 3:</strong> Divide by 4: x = 7',
                        '',
                        '<strong>CHECK:</strong> 4(7 + 1) = 4(8) = 32 âœ“'
                    ],
                    answer: 'x = 7'
                }
            ],
            
            tips: [
                'âœ… ALWAYS expand brackets FIRST - this is the most important step!',
                'âœ… Multiply the outside number by EVERY term inside the brackets',
                'âœ… After expanding, you have a two-step equation - follow the two-step process',
                'âœ… Check by substituting your answer back into the ORIGINAL equation (with brackets)',
                'âš ï¸ Don\'t forget to multiply the number outside by BOTH terms inside',
                'âš ï¸ Common mistake: 2(x + 3) â‰  2x + 3 (you must multiply the 3 too!)'
            ]
        }
    },
    
    // ============================================
    // 3. SIMPLIFYING EXPRESSIONS  
    // ============================================
    'simplifying_expressions': {
        'beginner': {
            title: 'Collecting Like Terms',
            introduction: 'Learn to <strong>combine like terms</strong> by adding terms with the same variable: 6x + 9x = 15x',
            principles: [
                {title: 'Like Terms', content: 'Terms with the same letter can be combined. 6x and 9x are like terms.'},
                {title: 'How to Combine', content: 'Add the numbers, keep the letter: 6x + 9x = 15x'}
            ],
            examples: [
                {question: 'Simplify: 6x + 9x', steps: ['Both have x','Add: 6 + 9 = 15', 'Keep x'], answer: '15x'},
                {question: 'Simplify: 5x + 5x', steps: ['Add: 5 + 5 = 10'], answer: '10x'}
            ],
            tips: ['âœ… Only combine same letters', 'âš ï¸ Keep the letter in answer']
        },
        'intermediate': {
            title: 'Variables and Constants',
            introduction: 'Simplify expressions with <strong>both variables and numbers</strong>: 5x + 4 + 2x + 2',
            principles: [
                {title: 'Two Types', content: 'Variable terms (5x) and constants (4). Collect each separately.'}
            ],
            examples: [
                {question: '5x + 4 + 2x + 2', steps: ['x terms: 5x + 2x = 7x', 'Constants: 4 + 2 = 6'], answer: '7x + 6'}
            ],
            tips: ['âœ… Keep variables and numbers separate']
        },
        'advanced': {
            title: 'Expressions with Powers',
            introduction: 'Simplify expressions with <strong>xÂ²</strong> terms: 4xÂ² + 7x + 2xÂ²',
            principles: [
                {title: 'Different Powers', content: 'xÂ² and x are different! Combine xÂ² with xÂ², x with x.'}
            ],
            examples: [
                {question: '4xÂ² + 7x + 2xÂ² + 1x', steps: ['xÂ²: 4xÂ² + 2xÂ² = 6xÂ²', 'x: 7x + 1x = 8x'], answer: '6xÂ² + 8x'}
            ],
            tips: ['âœ… xÂ² and x are NOT the same', 'âœ… Write highest power first']
        }
    },
    
    // ============================================
    // 4. EXPANDING & FACTORISING
    // ============================================
    'expanding_factorising': {
        'beginner': {
            title: 'Expanding Brackets',
            introduction: 'Multiply everything inside by the outside number: 6(x + 9) = 6x + 54',
            principles: [
                {title: 'Distribution', content: 'Multiply outside number by EACH term inside'}
            ],
            examples: [
                {question: '6(x + 9)', steps: ['6 Ã— x = 6x', '6 Ã— 9 = 54'], answer: '6x + 54'}
            ],
            tips: ['âœ… Multiply ALL terms inside']
        },
        'intermediate': {
            title: 'Factorising',
            introduction: 'Find common factor and put outside brackets: 8x + 80 = 8(x + 10)',
            principles: [
                {title: 'Common Factor', content: 'Find biggest number that divides both terms'}
            ],
            examples: [
                {question: '8x + 80', steps: ['Common factor: 8', '8x Ã· 8 = x', '80 Ã· 8 = 10'], answer: '8(x + 10)'}
            ],
            tips: ['âœ… Check by expanding back']
        },
        'advanced': {
            title: 'Double Brackets (FOIL)',
            introduction: 'Expand using FOIL method: (x + 1)(x + 4) = xÂ² + 5x + 4',
            principles: [
                {title: 'FOIL', content: 'First, Outer, Inner, Last - multiply all combinations'}
            ],
            examples: [
                {question: '(x + 1)(x + 4)', steps: ['F: xÃ—x = xÂ²', 'O: xÃ—4 = 4x', 'I: 1Ã—x = 1x', 'L: 1Ã—4 = 4', 'Combine: xÂ² + 5x + 4'], answer: 'xÂ² + 5x + 4'}
            ],
            tips: ['âœ… Combine middle terms']
        }
    },
    
    // ============================================
    // 5. FUNCTIONS
    // ============================================
    'functions': {
        'beginner': {
            title: 'Function Notation',
            introduction: 'Learn what f(x) means. If f(x) = x + 5, find f(3).',
            principles: [
                {title: 'Functions', content: 'f(x) is a rule. f(3) means substitute 3 for x'}
            ],
            examples: [
                {question: 'f(x) = x + 5, find f(3)', steps: ['Replace x with 3', 'f(3) = 3 + 5 = 8'], answer: '8'}
            ],
            tips: ['âœ… Replace ALL x with the number']
        },
        'intermediate': {
            title: 'Evaluating Functions',
            introduction: 'Evaluate functions with multiplication: f(x) = 2x + 3',
            principles: [
                {title: 'BOMDAS', content: 'Multiply before adding'}
            ],
            examples: [
                {question: 'f(x) = 2x + 3, find f(4)', steps: ['f(4) = 2(4) + 3', '= 8 + 3 = 11'], answer: '11'}
            ],
            tips: ['âœ… Use brackets when substituting']
        },
        'advanced': {
            title: 'Complex Functions',
            introduction: 'Functions with powers: f(x) = xÂ² + 2x - 3',
            principles: [
                {title: 'Multiple Terms', content: 'Calculate each term separately'}
            ],
            examples: [
                {question: 'f(x) = xÂ² + 2x - 3, find f(-1)', steps: ['f(-1) = (-1)Â² + 2(-1) - 3', '= 1 - 2 - 3 = -4'], answer: '-4'}
            ],
            tips: ['âœ… Use brackets for negative numbers']
        }
    },
    
    // ============================================
    // 6. PATTERNS
    // ============================================
    'patterns': {
        'beginner': {
            title: 'Visual Patterns',
            introduction: 'Identify and continue patterns: ðŸŒŸ ðŸŒ™ ðŸŒŸ ðŸŒ™ ?',
            principles: [
                {title: 'Repeating Patterns', content: 'Look for what repeats'}
            ],
            examples: [
                {question: 'ðŸŒŸ ðŸŒ™ ðŸŒŸ ðŸŒ™ ?', steps: ['Pattern alternates', 'After ðŸŒ™ comes ðŸŒŸ'], answer: 'ðŸŒŸ'}
            ],
            tips: ['âœ… Look for repeats']
        },
        'intermediate': {
            title: 'Number Sequences',
            introduction: 'Find the pattern in number sequences: 3, 7, 11, 15...',
            principles: [
                {title: 'Common Difference', content: 'What do you add each time?'}
            ],
            examples: [
                {question: '3, 7, 11, 15, ?', steps: ['Difference: +4 each time', '15 + 4 = 19'], answer: '19'}
            ],
            tips: ['âœ… Check the difference between terms']
        },
        'advanced': {
            title: 'nth Term Formula',
            introduction: 'Find patterns in special sequences: 1, 4, 9, 16...',
            principles: [
                {title: 'Special Sequences', content: 'Square numbers: 1Â², 2Â², 3Â², 4Â²...'}
            ],
            examples: [
                {question: '1, 4, 9, 16, ?', steps: ['These are squares', '1Â², 2Â², 3Â², 4Â², 5Â²', 'Next: 5Â² = 25'], answer: '25'}
            ],
            tips: ['âœ… Look for squares, doubles, triangular numbers']
        }
    },
    
    // ============================================
    // 7. ARITHMETIC
    // ============================================
    'arithmetic': {
        'beginner': {
            title: 'Basic Addition',
            introduction: 'Master basic addition: 8 + 4 = 12',
            principles: [
                {title: 'Adding', content: 'Count forward from the first number'}
            ],
            examples: [
                {question: '8 + 4', steps: ['Start at 8', 'Count forward 4: 9, 10, 11, 12'], answer: '12'}
            ],
            tips: ['âœ… Count carefully']
        },
        'intermediate': {
            title: 'Adding Negative Numbers',
            introduction: 'Add positive and negative: -7 + 14',
            principles: [
                {title: 'Negatives', content: 'Adding negative = subtracting'}
            ],
            examples: [
                {question: '-7 + 14', steps: ['14 - 7 = 7'], answer: '7'}
            ],
            tips: ['âœ… Think of it as subtraction']
        },
        'advanced': {
            title: 'Adding Two Negatives',
            introduction: 'Add two negative numbers: (-5) + (-12)',
            principles: [
                {title: 'Two Negatives', content: 'Result gets more negative'}
            ],
            examples: [
                {question: '(-5) + (-12)', steps: ['Add magnitudes: 5 + 12 = 17', 'Make negative: -17'], answer: '-17'}
            ],
            tips: ['âœ… Both negative = more negative result']
        }
    },
    
    // ============================================
    // 8. BODMAS
    // ============================================
    'bodmas': {
        'beginner': {
            title: 'Order of Operations Basics',
            introduction: 'Learn BODMAS: Brackets, Order, Multiply/Divide, Add/Subtract',
            principles: [
                {title: 'BODMAS', content: 'Multiply before you add'}
            ],
            examples: [
                {question: '5 + 3 Ã— 2', steps: ['Multiply first: 3 Ã— 2 = 6', 'Then add: 5 + 6 = 11'], answer: '11'}
            ],
            tips: ['âœ… Always multiply/divide before add/subtract']
        },
        'intermediate': {
            title: 'Multiple Operations',
            introduction: 'Handle complex expressions: 20 - 4 Ã— 3 + 2',
            principles: [
                {title: 'Order Matters', content: 'Follow BODMAS strictly'}
            ],
            examples: [
                {question: '20 - 4 Ã— 3 + 2', steps: ['Multiply: 4 Ã— 3 = 12', '20 - 12 + 2', 'Left to right: 10'], answer: '10'}
            ],
            tips: ['âœ… Multiplication first']
        },
        'advanced': {
            title: 'With Powers',
            introduction: 'BODMAS with indices: 3 + 2Â² Ã— 5',
            principles: [
                {title: 'Powers First', content: 'After brackets, do powers (Order)'}
            ],
            examples: [
                {question: '3 + 2Â² Ã— 5', steps: ['Power: 2Â² = 4', 'Multiply: 4 Ã— 5 = 20', 'Add: 3 + 20 = 23'], answer: '23'}
            ],
            tips: ['âœ… Powers before multiplication']
        }
    },
    
    // ============================================
    // 9. FRACTIONS
    // ============================================
    'fractions': {
        'beginner': {
            title: 'Adding Fractions',
            introduction: 'Add fractions with same denominator: 1/4 + 1/4',
            principles: [
                {title: 'Same Denominator', content: 'Add numerators, keep denominator'}
            ],
            examples: [
                {question: '1/4 + 1/4', steps: ['Add tops: 1 + 1 = 2', 'Keep bottom: 4', 'Result: 2/4 = 1/2'], answer: '1/2'}
            ],
            tips: ['âœ… Simplify answer']
        },
        'intermediate': {
            title: 'Multiplying Fractions',
            introduction: 'Multiply fractions: 2/3 Ã— 3/4',
            principles: [
                {title: 'Multiply Across', content: 'Top Ã— top, bottom Ã— bottom'}
            ],
            examples: [
                {question: '2/3 Ã— 3/4', steps: ['2 Ã— 3 = 6', '3 Ã— 4 = 12', '6/12 = 1/2'], answer: '1/2'}
            ],
            tips: ['âœ… Simplify final answer']
        },
        'advanced': {
            title: 'Complex Fraction Operations',
            introduction: 'Combine operations with fractions',
            principles: [
                {title: 'BODMAS with Fractions', content: 'Follow operation order'}
            ],
            examples: [
                {question: '(2/3 + 1/4) Ã— 3/5', steps: ['Brackets first: 2/3 + 1/4 = 11/12', '11/12 Ã— 3/5 = 11/20'], answer: '11/20'}
            ],
            tips: ['âœ… Brackets first']
        }
    },
    
    // ============================================
    // 10. DECIMALS
    // ============================================
    'decimals': {
        'beginner': {
            title: 'Adding Decimals',
            introduction: 'Add decimal numbers: 4.5 + 1.0',
            principles: [
                {title: 'Line Up Points', content: 'Decimal points must line up vertically'}
            ],
            examples: [
                {question: '4.5 + 1.0', steps: ['Line up: 4.5', '       + 1.0', '       = 5.5'], answer: '5.5'}
            ],
            tips: ['âœ… Always line up decimal points']
        },
        'intermediate': {
            title: 'Multiplying Decimals',
            introduction: 'Multiply decimals by whole numbers: 4.9 Ã— 6',
            principles: [
                {title: 'Multiply Normally', content: 'Then place decimal point'}
            ],
            examples: [
                {question: '4.9 Ã— 6', steps: ['49 Ã— 6 = 294', 'One decimal place: 29.4'], answer: '29.4'}
            ],
            tips: ['âœ… Count decimal places']
        },
        'advanced': {
            title: 'Decimal Ã— Decimal',
            introduction: 'Multiply two decimals: 6.0 Ã— 0.8',
            principles: [
                {title: 'Count Places', content: 'Total decimal places in answer'}
            ],
            examples: [
                {question: '6.0 Ã— 0.8', steps: ['60 Ã— 8 = 480', 'Two places total: 4.80 = 4.8'], answer: '4.8'}
            ],
            tips: ['âœ… Add up all decimal places']
        }
    },
    
    // ============================================
    // 11. MULTIPLICATION & DIVISION
    // ============================================
    'multiplication_division': {
        'beginner': {
            title: 'Basic Multiplication',
            introduction: 'Master times tables: 2 Ã— 5 = 10',
            principles: [
                {title: 'Multiplication', content: 'Repeated addition'}
            ],
            examples: [
                {question: '2 Ã— 5', steps: ['2 + 2 + 2 + 2 + 2 = 10'], answer: '10'}
            ],
            tips: ['âœ… Learn times tables']
        },
        'intermediate': {
            title: 'Negative Number Rules',
            introduction: 'Multiply and divide with negatives',
            principles: [
                {title: 'Sign Rules', content: 'Positive Ã— Negative = Negative<br>Negative Ã— Negative = Positive'}
            ],
            examples: [
                {question: '-4 Ã— 5', steps: ['Different signs = negative', 'Answer: -20'], answer: '-20'}
            ],
            tips: ['âœ… Remember sign rules']
        },
        'advanced': {
            title: 'Two Negatives',
            introduction: 'Multiply two negative numbers',
            principles: [
                {title: 'Negative Ã— Negative', content: 'Always gives positive'}
            ],
            examples: [
                {question: '(-17) Ã— (-18)', steps: ['17 Ã— 18 = 306', 'Both negative = positive'], answer: '306'}
            ],
            tips: ['âœ… Negative Ã— Negative = Positive']
        }
    },
    
    // ============================================
    // 12. NUMBER SYSTEMS
    // ============================================
    'number_systems': {
        'beginner': {
            title: 'Natural Numbers',
            introduction: 'Learn about natural numbers: 1, 2, 3, 4...',
            principles: [
                {title: 'Natural Numbers', content: 'Counting numbers starting from 1'}
            ],
            examples: [
                {question: 'Smallest natural number?', steps: ['Natural numbers: 1, 2, 3...', 'Smallest is 1'], answer: '1'}
            ],
            tips: ['âœ… Start from 1']
        },
        'intermediate': {
            title: 'Integers and Operations',
            introduction: 'Work with positive and negative integers',
            principles: [
                {title: 'Integers', content: 'Include negative numbers, zero, positives'}
            ],
            examples: [
                {question: 'What is -8 + (-5)?', steps: ['Both negative', 'Add magnitudes: 8 + 5 = 13', 'Make negative: -13'], answer: '-13'}
            ],
            tips: ['âœ… Watch signs carefully']
        },
        'advanced': {
            title: 'Temperature Problems',
            introduction: 'Apply integers to real situations',
            principles: [
                {title: 'Real Applications', content: 'Temperature can go below zero'}
            ],
            examples: [
                {question: '3Â° colder than -5Â°C?', steps: ['-5 - 3 = -8'], answer: '-8Â°C'}
            ],
            tips: ['âœ… Colder = subtract']
        }
    },
    
    // ============================================
    // 13. SURDS
    // ============================================
    'surds': {
        'beginner': {
            title: 'Multiplying Surds',
            introduction: 'Multiply square roots: âˆš7 Ã— âˆš5',
            principles: [
                {title: 'Multiplication', content: 'âˆša Ã— âˆšb = âˆš(aÃ—b)'}
            ],
            examples: [
                {question: 'âˆš7 Ã— âˆš5', steps: ['âˆš7 Ã— âˆš5 = âˆš(7Ã—5)', '= âˆš35'], answer: 'âˆš35'}
            ],
            tips: ['âœ… Multiply under the root']
        },
        'intermediate': {
            title: 'Surds with Coefficients',
            introduction: 'Multiply surds with numbers: 3âˆš2 Ã— 2âˆš2',
            principles: [
                {title: 'Multiply Separately', content: 'Numbers together, surds together'}
            ],
            examples: [
                {question: '3âˆš2 Ã— 2âˆš2', steps: ['3 Ã— 2 = 6', 'âˆš2 Ã— âˆš2 = 2', '6 Ã— 2 = 12'], answer: '12'}
            ],
            tips: ['âœ… âˆš2 Ã— âˆš2 = 2']
        },
        'advanced': {
            title: 'Expanding with Surds',
            introduction: 'Use FOIL with surds: (3 + âˆš2)(5 + âˆš2)',
            principles: [
                {title: 'FOIL Method', content: 'Multiply all combinations'}
            ],
            examples: [
                {question: '(3 + âˆš2)(5 + âˆš2)', steps: ['F: 3Ã—5 = 15', 'O: 3Ã—âˆš2 = 3âˆš2', 'I: âˆš2Ã—5 = 5âˆš2', 'L: âˆš2Ã—âˆš2 = 2', 'Sum: 17 + 8âˆš2'], answer: '17 + 8âˆš2'}
            ],
            tips: ['âœ… Remember âˆš2 Ã— âˆš2 = 2']
        }
    },
    
    // ============================================
    // 14. COMPLEX NUMBERS INTRO
    // ============================================
    'complex_numbers_intro': {
        'beginner': {
            title: 'Imaginary Unit',
            introduction: 'Meet i, the imaginary unit: i = âˆš(-1)',
            principles: [
                {title: 'Definition', content: 'i is defined as âˆš(-1)<br>iÂ² = -1'}
            ],
            examples: [
                {question: 'What is iÂ²?', steps: ['By definition', 'iÂ² = -1'], answer: '-1'}
            ],
            tips: ['âœ… iÂ² always equals -1']
        },
        'intermediate': {
            title: 'Adding Complex Numbers',
            introduction: 'Add complex numbers: (2 + 3i) + (4 + 5i)',
            principles: [
                {title: 'Add Parts', content: 'Add real parts, add imaginary parts separately'}
            ],
            examples: [
                {question: '(2 + 3i) + (4 + 5i)', steps: ['Real: 2 + 4 = 6', 'Imaginary: 3i + 5i = 8i'], answer: '6 + 8i'}
            ],
            tips: ['âœ… Keep real and imaginary separate']
        },
        'advanced': {
            title: 'Dividing Complex Numbers',
            introduction: 'Divide complex numbers',
            principles: [
                {title: 'Simplification', content: 'Divide real and imaginary parts'}
            ],
            examples: [
                {question: '(6 + 3i) Ã· 3', steps: ['6/3 = 2', '3i/3 = i'], answer: '2 + i'}
            ],
            tips: ['âœ… Divide each part']
        }
    },
    
    // ============================================
    // 15. COMPLEX NUMBERS EXPANDED
    // ============================================
    'complex_numbers_expanded': {
        'beginner': {
            title: 'Argand Diagram',
            introduction: 'Plot complex numbers on Argand diagram',
            principles: [
                {title: 'Axes', content: 'Horizontal = real, Vertical = imaginary'}
            ],
            examples: [
                {question: 'Which axis is real?', steps: ['Real = horizontal (x-axis)'], answer: 'x-axis'}
            ],
            tips: ['âœ… x = real, y = imaginary']
        },
        'intermediate': {
            title: 'Multiplication by i',
            introduction: 'Understand i Ã— (complex number)',
            principles: [
                {title: 'Rotation', content: 'Multiplying by i rotates 90Â° counterclockwise'}
            ],
            examples: [
                {question: 'i Ã— (1 + 0i)', steps: ['i Ã— 1 = i'], answer: 'i'}
            ],
            tips: ['âœ… i rotates 90Â°']
        },
        'advanced': {
            title: 'Conjugates',
            introduction: 'Find conjugate of complex numbers',
            principles: [
                {title: 'Conjugate', content: 'Change sign of imaginary part'}
            ],
            examples: [
                {question: 'Conjugate of 4 + 7i?', steps: ['Change imaginary sign', '4 - 7i'], answer: '4 - 7i'}
            ],
            tips: ['âœ… Flip imaginary sign only']
        }
    },
    
    // ============================================
    // 16. DESCRIPTIVE STATISTICS
    // ============================================
    'descriptive_statistics': {
        'beginner': {
            title: 'Finding the Mean (Simple)',
            introduction: 'Calculate the mean (average) of small datasets',
            principles: [
                {title: 'Mean Formula', content: 'Add all numbers, divide by how many there are'}
            ],
            examples: [
                {question: 'Mean of: 2, 2, 5, 12, 17', steps: ['Sum: 2+2+5+12+17 = 38', 'Count: 5 numbers', 'Mean: 38 Ã· 5 = 7.6'], answer: '7.6'}
            ],
            tips: ['âœ… Add all, then divide by count']
        },
        'intermediate': {
            title: 'Mean of Larger Datasets',
            introduction: 'Calculate mean with more numbers',
            principles: [
                {title: 'Same Process', content: 'Still add and divide, just more numbers'}
            ],
            examples: [
                {question: 'Mean of: 20, 27, 30, 34, 36, 39, 58', steps: ['Sum = 244', 'Count = 7', 'Mean = 244 Ã· 7 = 34.9'], answer: '34.9'}
            ],
            tips: ['âœ… Be careful adding larger numbers']
        },
        'advanced': {
            title: 'Mean with Decimals',
            introduction: 'Calculate mean of decimal numbers',
            principles: [
                {title: 'Decimal Data', content: 'Same method, careful with decimal arithmetic'}
            ],
            examples: [
                {question: 'Mean of: 12.1, 15.8, 20.0, 21.8, 41.8', steps: ['Sum = 111.5', 'Count = 5', 'Mean = 22.3'], answer: '22.3'}
            ],
            tips: ['âœ… Use calculator for decimal sums']
        }
    },
    
    // ============================================
    // 17. PROBABILITY
    // ============================================
    'probability': {
        'beginner': {
            title: 'Simple Probability',
            introduction: 'Calculate basic probabilities: coin flips, dice',
            principles: [
                {title: 'Probability', content: 'P = favorable outcomes / total outcomes'}
            ],
            examples: [
                {question: 'P(heads on coin flip)?', steps: ['Favorable: 1 (heads)', 'Total: 2 (heads or tails)', 'P = 1/2'], answer: '1/2'}
            ],
            tips: ['âœ… Count carefully']
        },
        'intermediate': {
            title: 'Compound Probability',
            introduction: 'Two or more events: multiply probabilities',
            principles: [
                {title: 'AND Rule', content: 'P(A and B) = P(A) Ã— P(B)'}
            ],
            examples: [
                {question: 'Two heads in a row?', steps: ['P(H) = 1/2', 'P(H and H) = 1/2 Ã— 1/2 = 1/4'], answer: '1/4'}
            ],
            tips: ['âœ… Multiply for "and"']
        },
        'advanced': {
            title: 'Conditional Probability',
            introduction: 'Probability that depends on previous events',
            principles: [
                {title: 'Without Replacement', content: 'Probability changes after first draw'}
            ],
            examples: [
                {question: 'Two aces without replacement', steps: ['P(1st ace) = 4/52', 'P(2nd ace) = 3/51', 'P(both) = 4/52 Ã— 3/51 = 1/221'], answer: '1/221'}
            ],
            tips: ['âœ… Update probabilities after each event']
        }
    },
    
    // ============================================
    // 18. SETS
    // ============================================
    'sets': {
        'beginner': {
            title: 'Union and Intersection',
            introduction: 'Combine sets or find common elements',
            principles: [
                {title: 'Union (âˆª)', content: 'All elements from both sets'},
                {title: 'Intersection (âˆ©)', content: 'Only common elements'}
            ],
            examples: [
                {question: '{1,2,3} âˆª {3,4,5}?', steps: ['Combine all', 'Remove duplicates'], answer: '{1,2,3,4,5}'},
                {question: '{1,2,3} âˆ© {3,4,5}?', steps: ['Only common'], answer: '{3}'}
            ],
            tips: ['âœ… Union = all, Intersection = common']
        },
        'intermediate': {
            title: 'Set Difference',
            introduction: 'Elements in A but not in B: A - B',
            principles: [
                {title: 'Difference', content: 'In first set but not second'}
            ],
            examples: [
                {question: 'A={1,2,3,4}, B={3,4,5,6}, A-B?', steps: ['In A: 1,2,3,4', 'Remove what is in B: remove 3,4'], answer: '{1,2}'}
            ],
            tips: ['âœ… Start with first set, remove second']
        },
        'advanced': {
            title: 'Cardinality Formulas',
            introduction: 'Count elements using formulas',
            principles: [
                {title: 'Formula', content: '|A âˆª B| = |A| + |B| - |A âˆ© B|'}
            ],
            examples: [
                {question: '|A|=5, |B|=7, |Aâˆ©B|=3, |AâˆªB|?', steps: ['5 + 7 - 3 = 9'], answer: '9'}
            ],
            tips: ['âœ… Subtract intersection to avoid double counting']
        }
    }
    
    // FUTURE TOPICS - Just add them here following the same structure:
    /*
    'patterns': {
        'beginner': { ... },
        'intermediate': { ... },
        'advanced': { ... }
    },
    'functions': {
        'beginner': { ... },
        'intermediate': { ... },
        'advanced': { ... }
    }
    */
};

// Export for use in other scripts
if (typeof module !== 'undefined' && module.exports) {
    module.exports = TUTORIALS;
}

</script>

<!-- TUTORIAL MODAL COMPONENT -->
<!-- Add this to student_app.html, just before the closing 
<!-- Smart Quiz Modal (Adaptive Learning) -->
<div id="smartQuizModal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-md w-full p-6 transform transition-all">
        <div class="text-center mb-6">
            <div class="text-6xl mb-4">ðŸ§ </div>
            <h2 class="text-2xl font-bold text-gray-800">Smart Quiz</h2>
            <p class="text-gray-600 mt-2">AI-powered personalised learning</p>
        </div>
        
        <!-- Mode Selection -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Choose your focus:</label>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="setSmartQuizMode('auto')" class="smart-mode-btn p-3 rounded-lg border-2 border-green-400 bg-green-50 transition-all text-left" data-mode="auto">
                    <div class="text-xl">ðŸŽ¯</div>
                    <div class="text-sm font-medium">Auto</div>
                    <div class="text-xs text-gray-500">Best overall pick</div>
                </button>
                <button onclick="setSmartQuizMode('review')" class="smart-mode-btn p-3 rounded-lg border-2 border-gray-200 hover:border-green-400 transition-all text-left" data-mode="review">
                    <div class="text-xl">ðŸ”„</div>
                    <div class="text-sm font-medium">Review</div>
                    <div class="text-xs text-gray-500">Refresh memory</div>
                </button>
                <button onclick="setSmartQuizMode('practice')" class="smart-mode-btn p-3 rounded-lg border-2 border-gray-200 hover:border-green-400 transition-all text-left" data-mode="practice">
                    <div class="text-xl">ðŸ’ª</div>
                    <div class="text-sm font-medium">Practice</div>
                    <div class="text-xs text-gray-500">Work on weak areas</div>
                </button>
                <button onclick="setSmartQuizMode('challenge')" class="smart-mode-btn p-3 rounded-lg border-2 border-gray-200 hover:border-green-400 transition-all text-left" data-mode="challenge">
                    <div class="text-xl">ðŸš€</div>
                    <div class="text-sm font-medium">Challenge</div>
                    <div class="text-xs text-gray-500">Push your limits</div>
                </button>
            </div>
        </div>
        
        <!-- Loading State -->
        <div id="smartQuizLoading" class="bg-gray-100 rounded-xl p-6 mb-6 text-center">
            <div class="animate-spin text-4xl mb-2">âš™ï¸</div>
            <p class="text-gray-600">Analysing your progress...</p>
        </div>
        
        <!-- Error State -->
        <div id="smartQuizError" class="hidden bg-red-50 text-red-600 rounded-xl p-4 mb-6 text-center">
            Error loading recommendation
        </div>
        
        <!-- Recommendation Content -->
        <div id="smartQuizContent" class="hidden bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 mb-6">
            <h3 class="font-bold text-gray-800 mb-3">ðŸ“Š Recommended for You:</h3>
            <div class="space-y-3">
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">Topic:</span>
                    <span id="smartQuizTopic" class="font-bold text-gray-800">Loading...</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">Difficulty:</span>
                    <span id="smartQuizDifficulty" class="px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-700">Loading...</span>
                </div>
                <div id="smartQuizMasteryContainer" class="hidden text-center pt-2 border-t border-green-200">
                    <span id="smartQuizMastery" class="text-sm text-gray-600">Current mastery: 0%</span>
                </div>
                <div class="pt-2 border-t border-green-200">
                    <p id="smartQuizReason" class="text-sm text-gray-600 italic">Loading reason...</p>
                </div>
            </div>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeSmartQuizModal()" class="flex-1 py-3 px-6 rounded-xl border-2 border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-all">
                Cancel
            </button>
            <button onclick="startSmartQuiz()" class="flex-1 py-3 px-6 rounded-xl bg-gradient-to-r from-green-500 to-emerald-500 text-white font-bold hover:from-green-600 hover:to-emerald-600 transition-all">
                ðŸ§  Start!
            </button>
        </div>
    </div>
</div>

</body> tag -->

<!-- Tutorial Splash Screen Modal -->
<div id="tutorialModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" style="display: none;">
    <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col">
        <!-- Header -->
        <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-6 py-4 flex justify-between items-center">
            <div class="flex items-center">
                <i class="fas fa-book-open text-2xl mr-3"></i>
                <h2 id="tutorialTitle" class="text-2xl font-bold">Tutorial</h2>
            </div>
            <button onclick="closeTutorial()" class="text-white hover:text-gray-200 text-2xl">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <!-- Content (Scrollable) -->
        <div class="flex-1 overflow-y-auto p-6">
            <!-- Introduction -->
            <div id="tutorialIntro" class="mb-6 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                <!-- Dynamic content -->
            </div>
            
            <!-- Key Principles -->
            <div class="mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                    Key Principles
                </h3>
                <div id="tutorialPrinciples" class="space-y-3">
                    <!-- Dynamic content -->
                </div>
            </div>
            
            <!-- Worked Examples -->
            <div class="mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-check-circle text-green-500 mr-2"></i>
                    Worked Examples
                </h3>
                <div id="tutorialExamples" class="space-y-4">
                    <!-- Dynamic content -->
                </div>
            </div>
            
            <!-- Tips -->
            <div class="mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-star text-purple-500 mr-2"></i>
                    Quick Tips
                </h3>
                <div id="tutorialTips" class="space-y-2">
                    <!-- Dynamic content -->
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="bg-gray-50 px-6 py-4 border-t">
            <div class="flex items-center justify-between">
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" id="dontShowAgain" class="mr-2 w-4 h-4">
                    <span class="text-sm text-gray-600">Don't show this automatically again</span>
                </label>
                <button onclick="startTutorialQuiz()" class="bg-gradient-to-r from-purple-600 to-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:shadow-lg transition-all">
                    Got It - Start Quiz! ðŸš€
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Floating Help Button (shown during quiz) -->
<button id="tutorialHelpBtn" class="fixed bottom-6 left-6 bg-purple-600 text-white px-4 py-3 rounded-full shadow-lg hover:shadow-xl transition-all z-40 hidden" onclick="showTutorialModal()">
    <i class="fas fa-book-open mr-2"></i>
    Need Help?
</button>

<style>
/* Tutorial Modal Styles */
#tutorialModal.flex {
    display: flex !important;
}

.tutorial-principle {
    background: white;
    border-left: 4px solid #9333ea;
    padding: 1rem;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.tutorial-example {
    background: #f0fdf4;
    border: 2px solid #86efac;
    border-radius: 0.75rem;
    padding: 1.25rem;
}

.tutorial-example-question {
    font-weight: 600;
    color: #047857;
    margin-bottom: 0.75rem;
    font-size: 1.1rem;
}

.tutorial-example-steps {
    background: white;
    padding: 1rem;
    border-radius: 0.5rem;
    margin: 0.75rem 0;
}

.tutorial-example-step {
    padding: 0.5rem 0;
    padding-left: 1.5rem;
    position: relative;
    color: #374151;
}

.tutorial-example-step:before {
    content: "â†’";
    position: absolute;
    left: 0;
    color: #9333ea;
    font-weight: bold;
}

.tutorial-example-answer {
    background: #dcfce7;
    padding: 0.75rem;
    border-radius: 0.5rem;
    font-weight: 700;
    color: #047857;
    text-align: center;
    font-size: 1.1rem;
}

.tutorial-tip {
    padding: 0.75rem;
    padding-left: 2.5rem;
    background: white;
    border-radius: 0.5rem;
    position: relative;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}

.tutorial-tip:before {
    content: attr(data-icon);
    position: absolute;
    left: 0.75rem;
    font-size: 1.2rem;
}

/* Floating Help Button Animation */
#tutorialHelpBtn {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.05);
    }
}

/* Responsive */
@media (max-width: 768px) {
    #tutorialModal > div {
        max-width: 100%;
        margin: 1rem;
    }
}
</style>


<!-- Tutorial Manager -->
<script>
/**
 * TUTORIAL MANAGER
 * 
 * Handles showing/hiding tutorials based on topic and difficulty.
 * Uses localStorage to remember user preferences.
 * 
 * HOW TO USE:
 * 1. Include tutorial_data.js first
 * 2. Include this script
 * 3. Call initTutorial(topic, difficulty) when starting a quiz
 * 
 * Example: initTutorial('introductory_algebra', 'beginner')
 */

class TutorialManager {
    constructor() {
        this.currentTopic = null;
        this.currentDifficulty = null;
        this.storageKey = 'agentmath_tutorial_prefs';
    }
    
    /**
     * Initialize tutorial for a topic/difficulty
     * Shows tutorial if user hasn't disabled it
     */
    initTutorial(topic, difficulty) {
        this.currentTopic = topic;
        this.currentDifficulty = difficulty;
        
        // Check if tutorial exists for this topic/difficulty
        if (!TUTORIALS[topic] || !TUTORIALS[topic][difficulty]) {
            console.log(`No tutorial available for ${topic} - ${difficulty}`);
            return;
        }
        
        // Check if user has disabled auto-show for this combination
        if (!this.shouldShowAuto(topic, difficulty)) {
            console.log(`Tutorial auto-show disabled for ${topic} - ${difficulty}`);
            this.showHelpButton(); // Still show the help button
            return;
        }
        
        // Show the tutorial
        this.showTutorial(topic, difficulty);
    }
    
    /**
     * Check if tutorial should auto-show
     */
    shouldShowAuto(topic, difficulty) {
        const prefs = this.getPreferences();
        const key = `${topic}_${difficulty}`;
        return !prefs[key]; // Show if NOT in preferences (not disabled)
    }
    
    /**
     * Get user preferences from localStorage
     */
    getPreferences() {
        const stored = localStorage.getItem(this.storageKey);
        return stored ? JSON.parse(stored) : {};
    }
    
    /**
     * Save preference to not show tutorial auto for this topic/difficulty
     */
    savePreference(topic, difficulty, dontShow) {
        const prefs = this.getPreferences();
        const key = `${topic}_${difficulty}`;
        
        if (dontShow) {
            prefs[key] = true;
        } else {
            delete prefs[key];
        }
        
        localStorage.setItem(this.storageKey, JSON.stringify(prefs));
    }
    
    /**
     * Show the tutorial modal
     */
    showTutorial(topic, difficulty) {
        topic = topic || this.currentTopic;
        difficulty = difficulty || this.currentDifficulty;
        
        const tutorialData = TUTORIALS[topic][difficulty];
        if (!tutorialData) {
            console.error(`No tutorial data found for ${topic} - ${difficulty}`);
            return;
        }
        
        // Populate modal content
        this.populateModal(tutorialData);
        
        // Show modal
        const modal = document.getElementById('tutorialModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        
        // Hide help button while modal is open
        this.hideHelpButton();
    }
    
    /**
     * Populate the modal with tutorial content
     */
    populateModal(data) {
        // Title
        document.getElementById('tutorialTitle').textContent = data.title;
        
        // Introduction
        document.getElementById('tutorialIntro').innerHTML = `
            <p class="text-gray-700">${data.introduction}</p>
        `;
        
        // Principles
        const principlesHTML = data.principles.map(principle => `
            <div class="tutorial-principle">
                <h4 class="font-semibold text-purple-700 mb-2">${principle.title}</h4>
                <p class="text-gray-700">${principle.content}</p>
            </div>
        `).join('');
        document.getElementById('tutorialPrinciples').innerHTML = principlesHTML;
        
        // Examples
        const examplesHTML = data.examples.map((example, idx) => `
            <div class="tutorial-example">
                <div class="tutorial-example-question">
                    Example ${idx + 1}: ${example.question}
                </div>
                <div class="tutorial-example-steps">
                    ${example.steps.map(step => `
                        <div class="tutorial-example-step">${step}</div>
                    `).join('')}
                </div>
                <div class="tutorial-example-answer">
                    Answer: ${example.answer}
                </div>
            </div>
        `).join('');
        document.getElementById('tutorialExamples').innerHTML = examplesHTML;
        
        // Tips
        const tipsHTML = data.tips.map(tip => {
            const icon = tip.startsWith('âœ…') ? 'âœ…' : 'âš ï¸';
            return `<div class="tutorial-tip" data-icon="${icon}">${tip.substring(2)}</div>`;
        }).join('');
        document.getElementById('tutorialTips').innerHTML = tipsHTML;
    }
    
    /**
     * Close the tutorial modal
     */
    closeTutorial() {
        // Check if "don't show again" is checked
        const dontShowAgain = document.getElementById('dontShowAgain').checked;
        if (dontShowAgain && this.currentTopic && this.currentDifficulty) {
            this.savePreference(this.currentTopic, this.currentDifficulty, true);
        }
        
        // Hide modal
        const modal = document.getElementById('tutorialModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        
        // Show help button
        this.showHelpButton();
    }
    
    /**
     * Start the quiz (close tutorial and begin)
     */
    startQuiz() {
        this.closeTutorial();
        // The quiz should already be loaded, just hidden behind modal
    }
    
    /**
     * Show the floating help button
     */
    showHelpButton() {
        if (this.currentTopic && this.currentDifficulty) {
            document.getElementById('tutorialHelpBtn').classList.remove('hidden');
        }
    }
    
    /**
     * Hide the floating help button
     */
    hideHelpButton() {
        document.getElementById('tutorialHelpBtn').classList.add('hidden');
    }
    
    /**
     * Reset all preferences (for testing)
     */
    resetAllPreferences() {
        localStorage.removeItem(this.storageKey);
        console.log('All tutorial preferences cleared');
    }
}

// Create global instance
const tutorialManager = new TutorialManager();

// Global functions for onclick handlers
function showTutorialModal() {
    tutorialManager.showTutorial();
}

function closeTutorial() {
    tutorialManager.closeTutorial();
}

function startTutorialQuiz() {
    tutorialManager.startQuiz();
}

function initTutorial(topic, difficulty) {
    tutorialManager.initTutorial(topic, difficulty);
}

// For debugging/testing
function resetTutorialPreferences() {
    tutorialManager.resetAllPreferences();
}

console.log('Tutorial Manager initialized');

</script>

<!-- ========================================== -->
<!-- END TUTORIAL SYSTEM -->
<!-- ========================================== -->

<!-- WHO AM I: JavaScript for reveal functionality -->
<script src="{{ url_for('static', filename='js/who_am_i.js') }}"></script>

<!-- AVATAR: JavaScript for avatar rendering -->
{% if feature_flags.AVATAR_SYSTEM_ENABLED %}
<script src="{{ url_for('static', filename='js/avatar.js') }}"></script>
<script>
    // Store current avatar config globally for quiz header
    window.currentAvatarConfig = null;
    
    // Store points before quiz for unlock detection
    let pointsBeforeQuiz = 0;
    
    // Load and render avatar on page load
    async function loadUserAvatar() {
        try {
            const response = await fetch('/api/avatar/equipped');
            const data = await response.json();
            
            if (data.success && data.equipped) {
                const config = data.equipped;
                window.currentAvatarConfig = config; // Store for quiz header
                
                // Render in header
                const headerAvatar = document.getElementById('header-avatar');
                if (headerAvatar && typeof AvatarRenderer !== 'undefined') {
                    AvatarRenderer.render(headerAvatar, config, 'small');
                }
                
                // Render in results screen
                const resultsAvatar = document.getElementById('results-avatar');
                if (resultsAvatar && typeof AvatarRenderer !== 'undefined') {
                    AvatarRenderer.render(resultsAvatar, config, 'large');
                }
                
                // Render in quiz header if visible
                const quizHeaderAvatar = document.getElementById('quiz-header-avatar');
                if (quizHeaderAvatar && typeof AvatarRenderer !== 'undefined') {
                    AvatarRenderer.render(quizHeaderAvatar, config, 'small');
                }
            }
        } catch (error) {
            console.log('Avatar loading skipped:', error.message);
        }
    }
    
    // Get current points before quiz starts
    async function getPointsBeforeQuiz() {
        try {
            const response = await fetch('/api/avatar/inventory');
            const data = await response.json();
            if (data.points !== undefined) {
                pointsBeforeQuiz = data.points;
                console.log('ðŸ“Š Points before quiz:', pointsBeforeQuiz);
            }
        } catch (error) {
            console.log('Could not get points:', error);
        }
    }
    
    // Check for newly affordable items after quiz
    async function checkForNewUnlocks(newTotalPoints) {
        try {
            const response = await fetch('/api/avatar/items');
            const data = await response.json();
            
            if (data.items) {
                // Find items that are now affordable but weren't before
                const newlyAffordable = data.items.filter(item => 
                    item.point_cost > pointsBeforeQuiz && 
                    item.point_cost <= newTotalPoints &&
                    !item.is_default
                );
                
                if (newlyAffordable.length > 0) {
                    const banner = document.getElementById('new-unlock-banner');
                    const message = document.getElementById('unlock-message');
                    if (banner && message) {
                        const itemNames = newlyAffordable.slice(0, 3).map(i => i.display_name).join(', ');
                        message.textContent = `You can now afford: ${itemNames}${newlyAffordable.length > 3 ? ' and more!' : '!'}`;
                        banner.classList.remove('hidden');
                    }
                }
            }
        } catch (error) {
            console.log('Could not check for unlocks:', error);
        }
    }
    
    // Load avatar when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        loadUserAvatar();
    });
    
    // Also refresh avatar after quiz results are shown (in case of new unlocks)
    const originalShowResults = typeof showResults === 'function' ? showResults : null;
    if (originalShowResults) {
        window.showResults = function() {
            originalShowResults.apply(this, arguments);
            loadUserAvatar(); // Refresh avatar display
        };
    }
</script>
{% endif %}

<!-- PUZZLE OF THE WEEK: Splash Modal -->
<div id="puzzle-splash-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden">
        <div class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-6 text-center">
            <i class="fas fa-puzzle-piece text-5xl mb-3"></i>
            <h2 class="text-2xl font-bold">ðŸ§© Puzzle of the Week</h2>
            <p class="text-purple-200 mt-1">Week <span id="splash-puzzle-week">--</span>, <span id="splash-puzzle-year">----</span></p>
        </div>
        <div class="p-6">
            <h3 id="splash-puzzle-title" class="text-xl font-bold text-gray-800 mb-2 text-center">--</h3>
            <p id="splash-puzzle-description" class="text-gray-600 text-center mb-4"></p>
            
            <!-- Puzzle Content -->
            <div id="splash-puzzle-content" class="border rounded-xl p-4 bg-gray-50 mb-4 min-h-48 flex items-center justify-center">
                <!-- Puzzle image or text will be inserted here -->
            </div>
            
            <!-- Hint Button -->
            <div id="splash-hint-section" class="hidden">
                <button id="splash-hint-btn" onclick="viewPuzzleHint()" class="w-full bg-yellow-100 text-yellow-700 py-2 rounded-lg hover:bg-yellow-200 transition mb-4">
                    <i class="fas fa-lightbulb mr-2"></i>Need a Hint?
                </button>
                <div id="splash-hint-content" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                    <p class="font-semibold text-yellow-800 mb-1"><i class="fas fa-lightbulb mr-2"></i>Hint:</p>
                    <p id="splash-hint-text" class="text-yellow-700"></p>
                </div>
            </div>
            
            <!-- Answer reveal info -->
            <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-4 text-center">
                <p class="text-green-700 text-sm">
                    <i class="fas fa-gift mr-2"></i><strong>Complete any quiz</strong> to unlock the answer!
                </p>
            </div>
            
            <div class="flex gap-3">
                <button onclick="closePuzzleSplash(true)" class="flex-1 bg-purple-600 text-white py-3 rounded-xl font-semibold hover:bg-purple-700 transition">
                    Continue to Quiz
                </button>
                <button onclick="closePuzzleSplash(false)" class="bg-gray-200 text-gray-700 px-6 py-3 rounded-xl hover:bg-gray-300 transition text-sm">
                    Don't show<br>this week
                </button>
            </div>
        </div>
    </div>
</div>

<!-- PUZZLE OF THE WEEK: Answer Reveal Modal -->
<div id="puzzle-answer-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden">
        <div class="bg-gradient-to-r from-green-500 to-teal-500 text-white p-6 text-center">
            <i class="fas fa-check-circle text-5xl mb-3"></i>
            <h2 class="text-2xl font-bold">Puzzle Answer Revealed!</h2>
        </div>
        <div class="p-6">
            <h3 id="answer-puzzle-title" class="text-xl font-bold text-gray-800 mb-4 text-center">--</h3>
            
            <!-- Answer Content -->
            <div id="answer-puzzle-content" class="border-2 border-green-200 rounded-xl p-4 bg-green-50 mb-4 min-h-48">
                <!-- Answer image or text will be inserted here -->
            </div>
            
            <button onclick="closeAnswerModal()" class="w-full bg-green-600 text-white py-3 rounded-xl font-semibold hover:bg-green-700 transition">
                <i class="fas fa-check mr-2"></i>Got It!
            </button>
        </div>
    </div>
</div>

<!-- PUZZLE OF THE WEEK: Indicator (shows when puzzle is available) -->
<div id="puzzle-indicator" class="fixed bottom-20 right-4 z-50 hidden">
    <button onclick="showPuzzleSplash()" class="bg-purple-600 text-white p-4 rounded-full shadow-xl hover:bg-purple-700 transition transform hover:scale-110 animate-bounce" title="View Puzzle of the Week" style="animation-duration: 2s;">
        <i class="fas fa-puzzle-piece text-2xl"></i>
    </button>
    <span class="absolute -top-1 -right-1 bg-yellow-400 text-yellow-900 text-xs font-bold px-2 py-1 rounded-full">ðŸ§©</span>
</div>

<!-- PUZZLE OF THE WEEK: JavaScript -->
<script>
    // Puzzle state
    let puzzleData = null;
    let puzzleStatus = null;

    // Check for puzzle on page load
    async function checkPuzzleStatus() {
        try {
            console.log('Checking puzzle status...');
            const response = await fetch('/api/puzzle/status');
            puzzleStatus = await response.json();
            console.log('Puzzle status:', puzzleStatus);
            
            if (puzzleStatus.has_puzzle && puzzleStatus.puzzle) {
                puzzleData = puzzleStatus.puzzle;
                console.log('Puzzle data loaded:', puzzleData.title);
                
                // Show splash if not dismissed
                if (puzzleStatus.show_popup) {
                    console.log('Showing puzzle splash popup');
                    showPuzzleSplash();
                }
                
                // Show indicator if puzzle available but dismissed (or after closing splash)
                if (!puzzleStatus.show_popup && !puzzleStatus.already_revealed) {
                    console.log('Showing puzzle indicator (popup dismissed, answer not revealed)');
                    document.getElementById('puzzle-indicator').classList.remove('hidden');
                }
            } else {
                console.log('No active puzzle');
            }
        } catch (error) {
            console.error('Error checking puzzle status:', error);
        }
    }

    function showPuzzleSplash() {
        if (!puzzleData) return;
        
        // Populate splash modal
        document.getElementById('splash-puzzle-week').textContent = puzzleData.week_number;
        document.getElementById('splash-puzzle-year').textContent = puzzleData.year;
        document.getElementById('splash-puzzle-title').textContent = puzzleData.title || 'Weekly Challenge';
        document.getElementById('splash-puzzle-description').textContent = puzzleData.description || '';
        
        // Show puzzle content
        const contentDiv = document.getElementById('splash-puzzle-content');
        if (puzzleData.puzzle_type === 'image' && puzzleData.puzzle_image) {
            contentDiv.innerHTML = `<img src="${puzzleData.puzzle_image}" alt="Puzzle" class="max-w-full max-h-96 rounded-lg">`;
        } else if (puzzleData.puzzle_text) {
            contentDiv.innerHTML = `<pre class="whitespace-pre-wrap font-mono text-lg text-center">${escapeHtmlPuzzle(puzzleData.puzzle_text)}</pre>`;
        } else {
            contentDiv.innerHTML = '<p class="text-gray-500 italic">No puzzle content available</p>';
        }
        
        // Show hint section if hint available
        if (puzzleStatus && puzzleStatus.hint_available) {
            document.getElementById('splash-hint-section').classList.remove('hidden');
            if (puzzleStatus.hint_viewed && puzzleData.hint) {
                document.getElementById('splash-hint-content').classList.remove('hidden');
                document.getElementById('splash-hint-text').textContent = puzzleData.hint;
                document.getElementById('splash-hint-btn').innerHTML = '<i class="fas fa-lightbulb mr-2"></i>Hint (Viewed)';
            }
        }
        
        document.getElementById('puzzle-splash-modal').classList.remove('hidden');
        document.getElementById('puzzle-indicator').classList.add('hidden');
    }

    function closePuzzleSplash(continueOnly = true) {
        document.getElementById('puzzle-splash-modal').classList.add('hidden');
        
        if (!continueOnly) {
            // Dismiss for this week
            fetch('/api/puzzle/dismiss-popup', { method: 'POST' });
        }
        
        // Show indicator if not revealed
        console.log('closePuzzleSplash - puzzleStatus:', puzzleStatus);
        if (puzzleStatus && !puzzleStatus.already_revealed) {
            console.log('Showing puzzle indicator');
            document.getElementById('puzzle-indicator').classList.remove('hidden');
        }
    }

    async function viewPuzzleHint() {
        try {
            const response = await fetch('/api/puzzle/view-hint', { method: 'POST' });
            const result = await response.json();
            
            if (result.success && result.hint) {
                document.getElementById('splash-hint-content').classList.remove('hidden');
                document.getElementById('splash-hint-text').textContent = result.hint;
                document.getElementById('splash-hint-btn').innerHTML = '<i class="fas fa-lightbulb mr-2"></i>Hint (Viewed)';
            }
        } catch (error) {
            console.error('Error viewing hint:', error);
        }
    }

    // Called from results screen
    async function revealPuzzleAnswer() {
        try {
            const response = await fetch('/api/puzzle/reveal-answer', { method: 'POST' });
            const result = await response.json();
            
            if (result.success) {
                // Hide the offer
                document.getElementById('puzzle-answer-offer').style.display = 'none';
                document.getElementById('puzzle-indicator').classList.add('hidden');
                
                // Show answer modal
                document.getElementById('answer-puzzle-title').textContent = puzzleData ? puzzleData.title : 'Puzzle Answer';
                
                const contentDiv = document.getElementById('answer-puzzle-content');
                if (result.answer_image) {
                    contentDiv.innerHTML = `<img src="${result.answer_image}" alt="Answer" class="max-w-full max-h-96 rounded-lg mx-auto">`;
                } else if (result.answer_text) {
                    contentDiv.innerHTML = `<pre class="whitespace-pre-wrap font-mono text-lg">${escapeHtmlPuzzle(result.answer_text)}</pre>`;
                } else {
                    contentDiv.innerHTML = '<p class="text-gray-500 italic text-center">No answer content available</p>';
                }
                
                document.getElementById('puzzle-answer-modal').classList.remove('hidden');
                
                // Update status
                if (puzzleStatus) {
                    puzzleStatus.already_revealed = true;
                    puzzleStatus.can_reveal_answer = false;
                }
            }
        } catch (error) {
            console.error('Error revealing answer:', error);
            alert('Error revealing answer. Please try again.');
        }
    }

    function dismissPuzzleAnswerOffer() {
        document.getElementById('puzzle-answer-offer').style.display = 'none';
        // Optionally dismiss permanently
        // fetch('/api/puzzle/dismiss-answer', { method: 'POST' });
    }

    function closeAnswerModal() {
        document.getElementById('puzzle-answer-modal').classList.add('hidden');
    }

    function escapeHtmlPuzzle(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Check for puzzle answer offer after quiz
    function checkPuzzleAnswerOffer() {
        if (puzzleStatus && puzzleStatus.has_puzzle && puzzleStatus.can_reveal_answer && !puzzleStatus.already_revealed) {
            document.getElementById('puzzle-answer-offer').style.display = 'block';
        } else {
            document.getElementById('puzzle-answer-offer').style.display = 'none';
        }
    }

    // Hook into page load
    const originalWindowOnload = window.onload;
    
        // ==================== SESSION VALIDATION ====================
        // Prevent cached pages from resuming after logout
        
        // Check if session is still valid
        async function validateSession() {
            try {
                const response = await fetch('/api/current-user', {
                    method: 'GET',
                    credentials: 'include',
                    cache: 'no-store'
                });
                
                if (!response.ok) {
                    // Session expired or user logged out
                    console.log('Session invalid, redirecting to login...');
                    window.location.href = '/login?session_expired=1';
                    return false;
                }
                
                const user = await response.json();
                if (!user || (!user.id && !user.is_guest)) {
                    console.log('No valid user session, redirecting to login...');
                    window.location.href = '/login?session_expired=1';
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('Session validation error:', error);
                window.location.href = '/login?session_expired=1';
                return false;
            }
        }
        
        // Validate session when page is shown (catches back button navigation)
        window.addEventListener('pageshow', function(event) {
            // If page was restored from bfcache (back-forward cache)
            if (event.persisted) {
                console.log('Page restored from cache, validating session...');
                validateSession();
            }
        });
        
        // Also validate when tab becomes visible (catches tab switching)
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                // Add small delay to avoid too many checks
                setTimeout(validateSession, 500);
            }
        });
        
        // Check for logged_out parameter in URL (set by logout redirect)
        if (window.location.search.includes('logged_out=1')) {
            // Clear any cached state and redirect to clean login
            sessionStorage.clear();
            localStorage.removeItem('mathmaster_session');
            window.location.href = '/login';
        }
        
        // ==================== END SESSION VALIDATION ====================

        window.onload = async function() {
        if (originalWindowOnload) {
            await originalWindowOnload();
        }
        // Check puzzle after other initialization
        await checkPuzzleStatus();
    };

    // Hook into showResults to offer puzzle answer
    const originalShowResultsForPuzzle = window.showResults;
    if (originalShowResultsForPuzzle) {
        window.showResults = function() {
            originalShowResultsForPuzzle.apply(this, arguments);
            // Check if we should offer puzzle answer
            setTimeout(checkPuzzleAnswerOffer, 500);
        };
    }
</script>

<!-- ==================== PRIZE PIN MODALS ==================== -->

<!-- PIN Setup Modal (shown when first crossing threshold) -->
<div id="prizePinSetupModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden animate-bounce-in">
        <div class="bg-gradient-to-r from-yellow-400 to-orange-500 p-6 text-white">
            <div class="text-center">
                <div class="text-5xl mb-2">ðŸ”</div>
                <h2 class="text-2xl font-bold">Protect Your Points!</h2>
                <p class="opacity-90 mt-1">You've earned a lot of points - let's keep them safe</p>
            </div>
        </div>
        
        <div class="p-6">
            <p class="text-gray-600 mb-4">
                Create a secret passcode to protect your Prize Shop access. Choose something memorable!
            </p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">
                        Your Secret Passcode
                    </label>
                    <input type="text" id="pinSetupCode" 
                           class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200 text-lg"
                           placeholder="e.g., fluffy, max, granny"
                           maxlength="50">
                    <p class="text-xs text-gray-500 mt-1">
                        ðŸ’¡ Use a name you'll remember: a pet, family member, or friend
                    </p>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">
                        Hint (to help you remember)
                    </label>
                    <select id="pinSetupHint" 
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200 text-lg">
                        <option value="">Choose a hint...</option>
                        <option value="My pet's name">ðŸ• My pet's name</option>
                        <option value="Family member">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§ Family member</option>
                        <option value="Best friend">ðŸ‘« Best friend</option>
                        <option value="Favourite character">ðŸ¦¸ Favourite character</option>
                        <option value="Favourite food">ðŸ• Favourite food</option>
                        <option value="Special place">ðŸ  Special place</option>
                    </select>
                    <input type="text" id="pinSetupCustomHint" 
                           class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-yellow-500 mt-2 hidden"
                           placeholder="Or type your own hint...">
                </div>
            </div>
            
            <div id="pinSetupError" class="hidden mt-3 p-3 bg-red-100 text-red-700 rounded-lg text-sm"></div>
            
            <button onclick="savePrizePin()" 
                    class="w-full mt-6 py-4 bg-gradient-to-r from-yellow-400 to-orange-500 text-white font-bold rounded-xl hover:from-yellow-500 hover:to-orange-600 transition-all transform hover:scale-[1.02]">
                ðŸ”’ Save My Passcode
            </button>
            
            <p class="text-center text-xs text-gray-400 mt-3">
                You'll need this passcode to access the Prize Shop
            </p>
        </div>
    </div>
</div>

<!-- PIN Entry Modal (shown when accessing Prize Shop) -->
<div id="prizePinEntryModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden animate-bounce-in">
        <div class="bg-gradient-to-r from-purple-500 to-pink-500 p-6 text-white">
            <div class="text-center">
                <div class="text-5xl mb-2">ðŸŽ</div>
                <h2 class="text-2xl font-bold">Prize Shop Access</h2>
                <p class="opacity-90 mt-1">Enter your passcode to continue</p>
            </div>
        </div>
        
        <div class="p-6">
            <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-4 mb-4">
                <p class="text-yellow-800 text-sm">
                    <strong>ðŸ’¡ Hint:</strong> <span id="pinEntryHint">Loading...</span>
                </p>
            </div>
            
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-1">
                    Your Passcode
                </label>
                <input type="text" id="pinEntryCode" 
                       class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:ring-2 focus:ring-purple-200 text-lg text-center tracking-widest"
                       placeholder="Enter your passcode"
                       maxlength="50"
                       onkeypress="if(event.key==='Enter') verifyPrizePin()">
            </div>
            
            <div id="pinEntryError" class="hidden mt-3 p-3 bg-red-100 text-red-700 rounded-lg text-sm"></div>
            
            <div class="flex gap-3 mt-6">
                <button onclick="closePinEntryModal()" 
                        class="flex-1 py-3 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300 transition-colors">
                    Cancel
                </button>
                <button onclick="verifyPrizePin()" 
                        class="flex-1 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold rounded-xl hover:from-purple-600 hover:to-pink-600 transition-all">
                    ðŸ”“ Enter Shop
                </button>
            </div>
            
            <p class="text-center text-xs text-gray-400 mt-4">
                Forgot your passcode? Ask your teacher for help.
            </p>
        </div>
    </div>
</div>

<style>
    @keyframes bounce-in {
        0% { transform: scale(0.9); opacity: 0; }
        50% { transform: scale(1.02); }
        100% { transform: scale(1); opacity: 1; }
    }
    .animate-bounce-in {
        animation: bounce-in 0.3s ease-out;
    }
</style>

<script>
    // ==================== PRIZE PIN PROTECTION ====================
    
    let prizePinStatus = null;
    let pendingPrizeShopAction = null;
    
    // Check PIN status on page load
    async function checkPrizePinStatus() {
        try {
            const response = await fetch('/api/prize-pin/status');
            prizePinStatus = await response.json();
            console.log('Prize PIN status:', prizePinStatus);
            return prizePinStatus;
        } catch (error) {
            console.error('Error checking prize PIN status:', error);
            return null;
        }
    }
    
    // Check if user needs to set up PIN after quiz
    async function checkPrizePinSetupNeeded() {
        const status = await checkPrizePinStatus();
        if (status && status.needs_setup) {
            // Show PIN setup modal
            document.getElementById('prizePinSetupModal').classList.remove('hidden');
            return true;
        }
        return false;
    }
    
    // Save new PIN
    async function savePrizePin() {
        const pin = document.getElementById('pinSetupCode').value.trim();
        const hintSelect = document.getElementById('pinSetupHint').value;
        const customHint = document.getElementById('pinSetupCustomHint').value.trim();
        const hint = customHint || hintSelect;
        
        const errorEl = document.getElementById('pinSetupError');
        errorEl.classList.add('hidden');
        
        if (!pin || pin.length < 2) {
            errorEl.textContent = 'Please enter a passcode (at least 2 characters)';
            errorEl.classList.remove('hidden');
            return;
        }
        
        if (!hint || hint.length < 2) {
            errorEl.textContent = 'Please select or enter a hint';
            errorEl.classList.remove('hidden');
            return;
        }
        
        try {
            const response = await fetch('/api/prize-pin/set', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ pin: pin, hint: hint })
            });
            
            const result = await response.json();
            
            if (result.success) {
                document.getElementById('prizePinSetupModal').classList.add('hidden');
                // Clear form
                document.getElementById('pinSetupCode').value = '';
                document.getElementById('pinSetupHint').value = '';
                document.getElementById('pinSetupCustomHint').value = '';
                
                // Show success message
                alert('âœ… Your passcode is set! Remember your hint: ' + hint);
                
                // Update status
                await checkPrizePinStatus();
            } else {
                errorEl.textContent = result.error || 'Failed to save passcode';
                errorEl.classList.remove('hidden');
            }
        } catch (error) {
            console.error('Error saving PIN:', error);
            errorEl.textContent = 'Connection error. Please try again.';
            errorEl.classList.remove('hidden');
        }
    }
    
    // Open Prize Shop (with PIN check)
    async function openPrizeShop(url) {
        const status = await checkPrizePinStatus();
        
        if (!status || !status.requires_pin) {
            // No PIN required - go directly
            window.location.href = url || '/prizes';
            return;
        }
        
        if (status.needs_setup) {
            // Need to set up PIN first
            pendingPrizeShopAction = url || '/prizes';
            document.getElementById('prizePinSetupModal').classList.remove('hidden');
            return;
        }
        
        // PIN is set - verify it
        pendingPrizeShopAction = url || '/prizes';
        document.getElementById('pinEntryHint').textContent = status.hint || 'Think about your passcode...';
        document.getElementById('pinEntryCode').value = '';
        document.getElementById('pinEntryError').classList.add('hidden');
        document.getElementById('prizePinEntryModal').classList.remove('hidden');
        
        // Focus the input
        setTimeout(() => document.getElementById('pinEntryCode').focus(), 100);
    }
    
    // Verify PIN and enter shop
    async function verifyPrizePin() {
        const pin = document.getElementById('pinEntryCode').value.trim();
        const errorEl = document.getElementById('pinEntryError');
        errorEl.classList.add('hidden');
        
        if (!pin) {
            errorEl.textContent = 'Please enter your passcode';
            errorEl.classList.remove('hidden');
            return;
        }
        
        try {
            const response = await fetch('/api/prize-pin/verify', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ pin: pin })
            });
            
            const result = await response.json();
            
            if (result.success) {
                document.getElementById('prizePinEntryModal').classList.add('hidden');
                // Navigate to prize shop
                window.location.href = pendingPrizeShopAction || '/prizes';
            } else {
                errorEl.textContent = result.error || 'Incorrect passcode';
                errorEl.classList.remove('hidden');
                document.getElementById('pinEntryCode').value = '';
                document.getElementById('pinEntryCode').focus();
            }
        } catch (error) {
            console.error('Error verifying PIN:', error);
            errorEl.textContent = 'Connection error. Please try again.';
            errorEl.classList.remove('hidden');
        }
    }
    
    // Close PIN entry modal
    function closePinEntryModal() {
        document.getElementById('prizePinEntryModal').classList.add('hidden');
        pendingPrizeShopAction = null;
    }
    
    // Handle custom hint option
    document.getElementById('pinSetupHint')?.addEventListener('change', function() {
        const customInput = document.getElementById('pinSetupCustomHint');
        if (this.value === '') {
            customInput.classList.remove('hidden');
            customInput.focus();
        } else {
            customInput.classList.add('hidden');
            customInput.value = '';
        }
    });
    
    // Hook into showResults to check for PIN setup
    const originalShowResultsForPin = window.showResults;
    if (originalShowResultsForPin) {
        window.showResults = function() {
            originalShowResultsForPin.apply(this, arguments);
            // Check if PIN setup is needed after a short delay
            setTimeout(checkPrizePinSetupNeeded, 1000);
        };
    }
    
    // Intercept Prize Shop links
    document.addEventListener('DOMContentLoaded', function() {
        // Find all Prize Shop links and add click handler
        document.querySelectorAll('a[href="/prizes"], a[href*="prize"]').forEach(link => {
            if (link.href.includes('/prizes') || link.href.includes('prize')) {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    openPrizeShop(this.href);
                });
            }
        });
        
        // Initial PIN status check
        checkPrizePinStatus();
    });
</script>

<!-- Floating Calculator Overlay -->
<div id="calculatorOverlay" class="calculator-overlay">
    <div id="calculatorContainer" class="calculator-container" onclick="event.stopPropagation()">
        <div class="calculator-header" id="calculatorHeader">
            <h4><i class="fas fa-calculator"></i> Calculator <span class="drag-hint">â‹®â‹® drag to move</span></h4>
            <button class="calculator-close" onclick="toggleCalculator()" title="Close calculator">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="calculator-display">
            <div id="calcExpression" class="calc-expression"></div>
            <div id="calcResult" class="calc-result">0</div>
        </div>
        
        <div class="calculator-body">
            <!-- Row 1: Clear, Brackets, Scientific -->
            <div class="calc-row">
                <button class="calc-btn calc-btn-clear" onclick="calcClear()">C</button>
                <button class="calc-btn calc-btn-function" onclick="calcBackspace()">âŒ«</button>
                <button class="calc-btn calc-btn-function" onclick="calcInput('(')">(</button>
                <button class="calc-btn calc-btn-function" onclick="calcInput(')')">)</button>
            </div>
            
            <!-- Row 2: Scientific functions -->
            <div class="calc-row">
                <button class="calc-btn calc-btn-function" onclick="calcSquare()">xÂ²</button>
                <button class="calc-btn calc-btn-function" onclick="calcSquareRoot()">âˆš</button>
                <button class="calc-btn calc-btn-function" onclick="calcPi()">Ï€</button>
                <button class="calc-btn calc-btn-operator" onclick="calcInput('Ã·')">Ã·</button>
            </div>
            
            <!-- Row 3: 7, 8, 9, Ã— -->
            <div class="calc-row">
                <button class="calc-btn calc-btn-number" onclick="calcInput('7')">7</button>
                <button class="calc-btn calc-btn-number" onclick="calcInput('8')">8</button>
                <button class="calc-btn calc-btn-number" onclick="calcInput('9')">9</button>
                <button class="calc-btn calc-btn-operator" onclick="calcInput('Ã—')">Ã—</button>
            </div>
            
            <!-- Row 4: 4, 5, 6, - -->
            <div class="calc-row">
                <button class="calc-btn calc-btn-number" onclick="calcInput('4')">4</button>
                <button class="calc-btn calc-btn-number" onclick="calcInput('5')">5</button>
                <button class="calc-btn calc-btn-number" onclick="calcInput('6')">6</button>
                <button class="calc-btn calc-btn-operator" onclick="calcInput('-')">âˆ’</button>
            </div>
            
            <!-- Row 5: 1, 2, 3, + -->
            <div class="calc-row">
                <button class="calc-btn calc-btn-number" onclick="calcInput('1')">1</button>
                <button class="calc-btn calc-btn-number" onclick="calcInput('2')">2</button>
                <button class="calc-btn calc-btn-number" onclick="calcInput('3')">3</button>
                <button class="calc-btn calc-btn-operator" onclick="calcInput('+')">+</button>
            </div>
            
            <!-- Row 6: Â±, 0, ., = -->
            <div class="calc-row">
                <button class="calc-btn calc-btn-function" onclick="calcNegate()">Â±</button>
                <button class="calc-btn calc-btn-number" onclick="calcInput('0')">0</button>
                <button class="calc-btn calc-btn-number" onclick="calcInput('.')">.</button>
                <button class="calc-btn calc-btn-equals" onclick="calcEquals()">=</button>
            </div>
        </div>
        
        <div class="calculator-footer">
            <label class="calc-session-toggle">
                <input type="checkbox" id="calcKeepOpen" onchange="saveCalcPreference()">
                <span>Keep open for entire quiz</span>
            </label>
        </div>
    </div>
</div>

<!-- Bonus Question Modal -->
<div id="bonusQuestionModal" class="bonus-modal-overlay" onclick="closeBonusOnOverlay(event)">
    <div class="bonus-modal" onclick="event.stopPropagation()">
        <div class="bonus-modal-header">
            <h2>ðŸ¦• Dino Challenge</h2>
            <p>Identify this dinosaur for +100 points!</p>
        </div>
        <div class="bonus-modal-body">
            <div class="bonus-image-container">
                <img id="bonusImage" src="" alt="Mystery Dinosaur" style="display: none;">
                <div id="bonusImageLoading" class="loading">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">Loading dinosaur...</p>
                </div>
            </div>
            <p class="bonus-question-text">Which dinosaur is this?</p>
            <div id="bonusOptions" class="bonus-options">
                <!-- Options populated by JS -->
            </div>
            <div id="bonusResult" class="bonus-result" style="display: none;">
                <!-- Result populated by JS -->
            </div>
        </div>
        <div class="bonus-modal-footer" id="bonusFooter" style="display: none;">
            <button onclick="closeBonusModal()" class="bonus-close-btn">
                Continue <i class="fas fa-arrow-right ml-2"></i>
            </button>
        </div>
    </div>
</div>

<!-- Dino Archive Modal -->
<div id="dinoArchiveModal" class="dino-archive-overlay" onclick="closeDinoArchiveOnOverlay(event)">
    <div class="dino-archive-modal" onclick="event.stopPropagation()">
        <div class="dino-archive-header">
            <button onclick="closeDinoArchive()" class="dino-archive-close">
                <i class="fas fa-times"></i>
            </button>
            <h2>ðŸ¦• Your Dino Archive</h2>
            <p>All the dinosaurs you've discovered!</p>
            <div class="dino-archive-stats">
                <div class="dino-archive-stat">
                    <div class="dino-archive-stat-value" id="archiveTotalCount">0</div>
                    <div class="dino-archive-stat-label">Total Attempted</div>
                </div>
                <div class="dino-archive-stat">
                    <div class="dino-archive-stat-value" id="archiveCorrectCount">0</div>
                    <div class="dino-archive-stat-label">Correct âœ“</div>
                </div>
                <div class="dino-archive-stat">
                    <div class="dino-archive-stat-value" id="archiveAccuracy">0%</div>
                    <div class="dino-archive-stat-label">Accuracy</div>
                </div>
            </div>
        </div>
        <div class="dino-archive-body" id="dinoArchiveBody">
            <div class="dino-archive-empty">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading your archive...</p>
            </div>
        </div>
        <div class="dino-archive-footer">
            <button onclick="closeDinoArchive()" class="bonus-close-btn">
                Close Archive
            </button>
        </div>
    </div>
</div>

<!-- Day 2: Quick Play Modal -->
<div id="quickPlayModal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-md w-full p-6 transform transition-all">
        <div class="text-center mb-6">
            <div class="text-6xl mb-4">âš¡</div>
            <h2 class="text-2xl font-bold text-gray-800">Quick Play</h2>
            <p class="text-gray-600 mt-2">10 rapid-fire questions from mixed topics!</p>
        </div>
        
        <div class="bg-gradient-to-r from-orange-100 to-red-100 rounded-xl p-4 mb-6">
            <h3 class="font-bold text-gray-800 mb-3">ðŸŽ® Rules:</h3>
            <ul class="text-sm text-gray-700 space-y-2">
                <li>â€¢ <strong>10 questions</strong> from random topics</li>
                <li>â€¢ <strong>Mixed difficulties</strong> - mostly your level</li>
                <li>â€¢ <strong>2x Points</strong> for all correct answers!</li>
                <li>â€¢ <strong>Speed bonus</strong> - finish fast for extra points</li>
            </ul>
        </div>
        
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Select your base level:</label>
            <div class="grid grid-cols-3 gap-2">
                <button onclick="setQuickPlayDifficulty('beginner')" class="quick-diff-btn p-3 rounded-lg border-2 border-gray-200 hover:border-orange-400 transition-all" data-diff="beginner">
                    <div class="text-2xl">ðŸŒ±</div>
                    <div class="text-xs font-medium">Beginner</div>
                </button>
                <button onclick="setQuickPlayDifficulty('intermediate')" class="quick-diff-btn p-3 rounded-lg border-2 border-orange-400 bg-orange-50 transition-all" data-diff="intermediate">
                    <div class="text-2xl">ðŸ“š</div>
                    <div class="text-xs font-medium">Intermediate</div>
                </button>
                <button onclick="setQuickPlayDifficulty('advanced')" class="quick-diff-btn p-3 rounded-lg border-2 border-gray-200 hover:border-orange-400 transition-all" data-diff="advanced">
                    <div class="text-2xl">ðŸš€</div>
                    <div class="text-xs font-medium">Advanced</div>
                </button>
            </div>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeQuickPlayModal()" class="flex-1 py-3 px-6 rounded-xl border-2 border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-all">
                Cancel
            </button>
            <button onclick="startQuickPlay()" class="flex-1 py-3 px-6 rounded-xl bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold hover:from-orange-600 hover:to-red-600 transition-all">
                âš¡ Start!
            </button>
        </div>
    </div>
</div>


<!-- Smart Quiz Modal (Adaptive Learning) -->
<div id="smartQuizModal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-md w-full p-6 transform transition-all">
        <div class="text-center mb-6">
            <div class="text-6xl mb-4">ðŸ§ </div>
            <h2 class="text-2xl font-bold text-gray-800">Smart Quiz</h2>
            <p class="text-gray-600 mt-2">AI-powered personalised learning</p>
        </div>
        
        <!-- Mode Selection -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Choose your focus:</label>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="setSmartQuizMode('auto')" class="smart-mode-btn p-3 rounded-lg border-2 border-green-400 bg-green-50 transition-all text-left" data-mode="auto">
                    <div class="text-xl">ðŸŽ¯</div>
                    <div class="text-sm font-medium">Auto</div>
                    <div class="text-xs text-gray-500">Best overall pick</div>
                </button>
                <button onclick="setSmartQuizMode('review')" class="smart-mode-btn p-3 rounded-lg border-2 border-gray-200 hover:border-green-400 transition-all text-left" data-mode="review">
                    <div class="text-xl">ðŸ”„</div>
                    <div class="text-sm font-medium">Review</div>
                    <div class="text-xs text-gray-500">Refresh memory</div>
                </button>
                <button onclick="setSmartQuizMode('practice')" class="smart-mode-btn p-3 rounded-lg border-2 border-gray-200 hover:border-green-400 transition-all text-left" data-mode="practice">
                    <div class="text-xl">ðŸ’ª</div>
                    <div class="text-sm font-medium">Practice</div>
                    <div class="text-xs text-gray-500">Work on weak areas</div>
                </button>
                <button onclick="setSmartQuizMode('challenge')" class="smart-mode-btn p-3 rounded-lg border-2 border-gray-200 hover:border-green-400 transition-all text-left" data-mode="challenge">
                    <div class="text-xl">ðŸš€</div>
                    <div class="text-sm font-medium">Challenge</div>
                    <div class="text-xs text-gray-500">Push your limits</div>
                </button>
            </div>
        </div>
        
        <!-- Loading State -->
        <div id="smartQuizLoading" class="bg-gray-100 rounded-xl p-6 mb-6 text-center">
            <div class="animate-spin text-4xl mb-2">âš™ï¸</div>
            <p class="text-gray-600">Analysing your progress...</p>
        </div>
        
        <!-- Error State -->
        <div id="smartQuizError" class="hidden bg-red-50 text-red-600 rounded-xl p-4 mb-6 text-center">
            Error loading recommendation
        </div>
        
        <!-- Recommendation Content -->
        <div id="smartQuizContent" class="hidden bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 mb-6">
            <h3 class="font-bold text-gray-800 mb-3">ðŸ“Š Recommended for You:</h3>
            <div class="space-y-3">
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">Topic:</span>
                    <span id="smartQuizTopic" class="font-bold text-gray-800">Loading...</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">Difficulty:</span>
                    <span id="smartQuizDifficulty" class="px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-700">Loading...</span>
                </div>
                <div id="smartQuizMasteryContainer" class="hidden text-center pt-2 border-t border-green-200">
                    <span id="smartQuizMastery" class="text-sm text-gray-600">Current mastery: 0%</span>
                </div>
                <div class="pt-2 border-t border-green-200">
                    <p id="smartQuizReason" class="text-sm text-gray-600 italic">Loading reason...</p>
                </div>
            </div>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeSmartQuizModal()" class="flex-1 py-3 px-6 rounded-xl border-2 border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-all">
                Cancel
            </button>
            <button onclick="startSmartQuiz()" class="flex-1 py-3 px-6 rounded-xl bg-gradient-to-r from-green-500 to-emerald-500 text-white font-bold hover:from-green-600 hover:to-emerald-600 transition-all">
                ðŸ§  Start!
            </button>
        </div>
    </div>
</div>


<!-- Adaptive Quiz Modal (10-Level Progression) -->
<div id="adaptiveQuizModal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-lg w-full p-6 transform transition-all max-h-[90vh] overflow-y-auto">
        <div class="text-center mb-6">
            <div class="text-6xl mb-4">ðŸŽ¯</div>
            <h2 class="text-2xl font-bold text-gray-800">Adaptive Quiz</h2>
            <p class="text-gray-600 mt-2">Master topics through 10 progressive levels</p>
        </div>
        
        <!-- Topic Selection -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-3">Choose your topic:</label>
            <div id="adaptiveTopicGrid" class="grid grid-cols-1 gap-3">
                <!-- Topics loaded dynamically -->
                <div class="text-center py-8 text-gray-500">
                    <div class="animate-spin text-3xl mb-2">âš™ï¸</div>
                    Loading topics...
                </div>
            </div>
        </div>
        
        <!-- Selected Topic Info -->
        <div id="adaptiveTopicInfo" class="hidden bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-4 mb-6">
            <h3 class="font-bold text-gray-800 mb-3">ðŸ“Š Your Progress:</h3>
            <div class="space-y-2">
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">Starting Level:</span>
                    <span id="adaptiveStartLevel" class="font-bold text-purple-700">Level 1</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">Questions:</span>
                    <span id="adaptiveQuestionCount" class="font-medium text-gray-800">10</span>
                </div>
                <div class="pt-2">
                    <div class="text-xs text-gray-500 mb-1">Level progression:</div>
                    <div class="flex gap-1">
                        <div id="adaptiveLevelPreview" class="flex gap-1">
                            <!-- Level dots preview -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Question Count Selection -->
        <div id="adaptiveOptionsSection" class="hidden mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Number of questions:</label>
            <div class="flex gap-2">
                <button onclick="setAdaptiveQuestionCount(5)" class="adaptive-count-btn px-4 py-2 rounded-lg border-2 border-gray-200 hover:border-purple-400 transition-all" data-count="5">5</button>
                <button onclick="setAdaptiveQuestionCount(10)" class="adaptive-count-btn px-4 py-2 rounded-lg border-2 border-purple-400 bg-purple-50 transition-all" data-count="10">10</button>
                <button onclick="setAdaptiveQuestionCount(15)" class="adaptive-count-btn px-4 py-2 rounded-lg border-2 border-gray-200 hover:border-purple-400 transition-all" data-count="15">15</button>
                <button onclick="setAdaptiveQuestionCount(20)" class="adaptive-count-btn px-4 py-2 rounded-lg border-2 border-gray-200 hover:border-purple-400 transition-all" data-count="20">20</button>
            </div>
        </div>
        
        <div class="flex gap-3">
            <button onclick="closeAdaptiveQuizModal()" class="flex-1 py-3 px-6 rounded-xl border-2 border-gray-300 text-gray-700 font-medium hover:bg-gray-50 transition-all">
                Cancel
            </button>
            <button id="startAdaptiveBtn" onclick="startAdaptiveQuiz()" disabled class="flex-1 py-3 px-6 rounded-xl bg-gradient-to-r from-purple-500 to-indigo-500 text-white font-bold hover:from-purple-600 hover:to-indigo-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                ðŸŽ¯ Start!
            </button>
        </div>
    </div>
</div>

<!-- Adaptive Quiz Active Screen -->
<div id="adaptiveQuizScreen" class="fixed inset-0 bg-gray-100 z-40 hidden overflow-y-auto">
    <!-- Adaptive Quiz Header -->
    <div class="adaptive-quiz-header bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-4 shadow-lg">
        <div class="max-w-4xl mx-auto flex items-center justify-between flex-wrap gap-3">
            <div class="flex items-center gap-4">
                <button onclick="abandonAdaptiveQuiz()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg flex items-center gap-2 transition-all">
                    <i class="fas fa-arrow-left"></i> Exit
                </button>
                <div>
                    <div class="font-bold text-lg" id="adaptiveQuizTitle">Solving Equations</div>
                    <div class="text-sm opacity-90">Question <span id="adaptiveQuestionNum">1</span> of <span id="adaptiveTotalQuestions">10</span></div>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <!-- Level Indicator -->
                <div class="adaptive-level-indicator">
                    <span>Level</span>
                    <span id="adaptiveCurrentLevel" class="text-yellow-300 text-lg">1</span>
                    <div class="adaptive-level-bar" id="adaptiveLevelBar">
                        <!-- 10 dots for levels -->
                    </div>
                </div>
                
                <!-- Score -->
                <div class="bg-white/20 px-4 py-2 rounded-lg">
                    <span class="text-sm opacity-90">Score:</span>
                    <span id="adaptiveScore" class="font-bold ml-1">0</span>/<span id="adaptiveMaxScore">10</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Question Area -->
    <div class="max-w-3xl mx-auto p-6 pb-24">
        <!-- Level Info Banner -->
        <div id="adaptiveLevelBanner" class="bg-purple-100 border border-purple-200 rounded-xl p-3 mb-4 flex items-center justify-between">
            <div>
                <span class="text-purple-800 font-medium">Level <span id="adaptiveBannerLevel">1</span>:</span>
                <span id="adaptiveLevelName" class="text-purple-600">Foundation</span>
            </div>
            <div class="text-sm text-purple-600">
                <span id="adaptiveStreak">0</span> correct in a row
            </div>
        </div>
        
        <!-- Question Card -->
        <div class="bg-white rounded-2xl shadow-lg p-8 mb-6">
            <!-- Image Area (for visual questions) -->
            <div id="adaptiveQuestionImage" class="hidden flex justify-center mb-6">
                <!-- SVG will be inserted here -->
            </div>
            
            <div id="adaptiveQuestionText" class="text-xl text-gray-800 mb-8 leading-relaxed">
                Loading question...
            </div>
            
            <div id="adaptiveOptionsContainer" class="space-y-3">
                <!-- Options loaded dynamically -->
            </div>
        </div>
        
        <!-- Feedback Area -->
        <div id="adaptiveFeedback" class="hidden rounded-2xl p-6 mb-6">
            <div class="flex items-start gap-4">
                <div id="adaptiveFeedbackIcon" class="text-4xl">âœ…</div>
                <div class="flex-1">
                    <div id="adaptiveFeedbackTitle" class="font-bold text-lg mb-2">Correct!</div>
                    <div id="adaptiveFeedbackExplanation" class="text-gray-600"></div>
                </div>
            </div>
        </div>
        
        <!-- Action Button -->
        <div class="text-center">
            <button id="adaptiveNextBtn" onclick="adaptiveNextQuestion()" class="hidden px-8 py-4 bg-gradient-to-r from-purple-500 to-indigo-500 text-white font-bold rounded-xl hover:from-purple-600 hover:to-indigo-600 transition-all text-lg">
                Next Question â†’
            </button>
        </div>
    </div>
</div>

<!-- Adaptive Quiz Results Screen -->
<div id="adaptiveResultsScreen" class="fixed inset-0 bg-gradient-to-br from-purple-600 to-indigo-700 z-40 hidden flex items-center justify-center p-4 overflow-y-auto">
    <div class="bg-white rounded-3xl max-w-md w-full p-8 text-center">
        <div class="text-6xl mb-4" id="adaptiveResultEmoji">ðŸŽ‰</div>
        <h2 class="text-3xl font-bold text-gray-800 mb-2">Quiz Complete!</h2>
        
        <div class="text-6xl font-bold text-purple-600 my-6">
            <span id="adaptiveFinalScore">8</span>/<span id="adaptiveFinalTotal">10</span>
        </div>
        
        <div class="text-xl text-gray-600 mb-6">
            <span id="adaptiveFinalPercent">80</span>% Correct
        </div>
        
        <!-- Level Progress -->
        <div class="bg-purple-50 rounded-xl p-4 mb-6">
            <div class="text-sm text-gray-600 mb-2">Level Progress</div>
            <div class="flex items-center justify-center gap-3">
                <span class="text-2xl font-bold text-gray-400" id="adaptiveStartLevelResult">1</span>
                <span class="text-3xl">â†’</span>
                <span class="text-3xl font-bold text-purple-600" id="adaptiveEndLevelResult">3</span>
            </div>
            <div id="adaptiveLevelChangeText" class="text-sm text-green-600 font-medium mt-2">
                +2 Levels! ðŸš€
            </div>
        </div>
        
        <div class="space-y-3">
            <button onclick="restartAdaptiveQuiz()" class="w-full py-3 px-6 bg-gradient-to-r from-purple-500 to-indigo-500 text-white font-bold rounded-xl hover:from-purple-600 hover:to-indigo-600 transition-all">
                ðŸ”„ Play Again
            </button>
            <button onclick="closeAdaptiveResults()" class="w-full py-3 px-6 border-2 border-gray-300 text-gray-700 font-medium rounded-xl hover:bg-gray-50 transition-all">
                Back to Dashboard
            </button>
        </div>
    </div>
</div>

<script>
// ============================================================
// ADAPTIVE QUIZ SYSTEM - 10-Level Progression
// ============================================================

let adaptiveQuizState = {
    topic: null,
    topicName: null,
    numQuestions: 10,
    currentQuestion: null,
    questionNumber: 0,
    score: 0,
    currentLevel: 1,
    startingLevel: 1,
    streak: 0,
    selectedAnswer: null,
    isAnswered: false
};

const LEVEL_NAMES = {
    1: 'Foundation',
    2: 'Building Basics',
    3: 'Gaining Confidence',
    4: 'Developing Skills',
    5: 'Intermediate',
    6: 'Advancing',
    7: 'Strong Progress',
    8: 'Near Mastery',
    9: 'Expert Level',
    10: 'Champion!'
};

const TOPIC_ICONS = {
    'solving_equations': 'ðŸ”¢',
    'fractions': 'ðŸ¥§',
    'percentages': 'ðŸ’¯',
    'probability': 'ðŸŽ²',
    'introductory_algebra': 'ðŸ“'
};

const TOPIC_DISPLAY_NAMES = {
    'solving_equations': 'Solving Equations',
    'fractions': 'Fractions',
    'percentages': 'Percentages',
    'probability': 'Probability',
    'introductory_algebra': 'Algebra'
};

// Show guest message
function showAdaptiveQuizGuestMessage() {
    alert('ðŸ”’ Adaptive Quiz requires a Guest Code!\n\nAdaptive Quiz tracks your progress through 10 levels of difficulty.\n\nClick "Return with Code" on the home page to get your personal guest code, or register for a full account!');
}

// Open the modal
function showAdaptiveQuizModal() {
    document.getElementById('adaptiveQuizModal').classList.remove('hidden');
    loadAdaptiveTopics();
}

// Close the modal
function closeAdaptiveQuizModal() {
    document.getElementById('adaptiveQuizModal').classList.add('hidden');
    // Reset selection
    adaptiveQuizState.topic = null;
    document.getElementById('adaptiveTopicInfo').classList.add('hidden');
    document.getElementById('adaptiveOptionsSection').classList.add('hidden');
    document.getElementById('startAdaptiveBtn').disabled = true;
}

// Load available topics
async function loadAdaptiveTopics() {
    const grid = document.getElementById('adaptiveTopicGrid');
    
    try {
        const response = await fetch('/api/quiz-adaptive/topics');
        const data = await response.json();
        
        if (data.topics && data.topics.length > 0) {
            grid.innerHTML = data.topics.map(t => `
                <div class="adaptive-topic-card" onclick="selectAdaptiveTopic('${t.topic}', ${t.question_count})" data-topic="${t.topic}">
                    <div class="topic-icon">${TOPIC_ICONS[t.topic] || 'ðŸ“š'}</div>
                    <div class="topic-name">${TOPIC_DISPLAY_NAMES[t.topic] || t.topic}</div>
                    <div class="topic-questions">${t.question_count} questions</div>
                    <div class="topic-level">Levels ${t.min_level}-${t.max_level}</div>
                </div>
            `).join('');
        } else {
            grid.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <div class="text-4xl mb-2">ðŸ“­</div>
                    <p>No adaptive topics available yet.</p>
                    <p class="text-sm mt-2">Ask your teacher to generate adaptive questions!</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading topics:', error);
        grid.innerHTML = `
            <div class="text-center py-8 text-red-500">
                <div class="text-4xl mb-2">âš ï¸</div>
                <p>Error loading topics</p>
            </div>
        `;
    }
}

// Select a topic
async function selectAdaptiveTopic(topic, questionCount) {
    // Update UI selection
    document.querySelectorAll('.adaptive-topic-card').forEach(card => {
        card.classList.remove('selected');
    });
    document.querySelector(`.adaptive-topic-card[data-topic="${topic}"]`).classList.add('selected');
    
    adaptiveQuizState.topic = topic;
    adaptiveQuizState.topicName = TOPIC_DISPLAY_NAMES[topic] || topic;
    
    // Get recommended level
    try {
        const response = await fetch(`/api/quiz-adaptive/recommended-level/${topic}`);
        const data = await response.json();
        
        adaptiveQuizState.startingLevel = data.level;
        adaptiveQuizState.currentLevel = data.level;
        
        // Update info display
        document.getElementById('adaptiveStartLevel').textContent = `Level ${data.level}`;
        document.getElementById('adaptiveQuestionCount').textContent = adaptiveQuizState.numQuestions;
        
        // Update level preview dots
        const previewContainer = document.getElementById('adaptiveLevelPreview');
        previewContainer.innerHTML = Array.from({length: 10}, (_, i) => {
            const level = i + 1;
            let dotClass = 'w-4 h-4 rounded-full ';
            if (level < data.level) {
                dotClass += 'bg-green-400';
            } else if (level === data.level) {
                dotClass += 'bg-purple-500 ring-2 ring-purple-300';
            } else {
                dotClass += 'bg-gray-200';
            }
            return `<div class="${dotClass}" title="Level ${level}"></div>`;
        }).join('');
        
    } catch (error) {
        console.error('Error getting recommended level:', error);
        adaptiveQuizState.startingLevel = 1;
        adaptiveQuizState.currentLevel = 1;
        document.getElementById('adaptiveStartLevel').textContent = 'Level 1';
    }
    
    // Show info sections
    document.getElementById('adaptiveTopicInfo').classList.remove('hidden');
    document.getElementById('adaptiveOptionsSection').classList.remove('hidden');
    document.getElementById('startAdaptiveBtn').disabled = false;
}

// Set question count
function setAdaptiveQuestionCount(count) {
    adaptiveQuizState.numQuestions = count;
    document.getElementById('adaptiveQuestionCount').textContent = count;
    
    // Update button styles
    document.querySelectorAll('.adaptive-count-btn').forEach(btn => {
        if (parseInt(btn.dataset.count) === count) {
            btn.classList.remove('border-gray-200');
            btn.classList.add('border-purple-400', 'bg-purple-50');
        } else {
            btn.classList.add('border-gray-200');
            btn.classList.remove('border-purple-400', 'bg-purple-50');
        }
    });
}

// Start the adaptive quiz
async function startAdaptiveQuiz() {
    if (!adaptiveQuizState.topic) return;
    
    try {
        const response = await fetch('/api/quiz-adaptive/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                topic: adaptiveQuizState.topic,
                num_questions: adaptiveQuizState.numQuestions,
                mode: 'adaptive'
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update state
            adaptiveQuizState.currentLevel = data.starting_level;
            adaptiveQuizState.startingLevel = data.starting_level;
            adaptiveQuizState.questionNumber = 1;
            adaptiveQuizState.score = 0;
            adaptiveQuizState.streak = 0;
            adaptiveQuizState.currentQuestion = data.question;
            
            // Close modal, show quiz screen
            closeAdaptiveQuizModal();
            document.getElementById('adaptiveQuizScreen').classList.remove('hidden');
            
            // Initialize UI
            updateAdaptiveQuizUI();
            renderAdaptiveQuestion(data.question);
            renderLevelBar();
        } else {
            alert('Error starting quiz: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error starting adaptive quiz:', error);
        alert('Could not start adaptive quiz. Please try again.');
    }
}

// Update quiz UI elements
function updateAdaptiveQuizUI() {
    document.getElementById('adaptiveQuizTitle').textContent = adaptiveQuizState.topicName;
    document.getElementById('adaptiveQuestionNum').textContent = adaptiveQuizState.questionNumber;
    document.getElementById('adaptiveTotalQuestions').textContent = adaptiveQuizState.numQuestions;
    document.getElementById('adaptiveCurrentLevel').textContent = adaptiveQuizState.currentLevel;
    document.getElementById('adaptiveScore').textContent = adaptiveQuizState.score;
    document.getElementById('adaptiveMaxScore').textContent = adaptiveQuizState.numQuestions;
    document.getElementById('adaptiveBannerLevel').textContent = adaptiveQuizState.currentLevel;
    document.getElementById('adaptiveLevelName').textContent = LEVEL_NAMES[adaptiveQuizState.currentLevel] || '';
    document.getElementById('adaptiveStreak').textContent = adaptiveQuizState.streak;
}

// Render level progress bar
function renderLevelBar() {
    const bar = document.getElementById('adaptiveLevelBar');
    bar.innerHTML = Array.from({length: 10}, (_, i) => {
        const level = i + 1;
        let classes = 'adaptive-level-dot';
        if (level < adaptiveQuizState.currentLevel) {
            classes += ' completed';
        } else if (level === adaptiveQuizState.currentLevel) {
            classes += ' active';
        }
        return `<div class="${classes}" title="Level ${level}"></div>`;
    }).join('');
}

// Render a question
function renderAdaptiveQuestion(question) {
    adaptiveQuizState.currentQuestion = question;
    adaptiveQuizState.selectedAnswer = null;
    adaptiveQuizState.isAnswered = false;
    
    // Handle image (SVG graphics)
    const imageContainer = document.getElementById('adaptiveQuestionImage');
    if (question.image_svg) {
        imageContainer.innerHTML = question.image_svg;
        imageContainer.classList.remove('hidden');
    } else {
        imageContainer.innerHTML = '';
        imageContainer.classList.add('hidden');
    }
    
    document.getElementById('adaptiveQuestionText').textContent = question.text;
    
    const container = document.getElementById('adaptiveOptionsContainer');
    container.innerHTML = question.options.map((opt, idx) => `
        <button class="adaptive-option w-full text-left p-4 rounded-xl border-2 border-gray-200 hover:border-purple-400 hover:bg-purple-50 transition-all flex items-center gap-3"
                onclick="selectAdaptiveAnswer(${idx})" data-index="${idx}">
            <span class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center font-bold text-gray-600">
                ${String.fromCharCode(65 + idx)}
            </span>
            <span class="flex-1">${opt}</span>
        </button>
    `).join('');
    
    // Hide feedback and next button
    document.getElementById('adaptiveFeedback').classList.add('hidden');
    document.getElementById('adaptiveNextBtn').classList.add('hidden');
}

// Select an answer
function selectAdaptiveAnswer(index) {
    if (adaptiveQuizState.isAnswered) return;
    
    adaptiveQuizState.selectedAnswer = index;
    
    // Update button styles
    document.querySelectorAll('.adaptive-option').forEach((btn, i) => {
        btn.classList.remove('border-purple-500', 'bg-purple-100');
        if (i === index) {
            btn.classList.add('border-purple-500', 'bg-purple-100');
        }
    });
    
    // Submit the answer
    submitAdaptiveAnswer();
}

// Submit answer
async function submitAdaptiveAnswer() {
    if (adaptiveQuizState.selectedAnswer === null) return;
    
    adaptiveQuizState.isAnswered = true;
    const previousLevel = adaptiveQuizState.currentLevel;
    
    try {
        const response = await fetch('/api/quiz-adaptive/submit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                answer: adaptiveQuizState.selectedAnswer,
                time_taken: 30
            })
        });
        
        const data = await response.json();
        
        // Update score
        if (data.correct) {
            adaptiveQuizState.score++;
            adaptiveQuizState.streak++;
        } else {
            adaptiveQuizState.streak = 0;
        }
        
        // Update level
        adaptiveQuizState.currentLevel = data.current_level;
        
        // Show feedback
        showAdaptiveFeedback(data);
        
        // Update UI
        updateAdaptiveQuizUI();
        renderLevelBar();
        
        // Highlight correct/incorrect answers
        document.querySelectorAll('.adaptive-option').forEach((btn, i) => {
            btn.classList.remove('hover:border-purple-400', 'hover:bg-purple-50');
            btn.style.cursor = 'default';
            
            if (i === data.correct_answer) {
                btn.classList.remove('border-gray-200', 'border-purple-500', 'bg-purple-100');
                btn.classList.add('border-green-500', 'bg-green-100');
                btn.querySelector('span:first-child').classList.remove('bg-gray-200');
                btn.querySelector('span:first-child').classList.add('bg-green-500', 'text-white');
            } else if (i === adaptiveQuizState.selectedAnswer && !data.correct) {
                btn.classList.remove('border-gray-200', 'border-purple-500', 'bg-purple-100');
                btn.classList.add('border-red-500', 'bg-red-100');
                btn.querySelector('span:first-child').classList.remove('bg-gray-200');
                btn.querySelector('span:first-child').classList.add('bg-red-500', 'text-white');
            }
        });
        
        // Show level change animation
        if (data.current_level !== previousLevel) {
            showLevelChangeToast(previousLevel, data.current_level);
        }
        
        // Check if quiz complete
        if (data.quiz_complete) {
            console.log('Quiz complete! Showing results...', data);
            // Hide next button, show results after a short delay
            document.getElementById('adaptiveNextBtn').classList.add('hidden');
            setTimeout(() => {
                showAdaptiveResults(data);
            }, 2500);
        } else {
            // Store next question
            adaptiveQuizState.currentQuestion = data.next_question;
            document.getElementById('adaptiveNextBtn').classList.remove('hidden');
        }
        
    } catch (error) {
        console.error('Error submitting answer:', error);
        alert('Error submitting answer. Please try again.');
    }
}

// Show feedback
function showAdaptiveFeedback(data) {
    const feedback = document.getElementById('adaptiveFeedback');
    const icon = document.getElementById('adaptiveFeedbackIcon');
    const title = document.getElementById('adaptiveFeedbackTitle');
    const explanation = document.getElementById('adaptiveFeedbackExplanation');
    
    feedback.classList.remove('hidden', 'bg-green-100', 'bg-red-100');
    
    if (data.correct) {
        feedback.classList.add('bg-green-100');
        icon.textContent = 'âœ…';
        title.textContent = 'Correct! ' + getEncouragement(adaptiveQuizState.streak);
        title.className = 'font-bold text-lg mb-2 text-green-800';
    } else {
        feedback.classList.add('bg-red-100');
        icon.textContent = 'âŒ';
        title.textContent = 'Not quite...';
        title.className = 'font-bold text-lg mb-2 text-red-800';
    }
    
    explanation.textContent = data.explanation;
}

// Get encouragement text
function getEncouragement(streak) {
    if (streak >= 5) return 'ðŸ”¥ On Fire!';
    if (streak >= 3) return 'â­ Great streak!';
    if (streak >= 2) return 'ðŸ‘ Keep it up!';
    return '';
}

// Show level change toast
function showLevelChangeToast(fromLevel, toLevel) {
    const isUp = toLevel > fromLevel;
    
    const toast = document.createElement('div');
    toast.className = `level-change-toast ${isUp ? 'level-up' : 'level-down'}`;
    toast.innerHTML = `
        <div class="text-5xl mb-3">${isUp ? 'ðŸš€' : 'ðŸ“š'}</div>
        <div class="text-2xl font-bold ${isUp ? 'text-green-600' : 'text-amber-600'}">
            ${isUp ? 'Level Up!' : 'Level Adjusted'}
        </div>
        <div class="text-4xl font-bold mt-2">
            ${fromLevel} â†’ ${toLevel}
        </div>
        <div class="text-gray-600 mt-2">
            ${isUp ? LEVEL_NAMES[toLevel] : 'Let\'s practice more!'}
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Remove after animation
    setTimeout(() => {
        toast.style.animation = 'levelPopOut 0.3s ease forwards';
        setTimeout(() => toast.remove(), 300);
    }, 2000);
}

// Next question
function adaptiveNextQuestion() {
    if (adaptiveQuizState.currentQuestion) {
        adaptiveQuizState.questionNumber++;
        updateAdaptiveQuizUI();
        renderAdaptiveQuestion(adaptiveQuizState.currentQuestion);
    }
}

// Show results
function showAdaptiveResults(data) {
    document.getElementById('adaptiveQuizScreen').classList.add('hidden');
    document.getElementById('adaptiveResultsScreen').classList.remove('hidden');
    
    const percent = data.final_percentage;
    document.getElementById('adaptiveFinalScore').textContent = data.final_score;
    document.getElementById('adaptiveFinalTotal').textContent = adaptiveQuizState.numQuestions;
    document.getElementById('adaptiveFinalPercent').textContent = Math.round(percent);
    
    // Emoji based on performance
    let emoji = 'ðŸŽ‰';
    if (percent >= 90) emoji = 'ðŸ†';
    else if (percent >= 70) emoji = 'â­';
    else if (percent >= 50) emoji = 'ðŸ‘';
    else emoji = 'ðŸ’ª';
    document.getElementById('adaptiveResultEmoji').textContent = emoji;
    
    // Level progress
    document.getElementById('adaptiveStartLevelResult').textContent = data.starting_level;
    document.getElementById('adaptiveEndLevelResult').textContent = data.ending_level;
    
    const levelChange = data.ending_level - data.starting_level;
    const levelText = document.getElementById('adaptiveLevelChangeText');
    if (levelChange > 0) {
        levelText.textContent = `+${levelChange} Level${levelChange > 1 ? 's' : ''}! ðŸš€`;
        levelText.className = 'text-sm text-green-600 font-medium mt-2';
    } else if (levelChange < 0) {
        levelText.textContent = `${levelChange} Level${levelChange < -1 ? 's' : ''} - Keep practicing!`;
        levelText.className = 'text-sm text-amber-600 font-medium mt-2';
    } else {
        levelText.textContent = 'Steady progress! ðŸ’ª';
        levelText.className = 'text-sm text-blue-600 font-medium mt-2';
    }
}

// Restart quiz
function restartAdaptiveQuiz() {
    document.getElementById('adaptiveResultsScreen').classList.add('hidden');
    showAdaptiveQuizModal();
}

// Close results
function closeAdaptiveResults() {
    document.getElementById('adaptiveResultsScreen').classList.add('hidden');
}

// Abandon quiz
async function abandonAdaptiveQuiz() {
    if (confirm('Are you sure you want to exit? Your progress will be lost.')) {
        try {
            await fetch('/api/quiz-adaptive/abandon', { method: 'POST' });
        } catch (e) {
            // Ignore errors
        }
        document.getElementById('adaptiveQuizScreen').classList.add('hidden');
    }
}
</script>

</body>
</html>
