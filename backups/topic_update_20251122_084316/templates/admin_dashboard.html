<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Math Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <div class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">üéì Math Master - Admin Dashboard</h1>
            <div class="flex items-center gap-4">
                <span class="text-gray-700" id="adminName"></span>
                <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <!-- Statistics Cards -->
        <div class="grid md:grid-cols-4 gap-6 mb-8" id="statsCards"></div>

        <!-- Tab Navigation -->
        <div class="bg-white rounded-lg shadow-md mb-6">
            <div class="flex border-b overflow-x-auto">
                <button onclick="showTab('pending')" id="pendingTab" class="tab-button px-6 py-3 font-semibold border-b-2 border-purple-600 whitespace-nowrap">
                    <i class="fas fa-clock mr-2"></i>Pending Teachers
                </button>
                <button onclick="location.href='/admin/users'" class="tab-button px-6 py-3 font-semibold text-gray-600 hover:text-gray-800 whitespace-nowrap">
                    <i class="fas fa-users-cog mr-2"></i>User Management
                </button>
                <button onclick="showTab('classes')" id="classesTab" class="tab-button px-6 py-3 font-semibold text-gray-600 hover:text-gray-800 whitespace-nowrap">
                    <i class="fas fa-chalkboard mr-2"></i>All Classes
                </button>
                <button onclick="showTab('comparison')" id="comparisonTab" class="tab-button px-6 py-3 font-semibold text-gray-600 hover:text-gray-800 whitespace-nowrap">
                    <i class="fas fa-chart-bar mr-2"></i>Class Comparison
                </button>
                <button onclick="showTab('manageQuestions')" id="manageQuestionsTab" class="tab-button px-6 py-3 font-semibold text-gray-600 hover:text-gray-800 whitespace-nowrap">
                    <i class="fas fa-edit mr-2"></i>Manage Questions
                </button>
                <button onclick="showTab('questions')" id="questionsTab" class="tab-button px-6 py-3 font-semibold text-gray-600 hover:text-gray-800 whitespace-nowrap">
                    <i class="fas fa-question-circle mr-2"></i>Question Flags
                    <span id="pendingFlagsCount" class="ml-2 bg-red-500 text-white px-2 py-1 rounded-full text-xs hidden"></span>
                </button>
            
                <button onclick="showTab('domains')" id="domainsTab" class="tab-button px-6 py-3 font-semibold text-gray-600 hover:text-gray-800 whitespace-nowrap">
                    <i class="fas fa-shield-alt mr-2"></i>Domain Management
                </button>
            
        </div>

        <!-- Pending Teachers Tab -->
        <div id="pendingContent" class="tab-content">
            <h2 class="text-2xl font-bold mb-6">Teachers Pending Approval</h2>
            <div id="pendingList" class="bg-white rounded-lg shadow-md p-6"></div>
        </div>

        <!-- Classes Tab -->
        <div id="classesContent" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-6">All Classes</h2>
            <div id="classesList" class="bg-white rounded-lg shadow-md overflow-x-auto"></div>
        </div>

        <!-- Comparison Tab -->
        <div id="comparisonContent" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-6">Class Performance Comparison</h2>
            <div id="comparisonData" class="bg-white rounded-lg shadow-md overflow-x-auto"></div>
        </div>

        <!-- Manage Questions Tab -->
        <div id="manageQuestionsContent" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-6">Manage Questions</h2>

            <!-- Filter Section -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="grid md:grid-cols-3 gap-4">
                    <div>
                        <label class="block font-semibold mb-2">Topic:</label>
                        <select id="filterTopic" onchange="loadQuestionsByFilter()" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="">All Topics</option>
                            <option value="arithmetic">Arithmetic</option>
                            <option value="fractions">Fractions</option>
                            <option value="decimals">Decimals</option>
                            <option value="multiplication_division">Multiplication & Division</option>
                            <option value="number_systems">Number Systems</option>
                            <option value="bodmas">BODMAS</option>
                            <option value="introductory_algebra">Introductory Algebra</option>
                            <option value="patterns">Patterns</option>
                            <option value="functions">Functions</option>
                            <option value="solving_equations">Solving Equations</option>
                            <option value="simplifying_expressions">Simplifying Expressions</option>
                            <option value="expanding_factorising">Expanding & Factorising</option>
                            <option value="surds">Surds</option>
                            <option value="sets">Sets</option>
                            <option value="probability">Probability</option>
                            <option value="descriptive_statistics">Descriptive Statistics</option>
                            <option value="complex_numbers_intro">Complex Numbers Intro</option>
                            <option value="complex_numbers_expanded">Complex Numbers - Expanded</option>
                        </select>
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Difficulty:</label>
                        <select id="filterDifficulty" onchange="loadQuestionsByFilter()" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="">All Levels</option>
                            <option value="beginner">Beginner</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="advanced">Advanced</option>
                        </select>
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Search:</label>
                        <input type="text" id="searchQuestion" onkeyup="filterQuestionsLocally()" placeholder="Search question text..." class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                </div>
                <div class="mt-4 flex justify-between items-center">
                    <div class="text-gray-600">
                        <span class="font-semibold" id="questionCount">0</span> questions found
                    </div>
                    <button onclick="loadQuestionsByFilter()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700">
                        <i class="fas fa-sync mr-2"></i>Refresh
                    </button>
                </div>
            </div>

            <!-- Questions List -->
            <div id="questionsList" class="space-y-3">
                <div class="text-center text-gray-500 py-8">
                    <i class="fas fa-question-circle text-4xl mb-3"></i>
                    <p>Select filters above to view questions</p>
                </div>
            </div>
        </div>

        <!-- Question Flags Tab -->
        <div id="questionsContent" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-6">Question Management</h2>

            <!-- Statistics Cards -->
            <div class="grid md:grid-cols-4 gap-4 mb-6">
                <div class="bg-red-500 text-white rounded-lg p-4">
                    <div class="text-3xl font-bold" id="statPendingFlags">0</div>
                    <div class="text-sm">Pending Flags</div>
                </div>
                <div class="bg-blue-500 text-white rounded-lg p-4">
                    <div class="text-3xl font-bold" id="statFlaggedQuestions">0</div>
                    <div class="text-sm">Flagged Questions</div>
                </div>
                <div class="bg-green-500 text-white rounded-lg p-4">
                    <div class="text-3xl font-bold" id="statResolvedFlags">0</div>
                    <div class="text-sm">Resolved Flags</div>
                </div>
                <div class="bg-purple-500 text-white rounded-lg p-4">
                    <div class="text-3xl font-bold" id="statTotalEdits">0</div>
                    <div class="text-sm">Question Edits</div>
                </div>
            </div>

            <!-- Filter Tabs -->
            <div class="bg-white rounded-lg shadow-md mb-6">
                <div class="flex border-b">
                    <button onclick="filterFlags('pending')" id="filterPending" class="flag-filter px-6 py-3 font-semibold border-b-2 border-red-600">
                        Pending Flags
                    </button>
                    <button onclick="filterFlags('resolved')" id="filterResolved" class="flag-filter px-6 py-3 font-semibold text-gray-600">
                        Resolved
                    </button>
                    <button onclick="filterFlags('dismissed')" id="filterDismissed" class="flag-filter px-6 py-3 font-semibold text-gray-600">
                        Dismissed
                    </button>
                    <button onclick="filterFlags('all')" id="filterAll" class="flag-filter px-6 py-3 font-semibold text-gray-600">
                        All Flags
                    </button>
                </div>
            </div>

            <!-- Flags List -->
            <div id="flagsList" class="space-y-4"></div>
        </div>
    </div>

    <!-- Question Edit Modal -->
    <div id="editQuestionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 overflow-y-auto">
        <div class="bg-white rounded-lg p-8 max-w-4xl w-full mx-4 my-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Edit Question</h2>
                <button onclick="hideEditModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <!-- Flags for this question -->
            <div id="editQuestionFlags" class="mb-6"></div>

            <!-- Edit Form -->
            <form id="editQuestionForm" class="space-y-4">
                <input type="hidden" id="editQuestionId">

                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block font-semibold mb-2">Topic:</label>
                        <select id="editTopic" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="arithmetic">Arithmetic</option>
                            <option value="fractions">Fractions</option>
                            <option value="decimals">Decimals</option>
                            <option value="multiplication_division">Multiplication & Division</option>
                            <option value="number_systems">Number Systems</option>
                            <option value="bodmas">BODMAS</option>
                            <option value="functions">Functions</option>
                            <option value="surds">Surds</option>
                            <option value="sets">Sets</option>
                            <option value="probability">Probability</option>
                            <option value="descriptive_statistics">Descriptive Statistics</option>
                            <option value="patterns">Patterns</option>
                            <option value="complex_numbers_intro">Complex Numbers Intro</option>
                            <option value="complex_numbers_expanded">Complex Numbers - Expanded</option>
                        </select>
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Difficulty Level:</label>
                        <select id="editDifficulty" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="beginner">Beginner</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="advanced">Advanced</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block font-semibold mb-2">Question Text:</label>
                    <textarea id="editQuestionText" rows="3" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                </div>

                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block font-semibold mb-2">Option A:</label>
                        <input type="text" id="editOptionA" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Option B:</label>
                        <input type="text" id="editOptionB" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Option C:</label>
                        <input type="text" id="editOptionC" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Option D:</label>
                        <input type="text" id="editOptionD" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                </div>

                <div>
                    <label class="block font-semibold mb-2">Correct Answer:</label>
                    <select id="editCorrectAnswer" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="0">Option A</option>
                        <option value="1">Option B</option>
                        <option value="2">Option C</option>
                        <option value="3">Option D</option>
                    </select>
                </div>

                <div>
                    <label class="block font-semibold mb-2">Explanation:</label>
                    <textarea id="editExplanation" rows="3" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                </div>

                <div>
                    <label class="block font-semibold mb-2">Edit Notes (why you're making this change):</label>
                    <textarea id="editNotes" rows="2" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="E.g., Corrected answer based on student feedback"></textarea>
                </div>

                <div class="flex gap-4">
                    <button type="submit" class="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 font-semibold">
                        <i class="fas fa-save mr-2"></i>Save Changes
                    </button>
                    <button type="button" onclick="hideEditModal()" class="flex-1 bg-gray-300 text-gray-800 py-3 rounded-lg hover:bg-gray-400 font-semibold">
                        Cancel
                    </button>
                </div>
            </form>

            <!-- Edit History -->
            <div id="editHistory" class="mt-6"></div>
        </div>
    </div>

    
        <!-- Domain Management Tab -->
        <div id="domainsContent" class="tab-content hidden">
<!-- Add this as a new tab in your admin_dashboard.html -->
<!-- Place this inside the tab content area -->

<div id="domain-management-tab">
    <h2>üìß Email Domain Management</h2>
    <p class="text-muted">Control which email domains teachers can access for student enrollment and management.</p>
    
    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5><i class="fas fa-globe"></i> Total Domains</h5>
                    <h2 id="total-domains-count">0</h2>
                    <small>Unique email domains in system</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <h5><i class="fas fa-clock"></i> Pending Requests</h5>
                    <h2 id="pending-requests-count">0</h2>
                    <small>Teachers requesting access</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5><i class="fas fa-shield-alt"></i> Restricted Teachers</h5>
                    <h2 id="restricted-teachers-count">0</h2>
                    <small>Teachers with domain limits</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs mb-3" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="domains-overview-tab" data-toggle="tab" href="#domains-overview" role="tab">
                <i class="fas fa-list"></i> Domains Overview
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="teacher-access-tab" data-toggle="tab" href="#teacher-access" role="tab">
                <i class="fas fa-user-shield"></i> Teacher Access
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="access-requests-tab" data-toggle="tab" href="#access-requests" role="tab">
                <i class="fas fa-inbox"></i> Access Requests
                <span id="requests-badge" class="badge badge-warning ml-1">0</span>
            </a>
        </li>
    </ul>

    <div class="tab-content">
        <!-- Domains Overview Tab - ALWAYS VISIBLE BY DEFAULT -->
        <div class="tab-pane active" id="domains-overview" role="tabpanel" style="display: block !important;">
            <div class="card" style="display: block !important;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-globe"></i> All Email Domains</h5>
                    <button class="btn btn-sm btn-primary" onclick="refreshDomains()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
                <div class="card-body" style="display: block !important; min-height: 300px;">
                    <!-- Manual trigger button for testing -->
                    <div style="margin-bottom: 1rem; padding: 0.5rem; background: #fef3c7; border-left: 4px solid #f59e0b; display: flex; justify-content: space-between; align-items: center;">
                        <span>‚ö†Ô∏è Table not showing? Click here to force it:</span>
                        <button onclick="forceShowDomainTable()" class="btn btn-sm btn-warning" style="background: #f59e0b; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                            üîß Force Show Table
                        </button>
                    </div>
                    
                    <div class="table-responsive" style="display: block !important;">
                        <table class="table table-hover" style="display: table !important; width: 100% !important;">
                            <thead>
                                <tr>
                                    <th>Domain</th>
                                    <th>Students</th>
                                    <th>Teachers</th>
                                    <th>Teachers with Access</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="domains-table-body" style="display: table-row-group !important;">
                                <tr style="display: table-row !important;">
                                    <td colspan="5" class="text-center" style="display: table-cell !important; padding: 2rem;">
                                        <div style="font-size: 1rem; color: #6b7280;">
                                            <i class="fas fa-spinner fa-spin"></i> Loading domains...
                                        </div>
                                        <div style="margin-top: 1rem; font-size: 0.875rem; color: #9ca3af;">
                                            If this message persists, click the "Force Show Table" button above.
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Teacher Access Tab -->
        <div class="tab-pane" id="teacher-access" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-user-shield"></i> Manage Teacher Domain Access</h5>
                </div>
                <div class="card-body">
                    <!-- Teacher Selection -->
                    <div class="form-group">
                        <label>Select Teacher:</label>
                        <select class="form-control" id="teacher-select" onchange="loadTeacherDomains()">
                            <option value="">-- Select a teacher --</option>
                        </select>
                    </div>

                    <div id="teacher-domains-container" style="display: none;">
                        <hr>
                        
                        <!-- Teacher Info -->
                        <div class="alert alert-info">
                            <h6 id="teacher-info-name"></h6>
                            <p id="teacher-info-email" class="mb-0 text-muted small"></p>
                        </div>

                        <!-- Access Status -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6>Access Status</h6>
                                        <p id="teacher-access-status" class="mb-0"></p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6>Accessible Students</h6>
                                        <p id="teacher-student-count" class="mb-0"></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Assigned Domains -->
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="fas fa-check-circle text-success"></i> Assigned Domains</h6>
                                <button class="btn btn-sm btn-warning" onclick="removeAllRestrictions()">
                                    <i class="fas fa-unlock"></i> Remove All Restrictions
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="assigned-domains-list">
                                    <p class="text-muted">No domains assigned</p>
                                </div>
                            </div>
                        </div>

                        <!-- Add Domain -->
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-plus-circle"></i> Assign New Domain</h6>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label>Select Domain:</label>
                                    <select class="form-control" id="domain-to-assign">
                                        <option value="">-- Select a domain --</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Notes (optional):</label>
                                    <textarea class="form-control" id="assign-notes" rows="2" 
                                              placeholder="Optional notes about this assignment..."></textarea>
                                </div>
                                <button class="btn btn-success" onclick="assignDomain()">
                                    <i class="fas fa-plus"></i> Assign Domain
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Access Requests Tab -->
        <div class="tab-pane" id="access-requests" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-inbox"></i> Domain Access Requests</h5>
                    <div>
                        <select class="form-control form-control-sm" id="request-status-filter" 
                                onchange="loadAccessRequests()">
                            <option value="pending">Pending Only</option>
                            <option value="all">All Requests</option>
                            <option value="approved">Approved</option>
                            <option value="denied">Denied</option>
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <div id="access-requests-container">
                        <div class="text-center">
                            <i class="fas fa-spinner fa-spin"></i> Loading requests...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Domain Details -->
<div class="modal fade" id="domainDetailsModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Domain Details: <span id="modal-domain-name"></span></h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="domain-details-content">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<style>
    .domain-tag {
        display: inline-block;
        background: #e3f2fd;
        border: 1px solid #2196f3;
        border-radius: 15px;
        padding: 5px 12px;
        margin: 3px;
        font-size: 0.9em;
    }
    
    .domain-tag .remove-btn {
        color: #f44336;
        margin-left: 8px;
        cursor: pointer;
        font-weight: bold;
    }
    
    .domain-tag .remove-btn:hover {
        color: #d32f2f;
    }
    
    .request-card {
        border-left: 4px solid #ffc107;
        margin-bottom: 15px;
    }
    
    .request-card.approved {
        border-left-color: #4caf50;
    }
    
    .request-card.denied {
        border-left-color: #f44336;
    }
    
    /* Bootstrap compatibility styles for domain management */
    .card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }
    
    .card-header {
        padding: 1rem;
        border-bottom: 1px solid #e5e7eb;
        background: #f9fafb;
        border-radius: 8px 8px 0 0;
    }
    
    .card-body {
        padding: 1rem;
    }
    
    .nav-tabs {
        border-bottom: 2px solid #e5e7eb;
        display: flex;
        margin-bottom: 1rem;
    }
    
    .nav-item {
        margin-bottom: -2px;
    }
    
    .nav-link {
        padding: 0.75rem 1.5rem;
        border: none;
        border-bottom: 3px solid transparent;
        background: none;
        cursor: pointer;
        color: #6b7280;
        text-decoration: none;
        display: block;
    }
    
    .nav-link:hover {
        color: #374151;
        border-bottom-color: #d1d5db;
    }
    
    .nav-link.active {
        color: #7c3aed;
        border-bottom-color: #7c3aed;
        font-weight: 600;
    }
    
    .tab-pane {
        display: none;
    }
    
    .tab-pane.show.active,
    .tab-pane.active {
        display: block;
    }
    
    .form-control {
        padding: 0.5rem 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        width: 100%;
    }
    
    .form-control-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    
    .table-responsive {
        overflow-x: auto;
    }
    
    .table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .table th, .table td {
        padding: 0.75rem;
        border-bottom: 1px solid #e5e7eb;
        text-align: left;
    }
    
    .table th {
        background: #f9fafb;
        font-weight: 600;
    }
    
    .table-hover tbody tr:hover {
        background: #f9fafb;
    }
    
    .table tbody tr {
        background: white;
    }
    
    .table tbody td {
        vertical-align: middle;
    }
    
    /* Ensure tab content is visible */
    #domainsContent .tab-pane.fade {
        transition: none;
    }
    
    #domainsContent .tab-pane.show {
        display: block !important;
        opacity: 1;
    }
    
    /* Force Domains Overview tab to be visible when active */
    #domains-overview.tab-pane.show.active {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        height: auto !important;
        overflow: visible !important;
    }
    
    /* Override any hidden class on domain management elements */
    #domainsContent:not(.hidden),
    #domainsContent.tab-content,
    #domain-management-tab,
    #domains-overview,
    #domains-overview *:not(.modal) {
        display: revert !important;
    }
    
    #domains-overview.tab-pane.active {
        display: block !important;
    }
    
    /* Tailwind hidden class override for domain tab */
    #domainsContent.hidden {
        display: block !important;
    }
    
    #domains-overview .hidden {
        display: revert !important;
    }
    
    /* Force table visibility */
    #domains-overview .table-responsive,
    #domains-overview .card,
    #domains-overview .card-body {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    #domains-overview table {
        display: table !important;
        width: 100% !important;
    }
    
    #domains-overview tbody {
        display: table-row-group !important;
    }
    
    #domains-overview tr {
        display: table-row !important;
    }
    
    #domains-overview td,
    #domains-overview th {
        display: table-cell !important;
    }
    
    .badge {
        padding: 0.25rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .badge-warning {
        background: #fbbf24;
        color: #78350f;
    }
    
    .badge-success {
        background: #10b981;
        color: white;
    }
    
    .btn {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-weight: 500;
    }
    
    .btn-sm {
        padding: 0.25rem 0.75rem;
        font-size: 0.875rem;
    }
    
    .btn-primary {
        background: #7c3aed;
        color: white;
    }
    
    .btn-primary:hover {
        background: #6d28d9;
    }
    
    .btn-success {
        background: #10b981;
        color: white;
    }
    
    .btn-success:hover {
        background: #059669;
    }
    
    .btn-danger {
        background: #ef4444;
        color: white;
    }
    
    .btn-danger:hover {
        background: #dc2626;
    }
    
    .btn-warning {
        background: #f59e0b;
        color: white;
    }
    
    .btn-warning:hover {
        background: #d97706;
    }
    
    .d-flex {
        display: flex;
    }
    
    .justify-content-between {
        justify-content: space-between;
    }
    
    .align-items-center {
        align-items: center;
    }
    
    .mb-0 {
        margin-bottom: 0;
    }
    
    .mb-3 {
        margin-bottom: 0.75rem;
    }
    
    .mb-4 {
        margin-bottom: 1rem;
    }
    
    .ml-1 {
        margin-left: 0.25rem;
    }
    
    .text-center {
        text-align: center;
    }
    
    .text-muted {
        color: #6b7280;
    }
    
    .text-danger {
        color: #ef4444;
    }
    
    .row {
        display: flex;
        flex-wrap: wrap;
        margin: -0.5rem;
    }
    
    .col-md-4 {
        flex: 0 0 33.333%;
        padding: 0.5rem;
    }
    
    @media (max-width: 768px) {
        .col-md-4 {
            flex: 0 0 100%;
        }
    }
    
    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
    }
    
    .modal.show {
        display: block;
    }
    
    .modal-dialog {
        position: relative;
        width: auto;
        margin: 1.75rem auto;
        max-width: 500px;
    }
    
    .modal-dialog.modal-lg {
        max-width: 800px;
    }
    
    .modal-content {
        position: relative;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .modal-title {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
    }
    
    .modal-body {
        padding: 1rem;
    }
    
    .close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #6b7280;
        padding: 0;
        line-height: 1;
    }
    
    .close:hover {
        color: #374151;
    }
    
    /* Bootstrap background colors */
    .bg-primary {
        background-color: #7c3aed !important;
    }
    
    .bg-success {
        background-color: #10b981 !important;
    }
    
    .bg-info {
        background-color: #06b6d4 !important;
    }
    
    .bg-warning {
        background-color: #f59e0b !important;
    }
    
    .bg-danger {
        background-color: #ef4444 !important;
    }
    
    .text-white {
        color: white !important;
    }
    
    .text-dark {
        color: #1f2937 !important;
    }
    
    /* Badge variants */
    .badge-primary {
        background-color: #7c3aed;
        color: white;
    }
    
    .badge-secondary {
        background-color: #6b7280;
        color: white;
    }
    
    .badge-info {
        background-color: #06b6d4;
        color: white;
    }
    
    /* Button outline variants */
    .btn-outline-primary {
        background-color: transparent;
        border: 1px solid #7c3aed;
        color: #7c3aed;
    }
    
    .btn-outline-primary:hover {
        background-color: #7c3aed;
        color: white;
    }
    
    /* Additional card styling */
    .card h2 {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 0.5rem 0;
    }
    
    .card h5 {
        margin: 0 0 0.5rem 0;
        font-size: 1rem;
    }
    
    .card small {
        font-size: 0.875rem;
        opacity: 0.9;
    }
    
    /* Ensure cards have proper min-height */
    .card.bg-primary,
    .card.bg-warning,
    .card.bg-info,
    .card.bg-success,
    .card.bg-danger {
        min-height: 120px;
    }
</style>

<script>
// Domain Management JavaScript

let currentTeacherId = null;
let allDomains = [];

// NOTE: Domain initialization is handled by showTab('domains') function
// which calls refreshDomains(), loadTeachersList(), and loadAccessRequests()

// Handle internal tabs within domain management (domains-overview, teacher-access, access-requests)
function initDomainTabs() {
    document.querySelectorAll('#domainsContent .nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            
            // Remove active class from all tabs
            document.querySelectorAll('#domainsContent .nav-link').forEach(l => l.classList.remove('active'));
            document.querySelectorAll('#domainsContent .tab-pane').forEach(p => {
                p.classList.remove('show', 'active');
            });
            
            // Add active class to clicked tab
            this.classList.add('active');
            const targetPane = document.getElementById(targetId);
            if (targetPane) {
                targetPane.classList.add('show', 'active');
            }
            
            // Load data for specific tabs when they're opened
            if (targetId === 'teacher-access') {
                console.log('Teacher Access tab opened, loading teachers...');
                loadTeachersList();
            } else if (targetId === 'access-requests') {
                console.log('Access Requests tab opened, loading requests...');
                loadAccessRequests();
            }
        });
    });
}

// Initialize tabs when page loads
window.addEventListener('DOMContentLoaded', initDomainTabs);

// Global debug function - call from console: debugDomainTab()
window.debugDomainTab = function() {
    const domainsContent = document.getElementById('domainsContent');
    const domainTab = document.getElementById('domain-management-tab');
    const domainsOverview = document.getElementById('domains-overview');
    const tbody = document.getElementById('domains-table-body');
    
    console.log('=== Domain Tab Debug Info ===');
    console.log('domainsContent:', {
        exists: !!domainsContent,
        display: domainsContent?.style.display,
        computed: domainsContent ? window.getComputedStyle(domainsContent).display : null,
        classes: domainsContent?.className
    });
    console.log('domain-management-tab:', {
        exists: !!domainTab,
        display: domainTab?.style.display,
        computed: domainTab ? window.getComputedStyle(domainTab).display : null
    });
    console.log('domains-overview:', {
        exists: !!domainsOverview,
        display: domainsOverview?.style.display,
        computed: domainsOverview ? window.getComputedStyle(domainsOverview).display : null,
        classes: domainsOverview?.className,
        visible: domainsOverview ? domainsOverview.offsetHeight > 0 : false
    });
    console.log('tbody:', {
        exists: !!tbody,
        rowCount: tbody?.querySelectorAll('tr').length,
        visible: tbody ? tbody.offsetHeight > 0 : false,
        height: tbody?.offsetHeight,
        firstRowHTML: tbody?.querySelector('tr')?.innerHTML.substring(0, 100)
    });
    console.log('=== End Debug Info ===');
};

// Nuclear option - force everything visible
window.forceShowDomainTable = function() {
    console.log('üö® NUCLEAR OPTION - Forcing table visible...');
    
    // Get all elements
    const domainsContent = document.getElementById('domainsContent');
    const domainTab = document.getElementById('domain-management-tab');
    const domainsOverview = document.getElementById('domains-overview');
    const card = domainsOverview?.querySelector('.card');
    const cardHeader = card?.querySelector('.card-header');
    const cardBody = card?.querySelector('.card-body');
    const tableResponsive = cardBody?.querySelector('.table-responsive');
    const table = tableResponsive?.querySelector('table');
    const tbody = document.getElementById('domains-table-body');
    
    // Force everything with inline styles that override everything
    const elements = [
        {el: domainsContent, name: 'domainsContent'},
        {el: domainTab, name: 'domainTab'},
        {el: domainsOverview, name: 'domainsOverview'},
        {el: card, name: 'card'},
        {el: cardHeader, name: 'cardHeader'},
        {el: cardBody, name: 'cardBody'},
        {el: tableResponsive, name: 'tableResponsive'},
        {el: table, name: 'table'},
        {el: tbody, name: 'tbody'}
    ];
    
    elements.forEach(({el, name}) => {
        if (el) {
            el.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; position: relative !important; height: auto !important; min-height: 50px !important;';
            el.classList.remove('hidden');
            console.log(`‚úÖ Forced ${name}`);
        } else {
            console.log(`‚ùå ${name} not found`);
        }
    });
    
    // Special handling for table elements
    if (table) {
        table.style.display = 'table !important';
    }
    if (tbody) {
        tbody.style.display = 'table-row-group !important';
    }
    
    // Force all rows
    tbody?.querySelectorAll('tr').forEach((row, i) => {
        row.style.cssText = 'display: table-row !important; visibility: visible !important; opacity: 1 !important;';
    });
    
    // Force all cells
    tbody?.querySelectorAll('td, th').forEach((cell) => {
        cell.style.cssText = 'display: table-cell !important; visibility: visible !important; opacity: 1 !important;';
    });
    
    console.log('‚úÖ All elements forced visible');
    console.log('Table height:', tbody?.offsetHeight, 'px');
    console.log('Table width:', tbody?.offsetWidth, 'px');
    
    // Scroll into view
    if (domainsOverview) {
        domainsOverview.scrollIntoView({behavior: 'smooth', block: 'start'});
    }
};

console.log('üí° Tip: If table not showing, try: forceShowDomainTable()');

// Modal handling functions (Bootstrap-free)
function showModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('show');
        modal.style.display = 'block';
    }
}

function hideModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('show');
        modal.style.display = 'none';
    }
}

// Setup close button handlers for all modals
window.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[data-dismiss="modal"]').forEach(btn => {
        btn.addEventListener('click', function() {
            const modal = this.closest('.modal');
            if (modal) {
                modal.classList.remove('show');
                modal.style.display = 'none';
            }
        });
    });
    
    // Close modal when clicking outside
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('show');
                this.style.display = 'none';
            }
        });
    });
});

// Refresh all domains
async function refreshDomains() {
    console.log('refreshDomains() called');
    try {
        const response = await fetch('/api/admin/domains');
        console.log('API response status:', response.status);
        
        const data = await response.json();
        console.log('Domains data received:', data);
        
        allDomains = data.domains;
        document.getElementById('total-domains-count').textContent = data.total_domains;
        
        renderDomainsTable(data.domains);
        updateRestrictedTeachersCount();
    } catch (error) {
        console.error('Error loading domains:', error);
        const tbody = document.getElementById('domains-table-body');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading domains. Please refresh the page.</td></tr>';
        }
    }
}

// Render domains table
function renderDomainsTable(domains) {
    const tbody = document.getElementById('domains-table-body');
    
    if (!tbody) {
        console.error('domains-table-body element not found!');
        return;
    }
    
    console.log('Rendering domains table with', domains.length, 'domains');
    
    if (domains.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No domains found in the system</td></tr>';
        return;
    }
    
    tbody.innerHTML = domains.map(domain => `
        <tr>
            <td><strong>${domain.domain}</strong></td>
            <td>
                <span class="badge badge-primary">${domain.student_count}</span>
            </td>
            <td>
                <span class="badge badge-info">${domain.teacher_count}</span>
            </td>
            <td>
                ${domain.teachers_with_access.length === 0 
                    ? '<span class="text-muted">No restrictions</span>'
                    : domain.teachers_with_access.map(t => 
                        `<span class="badge badge-secondary" title="${t.email}">${t.name}</span>`
                      ).join(' ')}
            </td>
            <td>
                <button class="btn btn-sm btn-outline-primary" 
                        onclick="showDomainDetails('${domain.domain}')">
                    <i class="fas fa-info-circle"></i> Details
                </button>
            </td>
        </tr>
    `).join('');
    
    console.log('Domains table rendered successfully');
    
    // Debug: Check if table is actually visible and force visibility aggressively
    setTimeout(() => {
        const tabPane = document.getElementById('domains-overview');
        const card = tabPane?.querySelector('.card');
        const cardBody = card?.querySelector('.card-body');
        const tableResponsive = cardBody?.querySelector('.table-responsive');
        const table = tableResponsive?.querySelector('table');
        
        const tableVisible = tbody.offsetHeight > 0 && tbody.offsetWidth > 0;
        
        console.log('Table visibility check:', {
            exists: !!tbody,
            visible: tableVisible,
            height: tbody.offsetHeight,
            width: tbody.offsetWidth,
            rowCount: tbody.querySelectorAll('tr').length,
            computedDisplay: tbody ? window.getComputedStyle(tbody).display : null,
            computedVisibility: tbody ? window.getComputedStyle(tbody).visibility : null,
            computedOpacity: tbody ? window.getComputedStyle(tbody).opacity : null,
            parentDisplay: tabPane ? window.getComputedStyle(tabPane).display : null,
            parentHeight: tabPane?.offsetHeight,
            html: tbody.innerHTML.substring(0, 200) + '...'
        });
        
        // SUPER AGGRESSIVE: Force everything visible no matter what
        if (tabPane) {
            tabPane.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; position: relative !important; height: auto !important; overflow: visible !important; z-index: 1 !important;';
            tabPane.classList.add('show', 'active');
            console.log('FORCED tab-pane with cssText');
        }
        if (card) {
            card.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important;';
            console.log('FORCED card with cssText');
        }
        if (cardBody) {
            cardBody.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; min-height: 200px !important;';
            console.log('FORCED card-body with cssText');
        }
        if (tableResponsive) {
            tableResponsive.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; overflow: auto !important;';
            console.log('FORCED table-responsive with cssText');
        }
        if (table) {
            table.style.cssText = 'display: table !important; visibility: visible !important; opacity: 1 !important; width: 100% !important;';
            console.log('FORCED table with cssText');
        }
        if (tbody) {
            tbody.style.cssText = 'display: table-row-group !important; visibility: visible !important; opacity: 1 !important;';
            console.log('FORCED tbody with cssText');
        }
        
        // Force all rows visible
        tbody.querySelectorAll('tr').forEach((row, i) => {
            row.style.cssText = 'display: table-row !important; visibility: visible !important; opacity: 1 !important;';
            console.log(`FORCED row ${i}`);
        });
        
        console.log('All force-visibility operations complete');
        
        // Double-check after forcing
        setTimeout(() => {
            const stillNotVisible = tbody.offsetHeight === 0 || tbody.offsetWidth === 0;
            console.log('After forcing - visible?', !stillNotVisible, {
                height: tbody.offsetHeight,
                width: tbody.offsetWidth,
                boundingRect: tbody.getBoundingClientRect()
            });
        }, 100);
    }, 100);
}

// Load teachers list
async function loadTeachersList() {
    console.log('loadTeachersList() called');
    try {
        const response = await fetch('/api/admin/all-users?role=teacher');
        console.log('Teachers API response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const teachers = await response.json();
        console.log('Teachers loaded:', teachers.length, 'total');
        
        const select = document.getElementById('teacher-select');
        if (!select) {
            console.error('teacher-select element not found!');
            return;
        }
        
        const approvedTeachers = teachers.filter(t => t.is_approved);
        console.log('Approved teachers:', approvedTeachers.length);
        
        select.innerHTML = '<option value="">-- Select a teacher --</option>' +
            approvedTeachers
                .map(t => `<option value="${t.id}">${t.full_name} (${t.email})</option>`)
                .join('');
        
        console.log('Teacher dropdown populated with', approvedTeachers.length, 'teachers');
    } catch (error) {
        console.error('Error loading teachers:', error);
        const select = document.getElementById('teacher-select');
        if (select) {
            select.innerHTML = '<option value="">‚ö†Ô∏è Error loading teachers</option>';
        }
    }
}

// Load teacher's domains
async function loadTeacherDomains() {
    const teacherId = document.getElementById('teacher-select').value;
    
    if (!teacherId) {
        document.getElementById('teacher-domains-container').style.display = 'none';
        return;
    }
    
    currentTeacherId = teacherId;
    
    try {
        const response = await fetch(`/api/admin/teacher/${teacherId}/domains`);
        const data = await response.json();
        
        // Show container
        document.getElementById('teacher-domains-container').style.display = 'block';
        
        // Update teacher info
        document.getElementById('teacher-info-name').textContent = data.teacher.full_name;
        document.getElementById('teacher-info-email').textContent = data.teacher.email;
        
        // Update status
        const hasRestrictions = data.statistics.has_restrictions;
        document.getElementById('teacher-access-status').innerHTML = hasRestrictions
            ? '<span class="badge badge-warning"><i class="fas fa-lock"></i> Restricted Access</span>'
            : '<span class="badge badge-success"><i class="fas fa-unlock"></i> Full Access (No Restrictions)</span>';
        
        document.getElementById('teacher-student-count').textContent = 
            `${data.statistics.accessible_student_count} students`;
        
        // Render assigned domains
        renderAssignedDomains(data.assigned_domains);
        
        // Populate available domains dropdown
        populateAvailableDomains(data.assigned_domains, data.available_domains);
        
    } catch (error) {
        console.error('Error loading teacher domains:', error);
        alert('Failed to load teacher domains');
    }
}

// Render assigned domains
function renderAssignedDomains(domains) {
    const container = document.getElementById('assigned-domains-list');
    
    if (domains.length === 0) {
        container.innerHTML = '<p class="text-muted">No domains assigned. This teacher has full access to all students.</p>';
        return;
    }
    
    container.innerHTML = domains.map(d => `
        <div class="domain-tag">
            <i class="fas fa-shield-alt"></i> ${d.email_domain}
            <span class="remove-btn" onclick="revokeDomain('${d.email_domain}')" 
                  title="Remove access">√ó</span>
        </div>
    `).join('');
}

// Populate available domains dropdown
function populateAvailableDomains(assigned, available) {
    const assignedDomains = assigned.map(d => d.email_domain);
    const select = document.getElementById('domain-to-assign');
    
    const availableOptions = available
        .filter(d => !assignedDomains.includes(d.domain))
        .map(d => `<option value="${d.domain}">${d.domain} (${d.student_count} students)</option>`)
        .join('');
    
    select.innerHTML = '<option value="">-- Select a domain --</option>' + availableOptions;
}

// Assign domain to teacher
async function assignDomain() {
    const domain = document.getElementById('domain-to-assign').value;
    const notes = document.getElementById('assign-notes').value;
    
    if (!domain) {
        alert('Please select a domain');
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/teacher/${currentTeacherId}/domains`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ domain, notes })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert('Domain access granted successfully');
            loadTeacherDomains();
            document.getElementById('assign-notes').value = '';
        } else {
            alert(data.error || 'Failed to assign domain');
        }
    } catch (error) {
        console.error('Error assigning domain:', error);
        alert('Failed to assign domain');
    }
}

// Revoke domain from teacher
async function revokeDomain(domain) {
    if (!confirm(`Remove access to ${domain}?`)) return;
    
    try {
        const response = await fetch(
            `/api/admin/teacher/${currentTeacherId}/domains/${encodeURIComponent(domain)}`,
            { method: 'DELETE' }
        );
        
        if (response.ok) {
            alert('Domain access revoked successfully');
            loadTeacherDomains();
            refreshDomains();
        } else {
            alert('Failed to revoke domain access');
        }
    } catch (error) {
        console.error('Error revoking domain:', error);
        alert('Failed to revoke domain access');
    }
}

// Remove all restrictions
async function removeAllRestrictions() {
    if (!confirm('Remove ALL domain restrictions? This teacher will have full access to all students.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/teacher/${currentTeacherId}/remove-all-restrictions`, {
            method: 'POST'
        });
        
        if (response.ok) {
            alert('All restrictions removed. Teacher now has full access.');
            loadTeacherDomains();
            refreshDomains();
        } else {
            alert('Failed to remove restrictions');
        }
    } catch (error) {
        console.error('Error removing restrictions:', error);
        alert('Failed to remove restrictions');
    }
}

// Load access requests
async function loadAccessRequests() {
    const status = document.getElementById('request-status-filter').value;
    
    try {
        const response = await fetch(`/api/admin/domain-requests?status=${status}`);
        const data = await response.json();
        
        document.getElementById('pending-requests-count').textContent = 
            data.requests.filter(r => r.status === 'pending').length;
        document.getElementById('requests-badge').textContent = 
            data.requests.filter(r => r.status === 'pending').length;
        
        renderAccessRequests(data.requests);
    } catch (error) {
        console.error('Error loading requests:', error);
    }
}

// Render access requests
function renderAccessRequests(requests) {
    const container = document.getElementById('access-requests-container');
    
    if (requests.length === 0) {
        container.innerHTML = '<p class="text-center text-muted">No requests found</p>';
        return;
    }
    
    container.innerHTML = requests.map(req => `
        <div class="card request-card ${req.status}">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6>
                            ${req.teacher_name}
                            <small class="text-muted">(${req.teacher_email})</small>
                        </h6>
                        <p class="mb-1">
                            <strong>Domain:</strong> <span class="badge badge-info">${req.email_domain}</span>
                        </p>
                        <p class="mb-1"><strong>Reason:</strong> ${req.reason}</p>
                        <small class="text-muted">
                            Requested: ${new Date(req.requested_at).toLocaleString()}
                        </small>
                        ${req.status !== 'pending' ? `
                            <br><small class="text-muted">
                                ${req.status === 'approved' ? 'Approved' : 'Denied'} by ${req.reviewed_by} 
                                on ${new Date(req.reviewed_at).toLocaleString()}
                            </small>
                        ` : ''}
                        ${req.admin_notes ? `<br><small><strong>Admin Notes:</strong> ${req.admin_notes}</small>` : ''}
                    </div>
                    <div class="col-md-4 text-right">
                        ${req.status === 'pending' ? `
                            <button class="btn btn-success btn-sm mb-2" 
                                    onclick="approveRequest(${req.id})">
                                <i class="fas fa-check"></i> Approve
                            </button>
                            <button class="btn btn-danger btn-sm mb-2" 
                                    onclick="denyRequest(${req.id})">
                                <i class="fas fa-times"></i> Deny
                            </button>
                        ` : `
                            <span class="badge badge-${req.status === 'approved' ? 'success' : 'danger'}">
                                ${req.status.toUpperCase()}
                            </span>
                        `}
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// Approve request
async function approveRequest(requestId) {
    const notes = prompt('Optional notes for approval:');
    
    try {
        const response = await fetch(`/api/admin/domain-requests/${requestId}/approve`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ admin_notes: notes || '' })
        });
        
        if (response.ok) {
            alert('Request approved successfully');
            loadAccessRequests();
            refreshDomains();
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to approve request');
        }
    } catch (error) {
        console.error('Error approving request:', error);
        alert('Failed to approve request');
    }
}

// Deny request
async function denyRequest(requestId) {
    const notes = prompt('Please provide a reason for denial:');
    
    if (!notes) {
        alert('Reason is required for denial');
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/domain-requests/${requestId}/deny`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ admin_notes: notes })
        });
        
        if (response.ok) {
            alert('Request denied');
            loadAccessRequests();
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to deny request');
        }
    } catch (error) {
        console.error('Error denying request:', error);
        alert('Failed to deny request');
    }
}

// Show domain details modal
function showDomainDetails(domain) {
    document.getElementById('modal-domain-name').textContent = domain;
    const domainData = allDomains.find(d => d.domain === domain);
    
    if (!domainData) return;
    
    const content = document.getElementById('domain-details-content');
    content.innerHTML = `
        <h6>Statistics</h6>
        <ul>
            <li>Students: ${domainData.student_count}</li>
            <li>Teachers: ${domainData.teacher_count}</li>
            <li>Teachers with Access: ${domainData.teachers_with_access.length}</li>
        </ul>
        ${domainData.teachers_with_access.length > 0 ? `
            <h6>Teachers with Access:</h6>
            <ul>
                ${domainData.teachers_with_access.map(t => 
                    `<li>${t.name} (${t.email})</li>`
                ).join('')}
            </ul>
        ` : '<p class="text-muted">No access restrictions for this domain</p>'}
    `;
    
    showModal('domainDetailsModal');
}

// Update restricted teachers count
function updateRestrictedTeachersCount() {
    // This is a simple count - in production you'd fetch from backend
    const restrictedTeachers = new Set();
    allDomains.forEach(d => {
        d.teachers_with_access.forEach(t => restrictedTeachers.add(t.id));
    });
    document.getElementById('restricted-teachers-count').textContent = restrictedTeachers.size;
}
</script>

        </div>


    <script>
        window.onload = async function() {
            await loadAdminName();
            await loadStatistics();
            await loadPendingTeachers();
        };

        async function loadAdminName() {
            try {
                const response = await fetch('/api/current-user');
                const user = await response.json();
                document.getElementById('adminName').textContent = user.full_name;
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function loadStatistics() {
            try {
                const response = await fetch('/api/admin/statistics');
                const stats = await response.json();

                document.getElementById('statsCards').innerHTML = `
                    <div class="bg-blue-500 text-white rounded-lg p-6 shadow-lg">
                        <div class="text-4xl font-bold">${stats.total_students}</div>
                        <div class="text-sm opacity-90">Total Students</div>
                    </div>
                    <div class="bg-green-500 text-white rounded-lg p-6 shadow-lg">
                        <div class="text-4xl font-bold">${stats.total_teachers}</div>
                        <div class="text-sm opacity-90">Approved Teachers</div>
                    </div>
                    <div class="bg-yellow-500 text-white rounded-lg p-6 shadow-lg">
                        <div class="text-4xl font-bold">${stats.pending_teachers}</div>
                        <div class="text-sm opacity-90">Pending Approvals</div>
                    </div>
                    <div class="bg-purple-500 text-white rounded-lg p-6 shadow-lg">
                        <div class="text-4xl font-bold">${stats.total_classes}</div>
                        <div class="text-sm opacity-90">Total Classes</div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        async function loadPendingTeachers() {
            try {
                const response = await fetch('/api/admin/pending-teachers');
                const teachers = await response.json();

                const list = document.getElementById('pendingList');
                if (teachers.length === 0) {
                    list.innerHTML = '<p class="text-gray-600">No pending teacher approvals.</p>';
                } else {
                    list.innerHTML = teachers.map(t => `
                        <div class="flex justify-between items-center p-4 border-b">
                            <div>
                                <div class="font-semibold text-lg">${t.full_name}</div>
                                <div class="text-gray-600">${t.email}</div>
                                <div class="text-sm text-gray-500">Registered: ${new Date(t.created_at).toLocaleString()}</div>
                            </div>
                            <button onclick="approveTeacher(${t.id})"
                                    class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600">
                                <i class="fas fa-check mr-2"></i>Approve
                            </button>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function approveTeacher(teacherId) {
            if (!confirm('Approve this teacher account?')) return;

            try {
                const response = await fetch(`/api/admin/approve-teacher/${teacherId}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    alert('Teacher approved successfully!');
                    await loadPendingTeachers();
                    await loadStatistics();
                } else {
                    alert('Failed to approve teacher');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function filterUsers() {
            const role = document.getElementById('userRoleFilter').value;
            try {
                const url = role ? `/api/admin/all-users?role=${role}` : '/api/admin/all-users';
                const response = await fetch(url);
                const users = await response.json();

                const list = document.getElementById('usersList');
                list.innerHTML = `
                    <table class="w-full">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="px-4 py-2 text-left">Name</th>
                                <th class="px-4 py-2 text-left">Email</th>
                                <th class="px-4 py-2 text-left">Role</th>
                                <th class="px-4 py-2 text-left">Status</th>
                                <th class="px-4 py-2 text-left">Registered</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map(u => `
                                <tr class="border-b">
                                    <td class="px-4 py-3">${u.full_name}</td>
                                    <td class="px-4 py-3">${u.email}</td>
                                    <td class="px-4 py-3">
                                        <span class="px-2 py-1 rounded text-sm ${
                                            u.role === 'admin' ? 'bg-red-100 text-red-800' :
                                            u.role === 'teacher' ? 'bg-blue-100 text-blue-800' :
                                            'bg-green-100 text-green-800'
                                        }">${u.role}</span>
                                    </td>
                                    <td class="px-4 py-3">
                                        ${u.is_approved ?
                                            '<span class="text-green-600">‚úì Approved</span>' :
                                            '<span class="text-yellow-600">‚è≥ Pending</span>'}
                                    </td>
                                    <td class="px-4 py-3">${new Date(u.created_at).toLocaleDateString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function loadAllClasses() {
            try {
                const response = await fetch('/api/admin/all-classes');
                const classes = await response.json();

                const list = document.getElementById('classesList');
                if (classes.length === 0) {
                    list.innerHTML = '<p class="p-6 text-gray-600">No classes created yet.</p>';
                } else {
                    list.innerHTML = `
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="px-4 py-2 text-left">Class Name</th>
                                    <th class="px-4 py-2 text-left">Teacher</th>
                                    <th class="px-4 py-2 text-center">Students</th>
                                    <th class="px-4 py-2 text-left">Created</th>
                                    <th class="px-4 py-2 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${classes.map(c => `
                                    <tr class="border-b">
                                        <td class="px-4 py-3 font-semibold">${c.name}</td>
                                        <td class="px-4 py-3">${c.teacher_name || 'N/A'}</td>
                                        <td class="px-4 py-3 text-center">${c.student_count}</td>
                                        <td class="px-4 py-3">${new Date(c.created_at).toLocaleDateString()}</td>
                                        <td class="px-4 py-3 text-center">
                                            <button onclick="renameClass(${c.id}, '${c.name.replace(/'/g, "\\'")}')"
                                                    class="text-blue-600 hover:text-blue-800 mr-2">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function renameClass(classId, currentName) {
            const newName = prompt('Enter new class name:', currentName);
            if (!newName || newName === currentName) return;

            try {
                const response = await fetch(`/api/admin/rename-class/${classId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name: newName })
                });

                if (response.ok) {
                    alert('Class renamed successfully!');
                    await loadAllClasses();
                } else {
                    alert('Failed to rename class');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function loadClassComparison() {
            try {
                const response = await fetch('/api/admin/class-comparison');
                const data = await response.json();

                const container = document.getElementById('comparisonData');
                if (data.length === 0) {
                    container.innerHTML = '<p class="p-6 text-gray-600">No data available yet.</p>';
                } else {
                    container.innerHTML = `
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="px-4 py-2 text-left">Class Name</th>
                                    <th class="px-4 py-2 text-left">Teacher</th>
                                    <th class="px-4 py-2 text-center">Students</th>
                                    <th class="px-4 py-2 text-center">Total Quizzes</th>
                                    <th class="px-4 py-2 text-center">Avg Score</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.map(c => `
                                    <tr class="border-b">
                                        <td class="px-4 py-3 font-semibold">${c.class_name}</td>
                                        <td class="px-4 py-3">${c.teacher_name}</td>
                                        <td class="px-4 py-3 text-center">${c.student_count}</td>
                                        <td class="px-4 py-3 text-center">${c.total_quizzes}</td>
                                        <td class="px-4 py-3 text-center">
                                            <span class="px-3 py-1 rounded-full text-sm ${
                                                c.average_score >= 80 ? 'bg-green-100 text-green-800' :
                                                c.average_score >= 60 ? 'bg-yellow-100 text-yellow-800' :
                                                'bg-red-100 text-red-800'
                                            }">
                                                ${c.average_score.toFixed(1)}%
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function showTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => {
                el.classList.remove('border-purple-600', 'text-gray-800');
                el.classList.add('text-gray-600');
            });

            const tabContent = document.getElementById(tab + 'Content');
            tabContent.classList.remove('hidden');
            
            // Force visibility for domain management tab
            if (tab === 'domains') {
                tabContent.style.display = 'block';
                tabContent.style.visibility = 'visible';
                tabContent.style.opacity = '1';
            }
            
            document.getElementById(tab + 'Tab').classList.add('border-purple-600', 'text-gray-800');

            if (tab === 'classes') loadAllClasses();
            else if (tab === 'comparison') loadClassComparison();
            else if (tab === 'manageQuestions') loadQuestionsByFilter();
            else if (tab === 'questions') loadQuestionManagement();
            else if (tab === 'domains') {
                console.log('Domain tab activated - loading data...');
                refreshDomains();
                loadTeachersList();
                loadAccessRequests();
            }
        }

        // ==================== MANAGE QUESTIONS FUNCTIONS ====================

        let allQuestionsData = [];

        async function loadQuestionsByFilter() {
            const topic = document.getElementById('filterTopic').value;
            const difficulty = document.getElementById('filterDifficulty').value;

            try {
                let url = '/api/admin/all-questions?';
                if (topic) url += `topic=${topic}&`;
                if (difficulty) url += `difficulty=${difficulty}`;

                const response = await fetch(url);
                allQuestionsData = await response.json();

                displayQuestions(allQuestionsData);
            } catch (error) {
                console.error('Error loading questions:', error);
                document.getElementById('questionsList').innerHTML = '<div class="text-center text-red-500 py-8">Error loading questions</div>';
            }
        }

        function filterQuestionsLocally() {
            const searchTerm = document.getElementById('searchQuestion').value.toLowerCase();

            if (!searchTerm) {
                displayQuestions(allQuestionsData);
                return;
            }

            const filtered = allQuestionsData.filter(q =>
                q.question.toLowerCase().includes(searchTerm) ||
                q.options.some(opt => opt.toLowerCase().includes(searchTerm))
            );

            displayQuestions(filtered);
        }

        function displayQuestions(questions) {
            const container = document.getElementById('questionsList');
            const countEl = document.getElementById('questionCount');

            countEl.textContent = questions.length;

            if (questions.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8"><i class="fas fa-search text-4xl mb-3"></i><p>No questions found</p></div>';
                return;
            }

            container.innerHTML = questions.map((q, index) => {
                const difficultyColors = {
                    'beginner': 'bg-green-100 text-green-800',
                    'intermediate': 'bg-yellow-100 text-yellow-800',
                    'advanced': 'bg-red-100 text-red-800'
                };

                const topicIcons = {
                    'arithmetic': 'fa-calculator',
                    'fractions': 'fa-divide',
                    'decimals': 'fa-percent',
                    'multiplication_division': 'fa-times',
                    'number_systems': 'fa-hashtag',
                    'bodmas': 'fa-list-ol',
                    'functions': 'fa-chart-line',
                    'surds': 'fa-square-root-alt',
                    'sets': 'fa-circle-notch',
                    'probability': 'fa-dice',
                    'complex_numbers_intro': 'fa-infinity',
                    'complex_numbers_expanded': 'fa-infinity',
                    'geometry': 'fa-shapes',
                    'algebra': 'fa-function'
                };

                return `
                    <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">
                                        <i class="fas ${topicIcons[q.topic] || 'fa-book'} mr-1"></i>${q.topic.charAt(0).toUpperCase() + q.topic.slice(1)}
                                    </span>
                                    <span class="${difficultyColors[q.difficulty]} px-3 py-1 rounded-full text-sm font-semibold">
                                        ${q.difficulty.charAt(0).toUpperCase() + q.difficulty.slice(1)}
                                    </span>
                                    <span class="text-gray-500 text-sm">ID: ${q.id}</span>
                                </div>
                            </div>
                            <button onclick="openQuestionEditor(${q.id})" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                                <i class="fas fa-edit mr-2"></i>Edit
                            </button>
                        </div>

                        <div class="mb-4">
                            <div class="font-semibold text-gray-700 mb-2">Question:</div>
                            <div class="text-gray-800 bg-gray-50 p-3 rounded-lg">${q.question}</div>
                        </div>

                        <div class="grid grid-cols-2 gap-3 mb-4">
                            ${q.options.map((opt, i) => `
                                <div class="flex items-center gap-2 p-2 rounded ${i === q.correct ? 'bg-green-50 border-2 border-green-500' : 'bg-gray-50'}">
                                    <span class="font-semibold ${i === q.correct ? 'text-green-700' : 'text-gray-600'}">
                                        ${String.fromCharCode(65 + i)})
                                    </span>
                                    <span class="${i === q.correct ? 'text-green-700 font-semibold' : 'text-gray-700'}">
                                        ${opt}
                                    </span>
                                    ${i === q.correct ? '<i class="fas fa-check text-green-600 ml-auto"></i>' : ''}
                                </div>
                            `).join('')}
                        </div>

                        <div class="bg-blue-50 p-3 rounded-lg">
                            <div class="font-semibold text-blue-900 text-sm mb-1">Explanation:</div>
                            <div class="text-blue-800 text-sm">${q.explanation}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function openQuestionEditor(questionId) {
            try {
                const response = await fetch(`/api/admin/question/${questionId}`);
                const data = await response.json();
                const q = data.question;

                // Populate form
                document.getElementById('editQuestionId').value = q.id;
                document.getElementById('editTopic').value = q.topic;
                document.getElementById('editDifficulty').value = q.difficulty;
                document.getElementById('editQuestionText').value = q.question;
                document.getElementById('editOptionA').value = q.options[0];
                document.getElementById('editOptionB').value = q.options[1];
                document.getElementById('editOptionC').value = q.options[2];
                document.getElementById('editOptionD').value = q.options[3];
                document.getElementById('editCorrectAnswer').value = q.correct;
                document.getElementById('editExplanation').value = q.explanation;
                document.getElementById('editNotes').value = '';

                // Show any pending flags
                const flagsHtml = data.flags && data.flags.length > 0 ? data.flags.filter(f => f.status === 'pending').map(f => `
                    <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg mb-2">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-sm font-semibold">${f.user_name}</span>
                            <span class="text-xs text-gray-600">${f.flag_type}</span>
                        </div>
                        <div class="text-sm text-gray-700">"${f.description}"</div>
                    </div>
                `).join('') : '<div class="text-sm text-gray-600">No pending flags</div>';

                document.getElementById('editQuestionFlags').innerHTML = `
                    <div class="mb-4">
                        <div class="font-semibold mb-2">Pending Flags:</div>
                        ${flagsHtml}
                    </div>
                `;

                // Store flag IDs for resolution
                flagsToResolve = data.flags ? data.flags.filter(f => f.status === 'pending').map(f => f.id) : [];

                // Show edit history
                if (data.edit_history && data.edit_history.length > 0) {
                    const historyHtml = `
                        <div class="border-t pt-4 mt-4">
                            <h3 class="font-semibold mb-3">Edit History</h3>
                            <div class="space-y-2 max-h-40 overflow-y-auto">
                                ${data.edit_history.map(edit => `
                                    <div class="text-sm p-2 bg-gray-50 rounded">
                                        <div class="font-semibold">${edit.edited_by} - ${new Date(edit.edited_at).toLocaleString()}</div>
                                        ${edit.edit_notes ? `<div class="text-gray-600">${edit.edit_notes}</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    document.getElementById('editHistory').innerHTML = historyHtml;
                } else {
                    document.getElementById('editHistory').innerHTML = '';
                }

                // Show modal
                document.getElementById('editQuestionModal').classList.remove('hidden');
                document.getElementById('editQuestionModal').classList.add('flex');
            } catch (error) {
                console.error('Error loading question:', error);
                alert('Error loading question details');
            }
        }

        // ==================== QUESTION FLAG FUNCTIONS ====================

        let currentFilteredFlags = [];
        let currentQuestionId = null;
        let flagsToResolve = [];

        async function loadQuestionManagement() {
            await loadFlagStatistics();
            await loadPendingFlagsCount();
            await filterFlags('pending');
        }

        async function loadFlagStatistics() {
            try {
                const response = await fetch('/api/admin/flags/statistics');
                const stats = await response.json();

                document.getElementById('statPendingFlags').textContent = stats.pending_flags;
                document.getElementById('statFlaggedQuestions').textContent = stats.flagged_questions;
                document.getElementById('statResolvedFlags').textContent = stats.resolved_flags;
                document.getElementById('statTotalEdits').textContent = stats.total_edits;
            } catch (error) {
                console.error('Error loading flag statistics:', error);
            }
        }

        async function loadPendingFlagsCount() {
            try {
                const response = await fetch('/api/admin/flags/statistics');
                const stats = await response.json();

                const badge = document.getElementById('pendingFlagsCount');
                if (stats.pending_flags > 0) {
                    badge.textContent = stats.pending_flags;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error loading pending flags count:', error);
            }
        }

        async function filterFlags(status) {
            // Update filter button styles
            document.querySelectorAll('.flag-filter').forEach(btn => {
                btn.classList.remove('border-red-600', 'border-green-600', 'border-gray-600', 'border-blue-600');
                btn.classList.add('text-gray-600');
            });

            const activeBtn = document.getElementById('filter' + status.charAt(0).toUpperCase() + status.slice(1));
            activeBtn.classList.remove('text-gray-600');
            activeBtn.classList.add('text-gray-800');

            if (status === 'pending') activeBtn.classList.add('border-red-600');
            else if (status === 'resolved') activeBtn.classList.add('border-green-600');
            else if (status === 'dismissed') activeBtn.classList.add('border-gray-600');
            else activeBtn.classList.add('border-blue-600');

            // Load flags
            try {
                const url = status === 'all' ? '/api/admin/flags/all' : `/api/admin/flags/all?status=${status}`;
                const response = await fetch(url);
                currentFilteredFlags = await response.json();

                displayFlags(currentFilteredFlags);
            } catch (error) {
                console.error('Error loading flags:', error);
            }
        }

        function displayFlags(flags) {
            const container = document.getElementById('flagsList');

            if (flags.length === 0) {
                container.innerHTML = '<div class="bg-white rounded-lg shadow-md p-8 text-center text-gray-600">No flags found</div>';
                return;
            }

            container.innerHTML = flags.map(flag => {
                const statusColor = flag.status === 'pending' ? 'red' : flag.status === 'resolved' ? 'green' : 'gray';
                const typeIcons = {
                    'incorrect': 'fa-times-circle',
                    'ambiguous': 'fa-question-circle',
                    'typo': 'fa-spell-check',
                    'other': 'fa-exclamation-circle'
                };

                return `
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="bg-${statusColor}-100 text-${statusColor}-800 px-3 py-1 rounded-full text-sm font-semibold">
                                        ${flag.status.toUpperCase()}
                                    </span>
                                    <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">
                                        <i class="fas ${typeIcons[flag.flag_type]}"></i> ${flag.flag_type}
                                    </span>
                                </div>
                                <div class="text-sm text-gray-600">
                                    Reported by <strong>${flag.user_name}</strong> on ${new Date(flag.created_at).toLocaleDateString()}
                                </div>
                            </div>
                        </div>

                        <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                            <div class="font-semibold mb-2">Question:</div>
                            <div class="text-gray-700 mb-3">${flag.question.question}</div>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                ${flag.question.options.map((opt, i) => `
                                    <div class="${i === flag.question.correct ? 'text-green-600 font-semibold' : ''}">
                                        ${String.fromCharCode(65 + i)}) ${opt}
                                        ${i === flag.question.correct ? '<i class="fas fa-check ml-1"></i>' : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="font-semibold mb-1">Issue Description:</div>
                            <div class="text-gray-700 italic">"${flag.description}"</div>
                        </div>

                        ${flag.admin_notes ? `
                            <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                                <div class="font-semibold text-sm mb-1">Admin Notes:</div>
                                <div class="text-sm text-gray-700">${flag.admin_notes}</div>
                            </div>
                        ` : ''}

                        ${flag.status === 'pending' ? `
                            <div class="flex gap-3">
                                <button onclick="openEditQuestion(${flag.question_id})"
                                        class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
                                    <i class="fas fa-edit mr-2"></i>Edit Question
                                </button>
                                <button onclick="dismissFlag(${flag.id})"
                                        class="flex-1 bg-gray-400 text-white py-2 rounded-lg hover:bg-gray-500">
                                    <i class="fas fa-ban mr-2"></i>Dismiss Flag
                                </button>
                            </div>
                        ` : `
                            <div class="text-sm text-gray-600">
                                ${flag.status === 'resolved' ?
                                    `‚úì Resolved by ${flag.resolver_name} on ${new Date(flag.resolved_at).toLocaleDateString()}` :
                                    `‚úó Dismissed on ${new Date(flag.resolved_at).toLocaleDateString()}`
                                }
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }

        async function openEditQuestion(questionId) {
            currentQuestionId = questionId;

            try {
                const response = await fetch(`/api/admin/question/${questionId}`);
                const data = await response.json();

                // Populate form
                document.getElementById('editQuestionId').value = questionId;
                document.getElementById('editQuestionText').value = data.question.question;
                document.getElementById('editOptionA').value = data.question.options[0];
                document.getElementById('editOptionB').value = data.question.options[1];
                document.getElementById('editOptionC').value = data.question.options[2];
                document.getElementById('editOptionD').value = data.question.options[3];
                document.getElementById('editCorrectAnswer').value = data.question.correct;
                document.getElementById('editExplanation').value = data.question.explanation;
                document.getElementById('editNotes').value = '';

                // Show flags for this question
                const flagsHtml = data.flags.filter(f => f.status === 'pending').map(f => `
                    <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg mb-2">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-sm font-semibold">${f.user_name}</span>
                            <span class="text-xs text-gray-600">${f.flag_type}</span>
                        </div>
                        <div class="text-sm text-gray-700">"${f.description}"</div>
                    </div>
                `).join('');

                document.getElementById('editQuestionFlags').innerHTML = flagsHtml || '<div class="text-sm text-gray-600">No pending flags for this question</div>';

                // Store flag IDs to resolve
                flagsToResolve = data.flags.filter(f => f.status === 'pending').map(f => f.id);

                // Show edit history
                if (data.edit_history.length > 0) {
                    const historyHtml = `
                        <div class="border-t pt-4">
                            <h3 class="font-semibold mb-3">Edit History</h3>
                            <div class="space-y-2">
                                ${data.edit_history.map(edit => `
                                    <div class="text-sm p-2 bg-gray-50 rounded">
                                        <div class="font-semibold">${edit.edited_by} - ${new Date(edit.edited_at).toLocaleString()}</div>
                                        ${edit.edit_notes ? `<div class="text-gray-600">${edit.edit_notes}</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    document.getElementById('editHistory').innerHTML = historyHtml;
                } else {
                    document.getElementById('editHistory').innerHTML = '';
                }

                // Show modal
                document.getElementById('editQuestionModal').classList.remove('hidden');
                document.getElementById('editQuestionModal').classList.add('flex');
            } catch (error) {
                console.error('Error loading question:', error);
                alert('Error loading question details');
            }
        }

        function hideEditModal() {
            document.getElementById('editQuestionModal').classList.add('hidden');
            document.getElementById('editQuestionModal').classList.remove('flex');
            currentQuestionId = null;
            flagsToResolve = [];
        }

        document.getElementById('editQuestionForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const questionId = document.getElementById('editQuestionId').value;
            const questionData = {
                topic: document.getElementById('editTopic').value,
                difficulty: document.getElementById('editDifficulty').value,
                question_text: document.getElementById('editQuestionText').value,
                option_a: document.getElementById('editOptionA').value,
                option_b: document.getElementById('editOptionB').value,
                option_c: document.getElementById('editOptionC').value,
                option_d: document.getElementById('editOptionD').value,
                correct_answer: parseInt(document.getElementById('editCorrectAnswer').value),
                explanation: document.getElementById('editExplanation').value,
                notes: document.getElementById('editNotes').value,
                resolve_flag_ids: flagsToResolve
            };

            try {
                const response = await fetch(`/api/admin/question/${questionId}/edit`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(questionData)
                });

                if (response.ok) {
                    alert('Question updated successfully!');
                    hideEditModal();
                    // Refresh both tabs
                    await loadQuestionsByFilter();
                    await loadQuestionManagement();
                } else {
                    alert('Error updating question');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating question');
            }
        });

        async function dismissFlag(flagId) {
            const notes = prompt('Enter reason for dismissing this flag (optional):');
            if (notes === null) return; // User cancelled

            try {
                const response = await fetch(`/api/admin/flag/${flagId}/dismiss`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ notes })
                });

                if (response.ok) {
                    alert('Flag dismissed');
                    await loadQuestionManagement();
                } else {
                    alert('Error dismissing flag');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error dismissing flag');
            }
        }

        // Load pending flags count on page load
        window.addEventListener('load', function() {
            loadPendingFlagsCount();
            // Refresh count every 30 seconds
            setInterval(loadPendingFlagsCount, 30000);
        });

        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (error) {
                console.error('Error:', error);
            }
        }
    </script>
</body>
</html>
