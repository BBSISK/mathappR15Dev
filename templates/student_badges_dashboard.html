<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Badges & Progress</title>
    <!-- AVATAR: CSS for avatar display -->
    {% if feature_flags.AVATAR_SYSTEM_ENABLED %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/avatar.css') }}">
    {% endif %}
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .section-title {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .badges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .badge-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            border: 3px solid transparent;
        }

        .badge-card.earned {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            border-color: #fdcb6e;
            box-shadow: 0 5px 15px rgba(253, 203, 110, 0.4);
        }

        .badge-card:hover {
            transform: scale(1.05);
        }

        .badge-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .badge-name {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 5px;
            color: #333;
        }

        .badge-description {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 10px;
        }

        .badge-progress {
            background: rgba(255,255,255,0.5);
            height: 8px;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }

        .badge-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s;
        }

        .badge-points {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            margin-top: 5px;
        }

        .earned-date {
            font-size: 0.75em;
            color: #e67e22;
            margin-top: 5px;
            font-weight: bold;
        }

        .topic-progress-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .topic-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 5px solid #667eea;
        }

        .topic-card.mastered {
            border-left-color: #2ecc71;
            background: #d5f4e6;
        }

        .topic-name {
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 10px;
            text-transform: capitalize;
        }

        .topic-difficulty {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 3px 10px;
            border-radius: 5px;
            font-size: 0.8em;
            margin-bottom: 10px;
        }

        .topic-stats {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 0.9em;
        }

        .mastery-badge {
            display: inline-block;
            background: #2ecc71;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-top: 10px;
        }

        .topic-progress-table {
            width: 100%;
            margin-top: 15px;
        }

        .topic-progress-table table {
            width: 100%;
            border-collapse: collapse;
            table-layout: auto;
        }

        .topic-progress-table th {
            background: #f8f9fa;
            font-weight: 600;
            padding: 12px 8px;
            text-align: left;
        }

        .topic-progress-table th:not(:first-child) {
            text-align: center;
        }

        .topic-progress-table td {
            padding: 12px 8px;
            border-bottom: 1px solid #e5e7eb;
        }

        .topic-progress-table td:not(:first-child) {
            text-align: center;
        }

        .topic-progress-table tbody tr:hover {
            background-color: #f9fafb;
        }

        @media (max-width: 640px) {
            .topic-progress-table {
                font-size: 0.8em;
            }
            .topic-progress-table th,
            .topic-progress-table td {
                padding: 8px 4px;
            }
        }

        .level-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .level-number {
            font-size: 4em;
            font-weight: bold;
        }

        .level-progress {
            margin-top: 15px;
            background: rgba(255,255,255,0.3);
            height: 12px;
            border-radius: 10px;
            overflow: hidden;
        }

        .level-progress-bar {
            height: 100%;
            background: rgba(255,255,255,0.9);
            transition: width 0.5s;
        }

        .back-button {
            display: inline-block;
            background: white;
            color: #667eea;
            padding: 12px 30px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(0,0,0,0.3);
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 1.5em;
        }

        .streak-fire {
            font-size: 2em;
            animation: flicker 1.5s infinite;
        }

        @keyframes flicker {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .empty-state {
            text-align: center;
            padding: 50px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-button">‚Üê Back to Dashboard</a>

        <div class="header">
            <!-- AVATAR: Display large avatar at top of profile -->
            {% if feature_flags.AVATAR_SYSTEM_ENABLED %}
            <div id="profile-avatar" class="avatar-container avatar-xlarge" style="margin: 0 auto 20px; border: 4px solid rgba(255,255,255,0.3);"></div>
            <a href="/avatar/shop" style="display: inline-block; background: rgba(255,255,255,0.2); color: white; padding: 8px 20px; border-radius: 20px; text-decoration: none; font-size: 0.9em; margin-bottom: 15px;">üé® Customize Avatar</a>
            {% endif %}
            <h1>üèÜ My Badges & Progress</h1>
            <p>Track your achievements and mastery</p>
        </div>

        <div id="loading" class="loading">
            Loading your achievements... ‚è≥
        </div>

        <div id="content" style="display: none;">
            <!-- Level Display -->
            <div class="level-display">
                <div>Level <span id="user-level" class="level-number">1</span></div>
                <div id="level-text"></div>
                <div class="level-progress">
                    <div id="level-progress-bar" class="level-progress-bar" style="width: 0%"></div>
                </div>
            </div>

            <!-- Stats Overview -->
            <div class="stats-overview">
                <div class="stat-card">
                    <div class="stat-icon">üéØ</div>
                    <div id="total-quizzes" class="stat-value">0</div>
                    <div class="stat-label">Quizzes Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div id="accuracy" class="stat-value">0%</div>
                    <div class="stat-label">Overall Accuracy</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><span class="streak-fire">üî•</span></div>
                    <div id="streak" class="stat-value">0</div>
                    <div class="stat-label">Day Streak</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚≠ê</div>
                    <div id="total-points" class="stat-value">0</div>
                    <div class="stat-label">Total Points</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üéì</div>
                    <div id="topics-mastered" class="stat-value">0</div>
                    <div class="stat-label">Topics Mastered</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üíé</div>
                    <div id="perfect-scores" class="stat-value">0</div>
                    <div class="stat-label">Perfect Scores</div>
                </div>
            </div>

            <!-- Earned Badges -->
            <div class="section">
                <h2 class="section-title">üèÜ Earned Badges (<span id="earned-count">0</span>)</h2>
                <div id="earned-badges" class="badges-grid"></div>
            </div>

            <!-- Available Badges -->
            <div class="section">
                <h2 class="section-title">üéØ Available Badges (<span id="available-count">0</span>)</h2>
                <div id="available-badges" class="badges-grid"></div>
            </div>

            <!-- Topic Progress -->
            <div class="section">
                <h2 class="section-title">üìö Topic Progress</h2>
                <div id="topic-progress" class="topic-progress-grid"></div>
            </div>
        </div>
    </div>

    <script>
        // Fetch and display all badge and stats data
        async function loadDashboard() {
            try {
                // Fetch badges
                const badgesResponse = await fetch('/api/student/badges');
                const badgesData = await badgesResponse.json();

                // Fetch stats
                const statsResponse = await fetch('/api/student/stats');
                const statsData = await statsResponse.json();

                // Display everything
                displayStats(badgesData, statsData.stats);
                displayBadges(badgesData);
                displayTopicProgress(statsData.topic_progress);

                // Hide loading, show content
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('loading').innerHTML = 
                    '<div style="color: #e74c3c;">‚ùå Error loading data. Please refresh the page.</div>';
            }
        }

        function displayStats(badgesData, stats) {
            // Level and points
            document.getElementById('user-level').textContent = badgesData.level;
            document.getElementById('total-points').textContent = badgesData.total_points;

            // Calculate progress to next level
            const currentLevelPoints = (badgesData.level - 1) * 100;
            const nextLevelPoints = badgesData.level * 100;
            const progressToNext = badgesData.total_points - currentLevelPoints;
            const progressPercent = (progressToNext / 100) * 100;
            
            document.getElementById('level-progress-bar').style.width = progressPercent + '%';
            document.getElementById('level-text').textContent = 
                `${badgesData.total_points} / ${nextLevelPoints} points to Level ${badgesData.level + 1}`;

            // Other stats
            document.getElementById('total-quizzes').textContent = stats.total_quizzes;
            document.getElementById('accuracy').textContent = stats.overall_accuracy + '%';
            document.getElementById('streak').textContent = stats.current_streak_days;
            document.getElementById('topics-mastered').textContent = stats.topics_mastered;
            document.getElementById('perfect-scores').textContent = stats.perfect_scores;
        }

        function displayBadges(data) {
            const earnedContainer = document.getElementById('earned-badges');
            const availableContainer = document.getElementById('available-badges');

            document.getElementById('earned-count').textContent = data.earned.length;
            document.getElementById('available-count').textContent = data.available.length;

            // Display earned badges
            if (data.earned.length === 0) {
                earnedContainer.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üéØ</div><p>Complete quizzes to earn your first badge!</p></div>';
            } else {
                earnedContainer.innerHTML = data.earned.map(badge => createBadgeCard(badge, true)).join('');
            }

            // Display available badges
            availableContainer.innerHTML = data.available.map(badge => createBadgeCard(badge, false)).join('');
        }

        function createBadgeCard(badge, earned) {
            const earnedClass = earned ? 'earned' : '';
            const icon = getBadgeEmoji(badge.icon);
            const earnedDate = earned ? `<div class="earned-date">‚úì Earned ${new Date(badge.earned_at).toLocaleDateString()}</div>` : '';
            const progress = !earned ? `
                <div class="badge-progress">
                    <div class="badge-progress-bar" style="width: ${badge.progress}%"></div>
                </div>
                <div style="font-size: 0.8em; color: #666; margin-top: 5px;">${badge.progress}% Complete</div>
            ` : '';

            return `
                <div class="badge-card ${earnedClass}">
                    <div class="badge-icon">${icon}</div>
                    <div class="badge-name">${badge.name}</div>
                    <div class="badge-description">${badge.description}</div>
                    <div class="badge-points">+${badge.points} pts</div>
                    ${earnedDate}
                    ${progress}
                </div>
            `;
        }

        function displayTopicProgress(topicProgress) {
            const container = document.getElementById('topic-progress');

            if (topicProgress.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìö</div><p>Start taking quizzes to track your progress by topic!</p></div>';
                return;
            }

            // Create table layout - one topic per row
            let tableHTML = `
                <div class="topic-progress-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Topic</th>
                                <th>Level</th>
                                <th>Attempts</th>
                                <th>Best %</th>
                                <th>Max Points</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            topicProgress.forEach(topic => {
                const maxPoints = topic.max_points !== undefined ? topic.max_points : topic.best_score || '-';
                const difficultyColors = {
                    'Beginner': 'background:#d1fae5;color:#065f46',
                    'Intermediate': 'background:#fef3c7;color:#92400e',
                    'Advanced': 'background:#fee2e2;color:#991b1b'
                };
                const diffStyle = difficultyColors[topic.difficulty] || 'background:#f3f4f6;color:#374151';
                const masteredBadge = topic.is_mastered 
                    ? '<span style="background:#10b981;color:white;padding:2px 8px;border-radius:10px;font-size:0.75em;">üèÜ Mastered</span>' 
                    : '<span style="color:#9ca3af;font-size:0.85em;">In Progress</span>';
                const rowStyle = topic.is_mastered ? 'background-color:#ecfdf5;' : '';
                const pctColor = topic.best_percentage >= 80 ? '#059669' : topic.best_percentage >= 60 ? '#d97706' : '#dc2626';
                
                tableHTML += `
                    <tr style="${rowStyle}">
                        <td><strong>${topic.topic}</strong></td>
                        <td><span style="padding:2px 8px;border-radius:4px;font-size:0.8em;${diffStyle}">${topic.difficulty}</span></td>
                        <td>${topic.attempts}</td>
                        <td><strong style="color:${pctColor}">${topic.best_percentage}%</strong></td>
                        <td><strong style="color:#7c3aed;">‚≠ê ${maxPoints}</strong></td>
                        <td>${masteredBadge}</td>
                    </tr>
                `;
            });
            
            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = tableHTML;
        }

        function getBadgeEmoji(iconClass) {
            const iconMap = {
                'fa-star': '‚≠ê',
                'fa-book': 'üìö',
                'fa-graduation-cap': 'üéì',
                'fa-heart': '‚ù§Ô∏è',
                'fa-trophy': 'üèÜ',
                'fa-bullseye': 'üéØ',
                'fa-crown': 'üëë',
                'fa-medal': 'ü•à',
                'fa-gem': 'üíé',
                'fa-fire': 'üî•',
                'fa-bolt': '‚ö°',
                'fa-rocket': 'üöÄ',
                'fa-certificate': 'üìú',
                'fa-brain': 'üß†',
                'fa-infinity': '‚ôæÔ∏è'
            };
            return iconMap[iconClass] || 'üèÖ';
        }

        // Load dashboard on page load
        loadDashboard();
    </script>
    
    <!-- AVATAR: JavaScript for avatar rendering -->
    {% if feature_flags.AVATAR_SYSTEM_ENABLED %}
    <script src="{{ url_for('static', filename='js/avatar.js') }}"></script>
    <script>
        // Load and render avatar
        async function loadProfileAvatar() {
            try {
                const response = await fetch('/api/avatar/equipped');
                const data = await response.json();
                
                if (data.success && data.equipped) {
                    const profileAvatar = document.getElementById('profile-avatar');
                    if (profileAvatar && typeof AvatarRenderer !== 'undefined') {
                        AvatarRenderer.render(profileAvatar, data.equipped, 'xlarge');
                    }
                }
            } catch (error) {
                console.log('Avatar loading skipped:', error.message);
            }
        }
        
        // Load avatar when DOM is ready
        document.addEventListener('DOMContentLoaded', loadProfileAvatar);
    </script>
    {% endif %}
</body>
</html>
