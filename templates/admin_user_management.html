<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - AgentMath.app</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    
    <style>
        body {
            background-color: #f8f9fa;
        }
        .navbar {
            background-color: #007bff !important;
        }
        .badge-approved {
            background-color: #28a745;
        }
        .badge-pending {
            background-color: #ffc107;
            color: #000;
        }
        .user-row:hover {
            background-color: #f1f3f5;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="/admin">
                <i class="fas fa-graduation-cap"></i> AgentMath.app - Admin
            </a>
            <div class="text-white">
                <a href="/admin" class="btn btn-outline-light btn-sm mr-2">Dashboard</a>
                <a href="/logout" class="btn btn-outline-light btn-sm">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-users"></i> User Management</h2>
                    <div>
                        <button class="btn btn-danger" id="bulkDeleteBtn" style="display: none;">
                            <i class="fas fa-trash"></i> Delete Selected (<span id="selectedCount">0</span>)
                        </button>
                    </div>
                </div>

                <!-- Filters -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label>Role Filter</label>
                                <select class="form-control" id="roleFilter">
                                    <option value="">All Roles</option>
                                    <option value="student">Students</option>
                                    <option value="teacher">Teachers</option>
                                    <option value="admin">Admins</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label>Approval Status</label>
                                <select class="form-control" id="approvalFilter">
                                    <option value="">All Users</option>
                                    <option value="approved">Approved Only</option>
                                    <option value="pending">Pending Only</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label>Search</label>
                                <input type="text" class="form-control" id="searchInput" placeholder="Search by name or email...">
                            </div>
                            <div class="col-md-2">
                                <label>&nbsp;</label>
                                <button class="btn btn-primary btn-block" id="refreshBtn">
                                    <i class="fas fa-sync"></i> Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="usersTable">
                                <thead>
                                    <tr>
                                        <th width="30">
                                            <input type="checkbox" id="selectAll">
                                        </th>
                                        <th>Username</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Joined</th>
                                        <th>Quizzes</th>
                                        <th>Points</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <tr>
                                        <td colspan="9" class="text-center">
                                            <i class="fas fa-spinner fa-spin"></i> Loading users...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit User</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="editUserForm">
                        <input type="hidden" id="editUserId">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" class="form-control" id="editUserEmail">
                        </div>
                        <div class="form-group">
                            <label>Role</label>
                            <select class="form-control" id="editUserRole">
                                <option value="student">Student</option>
                                <option value="teacher">Teacher</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="editUserApproved">
                                <label class="custom-control-label" for="editUserApproved">Approved</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveUserBtn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery, Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    let allUsers = [];
    let selectedUsers = new Set();

    $(document).ready(function() {
        loadUsers();
        $('#roleFilter, #approvalFilter').change(filterUsers);
        $('#searchInput').on('input', filterUsers);
        $('#refreshBtn').click(loadUsers);
        $('#selectAll').change(toggleSelectAll);
        $('#bulkDeleteBtn').click(bulkDeleteUsers);
        $('#saveUserBtn').click(saveUserChanges);
    });

    function loadUsers() {
        $('#usersTableBody').html('<tr><td colspan="9" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>');
        
        $.ajax({
            url: '/api/admin/users',
            method: 'GET',
            success: function(users) {
                allUsers = users;
                displayUsers(users);
            },
            error: function(xhr) {
                $('#usersTableBody').html('<tr><td colspan="9" class="text-center text-danger">Error loading users</td></tr>');
                console.error('Error:', xhr);
            }
        });
    }

    function displayUsers(users) {
        if (users.length === 0) {
            $('#usersTableBody').html('<tr><td colspan="9" class="text-center">No users found</td></tr>');
            return;
        }
        
        const html = users.map(user => `
            <tr class="user-row">
                <td><input type="checkbox" class="user-checkbox" data-user-id="${user.id}"></td>
                <td><strong>${escapeHtml(user.username)}</strong></td>
                <td>${escapeHtml(user.email)}</td>
                <td><span class="badge badge-info">${user.role}</span></td>
                <td><span class="badge ${user.is_approved ? 'badge-approved' : 'badge-pending'}">${user.is_approved ? 'Approved' : 'Pending'}</span></td>
                <td>${formatDate(user.created_at)}</td>
                <td>${user.total_quizzes}</td>
                <td>${user.total_points}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="editUser(${user.id})"><i class="fas fa-edit"></i></button>
                    ${!user.is_approved ? `<button class="btn btn-sm btn-success" onclick="approveUser(${user.id})"><i class="fas fa-check"></i></button>` : ''}
                    <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id}, '${escapeHtml(user.username)}')"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `).join('');
        
        $('#usersTableBody').html(html);
        $('.user-checkbox').change(updateSelectedCount);
    }

    function filterUsers() {
        const roleFilter = $('#roleFilter').val();
        const approvalFilter = $('#approvalFilter').val();
        const searchTerm = $('#searchInput').val().toLowerCase();
        
        const filtered = allUsers.filter(user => {
            if (roleFilter && user.role !== roleFilter) return false;
            if (approvalFilter === 'approved' && !user.is_approved) return false;
            if (approvalFilter === 'pending' && user.is_approved) return false;
            if (searchTerm && !user.username.toLowerCase().includes(searchTerm) && !user.email.toLowerCase().includes(searchTerm)) return false;
            return true;
        });
        
        displayUsers(filtered);
    }

    function toggleSelectAll() {
        $('.user-checkbox').prop('checked', $('#selectAll').prop('checked'));
        updateSelectedCount();
    }

    function updateSelectedCount() {
        selectedUsers.clear();
        $('.user-checkbox:checked').each(function() {
            selectedUsers.add(parseInt($(this).data('user-id')));
        });
        $('#selectedCount').text(selectedUsers.size);
        $('#bulkDeleteBtn').toggle(selectedUsers.size > 0);
    }

    function editUser(userId) {
        const user = allUsers.find(u => u.id === userId);
        if (!user) return;
        $('#editUserId').val(user.id);
        $('#editUserEmail').val(user.email);
        $('#editUserRole').val(user.role);
        $('#editUserApproved').prop('checked', user.is_approved);
        $('#editUserModal').modal('show');
    }

    function saveUserChanges() {
        const userId = $('#editUserId').val();
        $.ajax({
            url: `/api/admin/user/${userId}`,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify({
                email: $('#editUserEmail').val(),
                role: $('#editUserRole').val(),
                is_approved: $('#editUserApproved').prop('checked')
            }),
            success: function() {
                $('#editUserModal').modal('hide');
                loadUsers();
                alert('User updated successfully');
            },
            error: function(xhr) {
                alert('Error: ' + (xhr.responseJSON?.error || 'Unknown error'));
            }
        });
    }

    function approveUser(userId) {
        $.ajax({
            url: `/api/admin/user/${userId}/toggle-approval`,
            method: 'POST',
            success: function() {
                loadUsers();
            }
        });
    }

    function deleteUser(userId, username) {
        if (!confirm(`Delete user "${username}"?`)) return;
        $.ajax({
            url: `/api/admin/user/${userId}`,
            method: 'DELETE',
            success: function() {
                loadUsers();
            }
        });
    }

    function bulkDeleteUsers() {
        if (selectedUsers.size === 0 || !confirm(`Delete ${selectedUsers.size} user(s)?`)) return;
        $.ajax({
            url: '/api/admin/users/bulk-delete',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ user_ids: Array.from(selectedUsers) }),
            success: function(response) {
                selectedUsers.clear();
                $('#selectAll').prop('checked', false);
                loadUsers();
                alert(`Deleted ${response.deleted_count} user(s)`);
            }
        });
    }

    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        return new Date(dateString).toLocaleString();
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    </script>
</body>
</html>
