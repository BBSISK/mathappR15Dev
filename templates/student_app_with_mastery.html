<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgentMath.app - Student</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .number-line-container {
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .number-line {
            position: relative;
            margin: 30px 20px;
            height: 80px;
        }
        
        .number-line-base {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 4px;
            background: #4a5568;
            transform: translateY(-50%);
        }
        
        .number-line-tick {
            position: absolute;
            top: 50%;
            width: 2px;
            height: 20px;
            background: #4a5568;
            transform: translate(-50%, -50%);
        }
        
        .number-line-label {
            position: absolute;
            top: 70%;
            transform: translateX(-50%);
            font-size: 14px;
            font-weight: bold;
            color: #2d3748;
        }
        
        .number-line-arc {
            position: absolute;
            top: 15%;
            border: 3px solid #667eea;
            border-bottom: none;
            border-radius: 50px 50px 0 0;
            height: 25px;
        }
        
        .number-line-arrow {
            position: absolute;
            font-size: 24px;
            color: #667eea;
            animation: bounce 0.8s infinite;
        }
        
        .number-line-start-dot {
            position: absolute;
            top: 50%;
            width: 12px;
            height: 12px;
            background: #48bb78;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
        }
        
        .number-line-end-dot {
            position: absolute;
            top: 50%;
            width: 16px;
            height: 16px;
            background: #f56565;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            border: 3px solid white;
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
            z-index: 10;
            animation: pulse 1s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        
        /* Badge Widget Styles */
        .badge-summary-widget {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 25px;
            color: white;
            margin: 20px auto 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 1200px;
        }

        .badge-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .badge-summary-title {
            font-size: 1.8em;
            font-weight: bold;
            margin: 0;
        }

        .view-badges-btn {
            background: white;
            color: #667eea;
            padding: 10px 25px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .view-badges-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
        }

        .badge-summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
        }

        .badge-stat-box {
            text-align: center;
            background: rgba(255,255,255,0.2);
            padding: 20px 15px;
            border-radius: 12px;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .badge-stat-box:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-3px);
        }

        .badge-stat-value {
            font-size: 2.2em;
            font-weight: bold;
            display: block;
            margin-bottom: 8px;
        }

        .badge-stat-label {
            font-size: 0.9em;
            opacity: 0.95;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .recent-badge-mini {
            display: inline-block;
            background: rgba(255,255,255,0.25);
            padding: 8px 16px;
            border-radius: 20px;
            margin: 5px;
            font-size: 0.9em;
            backdrop-filter: blur(5px);
        }

        .badge-widget-loading {
            text-align: center;
            padding: 20px;
            opacity: 0.8;
        }

        @media (max-width: 640px) {
            .badge-summary-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            .badge-summary-title {
                font-size: 1.4em;
            }
        }

        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }
        
        .number-line-instruction {
            text-align: center;
            color: #4a5568;
            font-size: 14px;
            margin-top: 10px;
            font-weight: 500;
        }

        /* ============ Mastery Indicator Styles ============ */
        .mastery-badge {
            position: absolute;
            top: 12px;
            right: 12px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
            padding: 8px 12px;
            border-radius: 50%;
            font-size: 28px;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.6);
            animation: shine 2s infinite;
            z-index: 10;
            line-height: 1;
        }

        .difficulty-mastery {
            position: absolute;
            top: 10px;
            right: 10px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            box-shadow: 0 3px 10px rgba(255, 215, 0, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            z-index: 10;
            line-height: 1.2;
        }

        .difficulty-mastery .trophy {
            font-size: 20px;
        }

        .difficulty-mastery .score {
            font-size: 10px;
            letter-spacing: 0.3px;
            font-weight: 700;
        }

        @keyframes shine {
            0%, 100% {
                box-shadow: 0 4px 15px rgba(255, 215, 0, 0.6);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 6px 25px rgba(255, 215, 0, 0.9);
                transform: scale(1.05);
            }
        }

        .topic-card, .difficulty-button {
            position: relative;
        }

        .best-score-display {
            margin-top: 8px;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }

        .mastery-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 9999;
            text-align: center;
            animation: popIn 0.5s ease-out;
        }

        @keyframes popIn {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-100 via-purple-50 to-pink-100 min-h-screen">
    <!-- Header with User Info -->
    <div class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">üéì AgentMath.app</h1>
            <div class="flex items-center gap-4">
                <span class="text-gray-700" id="userName"></span>
                <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-all">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
        </div>
    </div>

    <div id="app" class="container mx-auto px-4 py-8">
        <!-- Badge Summary Widget -->
        <div id="badge-widget" class="badge-summary-widget" style="display: none;">
            <div class="badge-summary-header">
                <h2 class="badge-summary-title">üèÜ Your Progress</h2>
                <a href="/student/badges" class="view-badges-btn">View All Badges ‚Üí</a>
            </div>
            
            <div class="badge-summary-stats">
                <div class="badge-stat-box">
                    <span id="stat-level" class="badge-stat-value">-</span>
                    <div class="badge-stat-label">Level</div>
                </div>
                <div class="badge-stat-box">
                    <span id="stat-points" class="badge-stat-value">-</span>
                    <div class="badge-stat-label">Points</div>
                </div>
                <div class="badge-stat-box">
                    <span id="stat-badges" class="badge-stat-value">-</span>
                    <div class="badge-stat-label">Badges</div>
                </div>
                <div class="badge-stat-box">
                    <span id="stat-quizzes" class="badge-stat-value">-</span>
                    <div class="badge-stat-label">Quizzes</div>
                </div>
                <div class="badge-stat-box">
                    <span id="stat-streak" class="badge-stat-value">-</span>
                    <div class="badge-stat-label">üî• Streak</div>
                </div>
                <div class="badge-stat-box">
                    <span id="stat-accuracy" class="badge-stat-value">-</span>
                    <div class="badge-stat-label">Accuracy</div>
                </div>
            </div>
            
            <div id="recent-badges-container" style="margin-top: 15px; display: none;">
                <div style="opacity: 0.9; margin-bottom: 8px; font-size: 0.9em;">Recent Badges:</div>
                <div id="recent-badges"></div>
            </div>
        </div>

        <!-- Loading Screen -->
        <div id="loadingScreen" class="text-center py-20">
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-purple-600 mx-auto"></div>
            <p class="mt-4 text-xl text-gray-700">Loading...</p>
        </div>

        <!-- Topic Selection Screen -->
        <div id="topicScreen" class="hidden">
            <div class="text-center mb-8">
                <h2 class="text-4xl font-bold text-gray-800 mb-4">Choose a Topic</h2>
                <p class="text-xl text-gray-600">Select what you'd like to practice today</p>
            </div>
            
            <div class="grid md:grid-cols-3 lg:grid-cols-5 gap-6 mb-8" id="topicsGrid"></div>

            <!-- Progress Summary -->
            <div class="bg-white rounded-2xl p-6 shadow-lg">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">üìä Your Progress</h3>
                <div id="progressSummary" class="text-gray-600">Loading...</div>
            </div>
        </div>

        <!-- Difficulty Selection Screen -->
        <div id="difficultyScreen" class="hidden">
            <div class="max-w-4xl mx-auto">
                <button onclick="backToTopics()" class="mb-6 bg-white text-gray-700 px-6 py-2 rounded-lg shadow hover:shadow-md transition-all">
                    ‚Üê Back to Topics
                </button>
                
                <div class="text-center mb-12">
                    <h2 id="selectedTopicTitle" class="text-4xl font-bold text-gray-800 mb-4"></h2>
                    <p class="text-xl text-gray-600">Select your level</p>
                </div>
                
                <div id="difficultyButtonsContainer" class="grid md:grid-cols-3 gap-6">
                    <!-- Difficulty buttons will be generated dynamically -->
                </div>
            </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quizScreen" class="hidden max-w-3xl mx-auto">
            <div class="mb-6 flex justify-between items-center">
                <button onclick="backToDifficulty()" class="bg-white text-gray-700 px-6 py-2 rounded-lg shadow hover:shadow-md transition-all">
                    ‚Üê Back
                </button>
                <div class="bg-white px-6 py-2 rounded-lg shadow">
                    <span class="font-semibold text-gray-700">Score: <span id="score">0</span>/<span id="total">20</span></span>
                </div>
            </div>

            <div class="bg-white rounded-2xl p-8 shadow-2xl">
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 id="quizTopicTitle" class="text-2xl font-bold text-gray-800"></h2>
                        <span class="bg-purple-100 text-purple-700 px-4 py-2 rounded-full font-semibold">
                            Question <span id="currentQuestion">1</span>/<span id="totalQuestions">20</span>
                        </span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3 mb-4">
                        <div id="progressBar" class="bg-gradient-to-r from-purple-500 to-pink-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>

                <div class="mb-8">
                    <h3 id="questionText" class="text-3xl font-semibold text-gray-800 mb-6"></h3>
                    <div id="optionsContainer" class="space-y-3"></div>
                </div>

                <div id="feedbackContainer" class="hidden mb-6"></div>

                <button id="nextButton" onclick="nextQuestion()" class="hidden w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white py-4 rounded-xl font-bold text-lg hover:from-purple-700 hover:to-pink-700 transition-all shadow-lg">
                    Next Question ‚Üí
                </button>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="resultsScreen" class="hidden max-w-2xl mx-auto">
            <div class="bg-white rounded-2xl p-8 shadow-2xl text-center">
                <i class="fas fa-trophy text-yellow-500 text-8xl mb-6"></i>
                <h2 class="text-4xl font-bold text-gray-800 mb-4">Quiz Complete!</h2>
                <div id="percentage" class="text-6xl font-bold text-purple-600 mb-4"></div>
                <p id="scoreText" class="text-2xl text-gray-700 mb-8"></p>
                <div id="performanceMessage" class="text-xl font-semibold mb-6"></div>
                
                <div class="space-y-4">
                    <button onclick="retryQuiz()" class="w-full bg-purple-600 text-white py-4 rounded-xl font-semibold hover:bg-purple-700 transition-colors">
                        Try Again
                    </button>
                    <button onclick="backToTopics()" class="w-full bg-gray-200 text-gray-800 py-4 rounded-xl font-semibold hover:bg-gray-300 transition-colors">
                        Choose Another Topic
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTopic = '';
        let currentDifficulty = '';
        let questions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let answered = false;
        let startTime = null;
        let masteryData = {}; // Stores mastery status for all topics/difficulties

        const iconMap = {
            'calculator': 'fa-calculator',
            'divide': 'fa-divide',
            'book': 'fa-book',
            'chart': 'fa-chart-line',
            'layers': 'fa-layer-group'
        };

        // Load mastery data from API
        async function loadMasteryData() {
            try {
                const response = await fetch('/api/student/mastery');
                masteryData = await response.json();
                console.log('‚ú® Mastery data loaded:', masteryData);
            } catch (error) {
                console.error('Error loading mastery data:', error);
                masteryData = {};
            }
        }

        window.onload = async function() {
            await loadCurrentUser();
            await loadMasteryData(); // Load mastery data BEFORE topics
            await loadTopics();
            await loadProgress();
            await loadBadgeWidget(); // Load badge widget
        };

        // Generate BLANK number line (for questions - no solution shown)
        function generateBlankNumberLine(questionText) {
            const match = questionText.match(/(\d+)\s*([+\-])\s*(\d+)/);
            if (!match) return null;
            
            const num1 = parseInt(match[1]);
            const num2 = parseInt(match[3]);
            const operation = match[2] === '+' ? 'addition' : 'subtraction';
            const result = operation === 'addition' ? num1 + num2 : num1 - num2;
            
            // Determine range
            let minNum, maxNum, stepSize;
            if (Math.max(num1, num2, result) > 30) {
                if (num2 <= 10) {
                    minNum = Math.max(0, Math.min(num1, result) - 3);
                    maxNum = Math.max(num1, result) + 3;
                    stepSize = 1;
                } else if (num2 <= 20) {
                    minNum = Math.max(0, Math.min(num1, result) - 5);
                    maxNum = Math.max(num1, result) + 5;
                    stepSize = 2;
                } else {
                    const padding = Math.ceil(num2 * 0.2);
                    minNum = Math.max(0, Math.floor((Math.min(num1, result) - padding) / 5) * 5);
                    maxNum = Math.ceil((Math.max(num1, result) + padding) / 5) * 5;
                    stepSize = (maxNum - minNum > 50) ? 10 : 5;
                }
            } else {
                minNum = Math.max(0, Math.min(num1, result) - 2);
                maxNum = Math.max(num1, result) + 2;
                stepSize = 1;
            }
            
            const range = maxNum - minNum;
            
            // Generate BLANK number line (no solution)
            let html = '<div class="number-line-container">';
            html += '<div class="number-line"><div class="number-line-base"></div>';
            
            for (let i = minNum; i <= maxNum; i += stepSize) {
                const position = ((i - minNum) / range) * 100;
                html += `<div class="number-line-tick" style="left: ${position}%"></div>`;
                html += `<div class="number-line-label" style="left: ${position}%">${i}</div>`;
            }
            
            html += '</div>';
            html += `<div class="number-line-instruction">üí° Use the number line to help solve: ${questionText}</div>`;
            html += '</div>';
            
            return html;
        }

        // Generate SOLUTION number line (for explanations - shows complete solution)
        function generateSolutionNumberLine(questionText) {
            const match = questionText.match(/(\d+)\s*([+\-])\s*(\d+)/);
            if (!match) return null;
            
            const num1 = parseInt(match[1]);
            const num2 = parseInt(match[3]);
            const operation = match[2] === '+' ? 'addition' : 'subtraction';
            const result = operation === 'addition' ? num1 + num2 : num1 - num2;
            
            // Same range logic as blank version
            let minNum, maxNum, stepSize;
            if (Math.max(num1, num2, result) > 30) {
                if (num2 <= 10) {
                    minNum = Math.max(0, Math.min(num1, result) - 3);
                    maxNum = Math.max(num1, result) + 3;
                    stepSize = 1;
                } else if (num2 <= 20) {
                    minNum = Math.max(0, Math.min(num1, result) - 5);
                    maxNum = Math.max(num1, result) + 5;
                    stepSize = 2;
                } else {
                    const padding = Math.ceil(num2 * 0.2);
                    minNum = Math.max(0, Math.floor((Math.min(num1, result) - padding) / 5) * 5);
                    maxNum = Math.ceil((Math.max(num1, result) + padding) / 5) * 5;
                    stepSize = (maxNum - minNum > 50) ? 10 : 5;
                }
            } else {
                minNum = Math.max(0, Math.min(num1, result) - 2);
                maxNum = Math.max(num1, result) + 2;
                stepSize = 1;
            }
            
            const range = maxNum - minNum;
            const startPos = ((num1 - minNum) / range) * 100;
            const endPos = ((result - minNum) / range) * 100;
            
            // Generate SOLUTION number line (with answer)
            let html = '<div class="number-line-container" style="margin-top:16px;background:linear-gradient(135deg,#f0f9ff 0%,#e0f2fe 100%);">';
            html += '<div class="number-line"><div class="number-line-base"></div>';
            
            // Ticks and labels
            for (let i = minNum; i <= maxNum; i += stepSize) {
                const position = ((i - minNum) / range) * 100;
                html += `<div class="number-line-tick" style="left:${position}%"></div>`;
                html += `<div class="number-line-label" style="left:${position}%">${i}</div>`;
            }
            
            // Special ticks for start and end
            if (num1 % stepSize !== 0 && num1 >= minNum && num1 <= maxNum) {
                const position = ((num1 - minNum) / range) * 100;
                html += `<div class="number-line-tick" style="left:${position}%;height:15px"></div>`;
                html += `<div class="number-line-label" style="left:${position}%;font-weight:bold">${num1}</div>`;
            }
            if (result % stepSize !== 0 && result >= minNum && result <= maxNum) {
                const position = ((result - minNum) / range) * 100;
                html += `<div class="number-line-tick" style="left:${position}%;height:15px"></div>`;
                html += `<div class="number-line-label" style="left:${position}%;font-weight:bold;color:#48bb78">${result}</div>`;
            }
            
            // Dots
            html += `<div class="number-line-start-dot" style="left:${startPos}%"></div>`;
            html += `<div class="number-line-end-dot" style="left:${endPos}%"></div>`;
            
            // Arc and arrow
            if (operation === 'addition') {
                const arcWidth = ((num2) / range) * 100;
                html += `<div class="number-line-arc" style="left:${startPos}%;width:${arcWidth}%"></div>`;
                const arrowPos = startPos + arcWidth / 2;
                html += `<div class="number-line-arrow" style="left:${arrowPos}%;top:5%">‚Üí</div>`;
                html += '</div>';
                html += `<div class="number-line-instruction" style="background:rgba(72,187,120,0.1);border-left:4px solid #48bb78;padding:12px">`;
                html += `‚úÖ <strong>Solution:</strong> Start at <strong>${num1}</strong> (üü¢), add <strong>${num2}</strong> by jumping forward ‚Üí to reach <strong>${result}</strong> (üî¥)`;
                html += '</div>';
            } else {
                const arcWidth = ((num2) / range) * 100;
                html += `<div class="number-line-arc" style="left:${startPos - arcWidth}%;width:${arcWidth}%;border-color:#f56565"></div>`;
                const arrowPos = startPos - arcWidth / 2;
                html += `<div class="number-line-arrow" style="left:${arrowPos}%;top:5%;color:#f56565">‚Üê</div>`;
                html += '</div>';
                html += `<div class="number-line-instruction" style="background:rgba(72,187,120,0.1);border-left:4px solid #48bb78;padding:12px">`;
                html += `‚úÖ <strong>Solution:</strong> Start at <strong>${num1}</strong> (üü¢), subtract <strong>${num2}</strong> by jumping back ‚Üê to reach <strong>${result}</strong> (üî¥)`;
                html += '</div>';
            }
            
            html += '</div>';
            return html;
        }
        }

        async function loadCurrentUser() {
            try {
                const response = await fetch('/api/current-user');
                const user = await response.json();
                document.getElementById('userName').textContent = user.full_name;
            } catch (error) {
                console.error('Error loading user:', error);
            }
        }

        async function loadTopics() {
            try {
                const response = await fetch('/api/topics');
                const topics = await response.json();
                
                const grid = document.getElementById('topicsGrid');
                grid.innerHTML = '';
                
                for (const [key, topic] of Object.entries(topics)) {
                    const iconClass = iconMap[topic.icon] || 'fa-book';
                    const card = document.createElement('button');
                    card.onclick = () => selectTopic(key, topic.title);
                    card.className = `topic-card ${topic.color} text-white rounded-2xl p-8 shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all duration-200`;
                    
                    // Check if topic is fully mastered (all 3 difficulties > 80%)
                    const topicMastered = masteryData[key]?.topic_mastered || false;
                    const masteryBadge = topicMastered ? 
                        '<div class="mastery-badge" title="All difficulties mastered!">‚≠ê</div>' : '';
                    
                    card.innerHTML = `
                        ${masteryBadge}
                        <i class="fas ${iconClass} text-6xl mb-4"></i>
                        <h2 class="text-2xl font-bold mb-2">${topic.title}</h2>
                        <p class="text-white text-opacity-90">25 questions per quiz</p>
                    `;
                    grid.appendChild(card);
                }
                
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('topicScreen').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading topics:', error);
            }
        }

        async function loadProgress() {
            try {
                const response = await fetch('/api/my-progress');
                const attempts = await response.json();
                
                const summary = document.getElementById('progressSummary');
                if (attempts.length === 0) {
                    summary.innerHTML = '<p>No quizzes completed yet. Start learning!</p>';
                } else {
                    const total = attempts.length;
                    const avgScore = (attempts.reduce((sum, a) => sum + a.percentage, 0) / total).toFixed(1);
                    
                    summary.innerHTML = `
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div>
                                <div class="text-3xl font-bold text-purple-600">${total}</div>
                                <div class="text-sm">Quizzes Completed</div>
                            </div>
                            <div>
                                <div class="text-3xl font-bold text-green-600">${avgScore}%</div>
                                <div class="text-sm">Average Score</div>
                            </div>
                            <div>
                                <div class="text-3xl font-bold text-blue-600">${attempts[0].topic}</div>
                                <div class="text-sm">Last Topic</div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading progress:', error);
            }
        }

        async function loadBadgeWidget() {
            try {
                // Fetch badge and stats data in parallel
                const [badgesResponse, statsResponse] = await Promise.all([
                    fetch('/api/student/badges'),
                    fetch('/api/student/stats')
                ]);
                
                const badgesData = await badgesResponse.json();
                const statsData = await statsResponse.json();
                
                // Update widget values
                document.getElementById('stat-level').textContent = badgesData.level;
                document.getElementById('stat-points').textContent = badgesData.total_points;
                document.getElementById('stat-badges').textContent = badgesData.earned.length + '/' + (badgesData.earned.length + badgesData.available.length);
                document.getElementById('stat-quizzes').textContent = statsData.stats.total_quizzes;
                document.getElementById('stat-streak').textContent = statsData.stats.current_streak_days;
                document.getElementById('stat-accuracy').textContent = statsData.stats.overall_accuracy + '%';
                
                // Show recent badges if any
                if (badgesData.earned.length > 0) {
                    const recentBadges = badgesData.earned.slice(-3).reverse(); // Last 3 badges
                    const recentBadgesHtml = recentBadges.map(badge => {
                        const emoji = getBadgeEmoji(badge.icon);
                        return `<span class="recent-badge-mini">${emoji} ${badge.name}</span>`;
                    }).join('');
                    
                    document.getElementById('recent-badges').innerHTML = recentBadgesHtml;
                    document.getElementById('recent-badges-container').style.display = 'block';
                }
                
                // Show the widget
                document.getElementById('badge-widget').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading badge widget:', error);
                // Hide widget if there's an error
                document.getElementById('badge-widget').style.display = 'none';
            }
        }

        function getBadgeEmoji(iconClass) {
            const iconMap = {
                'fa-star': '‚≠ê', 'fa-book': 'üìö', 'fa-graduation-cap': 'üéì',
                'fa-heart': '‚ù§Ô∏è', 'fa-trophy': 'üèÜ', 'fa-bullseye': 'üéØ',
                'fa-crown': 'üëë', 'fa-medal': 'ü•à', 'fa-gem': 'üíé',
                'fa-fire': 'üî•', 'fa-bolt': '‚ö°', 'fa-rocket': 'üöÄ',
                'fa-certificate': 'üìú', 'fa-brain': 'üß†', 'fa-infinity': '‚ôæÔ∏è'
            };
            return iconMap[iconClass] || 'üèÖ';
        }

        function selectTopic(topic, title) {
            currentTopic = topic;
            document.getElementById('selectedTopicTitle').textContent = title;
            
            // Generate difficulty/section buttons based on topic
            const container = document.getElementById('difficultyButtonsContainer');
            container.innerHTML = '';
            
            // All topics now use standard 3 difficulty levels
            const difficulties = [
                {level: 'beginner', title: 'Beginner', icon: 'fa-seedling', color: 'bg-green-500', desc: 'Start with the basics'},
                {level: 'intermediate', title: 'Intermediate', icon: 'fa-chart-line', color: 'bg-yellow-500', desc: 'Challenge yourself more'},
                {level: 'advanced', title: 'Advanced', icon: 'fa-trophy', color: 'bg-red-500', desc: 'Master the topic'}
            ];
            
            // Use 3-column grid for standard difficulties
            container.className = 'grid md:grid-cols-3 gap-6';
            
            difficulties.forEach(diff => {
                const button = document.createElement('button');
                button.onclick = () => startQuiz(diff.level);
                button.className = `difficulty-button ${diff.color} hover:opacity-90 text-white rounded-2xl p-8 shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all`;
                
                // Check if this difficulty is mastered (>80%)
                const difficultyData = masteryData[topic]?.difficulties?.[diff.level];
                const isMastered = difficultyData?.mastered || false;
                const bestScore = difficultyData?.best_score || 0;
                
                // Add trophy badge if mastered
                const masteryBadge = isMastered ? `
                    <div class="difficulty-mastery" title="Mastered with ${bestScore}%!">
                        <div class="trophy">üèÜ</div>
                        <div class="score">${bestScore}%</div>
                    </div>
                ` : '';
                
                // Show best score if attempted but not mastered
                const scoreDisplay = (bestScore > 0 && !isMastered) ? 
                    `<div class="best-score-display">Best: ${bestScore}%</div>` : '';
                
                button.innerHTML = `
                    ${masteryBadge}
                    <i class="fas ${diff.icon} text-6xl mb-4"></i>
                    <h3 class="text-2xl font-bold mb-2">${diff.title}</h3>
                    <p class="text-white text-opacity-90">${diff.desc}</p>
                    <p class="mt-2 text-sm">25 questions</p>
                    ${scoreDisplay}
                `;
                container.appendChild(button);
            });
            
            document.getElementById('topicScreen').classList.add('hidden');
            document.getElementById('difficultyScreen').classList.remove('hidden');
        }

        async function startQuiz(difficulty) {
            currentDifficulty = difficulty;
            currentQuestionIndex = 0;
            score = 0;
            answered = false;
            startTime = Date.now();
            
            document.getElementById('difficultyScreen').classList.add('hidden');
            document.getElementById('loadingScreen').classList.remove('hidden');
            
            try {
                const response = await fetch(`/api/questions/${currentTopic}/${difficulty}`);
                questions = await response.json();
                
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('quizScreen').classList.remove('hidden');
                
                document.getElementById('quizTopicTitle').textContent = currentTopic.charAt(0).toUpperCase() + currentTopic.slice(1);
                document.getElementById('total').textContent = questions.length;
                document.getElementById('totalQuestions').textContent = questions.length;
                
                showQuestion();
            } catch (error) {
                console.error('Error loading questions:', error);
                alert('Error loading questions. Please try again.');
                backToDifficulty();
            }
        }

        function showQuestion() {
            const question = questions[currentQuestionIndex];
            answered = false;
            
            document.getElementById('questionText').textContent = question.question;
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
            document.getElementById('score').textContent = score;
            
            const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            
            // Add number line ONLY for arithmetic questions (addition/subtraction)
            // Do NOT show number line for complex numbers or other topics
            if (currentTopic === 'arithmetic') {
                const numberLineHtml = generateBlankNumberLine(question.question);
                if (numberLineHtml) {
                    const numberLineDiv = document.createElement('div');
                    numberLineDiv.innerHTML = numberLineHtml;
                    optionsContainer.appendChild(numberLineDiv);
                }
            }
            
            // Add answer options
            question.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'w-full p-4 rounded-xl text-left text-lg font-medium transition-all bg-gray-50 hover:bg-purple-50 border-2 border-gray-200 hover:border-purple-300 text-gray-800';
                button.textContent = option;
                button.onclick = () => handleAnswer(index);
                optionsContainer.appendChild(button);
            });
            
            // Add flag button
            const flagButton = document.createElement('button');
            flagButton.className = 'w-full mt-4 p-3 rounded-lg text-center text-sm font-medium bg-gray-100 hover:bg-gray-200 text-gray-700 transition-all';
            flagButton.innerHTML = '<i class="fas fa-flag mr-2"></i>Report an issue with this question';
            flagButton.onclick = () => showFlagQuestionModal(question.id);
            optionsContainer.appendChild(flagButton);
            
            document.getElementById('feedbackContainer').classList.add('hidden');
            document.getElementById('nextButton').classList.add('hidden');
        }

        function handleAnswer(selectedIndex) {
            if (answered) return;
            answered = true;
            
            const question = questions[currentQuestionIndex];
            const correct = selectedIndex === question.correct;
            
            if (correct) {
                score++;
                document.getElementById('score').textContent = score;
            }
            
            const allChildren = document.getElementById('optionsContainer').children;
            
            // CRITICAL FIX: Find the offset by checking if first child is number line
            // Number line div doesn't have onclick, buttons do
            let buttonOffset = 0;
            if (allChildren.length > 0 && !allChildren[0].onclick) {
                buttonOffset = 1; // First child is number line, so buttons start at index 1
            }
            
            // Calculate where option buttons end (before flag button)
            // There are always 4 option buttons, plus potentially 1 number line at start
            const optionButtonCount = 4;
            const optionButtonsEnd = buttonOffset + optionButtonCount;
            
            // Now loop through actual option buttons only (NOT the flag button at the end)
            for (let i = buttonOffset; i < optionButtonsEnd; i++) {
                const button = allChildren[i];
                const optionIndex = i - buttonOffset; // Convert container index to option index
                
                button.disabled = true;
                
                if (optionIndex === question.correct) {
                    button.className = 'w-full p-4 rounded-xl text-left text-lg font-medium bg-green-100 border-2 border-green-500 text-green-800';
                    button.innerHTML += ' <i class="fas fa-check float-right text-green-600"></i>';
                } else if (optionIndex === selectedIndex && !correct) {
                    button.className = 'w-full p-4 rounded-xl text-left text-lg font-medium bg-red-100 border-2 border-red-500 text-red-800';
                    button.innerHTML += ' <i class="fas fa-times float-right text-red-600"></i>';
                } else if (button.onclick) { // Only style actual option buttons
                    button.className = 'w-full p-4 rounded-xl text-left text-lg font-medium bg-gray-100 text-gray-600';
                }
            }
            
            // Keep the flag button enabled and clickable (it's the last child)
            // No need to disable it - students should be able to report issues after seeing the answer
            
            // Generate solution number line for arithmetic questions
            let solutionNumberLine = '';
            if (currentTopic === 'arithmetic') {
                solutionNumberLine = generateSolutionNumberLine(question.question) || '';
            }
            
            const feedback = document.getElementById('feedbackContainer');
            feedback.className = correct ? 'mb-6 p-6 rounded-xl bg-green-50 border-2 border-green-200' : 'mb-6 p-6 rounded-xl bg-blue-50 border-2 border-blue-200';
            feedback.innerHTML = `
                <div class="flex items-start">
                    <i class="fas ${correct ? 'fa-check' : 'fa-book'} ${correct ? 'text-green-600' : 'text-blue-600'} text-2xl mr-3 mt-1"></i>
                    <div>
                        <p class="font-bold text-lg mb-2 ${correct ? 'text-green-800' : 'text-blue-800'}">
                            ${correct ? 'üéâ Correct!' : 'üìñ Let\'s learn from this!'}
                        </p>
                        <p class="text-gray-700">${question.explanation}</p>
                        ${solutionNumberLine}
                    </div>
                </div>
            `;
            feedback.classList.remove('hidden');
            
            document.getElementById('nextButton').classList.remove('hidden');
        }

        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < questions.length) {
                showQuestion();
            } else {
                submitAndShowResults();
            }
        }

        async function submitAndShowResults() {
            const percentage = Math.round((score / questions.length) * 100);
            const timeTaken = Math.floor((Date.now() - startTime) / 1000);
            
            // Submit to backend
            try {
                await fetch('/api/submit-quiz', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        topic: currentTopic,
                        difficulty: currentDifficulty,
                        score: score,
                        total_questions: questions.length,
                        percentage: percentage,
                        time_taken: timeTaken
                    })
                });
            } catch (error) {
                console.error('Error submitting quiz:', error);
            }
            
            showResults(percentage);
        }

        function showResults(percentage) {
            document.getElementById('quizScreen').classList.add('hidden');
            document.getElementById('resultsScreen').classList.remove('hidden');
            
            document.getElementById('percentage').textContent = percentage + '%';
            document.getElementById('scoreText').textContent = `You scored ${score} out of ${questions.length}`;
            
            const messageEl = document.getElementById('performanceMessage');
            if (percentage === 100) {
                messageEl.className = 'text-xl text-green-600 font-semibold mb-6';
                messageEl.textContent = 'üåü Perfect score! Amazing work!';
            } else if (percentage >= 80) {
                messageEl.className = 'text-xl text-blue-600 font-semibold mb-6';
                messageEl.textContent = 'üéâ Great job! You\'re really getting it!';
            } else if (percentage >= 60) {
                messageEl.className = 'text-xl text-orange-600 font-semibold mb-6';
                messageEl.textContent = 'üëç Good effort! Keep practicing!';
            } else {
                messageEl.className = 'text-xl text-red-600 font-semibold mb-6';
                messageEl.textContent = 'üí™ Keep trying! Practice makes perfect!';
            }
        }

        function retryQuiz() {
            document.getElementById('resultsScreen').classList.add('hidden');
            startQuiz(currentDifficulty);
        }

        function backToTopics() {
            document.getElementById('difficultyScreen').classList.add('hidden');
            document.getElementById('resultsScreen').classList.add('hidden');
            document.getElementById('quizScreen').classList.add('hidden');
            document.getElementById('topicScreen').classList.remove('hidden');
            loadProgress(); // Refresh progress
        }

        function backToDifficulty() {
            document.getElementById('quizScreen').classList.add('hidden');
            document.getElementById('difficultyScreen').classList.remove('hidden');
        }

        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (error) {
                console.error('Error logging out:', error);
            }
        }

        // ==================== QUESTION FLAGGING ====================
        
        let currentFlagQuestionId = null;

        function showFlagQuestionModal(questionId) {
            currentFlagQuestionId = questionId;
            const question = questions[currentQuestionIndex];
            
            document.getElementById('flagQuestionText').textContent = question.question;
            document.getElementById('flagQuestionModal').classList.remove('hidden');
            document.getElementById('flagQuestionModal').classList.add('flex');
            
            document.getElementById('flagForm').reset();
        }

        function hideFlagModal() {
            document.getElementById('flagQuestionModal').classList.add('hidden');
            document.getElementById('flagQuestionModal').classList.remove('flex');
            currentFlagQuestionId = null;
        }

        document.addEventListener('DOMContentLoaded', function() {
            const flagForm = document.getElementById('flagForm');
            if (flagForm) {
                flagForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const flagType = document.getElementById('flagType').value;
                    const description = document.getElementById('flagDescription').value;
                    
                    if (!flagType || !description.trim()) {
                        alert('Please fill in all fields');
                        return;
                    }
                    
                    try {
                        const response = await fetch('/api/student/flag-question', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                question_id: currentFlagQuestionId,
                                flag_type: flagType,
                                description: description
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            alert('Thank you! Your report has been submitted to the administrator.');
                            hideFlagModal();
                        } else {
                            alert(data.error || 'Failed to submit report');
                        }
                    } catch (error) {
                        console.error('Error submitting flag:', error);
                        alert('Error submitting report. Please try again.');
                    }
                });
            }
        });
    </script>

    <!-- Flag Question Modal -->
    <div id="flagQuestionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Report Question Issue</h2>
                <button onclick="hideFlagModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <div id="flagQuestionContent" class="mb-6">
                <p class="text-gray-700 mb-4" id="flagQuestionText"></p>
            </div>

            <form id="flagForm" class="space-y-4">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Issue Type:</label>
                    <select id="flagType" required class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="">-- Select issue type --</option>
                        <option value="incorrect">Incorrect Answer</option>
                        <option value="ambiguous">Ambiguous/Unclear Question</option>
                        <option value="typo">Typo or Grammar Error</option>
                        <option value="other">Other Issue</option>
                    </select>
                </div>

                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Description:</label>
                    <textarea id="flagDescription" required rows="4" 
                              class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                              placeholder="Please describe the issue in detail..."></textarea>
                </div>

                <div class="flex gap-4">
                    <button type="submit" class="flex-1 bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 font-semibold">
                        <i class="fas fa-flag mr-2"></i>Submit Report
                    </button>
                    <button type="button" onclick="hideFlagModal()" class="flex-1 bg-gray-300 text-gray-800 py-3 rounded-lg hover:bg-gray-400 font-semibold">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>
