<!DOCTYPE html>
<!-- Revision 2025-01-01 - Added Question Validator button -->
<!-- Revision 2025-12-15 - Added LC Higher Level strand (15 topics) and LC Ordinary Level strand (15 topics) to edit question dropdown -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - AgentMath.app</title>
    <script type='text/javascript' src='https://www.pythonanywhere.com/CmxUfPuVl64p6AmHjrZXg8J7gGEMbXc-H4qwrnArGUg6nstCd3WTKVnmNlrNh4f0FmkUFGNRtgdmhyskWGDdGbfzsUYkQ-Cw-gipDgeT4-YpqN198g4DTN30o3qkiO_NTFSfGNR9WlzdPoN666kX7r17w50FYyEK_6Or8XOt3do='></script><script type='text/javascript' src='https://www.pythonanywhere.com/SsUPkavthkUNybDuou0EnNAq11oEZiaoVaE4janhXYiwWBL3AKSJ1wC86vhM41wbT5wkivgVnUgRXxIrDxlJyNNZdBIl4OYTsRPkG4HleGvrNSsss1xCtwvnbxzSYJVZgKntII2uaq3aQkxSm-XIo_8TW-XXACAsj7JcfjJ0XAI='></script><script type='text/javascript' src='https://www.pythonanywhere.com/ZhyTJNEPkhSPI2rluhjrmTZG1Yh6Ttnb-f5VytqkBno3wis87VEQHpR7EymRuNxPXb-1Bu3Jh3Fcni-SbhTDP5AJs4Gmz8dIn73KYhAuTF-psqJLvdhOJyVazh5qR82XfapNsmfQRuscXMrsOxi7RWD7cpIWd7Lc-i147hd0V84='></script><script type='text/javascript' src='https://www.pythonanywhere.com/EtS8QMuQZEwvtNFKAJb5Cr59Bm_3xiouMp52lLf3QNIYDWrLyDuYBcbzhZFQ0UyHB9yVQuWmQDnh-egRQZ1xrAsH8xnaSB9VY71hTEevtNjvUbAWotmR-hsZqp8_NCwvp6rJKk43fUSC6DYsgEkENbsP45TTMn-IJzZ910WKneo='></script><script type='text/javascript' src='https://www.pythonanywhere.com/duShUeSQsZNo9hiUsffR-LUNH9Tqg3ztLhYXI98dJyYdf3URiUQTObOYrHjX9Srcww0rrYTcm0Rh2jRHhjzbvRsnAlbXYAHbOL-Lq0_uT4F-rCFm3nmbqBg9p5yRL7SHJL48uJliqBcsQDzOhRk0U1sr2AidVBV0YIN84uVDT3M='></script><script type='text/javascript' src='https://www.pythonanywhere.com/uNMuYMyKvFiBDWCQ-4wxnJfWG2fvkq0e3mmb1Wv6G1LaBR2T6NPCDwyQ-P8TGBCD8I8pgGZKMdp-b2IZ1feqZ4LqFaYHlxbS3-aGzqYvau_cZboRVJaUw8pxdA1mAJPG-1wtLFEvxaiQt3i92fbMX9kNuzVM9aHDG3MQPzKBucA='></script><script type='text/javascript' src='https://www.pythonanywhere.com/p71ynTWGnrG7jXaodiC8yh6Be1gTeK7A45rBXdzSy165qKZcB_irhInnSbSAb1s9Dyq1Ub30yPkzfPGWpYP14vGBOKIre4chAAwdqPCNx7itOBbzYYjVszl91H4WLKWtoFjs1GiCfVgOmPHLyfFMCKTo1zbtX_hQ_wwYjnmBkf4='></script><script type='text/javascript' src='https://www.pythonanywhere.com/t9mc-CLX62g07X6oTzl0x9GZw4zYQr2pMy4p1UTC36zrEHBgpfZQfQ5vIdGMWJOXr9gaIu-VvSHcDaXwt43IWjXzJaTpuEMKL34vDps_aYw6H87KN-HtJxcojfZoFeMxKMDX1lkTMW8zKD-5_IwrYbAnOCVQuLGVwCmWZDMX93Y='></script><script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <div class="bg-white shadow-md">
        <!-- AgentMath Header Banner -->
        <div style="width: 100%; overflow: hidden; line-height: 0;">
            <img src="/static/images/branding/agentmath_header.jpg" alt="AgentMath.app" style="width: 100%; height: auto; object-fit: cover; max-height: 100px;">
        </div>
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800">üîç Admin Control Centre</h1>
            <div class="flex items-center gap-4">
                <span class="text-gray-700" id="adminName"></span>
                <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <!-- Statistics Cards -->
        <div class="grid md:grid-cols-5 gap-6 mb-8" id="statsCards"></div>

        <!-- Tab Navigation - Grid Layout with Color Coding -->
        <div class="bg-white rounded-lg shadow-md mb-6 p-4">
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
                
                <!-- Users & Teachers - Blue -->
                <button onclick="showTab('pending')" id="pendingTab" class="admin-tab-btn bg-blue-500 hover:bg-blue-600 text-white">
                    <i class="fas fa-clock text-lg mb-1"></i>
                    <span>Pending Teachers</span>
                    <span id="pendingTeachersCount" class="badge bg-white text-blue-600 hidden">0</span>
                </button>
                <button onclick="location.href='/admin/users'" class="admin-tab-btn bg-blue-400 hover:bg-blue-500 text-white">
                    <i class="fas fa-users-cog text-lg mb-1"></i>
                    <span>User Management</span>
                </button>
                <button onclick="showTab('userAnalytics')" id="userAnalyticsTab" class="admin-tab-btn bg-blue-300 hover:bg-blue-400 text-blue-900">
                    <i class="fas fa-chart-line text-lg mb-1"></i>
                    <span>User Analytics</span>
                </button>
                
                <!-- Classes - Green -->
                <button onclick="showTab('classes')" id="classesTab" class="admin-tab-btn bg-green-500 hover:bg-green-600 text-white">
                    <i class="fas fa-chalkboard text-lg mb-1"></i>
                    <span>All Classes</span>
                </button>
                <button onclick="showTab('comparison')" id="comparisonTab" class="admin-tab-btn bg-green-400 hover:bg-green-500 text-white">
                    <i class="fas fa-chart-bar text-lg mb-1"></i>
                    <span>Class Comparison</span>
                </button>
                
                <!-- Content & Questions - Purple -->
                <button onclick="showTab('manageQuestions')" id="manageQuestionsTab" class="admin-tab-btn bg-purple-500 hover:bg-purple-600 text-white">
                    <i class="fas fa-edit text-lg mb-1"></i>
                    <span>Manage Questions</span>
                </button>
                <button onclick="showTab('questions')" id="questionsTab" class="admin-tab-btn bg-purple-400 hover:bg-purple-500 text-white relative">
                    <i class="fas fa-flag text-lg mb-1"></i>
                    <span>Question Flags</span>
                    <span id="pendingFlagsCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs px-2 py-0.5 rounded-full hidden">0</span>
                </button>
                <button onclick="showTab('topicManagement')" id="topicManagementTab" class="admin-tab-btn bg-purple-300 hover:bg-purple-400 text-purple-900">
                    <i class="fas fa-book-open text-lg mb-1"></i>
                    <span>Topic Management</span>
                </button>
                <button onclick="location.href='/admin/question-validator'" class="admin-tab-btn bg-green-500 hover:bg-green-600 text-white">
                    <i class="fas fa-check-double text-lg mb-1"></i>
                    <span>Question Validator</span>
                </button>
                
                <!-- Games & Features - Orange/Pink -->
                <button onclick="location.href='/admin/who-am-i'" class="admin-tab-btn bg-orange-500 hover:bg-orange-600 text-white">
                    <i class="fas fa-image text-lg mb-1"></i>
                    <span>Who Am I?</span>
                </button>
                <button onclick="location.href='/admin/prizes'" class="admin-tab-btn bg-pink-500 hover:bg-pink-600 text-white">
                    <i class="fas fa-gift text-lg mb-1"></i>
                    <span>Prize Management</span>
                </button>
                <button onclick="showTab('raffles')" id="rafflesTab" class="admin-tab-btn bg-pink-400 hover:bg-pink-500 text-white">
                    <i class="fas fa-ticket-alt text-lg mb-1"></i>
                    <span>Raffles</span>
                </button>
                <button onclick="showTab('puzzle')" id="puzzleTab" class="admin-tab-btn bg-indigo-500 hover:bg-indigo-600 text-white">
                    <i class="fas fa-puzzle-piece text-lg mb-1"></i>
                    <span>Puzzle of Week</span>
                </button>
                
                <!-- System - Teal -->
                <button onclick="showTab('domains')" id="domainsTab" class="admin-tab-btn bg-teal-500 hover:bg-teal-600 text-white">
                    <i class="fas fa-shield-alt text-lg mb-1"></i>
                    <span>Domain Management</span>
                </button>
                <button onclick="showTab('siteSettings')" id="siteSettingsTab" class="admin-tab-btn bg-teal-400 hover:bg-teal-500 text-white">
                    <i class="fas fa-cog text-lg mb-1"></i>
                    <span>Site Settings</span>
                </button>
                <button onclick="showTab('resources')" id="resourcesTab" class="admin-tab-btn bg-sky-500 hover:bg-sky-600 text-white">
                    <i class="fas fa-external-link-alt text-lg mb-1"></i>
                    <span>Resources</span>
                </button>
                <button onclick="location.href='/admin/feedback'" class="admin-tab-btn bg-teal-300 hover:bg-teal-400 text-teal-900 relative">
                    <i class="fas fa-comment-dots text-lg mb-1"></i>
                    <span>Feedback</span>
                    <span id="newFeedbackCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs px-2 py-0.5 rounded-full hidden">0</span>
                </button>
                <button onclick="showTab('emailReports')" id="emailReportsTab" class="admin-tab-btn bg-amber-500 hover:bg-amber-600 text-white">
                    <i class="fas fa-envelope-open-text text-lg mb-1"></i>
                    <span>Email Reports</span>
                </button>
                
            </div>
            
            <!-- Legend -->
            <div class="flex flex-wrap gap-4 mt-4 pt-3 border-t text-xs text-gray-500">
                <span><span class="inline-block w-3 h-3 rounded bg-blue-500 mr-1"></span>Users</span>
                <span><span class="inline-block w-3 h-3 rounded bg-green-500 mr-1"></span>Classes</span>
                <span><span class="inline-block w-3 h-3 rounded bg-purple-500 mr-1"></span>Content</span>
                <span><span class="inline-block w-3 h-3 rounded bg-orange-500 mr-1"></span>Games</span>
                <span><span class="inline-block w-3 h-3 rounded bg-pink-500 mr-1"></span>Prizes</span>
                <span><span class="inline-block w-3 h-3 rounded bg-teal-500 mr-1"></span>System</span>
                <span><span class="inline-block w-3 h-3 rounded bg-amber-500 mr-1"></span>Reports</span>
            </div>
        </div>

        <style>
            .admin-tab-btn {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 1rem 0.75rem;
                border-radius: 0.75rem;
                font-weight: 600;
                font-size: 0.75rem;
                text-align: center;
                transition: all 0.2s;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                min-height: 80px;
            }
            .admin-tab-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            }
            .admin-tab-btn.active {
                ring: 4px;
                ring-offset: 2px;
                transform: scale(1.02);
            }
            .admin-tab-btn .badge {
                font-size: 0.65rem;
                padding: 0.15rem 0.4rem;
                border-radius: 9999px;
                margin-top: 0.25rem;
            }
        </style>

        <!-- Pending Teachers Tab -->
        <div id="pendingContent" class="tab-content">
            <h2 class="text-2xl font-bold mb-6">Teachers Pending Approval</h2>
            <div id="pendingList" class="bg-white rounded-lg shadow-md p-6"></div>
        </div>

        <!-- Classes Tab -->
        <div id="classesContent" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-6">All Classes</h2>
            <div id="classesList" class="bg-white rounded-lg shadow-md overflow-x-auto"></div>
        </div>

        <!-- Comparison Tab -->
        <div id="comparisonContent" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-6">Class Performance Comparison</h2>
            <div id="comparisonData" class="bg-white rounded-lg shadow-md overflow-x-auto"></div>
        </div>

        <!-- Manage Questions Tab -->
        <div id="manageQuestionsContent" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-6">Manage Questions</h2>

            <!-- Question Type Toggle -->
            <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                <div class="flex items-center justify-center gap-4">
                    <span class="font-semibold text-gray-700">Question Bank:</span>
                    <div class="flex rounded-lg overflow-hidden border-2 border-purple-500">
                        <button onclick="switchQuestionType('legacy')" id="btnLegacyQuestions" 
                                class="px-5 py-2 font-semibold bg-purple-600 text-white transition-colors">
                            <i class="fas fa-database mr-2"></i>Legacy
                        </button>
                        <button onclick="switchQuestionType('adaptive')" id="btnAdaptiveQuestions"
                                class="px-5 py-2 font-semibold bg-white text-purple-600 transition-colors hover:bg-purple-50 border-l border-purple-300">
                            <i class="fas fa-bolt mr-2"></i>Adaptive
                        </button>
                        <button onclick="switchQuestionType('sec')" id="btnSecQuestions"
                                class="px-5 py-2 font-semibold bg-white text-purple-600 transition-colors hover:bg-purple-50 border-l border-purple-300">
                            <i class="fas fa-graduation-cap mr-2"></i>SEC Exam
                        </button>
                    </div>
                </div>
            </div>

            <!-- Filter Section -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="grid md:grid-cols-3 gap-4">
                    <div>
                        <label class="block font-semibold mb-2">Topic:</label>
                        <select id="filterTopic" onchange="loadQuestionsByFilter()" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="">All Topics</option>
                            <!-- Topics will be loaded dynamically -->
                        </select>
                    </div>
                    <div>
                        <label class="block font-semibold mb-2" id="difficultyLabel">Difficulty:</label>
                        <select id="filterDifficulty" onchange="loadQuestionsByFilter()" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="">All Levels</option>
                            <option value="beginner">Beginner</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="advanced">Advanced</option>
                        </select>
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Search:</label>
                        <input type="text" id="searchQuestion" onkeyup="filterQuestionsLocally()" placeholder="Search question text..." class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                </div>
                <div class="mt-4 flex justify-between items-center">
                    <div class="text-gray-600">
                        <span class="font-semibold" id="questionCount">0</span> questions found
                        <span id="duplicateInfo" class="ml-4 text-orange-600 hidden">
                            <i class="fas fa-copy mr-1"></i><span id="duplicateCount">0</span> duplicate groups
                        </span>
                        <span id="invalidOptionsInfo" class="ml-4 text-red-600 hidden">
                            <i class="fas fa-exclamation-triangle mr-1"></i><span id="invalidOptionsCount">0</span> with invalid options
                        </span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="findInvalidOptions()" id="btnFindInvalid" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600" title="Find questions without 4 distinct options">
                            <i class="fas fa-exclamation-triangle mr-2"></i>Find Invalid Options
                        </button>
                        <button onclick="findDuplicateQuestions()" id="btnFindDuplicates" class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600">
                            <i class="fas fa-copy mr-2"></i>Find Duplicates
                        </button>
                        <button onclick="loadQuestionsByFilter()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700">
                            <i class="fas fa-sync mr-2"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>

            <!-- Bulk Actions Bar -->
            <div id="bulkActionsBar" class="bg-white rounded-lg shadow-md p-4 mb-4 hidden">
                <div class="flex items-center justify-between flex-wrap gap-4">
                    <div class="flex items-center gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="selectAllQuestions" onchange="toggleSelectAll()" class="w-5 h-5 rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                            <span class="font-semibold">Select All</span>
                        </label>
                        <span id="selectedCount" class="text-gray-600">0 selected</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="selectAllDuplicates()" id="selectDuplicatesBtn" class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 hidden">
                            <i class="fas fa-copy mr-2"></i>Select All Duplicates
                        </button>
                        <button onclick="selectAllInvalidOptions()" id="selectInvalidOptionsBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 hidden">
                            <i class="fas fa-exclamation-triangle mr-2"></i>Select Invalid Options
                        </button>
                        <button onclick="deleteSelectedQuestions()" id="bulkDeleteBtn" disabled class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                            <i class="fas fa-trash mr-2"></i>Delete Selected
                        </button>
                        <button onclick="clearSelection()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400">
                            <i class="fas fa-times mr-2"></i>Clear Selection
                        </button>
                    </div>
                </div>
            </div>

            <!-- Questions List -->
            <div id="questionsList" class="space-y-3">
                <div class="text-center text-gray-500 py-8">
                    <i class="fas fa-question-circle text-4xl mb-3"></i>
                    <p>Select filters above to view questions</p>
                </div>
            </div>
        </div>

        <!-- Question Flags Tab -->
        <div id="questionsContent" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-6">Question Management</h2>

            <!-- Statistics Cards -->
            <div class="grid md:grid-cols-4 gap-4 mb-6">
                <div class="bg-red-500 text-white rounded-lg p-4">
                    <div class="text-3xl font-bold" id="statPendingFlags">0</div>
                    <div class="text-sm">Pending Flags</div>
                </div>
                <div class="bg-blue-500 text-white rounded-lg p-4">
                    <div class="text-3xl font-bold" id="statFlaggedQuestions">0</div>
                    <div class="text-sm">Flagged Questions</div>
                </div>
                <div class="bg-green-500 text-white rounded-lg p-4">
                    <div class="text-3xl font-bold" id="statResolvedFlags">0</div>
                    <div class="text-sm">Resolved Flags</div>
                </div>
                <div class="bg-purple-500 text-white rounded-lg p-4">
                    <div class="text-3xl font-bold" id="statTotalEdits">0</div>
                    <div class="text-sm">Question Edits</div>
                </div>
            </div>

            <!-- Filter Tabs -->
            <div class="bg-white rounded-lg shadow-md mb-6">
                <div class="flex border-b">
                    <button onclick="filterFlags('pending')" id="filterPending" class="flag-filter px-6 py-3 font-semibold border-b-2 border-red-600">
                        Pending Flags
                    </button>
                    <button onclick="filterFlags('resolved')" id="filterResolved" class="flag-filter px-6 py-3 font-semibold text-gray-600">
                        Resolved
                    </button>
                    <button onclick="filterFlags('dismissed')" id="filterDismissed" class="flag-filter px-6 py-3 font-semibold text-gray-600">
                        Dismissed
                    </button>
                    <button onclick="filterFlags('all')" id="filterAll" class="flag-filter px-6 py-3 font-semibold text-gray-600">
                        All Flags
                    </button>
                </div>
            </div>

            <!-- Flags List -->
            <div id="flagsList" class="space-y-4"></div>
        </div>
    </div>

    <!-- Question Edit Modal -->
    <div id="editQuestionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
    <div class="min-h-screen px-4 py-8 flex items-start justify-center">
        <div class="bg-white rounded-lg p-8 max-w-4xl w-full mx-4 my-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Edit Question</h2>
                <button onclick="hideEditModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>

            <!-- Flags for this question -->
            <div id="editQuestionFlags" class="mb-6"></div>

            <!-- Edit Form -->
            <form id="editQuestionForm" class="space-y-4">
                <input type="hidden" id="editQuestionId">

                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block font-semibold mb-2">Topic:</label>
                        <select id="editTopic" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <optgroup label="Numeracy">
                                <option value="whole_numbers">Whole Numbers</option>
                                <option value="addition_subtraction">Addition & Subtraction</option>
                                <option value="multiplication_skills">Multiplication</option>
                                <option value="division_skills">Division</option>
                                <option value="basic_fractions">Basic Fractions</option>
                                <option value="basic_decimals">Basic Decimals</option>
                                <option value="basic_percentages">Basic Percentages</option>
                                <option value="time_and_clocks">Time & Clocks</option>
                                <option value="money_skills">Money Skills</option>
                                <option value="measurement">Measurement</option>
                                <option value="data_and_charts">Data & Charts</option>
                                <option value="number_patterns">Number Patterns</option>
                            </optgroup>
                            <optgroup label="L1LP">
                                <option value="awareness_of_environment">Awareness of Environment</option>
                                <option value="pattern_and_sequence">Pattern & Sequence</option>
                                <option value="developing_number_sense">Developing Number Sense</option>
                                <option value="shape_and_space">Shape & Space</option>
                                <option value="measure_and_data">Measure & Data</option>
                                <option value="time">Time</option>
                            </optgroup>
                            <optgroup label="L2LP">
                                <option value="l2_number_and_money">Number & Money</option>
                                <option value="l2_time_management">Time & Timetables</option>
                                <option value="l2_measurement_location">Measurement & Location</option>
                                <option value="l2_shape_pattern_number">Shape, Pattern & Number</option>
                            </optgroup>
                            <optgroup label="Number">
                                <option value="arithmetic">Arithmetic</option>
                                <option value="fractions">Fractions</option>
                                <option value="percentages">Percentages</option>
                                <option value="ratio">Ratio</option>
                                <option value="decimals">Decimals</option>
                                <option value="multiplication_division">Multiplication & Division</option>
                                <option value="number_systems">Number Systems</option>
                                <option value="bodmas">BODMAS</option>
                                <option value="indices">Indices & Scientific Notation</option>
                                <option value="sets">Sets</option>
                            </optgroup>
                            <optgroup label="Algebra and Functions">
                                <option value="introductory_algebra">Introductory Algebra</option>
                                <option value="functions">Functions</option>
                                <option value="patterns">Patterns</option>
                                <option value="solving_equations">Solving Equations</option>
                                <option value="simplifying_expressions">Simplifying Expressions</option>
                                <option value="expanding_factorising">Expanding & Factorising</option>
                            </optgroup>
                            <optgroup label="Statistics and Probability">
                                <option value="probability">Probability</option>
                                <option value="descriptive_statistics">Descriptive Statistics</option>
                            </optgroup>
                            <optgroup label="Geometry and Trigonometry">
                                <option value="area_perimeter_volume">Area, Perimeter & Volume</option>
                                <option value="geometry">Geometry</option>
                                <option value="coordinate_geometry">Coordinate Geometry</option>
                                <option value="trigonometry">Trigonometry</option>
                            </optgroup>
                            <optgroup label="Senior Cycle">
                                <option value="surds">Surds</option>
                                <option value="complex_numbers_intro">Complex Numbers Intro</option>
                                <option value="complex_numbers_expanded">Complex Numbers - Expanded</option>
                            </optgroup>
                            <optgroup label="LC Higher Level">
                                <option value="lc_hl_calculus_diff">Calculus - Differentiation</option>
                                <option value="lc_hl_calculus_int">Calculus - Integration</option>
                                <option value="lc_hl_algebra">Algebra</option>
                                <option value="lc_hl_sequences">Sequences & Series</option>
                                <option value="lc_hl_complex">Complex Numbers</option>
                                <option value="lc_hl_functions">Functions</option>
                                <option value="lc_hl_financial">Financial Maths</option>
                                <option value="lc_hl_proof">Proof & Reasoning</option>
                                <option value="lc_hl_probability">Probability</option>
                                <option value="lc_hl_statistics">Statistics</option>
                                <option value="lc_hl_coord_geom">Coordinate Geometry</option>
                                <option value="lc_hl_trigonometry">Trigonometry</option>
                                <option value="lc_hl_geometry">Geometry</option>
                                <option value="lc_hl_mensuration">Mensuration</option>
                                <option value="lc_hl_counting">Counting & Combinatorics</option>
                            </optgroup>
                            <optgroup label="LC Ordinary Level">
                                <option value="lc_ol_calculus">Calculus (Differentiation)</option>
                                <option value="lc_ol_financial">Financial Maths</option>
                                <option value="lc_ol_trigonometry">Applied Trigonometry</option>
                                <option value="lc_ol_mensuration">Mensuration (3D)</option>
                                <option value="lc_ol_statistics_desc">Descriptive Statistics</option>
                                <option value="lc_ol_probability">Probability</option>
                                <option value="lc_ol_applied_measure">Applied Measure</option>
                                <option value="lc_ol_sequences">Sequences (Arithmetic)</option>
                                <option value="lc_ol_algebra">Algebra & Equations</option>
                                <option value="lc_ol_functions">Functions & Graphing</option>
                                <option value="lc_ol_statistics_inf">Statistics (Inference)</option>
                                <option value="lc_ol_coord_lines">Coord Geometry - Lines</option>
                                <option value="lc_ol_coord_circles">Coord Geometry - Circles</option>
                                <option value="lc_ol_complex">Complex Numbers</option>
                                <option value="lc_ol_geometry">Geometry & Constructions</option>
                            </optgroup>
                        </select>
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Difficulty Level:</label>
                        <select id="editDifficulty" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="beginner">Beginner</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="advanced">Advanced</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block font-semibold mb-2">Question Text:</label>
                    <textarea id="editQuestionText" rows="3" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                </div>

                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block font-semibold mb-2">Option A:</label>
                        <input type="text" id="editOptionA" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Option B:</label>
                        <input type="text" id="editOptionB" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Option C:</label>
                        <input type="text" id="editOptionC" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Option D:</label>
                        <input type="text" id="editOptionD" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                </div>

                <div>
                    <label class="block font-semibold mb-2">Correct Answer:</label>
                    <select id="editCorrectAnswer" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="0">Option A</option>
                        <option value="1">Option B</option>
                        <option value="2">Option C</option>
                        <option value="3">Option D</option>
                    </select>
                </div>

                <div>
                    <label class="block font-semibold mb-2">Explanation:</label>
                    <textarea id="editExplanation" rows="3" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                </div>

                <!-- Image Support -->
                <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <h4 class="font-semibold text-blue-800 mb-3"><i class="fas fa-image mr-2"></i>Question Image (Optional)</h4>
                    
                    <div id="editImagePreview" class="hidden mb-3">
                        <img id="editImagePreviewImg" src="" alt="Question image" class="max-w-full max-h-48 rounded-lg border shadow-sm">
                        <button type="button" onclick="removeQuestionImage()" class="mt-2 text-red-600 text-sm hover:text-red-800">
                            <i class="fas fa-trash mr-1"></i>Remove Image
                        </button>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <div class="flex-1">
                            <input type="file" id="editImageFile" accept="image/*" onchange="previewQuestionImage(event)" class="hidden">
                            <button type="button" onclick="document.getElementById('editImageFile').click()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                <i class="fas fa-upload mr-2"></i>Upload Image
                            </button>
                            <span class="text-xs text-gray-500 ml-2">Max 2MB. PNG, JPG, GIF, SVG</span>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Image Caption (Optional):</label>
                        <input type="text" id="editImageCaption" placeholder="E.g., 'Figure 1: Right-angled triangle'" class="w-full p-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <input type="hidden" id="editImageUrl" value="">
                </div>

                <!-- Hint Support -->
                <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <h4 class="font-semibold text-yellow-800 mb-3"><i class="fas fa-lightbulb mr-2"></i>Question Hint (Optional)</h4>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Hint Text:</label>
                        <textarea id="editHintText" rows="2" placeholder="E.g., 'Remember to use Pythagoras theorem: a¬≤ + b¬≤ = c¬≤'" class="w-full p-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500"></textarea>
                    </div>
                    
                    <div class="mt-3 flex items-center gap-4">
                        <label class="block text-sm font-medium text-gray-700">Point Penalty:</label>
                        <select id="editHintPenalty" class="p-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-yellow-500">
                            <option value="25">25% (Easy hint)</option>
                            <option value="50" selected>50% (Standard)</option>
                            <option value="75">75% (Big hint)</option>
                        </select>
                        <span class="text-xs text-gray-500">% of points lost if hint is used</span>
                    </div>
                </div>

                <div>
                    <label class="block font-semibold mb-2">Edit Notes (why you're making this change):</label>
                    <textarea id="editNotes" rows="2" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="E.g., Corrected answer based on student feedback"></textarea>
                </div>

                <div class="flex gap-4">
                    <button type="submit" class="flex-1 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 font-semibold">
                        <i class="fas fa-save mr-2"></i>Save Changes
                    </button>
                    <button type="button" onclick="hideEditModal()" class="flex-1 bg-gray-300 text-gray-800 py-3 rounded-lg hover:bg-gray-400 font-semibold">
                        Cancel
                    </button>
                </div>
                
                <!-- Delete Question Section -->
                <div class="mt-4 pt-4 border-t border-red-200">
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-red-600">
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            <strong>Danger Zone:</strong> This action cannot be undone
                        </div>
                        <button type="button" onclick="deleteQuestion()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 font-semibold">
                            <i class="fas fa-trash mr-2"></i>Delete Question
                        </button>
                    </div>
                </div>
            </form>

            <!-- Edit History -->
            <div id="editHistory" class="mt-6"></div>
        </div>
    </div>
    </div>

    <!-- Adaptive Question Edit Modal -->
    <div id="adaptiveEditQuestionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
        <div class="min-h-screen px-4 py-8 flex items-start justify-center">
            <div class="bg-white rounded-lg p-8 max-w-4xl w-full mx-4 my-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-bolt text-purple-600 mr-2"></i>Edit Adaptive Question
                    </h2>
                    <button onclick="hideAdaptiveEditModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                
                <!-- Flags for this question -->
                <div id="adaptiveEditQuestionFlags" class="mb-4"></div>
                
                <!-- Question Info -->
                <div class="bg-purple-50 rounded-lg p-4 mb-4">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><strong>Topic:</strong> <span id="adaptiveEditTopic"></span></div>
                        <div><strong>Level:</strong> <span id="adaptiveEditLevel"></span></div>
                    </div>
                </div>
                
                <!-- SVG Preview -->
                <div id="adaptiveEditSvgPreview" class="bg-gray-50 p-4 rounded-lg mb-4 text-center" style="display: none;"></div>
                
                <!-- Edit Form -->
                <form id="adaptiveEditQuestionForm" onsubmit="event.preventDefault(); saveAdaptiveQuestion();" class="space-y-4">
                    <input type="hidden" id="adaptiveEditQuestionId">
                    
                    <div>
                        <label class="block font-semibold mb-2">Question Text:</label>
                        <textarea id="adaptiveEditQuestionText" rows="3" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block font-semibold mb-2">Option A:</label>
                            <input type="text" id="adaptiveEditOptionA" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block font-semibold mb-2">Option B:</label>
                            <input type="text" id="adaptiveEditOptionB" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block font-semibold mb-2">Option C:</label>
                            <input type="text" id="adaptiveEditOptionC" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block font-semibold mb-2">Option D:</label>
                            <input type="text" id="adaptiveEditOptionD" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block font-semibold mb-2">Correct Answer:</label>
                        <select id="adaptiveEditCorrectAnswer" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                            <option value="D">D</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block font-semibold mb-2">Admin Notes:</label>
                        <textarea id="adaptiveEditNotes" rows="2" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                  placeholder="Notes about this edit..."></textarea>
                    </div>
                    
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 font-semibold">
                            <i class="fas fa-save mr-2"></i>Save Changes
                        </button>
                        <button type="button" onclick="hideAdaptiveEditModal()" class="flex-1 bg-gray-300 text-gray-800 py-3 rounded-lg hover:bg-gray-400 font-semibold">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

        <!-- User Analytics Tab (Main) -->
        <div id="userAnalyticsContent" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-2">üìä User Analytics</h2>
            <p class="text-gray-600 text-sm mb-6">Monitor user activity and manage inactive accounts</p>

            <!-- Statistics Cards -->
            <div class="grid md:grid-cols-4 gap-4 mb-6">
                <div class="bg-blue-500 text-white rounded-lg p-6 shadow-lg text-center">
                    <i class="fas fa-users text-3xl mb-2"></i>
                    <div class="text-3xl font-bold" id="analytics-total-registered">0</div>
                    <div class="text-sm opacity-90">Registered Users</div>
                </div>
                <div class="bg-green-500 text-white rounded-lg p-6 shadow-lg text-center">
                    <i class="fas fa-ticket-alt text-3xl mb-2"></i>
                    <div class="text-3xl font-bold" id="analytics-total-repeat-guests">0</div>
                    <div class="text-sm opacity-90">Repeat Guests</div>
                </div>
                <div class="bg-yellow-500 text-white rounded-lg p-6 shadow-lg text-center">
                    <i class="fas fa-clock text-3xl mb-2"></i>
                    <div class="text-3xl font-bold" id="analytics-inactive-guests">0</div>
                    <div class="text-sm opacity-90">Inactive (60+ days)</div>
                </div>
                <div class="bg-cyan-500 text-white rounded-lg p-6 shadow-lg text-center">
                    <i class="fas fa-user-clock text-3xl mb-2"></i>
                    <div class="text-3xl font-bold" id="analytics-total-casual">0</div>
                    <div class="text-sm opacity-90">Casual Today</div>
                </div>
            </div>

            <!-- Cleanup Warning Banner -->
            <div id="analytics-cleanup-alert" class="bg-yellow-100 border-l-4 border-yellow-500 p-4 mb-6 hidden">
                <div class="flex justify-between items-center">
                    <div>
                        <strong class="text-yellow-800"><i class="fas fa-exclamation-triangle mr-2"></i>Cleanup Available:</strong>
                        <span id="analytics-cleanup-status" class="text-yellow-700"></span>
                    </div>
                    <button onclick="runAnalyticsCleanup()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded">
                        Run Cleanup Now
                    </button>
                </div>
            </div>

            <!-- User List Tabs -->
            <div class="bg-white rounded-lg shadow-md">
                <div class="flex border-b">
                    <button onclick="showAnalyticsSubTab('registered')" id="analyticsRegisteredTab" class="analytics-sub-tab px-6 py-3 font-semibold border-b-2 border-blue-600 text-blue-600">
                        Registered Users
                    </button>
                    <button onclick="showAnalyticsSubTab('guests')" id="analyticsGuestsTab" class="analytics-sub-tab px-6 py-3 font-semibold text-gray-600 hover:text-gray-800">
                        Repeat Guests
                    </button>
                    <button onclick="showAnalyticsSubTab('inactive')" id="analyticsInactiveTab" class="analytics-sub-tab px-6 py-3 font-semibold text-gray-600 hover:text-gray-800">
                        Inactive
                    </button>
                </div>

                <!-- Registered Users List -->
                <div id="analyticsRegisteredContent" class="analytics-sub-content p-6">
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-sm font-semibold">User</th>
                                    <th class="px-4 py-2 text-left text-sm font-semibold">Email</th>
                                    <th class="px-4 py-2 text-left text-sm font-semibold">Points</th>
                                    <th class="px-4 py-2 text-left text-sm font-semibold">Last Active</th>
                                    <th class="px-4 py-2 text-left text-sm font-semibold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="analytics-registered-users-table" class="divide-y">
                                <tr><td colspan="5" class="text-center py-4 text-gray-500">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Repeat Guests List -->
                <div id="analyticsGuestsContent" class="analytics-sub-content p-6 hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-sm font-semibold">Code</th>
                                    <th class="px-4 py-2 text-left text-sm font-semibold">Nickname</th>
                                    <th class="px-4 py-2 text-left text-sm font-semibold">Points</th>
                                    <th class="px-4 py-2 text-left text-sm font-semibold">Last Active</th>
                                    <th class="px-4 py-2 text-left text-sm font-semibold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="analytics-repeat-guests-table" class="divide-y">
                                <tr><td colspan="5" class="text-center py-4 text-gray-500">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Inactive Users List -->
                <div id="analyticsInactiveContent" class="analytics-sub-content p-6 hidden">
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-3 mb-4">
                        <p class="text-sm text-blue-700">Guest codes inactive 60+ days can be recycled. Registered users are never deleted.</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-sm font-semibold">Type</th>
                                    <th class="px-4 py-2 text-left text-sm font-semibold">Identifier</th>
                                    <th class="px-4 py-2 text-left text-sm font-semibold">Days Inactive</th>
                                    <th class="px-4 py-2 text-left text-sm font-semibold">Points</th>
                                    <th class="px-4 py-2 text-left text-sm font-semibold">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="analytics-inactive-users-table" class="divide-y">
                                <tr><td colspan="5" class="text-center py-4 text-gray-500">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Raffles Management Tab -->
        <div id="rafflesContent" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-2"><i class="fas fa-ticket-alt text-pink-600 mr-2"></i>Raffle Management</h2>
            <p class="text-gray-600 mb-6">Create and manage raffles. Students can spend points to enter raffles for prizes.</p>

            <!-- Stats Overview -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-gradient-to-r from-pink-500 to-pink-600 text-white rounded-lg p-4">
                    <div class="text-3xl font-bold" id="raffle-stat-active">0</div>
                    <div class="text-pink-100">Active Raffles</div>
                </div>
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg p-4">
                    <div class="text-3xl font-bold" id="raffle-stat-entries">0</div>
                    <div class="text-blue-100">Total Entries</div>
                </div>
                <div class="bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg p-4">
                    <div class="text-3xl font-bold" id="raffle-stat-draws">0</div>
                    <div class="text-green-100">Draws Completed</div>
                </div>
                <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg p-4">
                    <div class="text-3xl font-bold" id="raffle-stat-points">0</div>
                    <div class="text-purple-100">Points Spent</div>
                </div>
            </div>

            <!-- Auto-Draw Controls -->
            <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-lg p-6 mb-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="text-lg font-bold"><i class="fas fa-magic mr-2"></i>Automatic Draws</h3>
                        <p class="opacity-80 text-sm">Raffles with auto-draw enabled will be drawn automatically at their scheduled times.</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="runAutoDraw()" class="bg-white text-indigo-600 px-4 py-2 rounded-lg font-semibold hover:bg-indigo-50 transition">
                            <i class="fas fa-play mr-2"></i>Run Auto-Draw Now
                        </button>
                    </div>
                </div>
                <div id="auto-draw-result" class="mt-4 hidden">
                    <div class="bg-white bg-opacity-20 rounded-lg p-3 text-sm">
                        <div id="auto-draw-result-content"></div>
                    </div>
                </div>
            </div>

            <!-- Create Raffle Button -->
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-semibold">All Raffles</h3>
                <button onclick="openCreateRaffleModal()" class="bg-pink-600 text-white px-6 py-2 rounded-lg hover:bg-pink-700 transition">
                    <i class="fas fa-plus mr-2"></i>Create New Raffle
                </button>
            </div>

            <!-- Raffles List -->
            <div id="raffles-list" class="space-y-4">
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-spinner fa-spin text-4xl mb-3"></i>
                    <p>Loading raffles...</p>
                </div>
            </div>

            <!-- Recent Winners Section -->
            <div class="mt-8">
                <h3 class="text-lg font-semibold mb-4"><i class="fas fa-trophy text-yellow-500 mr-2"></i>Recent Winners</h3>
                <div id="raffle-winners-list" class="bg-white rounded-lg shadow-md overflow-hidden">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Date</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Raffle</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Winner</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Prize</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Entries</th>
                            </tr>
                        </thead>
                        <tbody id="raffle-winners-tbody">
                            <tr><td colspan="5" class="text-center py-4 text-gray-500">Loading winners...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Create/Edit Raffle Modal -->
        <div id="raffleModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
            <div class="min-h-screen px-4 py-8 flex items-start justify-center">
                <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4 my-8">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold" id="raffleModalTitle">Create New Raffle</h3>
                        <button onclick="closeRaffleModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>

                    <form id="raffleForm" onsubmit="saveRaffle(event)">
                        <input type="hidden" id="raffleId" value="">

                        <!-- Basic Info -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block font-semibold mb-2">Raffle Name *</label>
                                <input type="text" id="raffleName" required class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-pink-500" placeholder="e.g., Weekly Lucky Draw">
                            </div>
                            <div>
                                <label class="block font-semibold mb-2">Emoji</label>
                                <input type="text" id="raffleEmoji" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-pink-500" placeholder="üéüÔ∏è" value="üéüÔ∏è">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block font-semibold mb-2">Description</label>
                            <textarea id="raffleDescription" rows="2" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-pink-500" placeholder="Optional description for students"></textarea>
                        </div>

                        <div class="mb-4">
                            <label class="block font-semibold mb-2">Prize Description *</label>
                            <textarea id="rafflePrize" required rows="2" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-pink-500" placeholder="What the winner will receive"></textarea>
                        </div>

                        <!-- Entry Settings -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block font-semibold mb-2">Entry Cost (Points) *</label>
                                <input type="number" id="raffleEntryCost" required min="1" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-pink-500" value="100">
                            </div>
                            <div>
                                <label class="block font-semibold mb-2">Max Entries Per Student</label>
                                <input type="number" id="raffleMaxEntries" min="1" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-pink-500" value="10" placeholder="Leave empty for unlimited">
                            </div>
                        </div>

                        <!-- Draw Schedule -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block font-semibold mb-2">Draw Frequency</label>
                                <select id="raffleFrequency" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-pink-500">
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="manual">Manual Only</option>
                                </select>
                            </div>
                            <div>
                                <label class="block font-semibold mb-2">Draw Day</label>
                                <select id="raffleDrawDay" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-pink-500">
                                    <option value="0">Sunday</option>
                                    <option value="1">Monday</option>
                                    <option value="2">Tuesday</option>
                                    <option value="3">Wednesday</option>
                                    <option value="4">Thursday</option>
                                    <option value="5" selected>Friday</option>
                                    <option value="6">Saturday</option>
                                </select>
                            </div>
                            <div>
                                <label class="block font-semibold mb-2">Draw Time</label>
                                <input type="time" id="raffleDrawTime" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-pink-500" value="15:00">
                            </div>
                        </div>

                        <!-- Options -->
                        <div class="flex flex-wrap gap-4 mb-6">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="raffleActive" checked class="w-5 h-5 rounded text-pink-600">
                                <span>Active (visible to students)</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="raffleAutoDraw" class="w-5 h-5 rounded text-pink-600">
                                <span>Enable Auto-Draw</span>
                            </label>
                        </div>

                        <!-- Actions -->
                        <div class="flex justify-end gap-3">
                            <button type="button" onclick="closeRaffleModal()" class="px-6 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
                            <button type="submit" class="px-6 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700">
                                <i class="fas fa-save mr-2"></i>Save Raffle
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Draw Confirmation Modal -->
        <div id="drawConfirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
            <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
                <div class="text-center">
                    <div class="text-6xl mb-4">üé≤</div>
                    <h3 class="text-xl font-bold mb-2">Draw Winner?</h3>
                    <p class="text-gray-600 mb-4" id="drawConfirmText">This will randomly select a winner from all entries.</p>
                    <p class="text-lg font-semibold text-pink-600 mb-6" id="drawConfirmEntries">0 entries in this raffle</p>
                    <div class="flex justify-center gap-3">
                        <button onclick="closeDrawConfirmModal()" class="px-6 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
                        <button onclick="confirmDraw()" class="px-6 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700">
                            <i class="fas fa-random mr-2"></i>Draw Winner
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Winner Announcement Modal -->
        <div id="winnerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
            <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
                <div class="text-center">
                    <div class="text-6xl mb-4">üéâ</div>
                    <h3 class="text-2xl font-bold text-green-600 mb-2">We Have a Winner!</h3>
                    <div class="bg-green-50 border-2 border-green-500 rounded-lg p-4 mb-4">
                        <p class="text-lg font-bold" id="winnerName">-</p>
                        <p class="text-gray-600" id="winnerDetails">-</p>
                    </div>
                    <p class="text-gray-600 mb-4" id="winnerPrize">Prize: -</p>
                    <button onclick="closeWinnerModal()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        <i class="fas fa-check mr-2"></i>Got It!
                    </button>
                </div>
            </div>
        </div>

        <!-- Raffle Entries Modal -->
        <div id="entriesModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
            <div class="min-h-screen px-4 py-8 flex items-start justify-center">
                <div class="bg-white rounded-lg p-8 max-w-3xl w-full mx-4 my-8">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold" id="entriesModalTitle">Raffle Entries</h3>
                        <button onclick="closeEntriesModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    <div id="entriesModalContent">
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-spinner fa-spin text-4xl mb-3"></i>
                            <p>Loading entries...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Puzzle of the Week Management Tab -->
        <div id="puzzleContent" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-2"><i class="fas fa-puzzle-piece text-purple-600 mr-2"></i>Puzzle of the Week</h2>
            <p class="text-gray-600 mb-6">Create and manage weekly puzzles for students. Puzzles appear as splash screens and answers can be revealed after completing quizzes.</p>

            <!-- Current Week Info -->
            <div class="bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-lg p-6 mb-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="text-xl font-bold">Current Week: <span id="puzzle-current-week">--</span>, <span id="puzzle-current-year">----</span></h3>
                        <p id="puzzle-active-status" class="mt-1">Loading...</p>
                    </div>
                    <button onclick="openPuzzleModal()" class="bg-white text-purple-600 px-6 py-3 rounded-lg font-semibold hover:bg-purple-50 transition">
                        <i class="fas fa-plus mr-2"></i>Create New Puzzle
                    </button>
                </div>
            </div>

            <!-- Active Puzzle Display -->
            <div id="active-puzzle-section" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-lg font-bold text-green-600"><i class="fas fa-check-circle mr-2"></i>Active Puzzle This Week</h3>
                    <div class="flex gap-2">
                        <button onclick="viewPuzzleStats(activePuzzleId)" class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-sm hover:bg-blue-200">
                            <i class="fas fa-chart-bar mr-1"></i>Stats
                        </button>
                        <button onclick="editPuzzle(activePuzzleId)" class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded text-sm hover:bg-yellow-200">
                            <i class="fas fa-edit mr-1"></i>Edit
                        </button>
                        <button onclick="deactivatePuzzle(activePuzzleId)" class="bg-red-100 text-red-700 px-3 py-1 rounded text-sm hover:bg-red-200">
                            <i class="fas fa-stop mr-1"></i>Deactivate
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Puzzle Preview -->
                    <div>
                        <h4 class="font-semibold mb-2">Puzzle</h4>
                        <div id="active-puzzle-preview" class="border rounded-lg p-4 bg-gray-50 min-h-48">
                            <!-- Puzzle content will be inserted here -->
                        </div>
                    </div>
                    <!-- Answer Preview -->
                    <div>
                        <h4 class="font-semibold mb-2">Answer</h4>
                        <div id="active-answer-preview" class="border rounded-lg p-4 bg-gray-50 min-h-48">
                            <!-- Answer content will be inserted here -->
                        </div>
                    </div>
                </div>
                <!-- Stats Row -->
                <div class="grid grid-cols-4 gap-4 mt-4">
                    <div class="bg-blue-50 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold text-blue-600" id="active-puzzle-views">0</div>
                        <div class="text-sm text-gray-600">Views</div>
                    </div>
                    <div class="bg-green-50 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold text-green-600" id="active-puzzle-reveals">0</div>
                        <div class="text-sm text-gray-600">Answer Reveals</div>
                    </div>
                    <div class="bg-yellow-50 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold text-yellow-600" id="active-puzzle-hints">0</div>
                        <div class="text-sm text-gray-600">Hints Viewed</div>
                    </div>
                    <div class="bg-purple-50 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold text-purple-600" id="active-puzzle-users">0</div>
                        <div class="text-sm text-gray-600">Unique Users</div>
                    </div>
                </div>
            </div>

            <!-- No Active Puzzle Alert -->
            <div id="no-active-puzzle-alert" class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mb-6 hidden">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-yellow-500 text-2xl mr-4"></i>
                    <div>
                        <h4 class="font-bold text-yellow-700">No Active Puzzle This Week</h4>
                        <p class="text-yellow-600">Students won't see a puzzle splash screen. Create or activate a puzzle for the current week.</p>
                    </div>
                </div>
            </div>

            <!-- Puzzle Library -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-bold mb-4"><i class="fas fa-archive mr-2 text-gray-600"></i>Puzzle Library</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Week</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Title</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Type</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Status</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Stats</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="puzzle-library-table" class="divide-y">
                            <tr><td colspan="6" class="text-center py-8 text-gray-500">Loading puzzles...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Puzzle Create/Edit Modal -->
        <div id="puzzle-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto m-4">
                <div class="p-6 border-b flex justify-between items-center bg-purple-600 text-white rounded-t-lg">
                    <h3 class="text-xl font-bold" id="puzzle-modal-title">Create New Puzzle</h3>
                    <button onclick="closePuzzleModal()" class="text-white hover:text-purple-200">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <form id="puzzle-form" class="p-6">
                    <input type="hidden" id="puzzle-id" value="">
                    
                    <!-- Basic Info -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Title *</label>
                            <input type="text" id="puzzle-title" required class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="e.g., Number Sequence Challenge">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Type</label>
                            <select id="puzzle-type" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500" onchange="togglePuzzleType()">
                                <option value="image">Image</option>
                                <option value="text">Text</option>
                            </select>
                        </div>
                    </div>

                    <!-- Week Selection -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Week Number *</label>
                            <input type="number" id="puzzle-week" min="1" max="53" required class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Year *</label>
                            <input type="number" id="puzzle-year" min="2024" max="2030" required class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500">
                        </div>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Description</label>
                        <textarea id="puzzle-description" rows="2" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500" placeholder="Brief description of the puzzle..."></textarea>
                    </div>

                    <!-- Puzzle Content Section -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <!-- Puzzle -->
                        <div class="border rounded-lg p-4 bg-gray-50">
                            <h4 class="font-semibold mb-3 text-purple-600"><i class="fas fa-puzzle-piece mr-2"></i>Puzzle Content</h4>
                            
                            <!-- Image Upload (shown when type=image) -->
                            <div id="puzzle-image-section">
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Puzzle Image (800√ó600)</label>
                                <div class="border-2 border-dashed rounded-lg p-4 text-center mb-2" id="puzzle-image-dropzone">
                                    <input type="file" id="puzzle-image-input" accept="image/*" class="hidden" onchange="handlePuzzleImageUpload(this, 'puzzle')">
                                    <div id="puzzle-image-preview" class="hidden mb-2">
                                        <img src="" alt="Puzzle preview" class="max-h-48 mx-auto rounded">
                                    </div>
                                    <button type="button" onclick="document.getElementById('puzzle-image-input').click()" class="bg-purple-100 text-purple-700 px-4 py-2 rounded hover:bg-purple-200">
                                        <i class="fas fa-upload mr-2"></i>Upload Image
                                    </button>
                                    <p class="text-sm text-gray-500 mt-2">PNG, JPG, GIF up to 5MB</p>
                                </div>
                                <input type="hidden" id="puzzle-image-path">
                            </div>
                            
                            <!-- Text Input (shown when type=text) -->
                            <div id="puzzle-text-section" class="hidden">
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Puzzle Text</label>
                                <textarea id="puzzle-text" rows="6" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 font-mono" placeholder="Enter the puzzle text...&#10;&#10;What comes next?&#10;2, 4, 8, 16, ?"></textarea>
                            </div>
                        </div>

                        <!-- Answer -->
                        <div class="border rounded-lg p-4 bg-gray-50">
                            <h4 class="font-semibold mb-3 text-green-600"><i class="fas fa-check-circle mr-2"></i>Answer Content</h4>
                            
                            <!-- Answer Image Upload -->
                            <div id="answer-image-section">
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Answer Image (800√ó600)</label>
                                <div class="border-2 border-dashed rounded-lg p-4 text-center mb-2">
                                    <input type="file" id="answer-image-input" accept="image/*" class="hidden" onchange="handlePuzzleImageUpload(this, 'answer')">
                                    <div id="answer-image-preview" class="hidden mb-2">
                                        <img src="" alt="Answer preview" class="max-h-48 mx-auto rounded">
                                    </div>
                                    <button type="button" onclick="document.getElementById('answer-image-input').click()" class="bg-green-100 text-green-700 px-4 py-2 rounded hover:bg-green-200">
                                        <i class="fas fa-upload mr-2"></i>Upload Image
                                    </button>
                                    <p class="text-sm text-gray-500 mt-2">PNG, JPG, GIF up to 5MB</p>
                                </div>
                                <input type="hidden" id="answer-image-path">
                            </div>
                            
                            <!-- Answer Text (always visible for explanation) -->
                            <div class="mt-3">
                                <label class="block text-sm font-semibold text-gray-700 mb-1">Answer Text / Explanation</label>
                                <textarea id="answer-text" rows="4" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500" placeholder="The answer is 32!&#10;&#10;Pattern: Each number doubles."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Hint -->
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-gray-700 mb-1"><i class="fas fa-lightbulb text-yellow-500 mr-1"></i>Hint (optional)</label>
                        <textarea id="puzzle-hint" rows="2" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-yellow-500" placeholder="A helpful hint for stuck students..."></textarea>
                    </div>

                    <!-- Activate Option -->
                    <div class="mb-6 flex items-center">
                        <input type="checkbox" id="puzzle-active" class="w-5 h-5 text-purple-600 rounded focus:ring-purple-500 mr-3">
                        <label for="puzzle-active" class="text-sm font-semibold text-gray-700">Activate immediately (make this the live puzzle for its week)</label>
                    </div>

                    <!-- Submit Buttons -->
                    <div class="flex justify-end gap-3 pt-4 border-t">
                        <button type="button" onclick="closePuzzleModal()" class="px-6 py-2 border rounded-lg hover:bg-gray-50">Cancel</button>
                        <button type="submit" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                            <i class="fas fa-save mr-2"></i>Save Puzzle
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Puzzle Stats Modal -->
        <div id="puzzle-stats-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-lg m-4">
                <div class="p-6 border-b flex justify-between items-center">
                    <h3 class="text-xl font-bold"><i class="fas fa-chart-bar mr-2 text-blue-600"></i>Puzzle Statistics</h3>
                    <button onclick="closePuzzleStatsModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="p-6">
                    <h4 id="stats-puzzle-title" class="font-bold text-lg mb-1">--</h4>
                    <p id="stats-puzzle-week" class="text-gray-600 mb-4">Week --, ----</p>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-blue-50 rounded-lg p-4 text-center">
                            <div class="text-3xl font-bold text-blue-600" id="stats-views">0</div>
                            <div class="text-sm text-gray-600">Total Views</div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4 text-center">
                            <div class="text-3xl font-bold text-green-600" id="stats-reveals">0</div>
                            <div class="text-sm text-gray-600">Answer Reveals</div>
                        </div>
                        <div class="bg-yellow-50 rounded-lg p-4 text-center">
                            <div class="text-3xl font-bold text-yellow-600" id="stats-hints">0</div>
                            <div class="text-sm text-gray-600">Hints Viewed</div>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-4 text-center">
                            <div class="text-3xl font-bold text-purple-600" id="stats-users">0</div>
                            <div class="text-sm text-gray-600">Unique Users</div>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Reveal Rate:</span>
                            <span id="stats-reveal-rate" class="font-semibold">--%</span>
                        </div>
                        <div class="flex justify-between text-sm mt-2">
                            <span class="text-gray-600">Hint Usage Rate:</span>
                            <span id="stats-hint-rate" class="font-semibold">--%</span>
                        </div>
                    </div>
                </div>
                <div class="p-4 border-t bg-gray-50 rounded-b-lg">
                    <button onclick="closePuzzleStatsModal()" class="w-full py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Close</button>
                </div>
            </div>
        </div>

        <!-- Site Settings Tab -->
        <div id="siteSettingsContent" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-2"><i class="fas fa-cog text-teal-600 mr-2"></i>Site Settings</h2>
            <p class="text-gray-600 mb-6">Configure global settings for AgentMath.app</p>

            <!-- Login Settings Card -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-bold mb-4"><i class="fas fa-sign-in-alt mr-2 text-blue-600"></i>Login Page Settings</h3>
                
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                    <div>
                        <h4 class="font-semibold text-gray-800">Full Account Login</h4>
                        <p class="text-sm text-gray-600 mt-1">Show the "Full Account" login option on the login page (email/password login for students and teachers)</p>
                        <p class="text-xs text-orange-600 mt-2"><i class="fas fa-exclamation-triangle mr-1"></i>Currently disabled for GDPR compliance</p>
                    </div>
                    <div class="flex items-center">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="fullAccountLoginToggle" class="sr-only peer" onchange="toggleFullAccountLogin()">
                            <div class="w-14 h-7 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-teal-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-teal-600"></div>
                            <span class="ml-3 text-sm font-medium text-gray-700" id="fullAccountLoginStatus">Disabled</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Prize Shop PIN Settings Card -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-bold mb-4"><i class="fas fa-lock mr-2 text-yellow-600"></i>Prize Shop PIN Protection</h3>
                <p class="text-sm text-gray-600 mb-4">Protect Prize Shop access with a PIN when students have high point balances. This helps prevent unauthorized spending.</p>
                
                <div class="p-4 bg-gray-50 rounded-lg">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800">Points Threshold</h4>
                            <p class="text-sm text-gray-600 mt-1">Students with points at or above this amount will need to set a PIN to access the Prize Shop</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <input type="number" id="prizePinThreshold" 
                                   class="w-32 px-4 py-2 border border-gray-300 rounded-lg text-center font-bold text-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500" 
                                   min="500" max="10000" step="100" value="2000">
                            <span class="text-gray-600 font-medium">points</span>
                            <button onclick="savePrizePinThreshold()" 
                                    class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors font-semibold">
                                <i class="fas fa-save mr-1"></i>Save
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <p class="text-sm text-yellow-800">
                            <i class="fas fa-info-circle mr-1"></i>
                            <strong>How it works:</strong> When a quiz brings a student's points above this threshold for the first time, they'll be asked to create a memorable passcode (like a pet's name) with a hint. They'll need this passcode to access the Prize Shop.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Other Settings Card -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-bold mb-4"><i class="fas fa-sliders-h mr-2 text-purple-600"></i>Other Settings</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-4 bg-gray-50 rounded-lg opacity-50">
                        <h4 class="font-semibold text-gray-600">üìß Email Notifications</h4>
                        <p class="text-sm text-gray-500">Coming soon...</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg opacity-50">
                        <h4 class="font-semibold text-gray-600">üéÆ Game Features</h4>
                        <p class="text-sm text-gray-500">Coming soon...</p>
                    </div>
                </div>
            </div>

            <!-- Current Settings Summary -->
            <div class="bg-gradient-to-r from-teal-500 to-cyan-500 text-white rounded-lg p-6">
                <h3 class="text-lg font-bold mb-3"><i class="fas fa-info-circle mr-2"></i>Current Configuration</h3>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div class="bg-white bg-opacity-20 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold" id="settings-full-account">OFF</div>
                        <div class="text-sm opacity-90">Full Account Login</div>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold">ON</div>
                        <div class="text-sm opacity-90">Guest Codes</div>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold">ON</div>
                        <div class="text-sm opacity-90">Quick Try Mode</div>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold" id="settings-avatar">ON</div>
                        <div class="text-sm opacity-90">Avatar System</div>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-lg p-3 text-center">
                        <div class="text-2xl font-bold" id="settings-pin-threshold">2000</div>
                        <div class="text-sm opacity-90">PIN Threshold</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Resources Tab -->
        <div id="resourcesContent" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-2"><i class="fas fa-external-link-alt text-sky-600 mr-2"></i>Additional Resources</h2>
            <p class="text-gray-600 mb-6">Manage external learning resources displayed to students</p>

            <!-- Add New Resource -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-bold mb-4"><i class="fas fa-plus-circle mr-2 text-green-600"></i>Add New Resource</h3>
                
                <form id="addResourceForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Button Text *</label>
                            <input type="text" id="resourceButtonText" required maxlength="100"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500"
                                   placeholder="e.g., Corbett Maths">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Link URL *</label>
                            <input type="url" id="resourceLinkUrl" required
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500"
                                   placeholder="https://example.com">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Category *</label>
                            <select id="resourceCategory" required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500">
                                <option value="">-- Select Category --</option>
                                <option value="online_tutorials">üé¨ Online Tutorials</option>
                                <option value="maths_awareness">üß† Maths Awareness</option>
                                <option value="workbooks">üìö Maths WorkBooks</option>
                                <option value="worksheets">üìù Proficiency Building - Worksheet</option>
                                <option value="exam_papers">üìã Past Exam Paper and Exam Technique</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Display Order</label>
                            <input type="number" id="resourceDisplayOrder" value="1" min="1" max="100"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500"
                                   placeholder="1">
                            <p class="text-xs text-gray-500 mt-1">Lower numbers appear first within category</p>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Popup Description</label>
                        <textarea id="resourcePopupText" rows="2" maxlength="500"
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500"
                                  placeholder="Brief description shown when hovering over the button"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Preview Image</label>
                        <div class="flex items-center gap-4">
                            <input type="file" id="resourceImageFile" accept="image/*"
                                   class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500"
                                   onchange="previewResourceImage(this)">
                            <div id="resourceImagePreview" class="w-20 h-20 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center overflow-hidden">
                                <span class="text-gray-400 text-xs text-center">No image</span>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Recommended: 800x800px screenshot of the website</p>
                    </div>
                    
                    <div class="flex justify-end gap-3 pt-2">
                        <button type="button" onclick="resetResourceForm()" 
                                class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                            <i class="fas fa-times mr-1"></i>Clear
                        </button>
                        <button type="submit" 
                                class="px-6 py-2 bg-sky-600 text-white rounded-lg hover:bg-sky-700 font-semibold">
                            <i class="fas fa-plus mr-1"></i>Add Resource
                        </button>
                    </div>
                </form>
            </div>

            <!-- Existing Resources List -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold"><i class="fas fa-list mr-2 text-sky-600"></i>Existing Resources</h3>
                    <button onclick="loadResourcesList()" class="text-sm text-sky-600 hover:text-sky-800">
                        <i class="fas fa-sync-alt mr-1"></i>Refresh
                    </button>
                </div>
                
                <div id="resourcesList" class="space-y-4">
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Loading resources...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Email Reports Tab -->
        <div id="emailReportsContent" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-2"><i class="fas fa-envelope-open-text text-amber-600 mr-2"></i>Email Reports</h2>
            <p class="text-gray-600 mb-6">Configure automated email reports for stakeholders</p>

            <!-- Report Status Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-5 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-sm opacity-80">Daily Report</div>
                            <div class="text-2xl font-bold" id="dailyReportStatus">Enabled</div>
                            <div class="text-xs opacity-70 mt-1">Sent at 7:00 AM</div>
                        </div>
                        <div class="text-4xl opacity-80">üìä</div>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-5 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-sm opacity-80">Weekly Report</div>
                            <div class="text-2xl font-bold" id="weeklyReportStatus">Enabled</div>
                            <div class="text-xs opacity-70 mt-1">Sent Monday 7:00 AM</div>
                        </div>
                        <div class="text-4xl opacity-80">üìà</div>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-5 text-white">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-sm opacity-80">Monthly Report</div>
                            <div class="text-2xl font-bold" id="monthlyReportStatus">Enabled</div>
                            <div class="text-xs opacity-70 mt-1">Sent 1st of month</div>
                        </div>
                        <div class="text-4xl opacity-80">üìã</div>
                    </div>
                </div>
            </div>

            <!-- Distribution List Management -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold"><i class="fas fa-users text-amber-600 mr-2"></i>Distribution List</h3>
                    <button onclick="showAddRecipientModal()" class="bg-amber-500 text-white px-4 py-2 rounded-lg hover:bg-amber-600">
                        <i class="fas fa-plus mr-2"></i>Add Recipient
                    </button>
                </div>

                <!-- Recipients Table -->
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="px-4 py-3 text-left text-sm font-semibold">Name</th>
                                <th class="px-4 py-3 text-left text-sm font-semibold">Email</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold">Daily</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold">Weekly</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold">Monthly</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold">Status</th>
                                <th class="px-4 py-3 text-center text-sm font-semibold">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="distributionListTable" class="divide-y">
                            <tr>
                                <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                    <i class="fas fa-spinner fa-spin mr-2"></i>Loading recipients...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Send Test Report -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h3 class="text-lg font-bold mb-4"><i class="fas fa-paper-plane text-amber-600 mr-2"></i>Send Test Report</h3>
                <p class="text-gray-600 mb-4">Send a test report to preview how it will look</p>
                
                <div class="flex flex-wrap gap-4">
                    <div class="flex-1 min-w-[200px]">
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Report Type</label>
                        <select id="testReportType" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500">
                            <option value="daily">Daily Pulse Report</option>
                            <option value="weekly">Weekly Digest Report</option>
                            <option value="monthly">Monthly Review Report</option>
                        </select>
                    </div>
                    <div class="flex-1 min-w-[250px]">
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Send To (Email)</label>
                        <input type="email" id="testReportEmail" placeholder="your@email.com"
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500">
                    </div>
                    <div class="flex items-end">
                        <button onclick="sendTestReport()" class="bg-amber-500 text-white px-6 py-2 rounded-lg hover:bg-amber-600 font-semibold">
                            <i class="fas fa-paper-plane mr-2"></i>Send Test
                        </button>
                    </div>
                </div>
            </div>

            <!-- Report History -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold"><i class="fas fa-history text-amber-600 mr-2"></i>Recent Report History</h3>
                    <button onclick="loadReportHistory()" class="text-sm text-amber-600 hover:text-amber-800">
                        <i class="fas fa-sync-alt mr-1"></i>Refresh
                    </button>
                </div>
                
                <div id="reportHistoryList" class="space-y-2">
                    <div class="text-center py-4 text-gray-500">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Loading history...
                    </div>
                </div>
            </div>

            <!-- Report Settings -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-bold mb-4"><i class="fas fa-cog text-amber-600 mr-2"></i>Report Settings</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">School Name</label>
                        <input type="text" id="reportSchoolName" value="Palmerstown Community School"
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Reply-To Email</label>
                        <input type="email" id="reportReplyToEmail" placeholder="admin@school.ie"
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500">
                    </div>
                </div>

                <div class="mt-4 pt-4 border-t">
                    <h4 class="font-semibold text-gray-700 mb-3">Report Toggles</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <label class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                            <input type="checkbox" id="enableDailyReport" checked class="w-5 h-5 text-amber-600 rounded">
                            <span>Enable Daily Reports</span>
                        </label>
                        <label class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                            <input type="checkbox" id="enableWeeklyReport" checked class="w-5 h-5 text-amber-600 rounded">
                            <span>Enable Weekly Reports</span>
                        </label>
                        <label class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                            <input type="checkbox" id="enableMonthlyReport" checked class="w-5 h-5 text-amber-600 rounded">
                            <span>Enable Monthly Reports</span>
                        </label>
                    </div>
                </div>

                <div class="mt-4 flex justify-end">
                    <button onclick="saveReportSettings()" class="bg-amber-500 text-white px-6 py-2 rounded-lg hover:bg-amber-600 font-semibold">
                        <i class="fas fa-save mr-2"></i>Save Settings
                    </button>
                </div>
            </div>
        </div>

        <!-- Add Recipient Modal -->
        <div id="addRecipientModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold"><i class="fas fa-user-plus text-amber-600 mr-2"></i>Add Recipient</h3>
                    <button onclick="hideAddRecipientModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="addRecipientForm" onsubmit="addRecipient(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Recipient Name</label>
                            <input type="text" id="recipientName" required
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500"
                                   placeholder="e.g., Principal O'Brien">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Email Address</label>
                            <input type="email" id="recipientEmail" required
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500"
                                   placeholder="email@school.ie">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Subscribe To:</label>
                            <div class="space-y-2">
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" id="subDaily" checked class="w-4 h-4 text-amber-600 rounded">
                                    <span>Daily Pulse Report</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" id="subWeekly" checked class="w-4 h-4 text-amber-600 rounded">
                                    <span>Weekly Digest Report</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" id="subMonthly" checked class="w-4 h-4 text-amber-600 rounded">
                                    <span>Monthly Review Report</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <button type="submit" class="flex-1 bg-amber-500 text-white py-2 rounded-lg hover:bg-amber-600 font-semibold">
                            <i class="fas fa-plus mr-2"></i>Add Recipient
                        </button>
                        <button type="button" onclick="hideAddRecipientModal()" class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>

    
        <!-- Domain Management Tab -->
        <div id="domainsContent" class="tab-content hidden">
<!-- Add this as a new tab in your admin_dashboard.html -->
<!-- Place this inside the tab content area -->

<div id="domain-management-tab">
    <h2>üìß Email Domain Management</h2>
    <p class="text-muted">Control which email domains teachers can access for student enrollment and management.</p>
    
    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5><i class="fas fa-globe"></i> Total Domains</h5>
                    <h2 id="total-domains-count">0</h2>
                    <small>Unique email domains in system</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <h5><i class="fas fa-clock"></i> Pending Requests</h5>
                    <h2 id="pending-requests-count">0</h2>
                    <small>Teachers requesting access</small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5><i class="fas fa-shield-alt"></i> Restricted Teachers</h5>
                    <h2 id="restricted-teachers-count">0</h2>
                    <small>Teachers with domain limits</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs mb-3" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="domains-overview-tab" data-toggle="tab" href="#domains-overview" role="tab">
                <i class="fas fa-list"></i> Domains Overview
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="teacher-access-tab" data-toggle="tab" href="#teacher-access" role="tab">
                <i class="fas fa-user-shield"></i> Teacher Access
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="access-requests-tab" data-toggle="tab" href="#access-requests" role="tab">
                <i class="fas fa-inbox"></i> Access Requests
                <span id="requests-badge" class="badge badge-warning ml-1">0</span>
            </a>
        </li>
    </ul>

    <div class="tab-content">
        <!-- Domains Overview Tab - ALWAYS VISIBLE BY DEFAULT -->
        <div class="tab-pane active" id="domains-overview" role="tabpanel" style="display: block !important;">
            <div class="card" style="display: block !important;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-globe"></i> All Email Domains</h5>
                    <button class="btn btn-sm btn-primary" onclick="refreshDomains()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
                <div class="card-body" style="display: block !important; min-height: 300px;">
                    <!-- Manual trigger button for testing -->
                    <div style="margin-bottom: 1rem; padding: 0.5rem; background: #fef3c7; border-left: 4px solid #f59e0b; display: flex; justify-content: space-between; align-items: center;">
                        <span>‚ö†Ô∏è Table not showing? Click here to force it:</span>
                        <button onclick="forceShowDomainTable()" class="btn btn-sm btn-warning" style="background: #f59e0b; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                            üîß Force Show Table
                        </button>
                    </div>
                    
                    <div class="table-responsive" style="display: block !important;">
                        <table class="table table-hover" style="display: table !important; width: 100% !important;">
                            <thead>
                                <tr>
                                    <th>Domain</th>
                                    <th>Students</th>
                                    <th>Teachers</th>
                                    <th>Teachers with Access</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="domains-table-body" style="display: table-row-group !important;">
                                <tr style="display: table-row !important;">
                                    <td colspan="5" class="text-center" style="display: table-cell !important; padding: 2rem;">
                                        <div style="font-size: 1rem; color: #6b7280;">
                                            <i class="fas fa-spinner fa-spin"></i> Loading domains...
                                        </div>
                                        <div style="margin-top: 1rem; font-size: 0.875rem; color: #9ca3af;">
                                            If this message persists, click the "Force Show Table" button above.
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Teacher Access Tab -->
        <div class="tab-pane" id="teacher-access" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-user-shield"></i> Manage Teacher Domain Access</h5>
                </div>
                <div class="card-body">
                    <!-- Teacher Selection -->
                    <div class="form-group">
                        <label>Select Teacher:</label>
                        <select class="form-control" id="teacher-select" onchange="loadTeacherDomains()">
                            <option value="">-- Select a teacher --</option>
                        </select>
                    </div>

                    <div id="teacher-domains-container" style="display: none;">
                        <hr>
                        
                        <!-- Teacher Info -->
                        <div class="alert alert-info">
                            <h6 id="teacher-info-name"></h6>
                            <p id="teacher-info-email" class="mb-0 text-muted small"></p>
                        </div>

                        <!-- Access Status -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6>Access Status</h6>
                                        <p id="teacher-access-status" class="mb-0"></p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body">
                                        <h6>Accessible Students</h6>
                                        <p id="teacher-student-count" class="mb-0"></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Assigned Domains -->
                        <div class="card mb-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0"><i class="fas fa-check-circle text-success"></i> Assigned Domains</h6>
                                <button class="btn btn-sm btn-warning" onclick="removeAllRestrictions()">
                                    <i class="fas fa-unlock"></i> Remove All Restrictions
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="assigned-domains-list">
                                    <p class="text-muted">No domains assigned</p>
                                </div>
                            </div>
                        </div>

                        <!-- Add Domain -->
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-plus-circle"></i> Assign New Domain</h6>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label>Select Domain:</label>
                                    <select class="form-control" id="domain-to-assign">
                                        <option value="">-- Select a domain --</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Notes (optional):</label>
                                    <textarea class="form-control" id="assign-notes" rows="2" 
                                              placeholder="Optional notes about this assignment..."></textarea>
                                </div>
                                <button class="btn btn-success" onclick="assignDomain()">
                                    <i class="fas fa-plus"></i> Assign Domain
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Access Requests Tab -->
        <div class="tab-pane" id="access-requests" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-inbox"></i> Domain Access Requests</h5>
                    <div>
                        <select class="form-control form-control-sm" id="request-status-filter" 
                                onchange="loadAccessRequests()">
                            <option value="pending">Pending Only</option>
                            <option value="all">All Requests</option>
                            <option value="approved">Approved</option>
                            <option value="denied">Denied</option>
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <div id="access-requests-container">
                        <div class="text-center">
                            <i class="fas fa-spinner fa-spin"></i> Loading requests...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Topic Management Tab -->
<div id="topicManagementContent" class="tab-content hidden">
    <h2 class="text-2xl font-bold mb-6">Topic Management</h2>
    
    <!-- Strands Section -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold"><i class="fas fa-layer-group mr-2 text-purple-600"></i>Curriculum Strands</h3>
            <button onclick="openStrandModal()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                <i class="fas fa-plus mr-2"></i>Add Strand
            </button>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left font-semibold">Order</th>
                        <th class="px-4 py-3 text-left font-semibold">Icon</th>
                        <th class="px-4 py-3 text-left font-semibold">Name</th>
                        <th class="px-4 py-3 text-left font-semibold">Color</th>
                        <th class="px-4 py-3 text-left font-semibold">Description</th>
                        <th class="px-4 py-3 text-left font-semibold">Actions</th>
                    </tr>
                </thead>
                <tbody id="strandsTableBody">
                    <tr><td colspan="6" class="text-center py-4">Loading strands...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Topics Section -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold"><i class="fas fa-book mr-2 text-blue-600"></i>Topics</h3>
            <button onclick="openTopicModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                <i class="fas fa-plus mr-2"></i>Add Topic
            </button>
        </div>
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-1">Filter by Strand:</label>
            <select id="topicStrandFilter" onchange="loadTopicsAdmin()" class="border rounded-lg px-3 py-2">
                <option value="">All Strands</option>
            </select>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left font-semibold">Order</th>
                        <th class="px-4 py-3 text-left font-semibold">Icon</th>
                        <th class="px-4 py-3 text-left font-semibold">Topic ID</th>
                        <th class="px-4 py-3 text-left font-semibold">Display Name</th>
                        <th class="px-4 py-3 text-left font-semibold">Strand</th>
                        <th class="px-4 py-3 text-left font-semibold">Questions</th>
                        <th class="px-4 py-3 text-left font-semibold">Tutorials</th>
                        <th class="px-4 py-3 text-left font-semibold">Visible</th>
                        <th class="px-4 py-3 text-left font-semibold">Actions</th>
                    </tr>
                </thead>
                <tbody id="topicsTableBody">
                    <tr><td colspan="9" class="text-center py-4">Loading topics...</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- Note: User Analytics moved to main tab navigation -->
    </div>
    
    <!-- Question Generator Section -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold"><i class="fas fa-magic mr-2 text-green-600"></i>AI Question Generator</h3>
            <span id="apiKeyStatus" class="text-sm px-3 py-1 rounded-full bg-gray-100">Checking API key...</span>
        </div>
        
        <div id="generatorContent">
            <!-- Topic Selection -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Topic to Generate Questions For:</label>
                <select id="generatorTopicSelect" onchange="onGeneratorTopicChange()" class="w-full md:w-1/2 border rounded-lg px-3 py-2">
                    <option value="">-- Select a Topic --</option>
                </select>
                <div id="currentQuestionCounts" class="mt-2 text-sm text-gray-600 hidden">
                    Current questions: <span id="countBeginner">0</span> beginner, 
                    <span id="countIntermediate">0</span> intermediate, 
                    <span id="countAdvanced">0</span> advanced
                </div>
            </div>
            
            <!-- Difficulty Level Descriptions -->
            <div class="grid md:grid-cols-3 gap-4 mb-6">
                <!-- Beginner -->
                <div class="border rounded-lg p-4 bg-green-50">
                    <h4 class="font-semibold text-green-700 mb-2"><i class="fas fa-seedling mr-1"></i> Beginner Level</h4>
                    <p class="text-xs text-gray-600 mb-2">Describe what students should learn at this level:</p>
                    <textarea id="beginnerDescription" rows="4" class="w-full border rounded-lg px-3 py-2 text-sm" 
                        placeholder="Example: Simple one-step problems. Only addition and subtraction. Positive whole numbers only. Clear, straightforward questions."></textarea>
                    <div class="mt-2">
                        <label class="text-xs text-gray-600">Questions to generate:</label>
                        <input type="number" id="beginnerCount" value="40" min="1" max="100" class="w-20 border rounded px-2 py-1 text-sm ml-2">
                    </div>
                </div>
                
                <!-- Intermediate -->
                <div class="border rounded-lg p-4 bg-yellow-50">
                    <h4 class="font-semibold text-yellow-700 mb-2"><i class="fas fa-chart-line mr-1"></i> Intermediate Level</h4>
                    <p class="text-xs text-gray-600 mb-2">Describe what students should learn at this level:</p>
                    <textarea id="intermediateDescription" rows="4" class="w-full border rounded-lg px-3 py-2 text-sm" 
                        placeholder="Example: Two-step problems. Include multiplication and division. May include negative numbers. Some word problems."></textarea>
                    <div class="mt-2">
                        <label class="text-xs text-gray-600">Questions to generate:</label>
                        <input type="number" id="intermediateCount" value="40" min="1" max="100" class="w-20 border rounded px-2 py-1 text-sm ml-2">
                    </div>
                </div>
                
                <!-- Advanced -->
                <div class="border rounded-lg p-4 bg-red-50">
                    <h4 class="font-semibold text-red-700 mb-2"><i class="fas fa-rocket mr-1"></i> Advanced Level</h4>
                    <p class="text-xs text-gray-600 mb-2">Describe what students should learn at this level:</p>
                    <textarea id="advancedDescription" rows="4" class="w-full border rounded-lg px-3 py-2 text-sm" 
                        placeholder="Example: Multi-step complex problems. Fractions and decimals. Real-world application questions. Requires deeper understanding."></textarea>
                    <div class="mt-2">
                        <label class="text-xs text-gray-600">Questions to generate:</label>
                        <input type="number" id="advancedCount" value="40" min="1" max="100" class="w-20 border rounded px-2 py-1 text-sm ml-2">
                    </div>
                </div>
            </div>
            
            <!-- Generate Button -->
            <div class="flex items-center justify-between">
                <div class="text-sm text-gray-600">
                    <i class="fas fa-info-circle mr-1"></i>
                    This will generate questions using AI. It may take 1-2 minutes for all 120 questions.
                </div>
                <button onclick="generateQuestions()" id="generateBtn" 
                        class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <i class="fas fa-magic mr-2"></i>Generate Questions
                </button>
            </div>
            
            <!-- Progress/Results -->
            <div id="generatorProgress" class="mt-4 hidden">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fas fa-spinner fa-spin text-blue-600 mr-3"></i>
                        <span id="progressText">Generating questions... This may take 1-2 minutes.</span>
                    </div>
                    <div class="mt-2 bg-blue-200 rounded-full h-2">
                        <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <div id="generatorResult" class="mt-4 hidden"></div>
        </div>
    </div>

    <!-- Chart Question Generator Section -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold"><i class="fas fa-chart-bar mr-2 text-blue-600"></i>Chart Question Generator</h3>
            <span id="chartApiStatus" class="text-sm px-3 py-1 rounded-full bg-blue-100 text-blue-800">
                <i class="fas fa-image mr-1"></i> Auto-generates chart images
            </span>
        </div>
        
        <p class="text-gray-600 mb-4">
            Generate descriptive statistics questions with automatically created chart images. 
            Students will interpret bar charts, pie charts, line graphs, and histograms.
        </p>
        
        <div id="chartGeneratorContent">
            <!-- Chart Type Selection -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">Select Chart Types to Generate:</label>
                <div class="flex flex-wrap gap-3">
                    <label class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" id="chartTypeBar" checked class="w-4 h-4 text-blue-600">
                        <span><i class="fas fa-chart-bar text-blue-500"></i> Bar Charts</span>
                    </label>
                    <label class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" id="chartTypePie" checked class="w-4 h-4 text-blue-600">
                        <span><i class="fas fa-chart-pie text-green-500"></i> Pie Charts</span>
                    </label>
                    <label class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" id="chartTypeLine" checked class="w-4 h-4 text-blue-600">
                        <span><i class="fas fa-chart-line text-purple-500"></i> Line Graphs</span>
                    </label>
                    <label class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" id="chartTypeHistogram" checked class="w-4 h-4 text-blue-600">
                        <span><i class="fas fa-signal text-orange-500"></i> Histograms</span>
                    </label>
                </div>
            </div>
            
            <!-- Difficulty Selection -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">Select Difficulty Levels:</label>
                <div class="flex flex-wrap gap-3">
                    <label class="flex items-center gap-2 bg-green-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-green-100">
                        <input type="checkbox" id="chartDiffBeginner" checked class="w-4 h-4 text-green-600">
                        <span class="text-green-700"><i class="fas fa-seedling mr-1"></i> Beginner</span>
                    </label>
                    <label class="flex items-center gap-2 bg-yellow-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-yellow-100">
                        <input type="checkbox" id="chartDiffIntermediate" checked class="w-4 h-4 text-yellow-600">
                        <span class="text-yellow-700"><i class="fas fa-chart-line mr-1"></i> Intermediate</span>
                    </label>
                    <label class="flex items-center gap-2 bg-red-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-red-100">
                        <input type="checkbox" id="chartDiffAdvanced" checked class="w-4 h-4 text-red-600">
                        <span class="text-red-700"><i class="fas fa-rocket mr-1"></i> Advanced</span>
                    </label>
                </div>
            </div>
            
            <!-- Charts per Type -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Charts per type/difficulty:
                </label>
                <div class="flex items-center gap-3">
                    <input type="number" id="chartsPerType" value="3" min="1" max="10" 
                           class="w-20 border rounded-lg px-3 py-2 text-center">
                    <span class="text-sm text-gray-600">
                        (Each chart generates 3-5 questions, so 3 charts √ó 4 types √ó 3 difficulties ‚âà 100+ questions)
                    </span>
                </div>
            </div>
            
            <!-- Current Counts -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                <div class="text-sm font-medium text-gray-700 mb-2">Current Descriptive Statistics Questions:</div>
                <div id="chartQuestionCounts" class="flex gap-4 text-sm">
                    <span class="text-green-600"><i class="fas fa-seedling mr-1"></i> Beginner: <strong id="chartCountBeginner">--</strong></span>
                    <span class="text-yellow-600"><i class="fas fa-chart-line mr-1"></i> Intermediate: <strong id="chartCountIntermediate">--</strong></span>
                    <span class="text-red-600"><i class="fas fa-rocket mr-1"></i> Advanced: <strong id="chartCountAdvanced">--</strong></span>
                </div>
            </div>
            
            <!-- Generate Button -->
            <div class="flex items-center justify-between">
                <div class="text-sm text-gray-600">
                    <i class="fas fa-info-circle mr-1"></i>
                    Questions are saved to the "Descriptive Statistics" topic with auto-generated chart images.
                </div>
                <button onclick="generateChartQuestions()" id="chartGenerateBtn" 
                        class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <i class="fas fa-chart-bar mr-2"></i>Generate Chart Questions
                </button>
            </div>
            
            <!-- Progress/Results -->
            <div id="chartGeneratorProgress" class="mt-4 hidden">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fas fa-spinner fa-spin text-blue-600 mr-3"></i>
                        <span id="chartProgressText">Generating chart questions and images...</span>
                    </div>
                </div>
            </div>
            
            <div id="chartGeneratorResult" class="mt-4 hidden"></div>
        </div>
    </div>

    <!-- Geometry Question Generator Section -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold"><i class="fas fa-shapes mr-2 text-green-600"></i>Geometry Question Generator</h3>
            <span class="text-sm px-3 py-1 rounded-full bg-green-100 text-green-800">
                <i class="fas fa-image mr-1"></i> Auto-generates shape images
            </span>
        </div>
        
        <p class="text-gray-600 mb-4">
            Generate geometry questions with automatically created shape diagrams. 
            Students will calculate areas, perimeters, angles, and apply Pythagoras' theorem.
        </p>
        
        <div id="geometryGeneratorContent">
            <!-- Shape Type Selection -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">Select Shape Types to Generate:</label>
                <div class="flex flex-wrap gap-3">
                    <label class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" id="shapeTypeTriangle" checked class="w-4 h-4 text-green-600">
                        <span><i class="fas fa-play fa-rotate-270 text-blue-500"></i> Triangles</span>
                    </label>
                    <label class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" id="shapeTypeRectangle" checked class="w-4 h-4 text-green-600">
                        <span><i class="fas fa-square text-pink-500"></i> Rectangles & Squares</span>
                    </label>
                    <label class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" id="shapeTypeCircle" checked class="w-4 h-4 text-green-600">
                        <span><i class="fas fa-circle text-yellow-500"></i> Circles</span>
                    </label>
                    <label class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" id="shapeTypeAngle" checked class="w-4 h-4 text-green-600">
                        <span><i class="fas fa-drafting-compass text-purple-500"></i> Angles</span>
                    </label>
                </div>
            </div>
            
            <!-- Difficulty Selection -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">Select Difficulty Levels:</label>
                <div class="flex flex-wrap gap-3">
                    <label class="flex items-center gap-2 bg-green-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-green-100">
                        <input type="checkbox" id="geomDiffBeginner" checked class="w-4 h-4 text-green-600">
                        <span class="text-green-700"><i class="fas fa-seedling mr-1"></i> Beginner</span>
                    </label>
                    <label class="flex items-center gap-2 bg-yellow-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-yellow-100">
                        <input type="checkbox" id="geomDiffIntermediate" checked class="w-4 h-4 text-yellow-600">
                        <span class="text-yellow-700"><i class="fas fa-chart-line mr-1"></i> Intermediate</span>
                    </label>
                    <label class="flex items-center gap-2 bg-red-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-red-100">
                        <input type="checkbox" id="geomDiffAdvanced" checked class="w-4 h-4 text-red-600">
                        <span class="text-red-700"><i class="fas fa-rocket mr-1"></i> Advanced</span>
                    </label>
                </div>
            </div>
            
            <!-- Shapes per Type -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Shapes per type/difficulty:
                </label>
                <div class="flex items-center gap-3">
                    <input type="number" id="shapesPerType" value="3" min="1" max="10" 
                           class="w-20 border rounded-lg px-3 py-2 text-center">
                    <span class="text-sm text-gray-600">
                        (Each shape generates 2-4 questions, so 3 shapes √ó 4 types √ó 3 difficulties ‚âà 80+ questions)
                    </span>
                </div>
            </div>
            
            <!-- Current Counts -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                <div class="text-sm font-medium text-gray-700 mb-2">Current Geometry Questions:</div>
                <div id="geomQuestionCounts" class="flex gap-4 text-sm">
                    <span class="text-green-600"><i class="fas fa-seedling mr-1"></i> Beginner: <strong id="geomCountBeginner">--</strong></span>
                    <span class="text-yellow-600"><i class="fas fa-chart-line mr-1"></i> Intermediate: <strong id="geomCountIntermediate">--</strong></span>
                    <span class="text-red-600"><i class="fas fa-rocket mr-1"></i> Advanced: <strong id="geomCountAdvanced">--</strong></span>
                </div>
            </div>
            
            <!-- Topics covered info -->
            <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                <div class="text-sm font-medium text-blue-700 mb-2"><i class="fas fa-info-circle mr-1"></i> Topics Covered:</div>
                <div class="grid md:grid-cols-2 gap-2 text-sm text-blue-800">
                    <div><strong>Triangles:</strong> Area, perimeter, Pythagoras' theorem, types</div>
                    <div><strong>Rectangles/Squares:</strong> Area, perimeter, diagonals</div>
                    <div><strong>Circles:</strong> Diameter, circumference, area (using œÄ)</div>
                    <div><strong>Angles:</strong> Complementary, supplementary, triangle angles</div>
                </div>
            </div>
            
            <!-- Generate Button -->
            <div class="flex items-center justify-between">
                <div class="text-sm text-gray-600">
                    <i class="fas fa-info-circle mr-1"></i>
                    Questions are saved to the "Geometry" topic with auto-generated shape images.
                </div>
                <button onclick="generateGeometryQuestions()" id="geomGenerateBtn" 
                        class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <i class="fas fa-shapes mr-2"></i>Generate Geometry Questions
                </button>
            </div>
            
            <!-- Progress/Results -->
            <div id="geomGeneratorProgress" class="mt-4 hidden">
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fas fa-spinner fa-spin text-green-600 mr-3"></i>
                        <span id="geomProgressText">Generating geometry questions and shape images...</span>
                    </div>
                </div>
            </div>
            
            <div id="geomGeneratorResult" class="mt-4 hidden"></div>
        </div>
    </div>

    <!-- Patterns Question Generator Section -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold"><i class="fas fa-th mr-2 text-purple-600"></i>Patterns Question Generator</h3>
            <span class="text-sm px-3 py-1 rounded-full bg-purple-100 text-purple-800">
                <i class="fas fa-image mr-1"></i> Visual tile sequences
            </span>
        </div>
        
        <p class="text-gray-600 mb-4">
            Generate visual pattern questions with tile/shape sequences. 
            Students will identify rules, find nth terms, and continue patterns.
        </p>
        
        <div id="patternsGeneratorContent">
            <!-- Pattern Type Selection -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">Select Pattern Types to Generate:</label>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                    <label class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" id="patternTypeDot" checked class="w-4 h-4 text-purple-600">
                        <span><i class="fas fa-circle text-blue-500"></i> Dot Patterns (‚ñ≥, ‚ñ°, ‚ñ≠)</span>
                    </label>
                    <label class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" id="patternTypeLinear" checked class="w-4 h-4 text-purple-600">
                        <span><i class="fas fa-plus text-green-500"></i> Linear (+n each time)</span>
                    </label>
                    <label class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" id="patternTypeStaircase" checked class="w-4 h-4 text-purple-600">
                        <span><i class="fas fa-signal text-orange-500"></i> Staircase Blocks</span>
                    </label>
                    <label class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" id="patternTypeShape" checked class="w-4 h-4 text-purple-600">
                        <span><i class="fas fa-shapes text-red-500"></i> Matchstick Shapes</span>
                    </label>
                    <label class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" id="patternTypeTile" checked class="w-4 h-4 text-purple-600">
                        <span><i class="fas fa-th text-purple-500"></i> Repeating Tiles</span>
                    </label>
                </div>
            </div>
            
            <!-- Difficulty Selection -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">Select Difficulty Levels:</label>
                <div class="flex flex-wrap gap-3">
                    <label class="flex items-center gap-2 bg-green-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-green-100">
                        <input type="checkbox" id="patternDiffBeginner" checked class="w-4 h-4 text-green-600">
                        <span class="text-green-700"><i class="fas fa-seedling mr-1"></i> Beginner</span>
                    </label>
                    <label class="flex items-center gap-2 bg-yellow-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-yellow-100">
                        <input type="checkbox" id="patternDiffIntermediate" checked class="w-4 h-4 text-yellow-600">
                        <span class="text-yellow-700"><i class="fas fa-chart-line mr-1"></i> Intermediate</span>
                    </label>
                    <label class="flex items-center gap-2 bg-red-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-red-100">
                        <input type="checkbox" id="patternDiffAdvanced" checked class="w-4 h-4 text-red-600">
                        <span class="text-red-700"><i class="fas fa-rocket mr-1"></i> Advanced</span>
                    </label>
                </div>
            </div>
            
            <!-- Patterns per Type -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Patterns per type/difficulty:
                </label>
                <div class="flex items-center gap-3">
                    <input type="number" id="patternsPerType" value="2" min="1" max="10" 
                           class="w-20 border rounded-lg px-3 py-2 text-center">
                    <span class="text-sm text-gray-600">
                        (Each pattern generates 1-5 questions, so 2 patterns √ó 6 types √ó 3 difficulties ‚âà 70+ questions)
                    </span>
                </div>
            </div>
            
            <!-- Current Counts -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                <div class="text-sm font-medium text-gray-700 mb-2">Current Patterns Questions:</div>
                <div id="patternQuestionCounts" class="flex gap-4 text-sm">
                    <span class="text-green-600"><i class="fas fa-seedling mr-1"></i> Beginner: <strong id="patternCountBeginner">--</strong></span>
                    <span class="text-yellow-600"><i class="fas fa-chart-line mr-1"></i> Intermediate: <strong id="patternCountIntermediate">--</strong></span>
                    <span class="text-red-600"><i class="fas fa-rocket mr-1"></i> Advanced: <strong id="patternCountAdvanced">--</strong></span>
                </div>
            </div>
            
            <!-- Question types info -->
            <div class="mb-6 p-4 bg-purple-50 rounded-lg">
                <div class="text-sm font-medium text-purple-700 mb-2"><i class="fas fa-info-circle mr-1"></i> Question Types Generated:</div>
                <div class="grid md:grid-cols-2 gap-2 text-sm text-purple-800">
                    <div>‚Ä¢ "How many tiles in Pattern n?"</div>
                    <div>‚Ä¢ "What is the rule for this pattern?"</div>
                    <div>‚Ä¢ "How many more tiles are added each time?"</div>
                    <div>‚Ä¢ "Find the nth term formula" (Advanced)</div>
                </div>
            </div>
            
            <!-- Generate Button -->
            <div class="flex items-center justify-between">
                <div class="text-sm text-gray-600">
                    <i class="fas fa-info-circle mr-1"></i>
                    Questions are saved to the "Patterns" topic with visual tile sequence images.
                </div>
                <button onclick="generatePatternsQuestions()" id="patternsGenerateBtn" 
                        class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <i class="fas fa-th mr-2"></i>Generate Patterns Questions
                </button>
            </div>
            
            <!-- Progress/Results -->
            <div id="patternsGeneratorProgress" class="mt-4 hidden">
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fas fa-spinner fa-spin text-purple-600 mr-3"></i>
                        <span id="patternsProgressText">Generating pattern questions and images...</span>
                    </div>
                </div>
            </div>
            
            <div id="patternsGeneratorResult" class="mt-4 hidden"></div>
        </div>
    </div>
</div>

<!-- Coordinate Geometry Question Generator -->
<div class="bg-white rounded-lg shadow-md p-6 mt-6">
    <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-teal-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-crosshairs text-teal-600 text-lg"></i>
            </div>
            <div>
                <h3 class="text-lg font-semibold">Coordinate Geometry Question Generator</h3>
                <p class="text-sm text-gray-500">Auto-generate Cartesian plane questions with graph images</p>
            </div>
        </div>
        <span class="px-3 py-1 bg-teal-100 text-teal-700 rounded-full text-sm font-medium">
            <i class="fas fa-magic mr-1"></i>Auto-Generator
        </span>
    </div>
    
    <div class="border-t pt-4">
        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <!-- Topic Types -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Topic Types:</label>
                <div class="space-y-2">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="coordPoint" checked class="coord-type-checkbox rounded">
                        <span class="text-sm">üìç Reading/Plotting Points</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="coordDistance" checked class="coord-type-checkbox rounded">
                        <span class="text-sm">üìè Distance Between Points</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="coordMidpoint" checked class="coord-type-checkbox rounded">
                        <span class="text-sm">‚ö´ Midpoint of Segment</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="coordSlope" checked class="coord-type-checkbox rounded">
                        <span class="text-sm">üìê Slope/Gradient</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="coordEquation" checked class="coord-type-checkbox rounded">
                        <span class="text-sm">üìù Equation of Line (y = mx + c)</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="coordParallel" checked class="coord-type-checkbox rounded">
                        <span class="text-sm">‚´Ω Parallel & Perpendicular Lines</span>
                    </label>
                </div>
            </div>
            
            <!-- Difficulties -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Difficulties:</label>
                <div class="space-y-2">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="coordDiffBeginner" checked class="coord-diff-checkbox rounded">
                        <span class="text-sm text-green-600"><i class="fas fa-seedling mr-1"></i> Beginner (First quadrant, simple values)</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="coordDiffIntermediate" checked class="coord-diff-checkbox rounded">
                        <span class="text-sm text-yellow-600"><i class="fas fa-chart-line mr-1"></i> Intermediate (All quadrants, fractions)</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="coordDiffAdvanced" checked class="coord-diff-checkbox rounded">
                        <span class="text-sm text-red-600"><i class="fas fa-rocket mr-1"></i> Advanced (Complex values, formulas)</span>
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Problems per type -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                Problems per type/difficulty:
            </label>
            <div class="flex items-center gap-3">
                <input type="number" id="coordProblemsPerType" value="2" min="1" max="10" 
                       class="w-20 border rounded-lg px-3 py-2 text-center">
                <span class="text-sm text-gray-600">
                    (Each problem generates 2-3 questions, so 2 problems √ó 6 types √ó 3 difficulties ‚âà 80+ questions)
                </span>
            </div>
        </div>
        
        <!-- Current Counts -->
        <div class="mb-6 p-4 bg-gray-50 rounded-lg">
            <div class="text-sm font-medium text-gray-700 mb-2">Current Coordinate Geometry Questions:</div>
            <div id="coordQuestionCounts" class="flex gap-4 text-sm">
                <span class="text-green-600"><i class="fas fa-seedling mr-1"></i> Beginner: <strong id="coordCountBeginner">--</strong></span>
                <span class="text-yellow-600"><i class="fas fa-chart-line mr-1"></i> Intermediate: <strong id="coordCountIntermediate">--</strong></span>
                <span class="text-red-600"><i class="fas fa-rocket mr-1"></i> Advanced: <strong id="coordCountAdvanced">--</strong></span>
            </div>
        </div>
        
        <!-- Question types info -->
        <div class="mb-6 p-4 bg-teal-50 rounded-lg">
            <div class="text-sm font-medium text-teal-700 mb-2"><i class="fas fa-info-circle mr-1"></i> Question Types Generated:</div>
            <div class="grid md:grid-cols-2 gap-2 text-sm text-teal-800">
                <div>‚Ä¢ "What are the coordinates of point P?"</div>
                <div>‚Ä¢ "Find the distance between A and B"</div>
                <div>‚Ä¢ "Find the midpoint of line segment AB"</div>
                <div>‚Ä¢ "What is the slope of this line?"</div>
                <div>‚Ä¢ "What is the equation of this line?"</div>
                <div>‚Ä¢ "Are these lines parallel or perpendicular?"</div>
            </div>
        </div>
        
        <!-- Generate Button -->
        <div class="flex items-center justify-between">
            <div class="text-sm text-gray-600">
                <i class="fas fa-info-circle mr-1"></i>
                Questions are saved to the "Coordinate Geometry" topic with Cartesian plane images.
            </div>
            <button onclick="generateCoordinateQuestions()" id="coordGenerateBtn" 
                    class="bg-teal-600 text-white px-6 py-3 rounded-lg hover:bg-teal-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                <i class="fas fa-crosshairs mr-2"></i>Generate Coordinate Questions
            </button>
        </div>
        
        <!-- Progress/Results -->
        <div id="coordGeneratorProgress" class="mt-4 hidden">
            <div class="bg-teal-50 border border-teal-200 rounded-lg p-4">
                <div class="flex items-center">
                    <i class="fas fa-spinner fa-spin text-teal-600 mr-3"></i>
                    <span id="coordProgressText">Generating coordinate geometry questions and graphs...</span>
                </div>
            </div>
        </div>
        
        <div id="coordGeneratorResult" class="mt-4 hidden"></div>
    </div>
</div>

<!-- Speed, Distance, Time Question Generator -->
<div class="bg-white rounded-lg shadow-md p-6 mt-6">
    <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-tachometer-alt text-orange-600 text-lg"></i>
            </div>
            <div>
                <h3 class="text-lg font-semibold">Speed, Distance & Time Generator</h3>
                <p class="text-sm text-gray-500">Auto-generate SDT questions with journey maps and graphs</p>
            </div>
        </div>
        <span class="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-sm font-medium">
            <i class="fas fa-magic mr-1"></i>Auto-Generator
        </span>
    </div>
    
    <div class="border-t pt-4">
        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Question Types:</label>
                <div class="space-y-2">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="sdtTypeSpeed" checked class="rounded">
                        <span class="text-sm">üèéÔ∏è Find Speed (S = D √∑ T)</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="sdtTypeDistance" checked class="rounded">
                        <span class="text-sm">üìè Find Distance (D = S √ó T)</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="sdtTypeTime" checked class="rounded">
                        <span class="text-sm">‚è±Ô∏è Find Time (T = D √∑ S)</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="sdtTypeGraph" checked class="rounded">
                        <span class="text-sm">üìà Graph Reading</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="sdtTypeComparison" checked class="rounded">
                        <span class="text-sm">üèÅ Comparison</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="sdtTypeConversion" checked class="rounded">
                        <span class="text-sm">üîÑ Unit Conversion</span>
                    </label>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Difficulties:</label>
                <div class="space-y-2">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="sdtDiffBeginner" checked class="rounded">
                        <span class="text-sm text-green-600"><i class="fas fa-seedling mr-1"></i> Beginner</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="sdtDiffIntermediate" checked class="rounded">
                        <span class="text-sm text-yellow-600"><i class="fas fa-chart-line mr-1"></i> Intermediate</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="sdtDiffAdvanced" checked class="rounded">
                        <span class="text-sm text-red-600"><i class="fas fa-rocket mr-1"></i> Advanced</span>
                    </label>
                </div>
            </div>
        </div>
        
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Questions per type/difficulty:</label>
            <div class="flex items-center gap-3">
                <input type="number" id="sdtQuestionsPerType" value="3" min="1" max="10" class="w-20 border rounded-lg px-3 py-2 text-center">
                <span class="text-sm text-gray-600">(3 √ó 6 types √ó 3 difficulties = 54 questions)</span>
            </div>
        </div>
        
        <div class="mb-6 p-4 bg-gray-50 rounded-lg">
            <div class="text-sm font-medium text-gray-700 mb-2">Current Speed, Distance & Time Questions:</div>
            <div class="flex gap-4 text-sm">
                <span class="text-green-600"><i class="fas fa-seedling mr-1"></i> Beginner: <strong id="sdtCountBeginner">--</strong></span>
                <span class="text-yellow-600"><i class="fas fa-chart-line mr-1"></i> Intermediate: <strong id="sdtCountIntermediate">--</strong></span>
                <span class="text-red-600"><i class="fas fa-rocket mr-1"></i> Advanced: <strong id="sdtCountAdvanced">--</strong></span>
            </div>
        </div>
        
        <div class="mb-6 p-4 bg-orange-50 rounded-lg">
            <div class="text-sm font-medium text-orange-700 mb-2"><i class="fas fa-info-circle mr-1"></i> Features:</div>
            <div class="grid md:grid-cols-2 gap-2 text-sm text-orange-800">
                <div>‚Ä¢ üó∫Ô∏è Journey maps with Irish locations</div>
                <div>‚Ä¢ üèéÔ∏è Speedometer displays</div>
                <div>‚Ä¢ üìà Distance-time graphs</div>
                <div>‚Ä¢ üèÅ Race track comparisons</div>
            </div>
        </div>
        
        <div class="flex items-center justify-between">
            <div class="text-sm text-gray-600">
                <i class="fas fa-info-circle mr-1"></i>Questions saved to "speed_distance_time" topic
            </div>
            <button onclick="generateSDTQuestions()" id="sdtGenerateBtn" class="bg-orange-600 text-white px-6 py-3 rounded-lg hover:bg-orange-700 disabled:bg-gray-400">
                <i class="fas fa-tachometer-alt mr-2"></i>Generate SDT Questions
            </button>
        </div>
        
        <div id="sdtGeneratorProgress" class="mt-4 hidden">
            <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                <div class="flex items-center">
                    <i class="fas fa-spinner fa-spin text-orange-600 mr-3"></i>
                    <span>Generating SDT questions...</span>
                </div>
            </div>
        </div>
        <div id="sdtGeneratorResult" class="mt-4 hidden"></div>
    </div>
</div>

<!-- Currency Question Generator -->
<div class="bg-white rounded-lg shadow-md p-6 mt-6">
    <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
                <i class="fas fa-euro-sign text-green-600 text-lg"></i>
            </div>
            <div>
                <h3 class="text-lg font-semibold">Currency Question Generator</h3>
                <p class="text-sm text-gray-500">Auto-generate money questions with coin and shopping visuals</p>
            </div>
        </div>
        <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium">
            <i class="fas fa-magic mr-1"></i>Auto-Generator
        </span>
    </div>
    
    <div class="border-t pt-4">
        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Question Types:</label>
                <div class="space-y-2">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="currencyTypeCents" checked class="rounded">
                        <span class="text-sm">üí∂ Cents ‚Üî Euro</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="currencyTypeCoins" checked class="rounded">
                        <span class="text-sm">ü™ô Count Coins</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="currencyTypeChange" checked class="rounded">
                        <span class="text-sm">üßæ Making Change</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="currencyTypeShopping" checked class="rounded">
                        <span class="text-sm">üõí Shopping Totals</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="currencyTypeExchange" checked class="rounded">
                        <span class="text-sm">üí± Exchange Rates</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="currencyTypeDiscount" checked class="rounded">
                        <span class="text-sm">üè∑Ô∏è Discounts</span>
                    </label>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Difficulties:</label>
                <div class="space-y-2">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="currencyDiffBeginner" checked class="rounded">
                        <span class="text-sm text-green-600"><i class="fas fa-seedling mr-1"></i> Beginner</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="currencyDiffIntermediate" checked class="rounded">
                        <span class="text-sm text-yellow-600"><i class="fas fa-chart-line mr-1"></i> Intermediate</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" id="currencyDiffAdvanced" checked class="rounded">
                        <span class="text-sm text-red-600"><i class="fas fa-rocket mr-1"></i> Advanced</span>
                    </label>
                </div>
            </div>
        </div>
        
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Questions per type/difficulty:</label>
            <div class="flex items-center gap-3">
                <input type="number" id="currencyQuestionsPerType" value="3" min="1" max="10" class="w-20 border rounded-lg px-3 py-2 text-center">
                <span class="text-sm text-gray-600">(3 √ó 6 types √ó 3 difficulties = 54 questions)</span>
            </div>
        </div>
        
        <div class="mb-6 p-4 bg-gray-50 rounded-lg">
            <div class="text-sm font-medium text-gray-700 mb-2">Current Currency Questions:</div>
            <div class="flex gap-4 text-sm">
                <span class="text-green-600"><i class="fas fa-seedling mr-1"></i> Beginner: <strong id="currencyCountBeginner">--</strong></span>
                <span class="text-yellow-600"><i class="fas fa-chart-line mr-1"></i> Intermediate: <strong id="currencyCountIntermediate">--</strong></span>
                <span class="text-red-600"><i class="fas fa-rocket mr-1"></i> Advanced: <strong id="currencyCountAdvanced">--</strong></span>
            </div>
        </div>
        
        <div class="mb-6 p-4 bg-green-50 rounded-lg">
            <div class="text-sm font-medium text-green-700 mb-2"><i class="fas fa-info-circle mr-1"></i> Features:</div>
            <div class="grid md:grid-cols-2 gap-2 text-sm text-green-800">
                <div>‚Ä¢ ü™ô Euro coin images</div>
                <div>‚Ä¢ üõí Shopping basket visuals</div>
                <div>‚Ä¢ üßæ Change calculator displays</div>
                <div>‚Ä¢ üí± Exchange rate boards</div>
            </div>
        </div>
        
        <div class="flex items-center justify-between">
            <div class="text-sm text-gray-600">
                <i class="fas fa-info-circle mr-1"></i>Questions saved to "currency" topic
            </div>
            <button onclick="generateCurrencyQuestions()" id="currencyGenerateBtn" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 disabled:bg-gray-400">
                <i class="fas fa-euro-sign mr-2"></i>Generate Currency Questions
            </button>
        </div>
        
        <div id="currencyGeneratorProgress" class="mt-4 hidden">
            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <div class="flex items-center">
                    <i class="fas fa-spinner fa-spin text-green-600 mr-3"></i>
                    <span>Generating currency questions...</span>
                </div>
            </div>
        </div>
        <div id="currencyGeneratorResult" class="mt-4 hidden"></div>
    </div>
</div>

    <!-- Sets Question Generator Section -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold"><i class="fas fa-circle-notch mr-2 text-purple-600"></i>Sets Question Generator</h3>
            <span class="text-sm px-3 py-1 rounded-full bg-purple-100 text-purple-800">
                <i class="fas fa-image mr-1"></i> Auto-generates Venn diagrams
            </span>
        </div>
        
        <p class="text-gray-600 mb-4">
            Generate sets and Venn diagram questions aligned with Irish Junior Cycle. 
            Includes set notation, union, intersection, complements, and real-world contexts.
        </p>
        
        <div id="setsGeneratorContent">
            <!-- Question Type Selection -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">Select Question Types:</label>
                <div class="flex flex-wrap gap-3">
                    <label class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" id="setsTypeSurvey" checked class="w-4 h-4 text-purple-600">
                        <span><i class="fas fa-users text-blue-500"></i> Survey (real-world)</span>
                    </label>
                    <label class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" id="setsTypeNumber" checked class="w-4 h-4 text-purple-600">
                        <span><i class="fas fa-hashtag text-green-500"></i> Number Sets</span>
                    </label>
                    <label class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" id="setsTypeNotation" checked class="w-4 h-4 text-purple-600">
                        <span><i class="fas fa-subscript text-purple-500"></i> Notation Only</span>
                    </label>
                </div>
            </div>
            
            <!-- Difficulty Selection -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">Select Difficulty Levels:</label>
                <div class="flex flex-wrap gap-3">
                    <label class="flex items-center gap-2 bg-green-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-green-100">
                        <input type="checkbox" id="setsDiffBeginner" checked class="w-4 h-4 text-green-600">
                        <span class="text-green-700"><i class="fas fa-seedling mr-1"></i> Beginner</span>
                    </label>
                    <label class="flex items-center gap-2 bg-yellow-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-yellow-100">
                        <input type="checkbox" id="setsDiffIntermediate" checked class="w-4 h-4 text-yellow-600">
                        <span class="text-yellow-700"><i class="fas fa-chart-line mr-1"></i> Intermediate</span>
                    </label>
                    <label class="flex items-center gap-2 bg-red-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-red-100">
                        <input type="checkbox" id="setsDiffAdvanced" checked class="w-4 h-4 text-red-600">
                        <span class="text-red-700"><i class="fas fa-rocket mr-1"></i> Advanced</span>
                    </label>
                </div>
            </div>
            
            <!-- Sets per Type -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Sets per type/difficulty:</label>
                <div class="flex items-center gap-3">
                    <input type="number" id="setsSetsPerType" value="3" min="1" max="10" 
                           class="w-20 border rounded-lg px-3 py-2 text-center">
                    <span class="text-sm text-gray-600">
                        (Each set generates 3-7 questions depending on difficulty)
                    </span>
                </div>
            </div>
            
            <!-- Current Counts -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                <div class="text-sm font-medium text-gray-700 mb-2">Current Sets Questions:</div>
                <div id="setsQuestionCounts" class="flex gap-4 text-sm">
                    <span class="text-green-600"><i class="fas fa-seedling mr-1"></i> Beginner: <strong id="setsCountBeginner">--</strong></span>
                    <span class="text-yellow-600"><i class="fas fa-chart-line mr-1"></i> Intermediate: <strong id="setsCountIntermediate">--</strong></span>
                    <span class="text-red-600"><i class="fas fa-rocket mr-1"></i> Advanced: <strong id="setsCountAdvanced">--</strong></span>
                </div>
            </div>
            
            <!-- Features List -->
            <div class="mb-6 p-4 bg-purple-50 rounded-lg">
                <div class="text-sm font-medium text-purple-800 mb-2">Generated Question Types:</div>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm text-purple-700">
                    <div>‚Ä¢ ‚à© Intersection</div>
                    <div>‚Ä¢ ‚à™ Union</div>
                    <div>‚Ä¢ ' Complement</div>
                    <div>‚Ä¢ \ Set difference</div>
                    <div>‚Ä¢ # Cardinal number</div>
                    <div>‚Ä¢ ‚àà Membership</div>
                </div>
            </div>
            
            <!-- Generate Button -->
            <div class="flex items-center justify-between">
                <div class="text-sm text-gray-600">
                    <i class="fas fa-info-circle mr-1"></i>Questions saved to "sets" topic with auto-generated Venn diagrams.
                </div>
                <button onclick="generateSetsQuestions()" id="setsGenerateBtn" 
                        class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <i class="fas fa-circle-notch mr-2"></i>Generate Sets Questions
                </button>
            </div>
            
            <!-- Progress/Results -->
            <div id="setsGeneratorProgress" class="mt-4 hidden">
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fas fa-spinner fa-spin text-purple-600 mr-3"></i>
                        <span>Generating sets questions and Venn diagrams...</span>
                    </div>
                </div>
            </div>
            
            <div id="setsGeneratorResult" class="mt-4 hidden"></div>
        </div>
    </div>

    <!-- Percentages Question Generator Section -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold"><i class="fas fa-percent mr-2 text-green-600"></i>Percentages Question Generator</h3>
            <span class="text-sm px-3 py-1 rounded-full bg-green-100 text-green-800">
                <i class="fas fa-euro-sign mr-1"></i> Irish Financial Maths
            </span>
        </div>
        
        <p class="text-gray-600 mb-4">
            Generate percentage and financial maths questions aligned with Irish Junior Cycle. 
            Includes VAT (Irish rates), profit/loss, mark-up/margin, compound interest, and value for money.
        </p>
        
        <div id="percentagesGeneratorContent">
            <!-- Question Type Selection -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">Select Question Types:</label>
                <div class="flex flex-wrap gap-3">
                    <label class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" id="pctTypeBasic" checked class="w-4 h-4 text-green-600">
                        <span><i class="fas fa-calculator text-blue-500"></i> Basic %</span>
                    </label>
                    <label class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" id="pctTypeIncDec" checked class="w-4 h-4 text-green-600">
                        <span><i class="fas fa-arrow-up text-green-500"></i> Increase/Decrease</span>
                    </label>
                    <label class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" id="pctTypeProfitLoss" checked class="w-4 h-4 text-green-600">
                        <span><i class="fas fa-coins text-yellow-500"></i> Profit/Loss</span>
                    </label>
                    <label class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" id="pctTypeVAT" checked class="w-4 h-4 text-green-600">
                        <span><i class="fas fa-receipt text-red-500"></i> VAT</span>
                    </label>
                    <label class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" id="pctTypeCompound" checked class="w-4 h-4 text-green-600">
                        <span><i class="fas fa-piggy-bank text-pink-500"></i> Compound Interest</span>
                    </label>
                    <label class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" id="pctTypeValue" checked class="w-4 h-4 text-green-600">
                        <span><i class="fas fa-balance-scale text-purple-500"></i> Value for Money</span>
                    </label>
                </div>
            </div>
            
            <!-- Difficulty Selection -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">Select Difficulty Levels:</label>
                <div class="flex flex-wrap gap-3">
                    <label class="flex items-center gap-2 bg-green-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-green-100">
                        <input type="checkbox" id="pctDiffBeginner" checked class="w-4 h-4 text-green-600">
                        <span class="text-green-700"><i class="fas fa-seedling mr-1"></i> Beginner</span>
                    </label>
                    <label class="flex items-center gap-2 bg-yellow-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-yellow-100">
                        <input type="checkbox" id="pctDiffIntermediate" checked class="w-4 h-4 text-yellow-600">
                        <span class="text-yellow-700"><i class="fas fa-chart-line mr-1"></i> Intermediate</span>
                    </label>
                    <label class="flex items-center gap-2 bg-red-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-red-100">
                        <input type="checkbox" id="pctDiffAdvanced" checked class="w-4 h-4 text-red-600">
                        <span class="text-red-700"><i class="fas fa-rocket mr-1"></i> Advanced</span>
                    </label>
                </div>
            </div>
            
            <!-- Sets per Type -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Sets per type/difficulty:</label>
                <div class="flex items-center gap-3">
                    <input type="number" id="pctSetsPerType" value="3" min="1" max="10" 
                           class="w-20 border rounded-lg px-3 py-2 text-center">
                    <span class="text-sm text-gray-600">
                        (Each set generates 2-4 questions)
                    </span>
                </div>
            </div>
            
            <!-- Current Counts -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                <div class="text-sm font-medium text-gray-700 mb-2">Current Percentages Questions:</div>
                <div id="pctQuestionCounts" class="flex gap-4 text-sm">
                    <span class="text-green-600"><i class="fas fa-seedling mr-1"></i> Beginner: <strong id="pctCountBeginner">--</strong></span>
                    <span class="text-yellow-600"><i class="fas fa-chart-line mr-1"></i> Intermediate: <strong id="pctCountIntermediate">--</strong></span>
                    <span class="text-red-600"><i class="fas fa-rocket mr-1"></i> Advanced: <strong id="pctCountAdvanced">--</strong></span>
                </div>
            </div>
            
            <!-- Features List -->
            <div class="mb-6 p-4 bg-green-50 rounded-lg">
                <div class="text-sm font-medium text-green-800 mb-2">Irish Context Features:</div>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-sm text-green-700">
                    <div>‚Ä¢ üáÆüá™ Irish VAT rates (23%, 13.5%, 9%)</div>
                    <div>‚Ä¢ üè™ Irish shop names</div>
                    <div>‚Ä¢ üë§ Irish student names</div>
                    <div>‚Ä¢ üí∂ Euro currency</div>
                    <div>‚Ä¢ üìà Mark-up & Margin</div>
                    <div>‚Ä¢ üè¶ Compound interest (3 years)</div>
                </div>
            </div>
            
            <!-- Generate Button -->
            <div class="flex items-center justify-between">
                <div class="text-sm text-gray-600">
                    <i class="fas fa-info-circle mr-1"></i>Questions saved to "percentages" topic.
                </div>
                <button onclick="generatePercentagesQuestions()" id="pctGenerateBtn" 
                        class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <i class="fas fa-percent mr-2"></i>Generate Percentages Questions
                </button>
            </div>
            
            <!-- Progress/Results -->
            <div id="pctGeneratorProgress" class="mt-4 hidden">
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fas fa-spinner fa-spin text-green-600 mr-3"></i>
                        <span>Generating percentages questions...</span>
                    </div>
                </div>
            </div>
            
            <div id="pctGeneratorResult" class="mt-4 hidden"></div>
        </div>
    </div>

    <!-- Probability Question Generator Section -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold"><i class="fas fa-dice mr-2 text-indigo-600"></i>Probability Question Generator</h3>
            <span class="text-sm px-3 py-1 rounded-full bg-indigo-100 text-indigo-800">
                <i class="fas fa-random mr-1"></i> Irish Junior Cycle
            </span>
        </div>
        
        <p class="text-gray-600 mb-4">
            Generate probability questions aligned with Irish Junior Cycle. 
            Includes dice, coins, cards, bags, expected frequency, and combined events.
        </p>
        
        <div id="probabilityGeneratorContent">
            <!-- Question Type Selection -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">Select Question Types:</label>
                <div class="flex flex-wrap gap-3">
                    <label class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" id="probTypeBasic" checked class="w-4 h-4 text-indigo-600">
                        <span><i class="fas fa-question-circle text-blue-500"></i> Basic Concepts</span>
                    </label>
                    <label class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" id="probTypeDice" checked class="w-4 h-4 text-indigo-600">
                        <span><i class="fas fa-dice text-red-500"></i> Dice</span>
                    </label>
                    <label class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" id="probTypeCoins" checked class="w-4 h-4 text-indigo-600">
                        <span><i class="fas fa-coins text-yellow-500"></i> Coins</span>
                    </label>
                    <label class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" id="probTypeCards" checked class="w-4 h-4 text-indigo-600">
                        <span><i class="fas fa-heart text-pink-500"></i> Cards</span>
                    </label>
                    <label class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" id="probTypeBags" checked class="w-4 h-4 text-indigo-600">
                        <span><i class="fas fa-shopping-bag text-purple-500"></i> Bags/Marbles</span>
                    </label>
                    <label class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" id="probTypeExpected" checked class="w-4 h-4 text-indigo-600">
                        <span><i class="fas fa-calculator text-green-500"></i> Expected Frequency</span>
                    </label>
                    <label class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" id="probTypeRelative" checked class="w-4 h-4 text-indigo-600">
                        <span><i class="fas fa-percentage text-orange-500"></i> Relative Frequency</span>
                    </label>
                    <label class="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-gray-100">
                        <input type="checkbox" id="probTypeCombined" checked class="w-4 h-4 text-indigo-600">
                        <span><i class="fas fa-layer-group text-teal-500"></i> Combined Events</span>
                    </label>
                </div>
            </div>
            
            <!-- Difficulty Selection -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-3">Select Difficulty Levels:</label>
                <div class="flex flex-wrap gap-3">
                    <label class="flex items-center gap-2 bg-green-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-green-100">
                        <input type="checkbox" id="probDiffBeginner" checked class="w-4 h-4 text-green-600">
                        <span class="text-green-700"><i class="fas fa-seedling mr-1"></i> Beginner</span>
                    </label>
                    <label class="flex items-center gap-2 bg-yellow-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-yellow-100">
                        <input type="checkbox" id="probDiffIntermediate" checked class="w-4 h-4 text-yellow-600">
                        <span class="text-yellow-700"><i class="fas fa-chart-line mr-1"></i> Intermediate</span>
                    </label>
                    <label class="flex items-center gap-2 bg-red-50 px-4 py-2 rounded-lg cursor-pointer hover:bg-red-100">
                        <input type="checkbox" id="probDiffAdvanced" checked class="w-4 h-4 text-red-600">
                        <span class="text-red-700"><i class="fas fa-rocket mr-1"></i> Advanced</span>
                    </label>
                </div>
            </div>
            
            <!-- Sets per Type -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Sets per type/difficulty:</label>
                <div class="flex items-center gap-3">
                    <input type="number" id="probSetsPerType" value="3" min="1" max="10" 
                           class="w-20 border rounded-lg px-3 py-2 text-center">
                    <span class="text-sm text-gray-600">
                        (Each set generates 1-2 questions)
                    </span>
                </div>
            </div>
            
            <!-- Current Counts -->
            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                <div class="text-sm font-medium text-gray-700 mb-2">Current Probability Questions:</div>
                <div id="probQuestionCounts" class="flex gap-4 text-sm">
                    <span class="text-green-600"><i class="fas fa-seedling mr-1"></i> Beginner: <strong id="probCountBeginner">--</strong></span>
                    <span class="text-yellow-600"><i class="fas fa-chart-line mr-1"></i> Intermediate: <strong id="probCountIntermediate">--</strong></span>
                    <span class="text-red-600"><i class="fas fa-rocket mr-1"></i> Advanced: <strong id="probCountAdvanced">--</strong></span>
                </div>
            </div>
            
            <!-- Features List -->
            <div class="mb-6 p-4 bg-indigo-50 rounded-lg">
                <div class="text-sm font-medium text-indigo-800 mb-2">Topics Covered:</div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm text-indigo-700">
                    <div>‚Ä¢ üé≤ Single & two dice</div>
                    <div>‚Ä¢ ü™ô Coin flips (1-3)</div>
                    <div>‚Ä¢ üÉè Card probabilities</div>
                    <div>‚Ä¢ üé± Bag/marble problems</div>
                    <div>‚Ä¢ üìä Sample space</div>
                    <div>‚Ä¢ üî¢ Expected frequency</div>
                    <div>‚Ä¢ üìà Relative frequency</div>
                    <div>‚Ä¢ ‚ûï Combined events (AND/OR)</div>
                </div>
            </div>
            
            <!-- Generate Button -->
            <div class="flex items-center justify-between">
                <div class="text-sm text-gray-600">
                    <i class="fas fa-info-circle mr-1"></i>Questions saved to "probability" topic.
                </div>
                <button onclick="generateProbabilityQuestions()" id="probGenerateBtn" 
                        class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <i class="fas fa-dice mr-2"></i>Generate Probability Questions
                </button>
            </div>
            
            <!-- Progress/Results -->
            <div id="probGeneratorProgress" class="mt-4 hidden">
                <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
                    <div class="flex items-center">
                        <i class="fas fa-spinner fa-spin text-indigo-600 mr-3"></i>
                        <span>Generating probability questions...</span>
                    </div>
                </div>
            </div>
            
            <div id="probGeneratorResult" class="mt-4 hidden"></div>
        </div>
    </div>

<!-- Strand Modal -->
<div id="strandModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 w-full max-w-md">
        <h3 class="text-xl font-bold mb-4" id="strandModalTitle">Add Strand</h3>
        <form id="strandForm">
            <input type="hidden" id="strandId">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Name *</label>
                <input type="text" id="strandName" required class="w-full border rounded-lg px-3 py-2" placeholder="e.g., Algebra and Functions">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Icon (emoji)</label>
                <input type="text" id="strandIcon" class="w-full border rounded-lg px-3 py-2" placeholder="e.g., üìê">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Color</label>
                <input type="color" id="strandColor" class="w-full h-10 border rounded-lg" value="#667eea">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                <textarea id="strandDescription" rows="2" class="w-full border rounded-lg px-3 py-2" placeholder="Brief description of this strand"></textarea>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Sort Order</label>
                <input type="number" id="strandSortOrder" class="w-full border rounded-lg px-3 py-2" value="0">
            </div>
            <div class="flex justify-end gap-3">
                <button type="button" onclick="closeStrandModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                <button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Topic Modal -->
<div id="topicModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg p-6 w-full max-w-md">
        <h3 class="text-xl font-bold mb-4" id="topicModalTitle">Add Topic</h3>
        <form id="topicForm">
            <input type="hidden" id="topicDbId">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Topic ID * <span class="text-xs text-gray-500">(lowercase, underscores)</span></label>
                <input type="text" id="topicIdInput" required class="w-full border rounded-lg px-3 py-2" placeholder="e.g., descriptive_statistics">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Display Name *</label>
                <input type="text" id="topicDisplayName" required class="w-full border rounded-lg px-3 py-2" placeholder="e.g., Descriptive Statistics">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Icon <span class="text-xs text-gray-500">(Font Awesome name without fa-)</span></label>
                <input type="text" id="topicIcon" class="w-full border rounded-lg px-3 py-2" placeholder="e.g., chart-bar">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Strand</label>
                <select id="topicStrandSelect" class="w-full border rounded-lg px-3 py-2">
                    <option value="">Select a strand...</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Sort Order</label>
                <input type="number" id="topicSortOrder" class="w-full border rounded-lg px-3 py-2" value="0">
            </div>
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" id="topicVisible" checked class="mr-2">
                    <span class="text-sm text-gray-700">Visible to students</span>
                </label>
            </div>
            <div class="flex justify-end gap-3">
                <button type="button" onclick="closeTopicModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Tutorial Modal -->
<div id="tutorialModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center overflow-y-auto">
    <div class="bg-white rounded-lg p-6 w-full max-w-2xl my-8">
        <h3 class="text-xl font-bold mb-4" id="tutorialModalTitle">Edit Tutorials</h3>
        <div class="mb-4">
            <p class="text-gray-600" id="tutorialTopicName">Topic: Loading...</p>
        </div>
        
        <!-- Tutorial Difficulty Tabs -->
        <div class="flex border-b mb-4">
            <button onclick="showTutorialTab('beginner')" id="tutorialTabBeginner" class="px-4 py-2 font-semibold border-b-2 border-green-500 text-green-600">Beginner</button>
            <button onclick="showTutorialTab('intermediate')" id="tutorialTabIntermediate" class="px-4 py-2 font-semibold text-gray-500">Intermediate</button>
            <button onclick="showTutorialTab('advanced')" id="tutorialTabAdvanced" class="px-4 py-2 font-semibold text-gray-500">Advanced</button>
        </div>
        
        <form id="tutorialForm">
            <input type="hidden" id="tutorialId">
            <input type="hidden" id="tutorialTopicId">
            <input type="hidden" id="tutorialDifficulty" value="beginner">
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Title *</label>
                <input type="text" id="tutorialTitle" required class="w-full border rounded-lg px-3 py-2" placeholder="e.g., Introduction to Fractions">
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Introduction (HTML allowed)</label>
                <textarea id="tutorialIntroduction" rows="3" class="w-full border rounded-lg px-3 py-2" placeholder="Brief introduction text..."></textarea>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Key Principles (JSON array)</label>
                <textarea id="tutorialPrinciples" rows="4" class="w-full border rounded-lg px-3 py-2 font-mono text-sm" placeholder='[{"title": "Principle 1", "content": "Explanation..."}]'></textarea>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Examples (JSON array)</label>
                <textarea id="tutorialExamples" rows="4" class="w-full border rounded-lg px-3 py-2 font-mono text-sm" placeholder='[{"question": "2+2", "steps": ["Step 1"], "answer": "4"}]'></textarea>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Tips (JSON array of strings)</label>
                <textarea id="tutorialTips" rows="3" class="w-full border rounded-lg px-3 py-2 font-mono text-sm" placeholder='["Tip 1", "Tip 2"]'></textarea>
            </div>
            <div class="flex justify-between">
                <button type="button" onclick="deleteTutorial()" class="text-red-600 hover:text-red-800">
                    <i class="fas fa-trash mr-1"></i>Delete Tutorial
                </button>
                <div class="flex gap-3">
                    <button type="button" onclick="closeTutorialModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</button>
                    <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Save Tutorial</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Modal for Domain Details -->
<div class="modal fade" id="domainDetailsModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Domain Details: <span id="modal-domain-name"></span></h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="domain-details-content">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<style>
    .domain-tag {
        display: inline-block;
        background: #e3f2fd;
        border: 1px solid #2196f3;
        border-radius: 15px;
        padding: 5px 12px;
        margin: 3px;
        font-size: 0.9em;
    }
    
    .domain-tag .remove-btn {
        color: #f44336;
        margin-left: 8px;
        cursor: pointer;
        font-weight: bold;
    }
    
    .domain-tag .remove-btn:hover {
        color: #d32f2f;
    }
    
    .request-card {
        border-left: 4px solid #ffc107;
        margin-bottom: 15px;
    }
    
    .request-card.approved {
        border-left-color: #4caf50;
    }
    
    .request-card.denied {
        border-left-color: #f44336;
    }
    
    /* Bootstrap compatibility styles for domain management */
    .card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }
    
    .card-header {
        padding: 1rem;
        border-bottom: 1px solid #e5e7eb;
        background: #f9fafb;
        border-radius: 8px 8px 0 0;
    }
    
    .card-body {
        padding: 1rem;
    }
    
    .nav-tabs {
        border-bottom: 2px solid #e5e7eb;
        display: flex;
        margin-bottom: 1rem;
    }
    
    .nav-item {
        margin-bottom: -2px;
    }
    
    .nav-link {
        padding: 0.75rem 1.5rem;
        border: none;
        border-bottom: 3px solid transparent;
        background: none;
        cursor: pointer;
        color: #6b7280;
        text-decoration: none;
        display: block;
    }
    
    .nav-link:hover {
        color: #374151;
        border-bottom-color: #d1d5db;
    }
    
    .nav-link.active {
        color: #7c3aed;
        border-bottom-color: #7c3aed;
        font-weight: 600;
    }
    
    .tab-pane {
        display: none;
    }
    
    .tab-pane.show.active,
    .tab-pane.active {
        display: block;
    }
    
    .form-control {
        padding: 0.5rem 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        width: 100%;
    }
    
    .form-control-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    
    .table-responsive {
        overflow-x: auto;
    }
    
    .table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .table th, .table td {
        padding: 0.75rem;
        border-bottom: 1px solid #e5e7eb;
        text-align: left;
    }
    
    .table th {
        background: #f9fafb;
        font-weight: 600;
    }
    
    .table-hover tbody tr:hover {
        background: #f9fafb;
    }
    
    .table tbody tr {
        background: white;
    }
    
    .table tbody td {
        vertical-align: middle;
    }
    
    /* Ensure tab content is visible */
    #domainsContent .tab-pane.fade {
        transition: none;
    }
    
    #domainsContent .tab-pane.show {
        display: block !important;
        opacity: 1;
    }
    
    /* Force Domains Overview tab to be visible when active */
    #domains-overview.tab-pane.show.active {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        height: auto !important;
        overflow: visible !important;
    }
    
    /* Override any hidden class on domain management elements */
    #domainsContent:not(.hidden),
    #domainsContent.tab-content,
    #domain-management-tab,
    #domains-overview,
    #domains-overview *:not(.modal) {
        display: revert !important;
    }
    
    #domains-overview.tab-pane.active {
        display: block !important;
    }
    
    /* Tailwind hidden class override for domain tab */
    #domainsContent.hidden {
        display: block !important;
    }
    
    #domains-overview .hidden {
        display: revert !important;
    }
    
    /* Force table visibility */
    #domains-overview .table-responsive,
    #domains-overview .card,
    #domains-overview .card-body {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    #domains-overview table {
        display: table !important;
        width: 100% !important;
    }
    
    #domains-overview tbody {
        display: table-row-group !important;
    }
    
    #domains-overview tr {
        display: table-row !important;
    }
    
    #domains-overview td,
    #domains-overview th {
        display: table-cell !important;
    }
    
    .badge {
        padding: 0.25rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .badge-warning {
        background: #fbbf24;
        color: #78350f;
    }
    
    .badge-success {
        background: #10b981;
        color: white;
    }
    
    .btn {
        padding: 0.5rem 1rem;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-weight: 500;
    }
    
    .btn-sm {
        padding: 0.25rem 0.75rem;
        font-size: 0.875rem;
    }
    
    .btn-primary {
        background: #7c3aed;
        color: white;
    }
    
    .btn-primary:hover {
        background: #6d28d9;
    }
    
    .btn-success {
        background: #10b981;
        color: white;
    }
    
    .btn-success:hover {
        background: #059669;
    }
    
    .btn-danger {
        background: #ef4444;
        color: white;
    }
    
    .btn-danger:hover {
        background: #dc2626;
    }
    
    .btn-warning {
        background: #f59e0b;
        color: white;
    }
    
    .btn-warning:hover {
        background: #d97706;
    }
    
    .d-flex {
        display: flex;
    }
    
    .justify-content-between {
        justify-content: space-between;
    }
    
    .align-items-center {
        align-items: center;
    }
    
    .mb-0 {
        margin-bottom: 0;
    }
    
    .mb-3 {
        margin-bottom: 0.75rem;
    }
    
    .mb-4 {
        margin-bottom: 1rem;
    }
    
    .ml-1 {
        margin-left: 0.25rem;
    }
    
    .text-center {
        text-align: center;
    }
    
    .text-muted {
        color: #6b7280;
    }
    
    .text-danger {
        color: #ef4444;
    }
    
    .row {
        display: flex;
        flex-wrap: wrap;
        margin: -0.5rem;
    }
    
    .col-md-4 {
        flex: 0 0 33.333%;
        padding: 0.5rem;
    }
    
    @media (max-width: 768px) {
        .col-md-4 {
            flex: 0 0 100%;
        }
    }
    
    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
    }
    
    .modal.show {
        display: block;
    }
    
    .modal-dialog {
        position: relative;
        width: auto;
        margin: 1.75rem auto;
        max-width: 500px;
    }
    
    .modal-dialog.modal-lg {
        max-width: 800px;
    }
    
    .modal-content {
        position: relative;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .modal-title {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
    }
    
    .modal-body {
        padding: 1rem;
    }
    
    .close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #6b7280;
        padding: 0;
        line-height: 1;
    }
    
    .close:hover {
        color: #374151;
    }
    
    /* Bootstrap background colors */
    .bg-primary {
        background-color: #7c3aed !important;
    }
    
    .bg-success {
        background-color: #10b981 !important;
    }
    
    .bg-info {
        background-color: #06b6d4 !important;
    }
    
    .bg-warning {
        background-color: #f59e0b !important;
    }
    
    .bg-danger {
        background-color: #ef4444 !important;
    }
    
    .text-white {
        color: white !important;
    }
    
    .text-dark {
        color: #1f2937 !important;
    }
    
    /* Badge variants */
    .badge-primary {
        background-color: #7c3aed;
        color: white;
    }
    
    .badge-secondary {
        background-color: #6b7280;
        color: white;
    }
    
    .badge-info {
        background-color: #06b6d4;
        color: white;
    }
    
    /* Button outline variants */
    .btn-outline-primary {
        background-color: transparent;
        border: 1px solid #7c3aed;
        color: #7c3aed;
    }
    
    .btn-outline-primary:hover {
        background-color: #7c3aed;
        color: white;
    }
    
    /* Additional card styling */
    .card h2 {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 0.5rem 0;
    }
    
    .card h5 {
        margin: 0 0 0.5rem 0;
        font-size: 1rem;
    }
    
    .card small {
        font-size: 0.875rem;
        opacity: 0.9;
    }
    
    /* Ensure cards have proper min-height */
    .card.bg-primary,
    .card.bg-warning,
    .card.bg-info,
    .card.bg-success,
    .card.bg-danger {
        min-height: 120px;
    }
</style>

<script>
// Domain Management JavaScript

let currentTeacherId = null;
let allDomains = [];

// NOTE: Domain initialization is handled by showTab('domains') function
// which calls refreshDomains(), loadTeachersList(), and loadAccessRequests()

// Handle internal tabs within domain management (domains-overview, teacher-access, access-requests)
function initDomainTabs() {
    document.querySelectorAll('#domainsContent .nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href').substring(1);
            
            // Remove active class from all tabs
            document.querySelectorAll('#domainsContent .nav-link').forEach(l => l.classList.remove('active'));
            document.querySelectorAll('#domainsContent .tab-pane').forEach(p => {
                p.classList.remove('show', 'active');
            });
            
            // Add active class to clicked tab
            this.classList.add('active');
            const targetPane = document.getElementById(targetId);
            if (targetPane) {
                targetPane.classList.add('show', 'active');
            }
            
            // Load data for specific tabs when they're opened
            if (targetId === 'teacher-access') {
                console.log('Teacher Access tab opened, loading teachers...');
                loadTeachersList();
            } else if (targetId === 'access-requests') {
                console.log('Access Requests tab opened, loading requests...');
                loadAccessRequests();
            }
        });
    });
}

// Initialize tabs when page loads
window.addEventListener('DOMContentLoaded', initDomainTabs);

// Global debug function - call from console: debugDomainTab()
window.debugDomainTab = function() {
    const domainsContent = document.getElementById('domainsContent');
    const domainTab = document.getElementById('domain-management-tab');
    const domainsOverview = document.getElementById('domains-overview');
    const tbody = document.getElementById('domains-table-body');
    
    console.log('=== Domain Tab Debug Info ===');
    console.log('domainsContent:', {
        exists: !!domainsContent,
        display: domainsContent?.style.display,
        computed: domainsContent ? window.getComputedStyle(domainsContent).display : null,
        classes: domainsContent?.className
    });
    console.log('domain-management-tab:', {
        exists: !!domainTab,
        display: domainTab?.style.display,
        computed: domainTab ? window.getComputedStyle(domainTab).display : null
    });
    console.log('domains-overview:', {
        exists: !!domainsOverview,
        display: domainsOverview?.style.display,
        computed: domainsOverview ? window.getComputedStyle(domainsOverview).display : null,
        classes: domainsOverview?.className,
        visible: domainsOverview ? domainsOverview.offsetHeight > 0 : false
    });
    console.log('tbody:', {
        exists: !!tbody,
        rowCount: tbody?.querySelectorAll('tr').length,
        visible: tbody ? tbody.offsetHeight > 0 : false,
        height: tbody?.offsetHeight,
        firstRowHTML: tbody?.querySelector('tr')?.innerHTML.substring(0, 100)
    });
    console.log('=== End Debug Info ===');
};

// Nuclear option - force everything visible
window.forceShowDomainTable = function() {
    console.log('üö® NUCLEAR OPTION - Forcing table visible...');
    
    // Get all elements
    const domainsContent = document.getElementById('domainsContent');
    const domainTab = document.getElementById('domain-management-tab');
    const domainsOverview = document.getElementById('domains-overview');
    const card = domainsOverview?.querySelector('.card');
    const cardHeader = card?.querySelector('.card-header');
    const cardBody = card?.querySelector('.card-body');
    const tableResponsive = cardBody?.querySelector('.table-responsive');
    const table = tableResponsive?.querySelector('table');
    const tbody = document.getElementById('domains-table-body');
    
    // Force everything with inline styles that override everything
    const elements = [
        {el: domainsContent, name: 'domainsContent'},
        {el: domainTab, name: 'domainTab'},
        {el: domainsOverview, name: 'domainsOverview'},
        {el: card, name: 'card'},
        {el: cardHeader, name: 'cardHeader'},
        {el: cardBody, name: 'cardBody'},
        {el: tableResponsive, name: 'tableResponsive'},
        {el: table, name: 'table'},
        {el: tbody, name: 'tbody'}
    ];
    
    elements.forEach(({el, name}) => {
        if (el) {
            el.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; position: relative !important; height: auto !important; min-height: 50px !important;';
            el.classList.remove('hidden');
            console.log(`‚úÖ Forced ${name}`);
        } else {
            console.log(`‚ùå ${name} not found`);
        }
    });
    
    // Special handling for table elements
    if (table) {
        table.style.display = 'table !important';
    }
    if (tbody) {
        tbody.style.display = 'table-row-group !important';
    }
    
    // Force all rows
    tbody?.querySelectorAll('tr').forEach((row, i) => {
        row.style.cssText = 'display: table-row !important; visibility: visible !important; opacity: 1 !important;';
    });
    
    // Force all cells
    tbody?.querySelectorAll('td, th').forEach((cell) => {
        cell.style.cssText = 'display: table-cell !important; visibility: visible !important; opacity: 1 !important;';
    });
    
    console.log('‚úÖ All elements forced visible');
    console.log('Table height:', tbody?.offsetHeight, 'px');
    console.log('Table width:', tbody?.offsetWidth, 'px');
    
    // Scroll into view
    if (domainsOverview) {
        domainsOverview.scrollIntoView({behavior: 'smooth', block: 'start'});
    }
};

console.log('üí° Tip: If table not showing, try: forceShowDomainTable()');

// Modal handling functions (Bootstrap-free)
function showModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('show');
        modal.style.display = 'block';
    }
}

function hideModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('show');
        modal.style.display = 'none';
    }
}

// Setup close button handlers for all modals
window.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[data-dismiss="modal"]').forEach(btn => {
        btn.addEventListener('click', function() {
            const modal = this.closest('.modal');
            if (modal) {
                modal.classList.remove('show');
                modal.style.display = 'none';
            }
        });
    });
    
    // Close modal when clicking outside
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('show');
                this.style.display = 'none';
            }
        });
    });
});

// Refresh all domains
async function refreshDomains() {
    console.log('refreshDomains() called');
    try {
        const response = await fetch('/api/admin/domains');
        console.log('API response status:', response.status);
        
        const data = await response.json();
        console.log('Domains data received:', data);
        
        allDomains = data.domains;
        document.getElementById('total-domains-count').textContent = data.total_domains;
        
        renderDomainsTable(data.domains);
        updateRestrictedTeachersCount();
    } catch (error) {
        console.error('Error loading domains:', error);
        const tbody = document.getElementById('domains-table-body');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading domains. Please refresh the page.</td></tr>';
        }
    }
}

// Render domains table
function renderDomainsTable(domains) {
    const tbody = document.getElementById('domains-table-body');
    
    if (!tbody) {
        console.error('domains-table-body element not found!');
        return;
    }
    
    console.log('Rendering domains table with', domains.length, 'domains');
    
    if (domains.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No domains found in the system</td></tr>';
        return;
    }
    
    tbody.innerHTML = domains.map(domain => `
        <tr>
            <td><strong>${domain.domain}</strong></td>
            <td>
                <span class="badge badge-primary">${domain.student_count}</span>
            </td>
            <td>
                <span class="badge badge-info">${domain.teacher_count}</span>
            </td>
            <td>
                ${domain.teachers_with_access.length === 0 
                    ? '<span class="text-muted">No restrictions</span>'
                    : domain.teachers_with_access.map(t => 
                        `<span class="badge badge-secondary" title="${t.email}">${t.name}</span>`
                      ).join(' ')}
            </td>
            <td>
                <button class="btn btn-sm btn-outline-primary" 
                        onclick="showDomainDetails('${domain.domain}')">
                    <i class="fas fa-info-circle"></i> Details
                </button>
            </td>
        </tr>
    `).join('');
    
    console.log('Domains table rendered successfully');
    
    // Debug: Check if table is actually visible and force visibility aggressively
    setTimeout(() => {
        const tabPane = document.getElementById('domains-overview');
        const card = tabPane?.querySelector('.card');
        const cardBody = card?.querySelector('.card-body');
        const tableResponsive = cardBody?.querySelector('.table-responsive');
        const table = tableResponsive?.querySelector('table');
        
        const tableVisible = tbody.offsetHeight > 0 && tbody.offsetWidth > 0;
        
        console.log('Table visibility check:', {
            exists: !!tbody,
            visible: tableVisible,
            height: tbody.offsetHeight,
            width: tbody.offsetWidth,
            rowCount: tbody.querySelectorAll('tr').length,
            computedDisplay: tbody ? window.getComputedStyle(tbody).display : null,
            computedVisibility: tbody ? window.getComputedStyle(tbody).visibility : null,
            computedOpacity: tbody ? window.getComputedStyle(tbody).opacity : null,
            parentDisplay: tabPane ? window.getComputedStyle(tabPane).display : null,
            parentHeight: tabPane?.offsetHeight,
            html: tbody.innerHTML.substring(0, 200) + '...'
        });
        
        // SUPER AGGRESSIVE: Force everything visible no matter what
        if (tabPane) {
            tabPane.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; position: relative !important; height: auto !important; overflow: visible !important; z-index: 1 !important;';
            tabPane.classList.add('show', 'active');
            console.log('FORCED tab-pane with cssText');
        }
        if (card) {
            card.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important;';
            console.log('FORCED card with cssText');
        }
        if (cardBody) {
            cardBody.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; min-height: 200px !important;';
            console.log('FORCED card-body with cssText');
        }
        if (tableResponsive) {
            tableResponsive.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; overflow: auto !important;';
            console.log('FORCED table-responsive with cssText');
        }
        if (table) {
            table.style.cssText = 'display: table !important; visibility: visible !important; opacity: 1 !important; width: 100% !important;';
            console.log('FORCED table with cssText');
        }
        if (tbody) {
            tbody.style.cssText = 'display: table-row-group !important; visibility: visible !important; opacity: 1 !important;';
            console.log('FORCED tbody with cssText');
        }
        
        // Force all rows visible
        tbody.querySelectorAll('tr').forEach((row, i) => {
            row.style.cssText = 'display: table-row !important; visibility: visible !important; opacity: 1 !important;';
            console.log(`FORCED row ${i}`);
        });
        
        console.log('All force-visibility operations complete');
        
        // Double-check after forcing
        setTimeout(() => {
            const stillNotVisible = tbody.offsetHeight === 0 || tbody.offsetWidth === 0;
            console.log('After forcing - visible?', !stillNotVisible, {
                height: tbody.offsetHeight,
                width: tbody.offsetWidth,
                boundingRect: tbody.getBoundingClientRect()
            });
        }, 100);
    }, 100);
}

// Load teachers list
async function loadTeachersList() {
    console.log('loadTeachersList() called');
    try {
        const response = await fetch('/api/admin/all-users?role=teacher');
        console.log('Teachers API response status:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const teachers = await response.json();
        console.log('Teachers loaded:', teachers.length, 'total');
        
        const select = document.getElementById('teacher-select');
        if (!select) {
            console.error('teacher-select element not found!');
            return;
        }
        
        const approvedTeachers = teachers.filter(t => t.is_approved);
        console.log('Approved teachers:', approvedTeachers.length);
        
        select.innerHTML = '<option value="">-- Select a teacher --</option>' +
            approvedTeachers
                .map(t => `<option value="${t.id}">${t.full_name} (${t.email})</option>`)
                .join('');
        
        console.log('Teacher dropdown populated with', approvedTeachers.length, 'teachers');
    } catch (error) {
        console.error('Error loading teachers:', error);
        const select = document.getElementById('teacher-select');
        if (select) {
            select.innerHTML = '<option value="">‚ö†Ô∏è Error loading teachers</option>';
        }
    }
}

// Load teacher's domains
async function loadTeacherDomains() {
    const teacherId = document.getElementById('teacher-select').value;
    
    if (!teacherId) {
        document.getElementById('teacher-domains-container').style.display = 'none';
        return;
    }
    
    currentTeacherId = teacherId;
    
    try {
        const response = await fetch(`/api/admin/teacher/${teacherId}/domains`);
        const data = await response.json();
        
        // Show container
        document.getElementById('teacher-domains-container').style.display = 'block';
        
        // Update teacher info
        document.getElementById('teacher-info-name').textContent = data.teacher.full_name;
        document.getElementById('teacher-info-email').textContent = data.teacher.email;
        
        // Update status
        const hasRestrictions = data.statistics.has_restrictions;
        document.getElementById('teacher-access-status').innerHTML = hasRestrictions
            ? '<span class="badge badge-warning"><i class="fas fa-lock"></i> Restricted Access</span>'
            : '<span class="badge badge-success"><i class="fas fa-unlock"></i> Full Access (No Restrictions)</span>';
        
        document.getElementById('teacher-student-count').textContent = 
            `${data.statistics.accessible_student_count} students`;
        
        // Render assigned domains
        renderAssignedDomains(data.assigned_domains);
        
        // Populate available domains dropdown
        populateAvailableDomains(data.assigned_domains, data.available_domains);
        
    } catch (error) {
        console.error('Error loading teacher domains:', error);
        alert('Failed to load teacher domains');
    }
}

// Render assigned domains
function renderAssignedDomains(domains) {
    const container = document.getElementById('assigned-domains-list');
    
    if (domains.length === 0) {
        container.innerHTML = '<p class="text-muted">No domains assigned. This teacher has full access to all students.</p>';
        return;
    }
    
    container.innerHTML = domains.map(d => `
        <div class="domain-tag">
            <i class="fas fa-shield-alt"></i> ${d.email_domain}
            <span class="remove-btn" onclick="revokeDomain('${d.email_domain}')" 
                  title="Remove access">√ó</span>
        </div>
    `).join('');
}

// Populate available domains dropdown
function populateAvailableDomains(assigned, available) {
    const assignedDomains = assigned.map(d => d.email_domain);
    const select = document.getElementById('domain-to-assign');
    
    const availableOptions = available
        .filter(d => !assignedDomains.includes(d.domain))
        .map(d => `<option value="${d.domain}">${d.domain} (${d.student_count} students)</option>`)
        .join('');
    
    select.innerHTML = '<option value="">-- Select a domain --</option>' + availableOptions;
}

// Assign domain to teacher
async function assignDomain() {
    const domain = document.getElementById('domain-to-assign').value;
    const notes = document.getElementById('assign-notes').value;
    
    if (!domain) {
        alert('Please select a domain');
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/teacher/${currentTeacherId}/domains`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ domain, notes })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert('Domain access granted successfully');
            loadTeacherDomains();
            document.getElementById('assign-notes').value = '';
        } else {
            alert(data.error || 'Failed to assign domain');
        }
    } catch (error) {
        console.error('Error assigning domain:', error);
        alert('Failed to assign domain');
    }
}

// Revoke domain from teacher
async function revokeDomain(domain) {
    if (!confirm(`Remove access to ${domain}?`)) return;
    
    try {
        const response = await fetch(
            `/api/admin/teacher/${currentTeacherId}/domains/${encodeURIComponent(domain)}`,
            { method: 'DELETE' }
        );
        
        if (response.ok) {
            alert('Domain access revoked successfully');
            loadTeacherDomains();
            refreshDomains();
        } else {
            alert('Failed to revoke domain access');
        }
    } catch (error) {
        console.error('Error revoking domain:', error);
        alert('Failed to revoke domain access');
    }
}

// Remove all restrictions
async function removeAllRestrictions() {
    if (!confirm('Remove ALL domain restrictions? This teacher will have full access to all students.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/teacher/${currentTeacherId}/remove-all-restrictions`, {
            method: 'POST'
        });
        
        if (response.ok) {
            alert('All restrictions removed. Teacher now has full access.');
            loadTeacherDomains();
            refreshDomains();
        } else {
            alert('Failed to remove restrictions');
        }
    } catch (error) {
        console.error('Error removing restrictions:', error);
        alert('Failed to remove restrictions');
    }
}

// Load access requests
async function loadAccessRequests() {
    const status = document.getElementById('request-status-filter').value;
    
    try {
        const response = await fetch(`/api/admin/domain-requests?status=${status}`);
        const data = await response.json();
        
        document.getElementById('pending-requests-count').textContent = 
            data.requests.filter(r => r.status === 'pending').length;
        document.getElementById('requests-badge').textContent = 
            data.requests.filter(r => r.status === 'pending').length;
        
        renderAccessRequests(data.requests);
    } catch (error) {
        console.error('Error loading requests:', error);
    }
}

// Render access requests
function renderAccessRequests(requests) {
    const container = document.getElementById('access-requests-container');
    
    if (requests.length === 0) {
        container.innerHTML = '<p class="text-center text-muted">No requests found</p>';
        return;
    }
    
    container.innerHTML = requests.map(req => `
        <div class="card request-card ${req.status}">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6>
                            ${req.teacher_name}
                            <small class="text-muted">(${req.teacher_email})</small>
                        </h6>
                        <p class="mb-1">
                            <strong>Domain:</strong> <span class="badge badge-info">${req.email_domain}</span>
                        </p>
                        <p class="mb-1"><strong>Reason:</strong> ${req.reason}</p>
                        <small class="text-muted">
                            Requested: ${new Date(req.requested_at).toLocaleString()}
                        </small>
                        ${req.status !== 'pending' ? `
                            <br><small class="text-muted">
                                ${req.status === 'approved' ? 'Approved' : 'Denied'} by ${req.reviewed_by} 
                                on ${new Date(req.reviewed_at).toLocaleString()}
                            </small>
                        ` : ''}
                        ${req.admin_notes ? `<br><small><strong>Admin Notes:</strong> ${req.admin_notes}</small>` : ''}
                    </div>
                    <div class="col-md-4 text-right">
                        ${req.status === 'pending' ? `
                            <button class="btn btn-success btn-sm mb-2" 
                                    onclick="approveRequest(${req.id})">
                                <i class="fas fa-check"></i> Approve
                            </button>
                            <button class="btn btn-danger btn-sm mb-2" 
                                    onclick="denyRequest(${req.id})">
                                <i class="fas fa-times"></i> Deny
                            </button>
                        ` : `
                            <span class="badge badge-${req.status === 'approved' ? 'success' : 'danger'}">
                                ${req.status.toUpperCase()}
                            </span>
                        `}
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// Approve request
async function approveRequest(requestId) {
    const notes = prompt('Optional notes for approval:');
    
    try {
        const response = await fetch(`/api/admin/domain-requests/${requestId}/approve`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ admin_notes: notes || '' })
        });
        
        if (response.ok) {
            alert('Request approved successfully');
            loadAccessRequests();
            refreshDomains();
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to approve request');
        }
    } catch (error) {
        console.error('Error approving request:', error);
        alert('Failed to approve request');
    }
}

// Deny request
async function denyRequest(requestId) {
    const notes = prompt('Please provide a reason for denial:');
    
    if (!notes) {
        alert('Reason is required for denial');
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/domain-requests/${requestId}/deny`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ admin_notes: notes })
        });
        
        if (response.ok) {
            alert('Request denied');
            loadAccessRequests();
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to deny request');
        }
    } catch (error) {
        console.error('Error denying request:', error);
        alert('Failed to deny request');
    }
}

// Show domain details modal
function showDomainDetails(domain) {
    document.getElementById('modal-domain-name').textContent = domain;
    const domainData = allDomains.find(d => d.domain === domain);
    
    if (!domainData) return;
    
    const content = document.getElementById('domain-details-content');
    content.innerHTML = `
        <h6>Statistics</h6>
        <ul>
            <li>Students: ${domainData.student_count}</li>
            <li>Teachers: ${domainData.teacher_count}</li>
            <li>Teachers with Access: ${domainData.teachers_with_access.length}</li>
        </ul>
        ${domainData.teachers_with_access.length > 0 ? `
            <h6>Teachers with Access:</h6>
            <ul>
                ${domainData.teachers_with_access.map(t => 
                    `<li>${t.name} (${t.email})</li>`
                ).join('')}
            </ul>
        ` : '<p class="text-muted">No access restrictions for this domain</p>'}
    `;
    
    showModal('domainDetailsModal');
}

// Update restricted teachers count
function updateRestrictedTeachersCount() {
    // This is a simple count - in production you'd fetch from backend
    const restrictedTeachers = new Set();
    allDomains.forEach(d => {
        d.teachers_with_access.forEach(t => restrictedTeachers.add(t.id));
    });
    document.getElementById('restricted-teachers-count').textContent = restrictedTeachers.size;
}
</script>

        </div>


    <script>
        window.onload = async function() {
            await loadAdminName();
            await loadStatistics();
            await loadPendingTeachers();
            await loadTopicsDropdown(); // Load topics dynamically
        };

        async function loadAdminName() {
            try {
                const response = await fetch('/api/current-user');
                const user = await response.json();
                document.getElementById('adminName').textContent = user.full_name;
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function loadStatistics() {
            try {
                const response = await fetch('/api/admin/statistics');
                const stats = await response.json();

                let statsHTML = `
                    <div class="bg-blue-500 text-white rounded-lg p-6 shadow-lg">
                        <div class="text-4xl font-bold">${stats.total_students}</div>
                        <div class="text-sm opacity-90">Total Students</div>
                    </div>
                    <div class="bg-green-500 text-white rounded-lg p-6 shadow-lg">
                        <div class="text-4xl font-bold">${stats.total_teachers}</div>
                        <div class="text-sm opacity-90">Approved Teachers</div>
                    </div>
                    <div class="bg-yellow-500 text-white rounded-lg p-6 shadow-lg">
                        <div class="text-4xl font-bold">${stats.pending_teachers}</div>
                        <div class="text-sm opacity-90">Pending Approvals</div>
                    </div>
                    <div class="bg-purple-500 text-white rounded-lg p-6 shadow-lg">
                        <div class="text-4xl font-bold">${stats.total_classes}</div>
                        <div class="text-sm opacity-90">Total Classes</div>
                    </div>
                `;
                
                // Add prize statistics card if prize system is enabled
                if (stats.prize_stats) {
                    statsHTML += `
                        <div class="bg-pink-500 text-white rounded-lg p-6 shadow-lg cursor-pointer hover:bg-pink-600 transition" onclick="location.href='/admin/prizes'">
                            <div class="flex justify-between items-start mb-2">
                                <div class="text-3xl font-bold">${stats.prize_stats.active_prizes}</div>
                                <i class="fas fa-gift text-2xl opacity-75"></i>
                            </div>
                            <div class="text-sm opacity-90">Active Prizes</div>
                            <div class="mt-3 pt-3 border-t border-pink-400 text-xs opacity-90">
                                <div>${stats.prize_stats.total_schools} Schools ‚Ä¢ ${stats.prize_stats.pending_redemptions} Pending</div>
                            </div>
                        </div>
                    `;
                }
                
                document.getElementById('statsCards').innerHTML = statsHTML;
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }
        
        async function loadTopicsDropdown() {
            try {
                // Fetch all distinct topics from the database
                const response = await fetch('/api/admin/topics-list');
                const data = await response.json();
                
                const select = document.getElementById('filterTopic');
                
                // Keep the "All Topics" option
                select.innerHTML = '<option value="">All Topics</option>';
                
                // Add each topic from the database
                data.topics.forEach(topic => {
                    const option = document.createElement('option');
                    option.value = topic.value;
                    option.textContent = `${topic.name} (${topic.count})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading topics:', error);
                // Fall back to static list if API fails
                console.log('Using fallback topic list');
            }
        }

        async function loadPendingTeachers() {
            try {
                const response = await fetch('/api/admin/pending-teachers');
                const teachers = await response.json();

                const list = document.getElementById('pendingList');
                if (teachers.length === 0) {
                    list.innerHTML = '<p class="text-gray-600">No pending teacher approvals.</p>';
                } else {
                    list.innerHTML = teachers.map(t => `
                        <div class="flex justify-between items-center p-4 border-b">
                            <div>
                                <div class="font-semibold text-lg">${t.full_name}</div>
                                <div class="text-gray-600">${t.email}</div>
                                <div class="text-sm text-gray-500">Registered: ${new Date(t.created_at).toLocaleString()}</div>
                            </div>
                            <button onclick="approveTeacher(${t.id})"
                                    class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600">
                                <i class="fas fa-check mr-2"></i>Approve
                            </button>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function approveTeacher(teacherId) {
            if (!confirm('Approve this teacher account?')) return;

            try {
                const response = await fetch(`/api/admin/approve-teacher/${teacherId}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    alert('Teacher approved successfully!');
                    await loadPendingTeachers();
                    await loadStatistics();
                } else {
                    alert('Failed to approve teacher');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function filterUsers() {
            const role = document.getElementById('userRoleFilter').value;
            try {
                const url = role ? `/api/admin/all-users?role=${role}` : '/api/admin/all-users';
                const response = await fetch(url);
                const users = await response.json();

                const list = document.getElementById('usersList');
                list.innerHTML = `
                    <table class="w-full">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="px-4 py-2 text-left">Name</th>
                                <th class="px-4 py-2 text-left">Email</th>
                                <th class="px-4 py-2 text-left">Role</th>
                                <th class="px-4 py-2 text-left">Status</th>
                                <th class="px-4 py-2 text-left">Registered</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users.map(u => `
                                <tr class="border-b">
                                    <td class="px-4 py-3">${u.full_name}</td>
                                    <td class="px-4 py-3">${u.email}</td>
                                    <td class="px-4 py-3">
                                        <span class="px-2 py-1 rounded text-sm ${
                                            u.role === 'admin' ? 'bg-red-100 text-red-800' :
                                            u.role === 'teacher' ? 'bg-blue-100 text-blue-800' :
                                            'bg-green-100 text-green-800'
                                        }">${u.role}</span>
                                    </td>
                                    <td class="px-4 py-3">
                                        ${u.is_approved ?
                                            '<span class="text-green-600">‚úì Approved</span>' :
                                            '<span class="text-yellow-600">‚è≥ Pending</span>'}
                                    </td>
                                    <td class="px-4 py-3">${new Date(u.created_at).toLocaleDateString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function loadAllClasses() {
            try {
                const response = await fetch('/api/admin/all-classes');
                const classes = await response.json();

                const list = document.getElementById('classesList');
                if (classes.length === 0) {
                    list.innerHTML = '<p class="p-6 text-gray-600">No classes created yet.</p>';
                } else {
                    list.innerHTML = `
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="px-4 py-2 text-left">Class Name</th>
                                    <th class="px-4 py-2 text-left">Teacher</th>
                                    <th class="px-4 py-2 text-center">Students</th>
                                    <th class="px-4 py-2 text-left">Created</th>
                                    <th class="px-4 py-2 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${classes.map(c => `
                                    <tr class="border-b">
                                        <td class="px-4 py-3 font-semibold">${c.name}</td>
                                        <td class="px-4 py-3">${c.teacher_name || 'N/A'}</td>
                                        <td class="px-4 py-3 text-center">${c.student_count}</td>
                                        <td class="px-4 py-3">${new Date(c.created_at).toLocaleDateString()}</td>
                                        <td class="px-4 py-3 text-center">
                                            <button onclick="renameClass(${c.id}, '${c.name.replace(/'/g, "\\'")}')"
                                                    class="text-blue-600 hover:text-blue-800 mr-2">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function renameClass(classId, currentName) {
            const newName = prompt('Enter new class name:', currentName);
            if (!newName || newName === currentName) return;

            try {
                const response = await fetch(`/api/admin/rename-class/${classId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name: newName })
                });

                if (response.ok) {
                    alert('Class renamed successfully!');
                    await loadAllClasses();
                } else {
                    alert('Failed to rename class');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function loadClassComparison() {
            try {
                const response = await fetch('/api/admin/class-comparison');
                const data = await response.json();

                const container = document.getElementById('comparisonData');
                if (data.length === 0) {
                    container.innerHTML = '<p class="p-6 text-gray-600">No data available yet.</p>';
                } else {
                    container.innerHTML = `
                        <table class="w-full">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="px-4 py-2 text-left">Class Name</th>
                                    <th class="px-4 py-2 text-left">Teacher</th>
                                    <th class="px-4 py-2 text-center">Students</th>
                                    <th class="px-4 py-2 text-center">Total Quizzes</th>
                                    <th class="px-4 py-2 text-center">Avg Score</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.map(c => `
                                    <tr class="border-b">
                                        <td class="px-4 py-3 font-semibold">${c.class_name}</td>
                                        <td class="px-4 py-3">${c.teacher_name}</td>
                                        <td class="px-4 py-3 text-center">${c.student_count}</td>
                                        <td class="px-4 py-3 text-center">${c.total_quizzes}</td>
                                        <td class="px-4 py-3 text-center">
                                            <span class="px-3 py-1 rounded-full text-sm ${
                                                c.average_score >= 80 ? 'bg-green-100 text-green-800' :
                                                c.average_score >= 60 ? 'bg-yellow-100 text-yellow-800' :
                                                'bg-red-100 text-red-800'
                                            }">
                                                ${c.average_score.toFixed(1)}%
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function showTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => {
                el.classList.remove('border-purple-600', 'text-gray-800');
                el.classList.add('text-gray-600');
            });

            const tabContent = document.getElementById(tab + 'Content');
            tabContent.classList.remove('hidden');
            
            // Force visibility for domain management tab
            if (tab === 'domains') {
                tabContent.style.display = 'block';
                tabContent.style.visibility = 'visible';
                tabContent.style.opacity = '1';
            }
            
            document.getElementById(tab + 'Tab').classList.add('border-purple-600', 'text-gray-800');

            if (tab === 'classes') loadAllClasses();
            else if (tab === 'comparison') loadClassComparison();
            else if (tab === 'manageQuestions') loadQuestionsByFilter();
            else if (tab === 'questions') loadQuestionManagement();
            else if (tab === 'domains') {
                console.log('Domain tab activated - loading data...');
                refreshDomains();
                loadTeachersList();
                loadAccessRequests();
            }
            else if (tab === 'topicManagement') {
                console.log('Topic Management tab activated');
                loadStrandsAdmin();
                // Await loadTopicsAdmin before initializing generator to ensure topicsData is populated
                loadTopicsAdmin().then(() => {
                    initQuestionGenerator();
                });
            }
            else if (tab === 'userAnalytics') {
                console.log('User Analytics tab activated - loading data...');
                loadUserAnalyticsData();
            }
            else if (tab === 'puzzle') {
                console.log('Puzzle of the Week tab activated - loading data...');
                loadPuzzleData();
            }
            else if (tab === 'siteSettings') {
                console.log('Site Settings tab activated - loading data...');
                loadSiteSettings();
            }
            else if (tab === 'raffles') {
                console.log('Raffles tab activated - loading data...');
                loadRaffles();
                loadRaffleWinners();
            }
            else if (tab === 'resources') {
                console.log('Resources tab activated - loading data...');
                loadResourcesList();
            }
            else if (tab === 'emailReports') {
                console.log('Email Reports tab activated - loading data...');
                loadEmailReportsData();
            }
        }

        // ==================== MANAGE QUESTIONS FUNCTIONS ====================

        let allQuestionsData = [];
        let currentQuestionType = 'legacy'; // 'legacy', 'adaptive', or 'sec'

        // Switch between legacy, adaptive, and SEC questions
        async function switchQuestionType(type) {
            currentQuestionType = type;
            
            // Update toggle button styles
            const btnLegacy = document.getElementById('btnLegacyQuestions');
            const btnAdaptive = document.getElementById('btnAdaptiveQuestions');
            const btnSec = document.getElementById('btnSecQuestions');
            
            // Reset all buttons
            [btnLegacy, btnAdaptive, btnSec].forEach(btn => {
                btn.classList.remove('bg-purple-600', 'text-white');
                btn.classList.add('bg-white', 'text-purple-600');
            });
            
            if (type === 'legacy') {
                btnLegacy.classList.add('bg-purple-600', 'text-white');
                btnLegacy.classList.remove('bg-white', 'text-purple-600');
                
                // Show legacy-specific buttons
                document.getElementById('btnFindInvalid').style.display = '';
                document.getElementById('btnFindDuplicates').style.display = '';
                document.getElementById('difficultyLabel').textContent = 'Difficulty:';
                
                // Reset difficulty options for legacy
                const diffSelect = document.getElementById('filterDifficulty');
                diffSelect.innerHTML = `
                    <option value="">All Levels</option>
                    <option value="beginner">Beginner</option>
                    <option value="intermediate">Intermediate</option>
                    <option value="advanced">Advanced</option>
                `;
                
                // Load legacy topics
                await loadLegacyTopics();
            } else if (type === 'adaptive') {
                btnAdaptive.classList.add('bg-purple-600', 'text-white');
                btnAdaptive.classList.remove('bg-white', 'text-purple-600');
                
                // Hide legacy-specific buttons (not relevant for adaptive)
                document.getElementById('btnFindInvalid').style.display = 'none';
                document.getElementById('btnFindDuplicates').style.display = 'none';
                document.getElementById('difficultyLabel').textContent = 'Level Band:';
                
                // Update difficulty options for adaptive (level bands)
                const diffSelect = document.getElementById('filterDifficulty');
                diffSelect.innerHTML = `
                    <option value="">All Level Bands</option>
                    <option value="beginner">Beginner (1-3)</option>
                    <option value="intermediate">Intermediate (4-6)</option>
                    <option value="advanced">Advanced (7-9)</option>
                    <option value="mastery">Mastery (10)</option>
                `;
                
                // Load adaptive topics
                await loadAdaptiveTopics();
            } else if (type === 'sec') {
                btnSec.classList.add('bg-purple-600', 'text-white');
                btnSec.classList.remove('bg-white', 'text-purple-600');
                
                // Hide legacy-specific buttons
                document.getElementById('btnFindInvalid').style.display = 'none';
                document.getElementById('btnFindDuplicates').style.display = 'none';
                document.getElementById('difficultyLabel').textContent = 'Difficulty Band:';
                
                // Update difficulty options for SEC (Foundation/Ordinary/Higher)
                const diffSelect = document.getElementById('filterDifficulty');
                diffSelect.innerHTML = `
                    <option value="">All Bands</option>
                    <option value="foundation">Foundation (Levels 1-4)</option>
                    <option value="ordinary">Ordinary (Levels 5-8)</option>
                    <option value="higher">Higher (Levels 9-12)</option>
                `;
                
                // Load SEC topics
                await loadSecTopics();
            }
            
            // Clear search and reload questions
            document.getElementById('searchQuestion').value = '';
            document.getElementById('filterTopic').value = '';
            document.getElementById('filterDifficulty').value = '';
            await loadQuestionsByFilter();
        }

        // Load legacy topics into dropdown
        async function loadLegacyTopics() {
            try {
                const response = await fetch('/api/topics');
                const topics = await response.json();
                
                const select = document.getElementById('filterTopic');
                select.innerHTML = '<option value="">All Topics</option>';
                
                topics.forEach(t => {
                    const option = document.createElement('option');
                    option.value = t.id;
                    option.textContent = `${t.display_name} (${t.count || 0})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading legacy topics:', error);
            }
        }

        // Load adaptive topics into dropdown
        async function loadAdaptiveTopics() {
            try {
                const response = await fetch('/api/admin/adaptive-topics-list');
                const topics = await response.json();
                
                const select = document.getElementById('filterTopic');
                select.innerHTML = '<option value="">All Topics</option>';
                
                const topicNames = {
                    'fractions': 'Fractions',
                    'percentages': 'Percentages',
                    'ratio': 'Ratio',
                    'probability': 'Probability',
                    'sets': 'Sets & Venn Diagrams'
                };
                
                topics.forEach(t => {
                    const option = document.createElement('option');
                    option.value = t.topic;
                    option.textContent = `${topicNames[t.topic] || t.topic} (${t.count})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading adaptive topics:', error);
            }
        }

        // Load SEC exam topics into dropdown
        async function loadSecTopics() {
            try {
                const response = await fetch('/api/admin/adaptive-questions?mode=jc_exam&count_only=1');
                const data = await response.json();
                
                const select = document.getElementById('filterTopic');
                select.innerHTML = '<option value="">All Topics</option>';
                
                const topicNames = {
                    'fractions': 'Fractions',
                    'percentages': 'Percentages',
                    'ratio': 'Ratio',
                    'probability': 'Probability',
                    'sets': 'Sets & Venn Diagrams'
                };
                
                // Parse topic counts from response
                if (data.topics) {
                    data.topics.forEach(t => {
                        const option = document.createElement('option');
                        option.value = t.topic;
                        option.textContent = `${topicNames[t.topic] || t.topic} (${t.count})`;
                        select.appendChild(option);
                    });
                } else {
                    // Fallback - just show fractions since that's what we've generated
                    const option = document.createElement('option');
                    option.value = 'fractions';
                    option.textContent = 'Fractions (SEC)';
                    select.appendChild(option);
                }
            } catch (error) {
                console.error('Error loading SEC topics:', error);
                // Fallback
                const select = document.getElementById('filterTopic');
                select.innerHTML = '<option value="">All Topics</option><option value="fractions">Fractions (SEC)</option>';
            }
        }

        async function loadQuestionsByFilter() {
            const topic = document.getElementById('filterTopic').value;
            const difficulty = document.getElementById('filterDifficulty').value;

            try {
                let url;
                if (currentQuestionType === 'adaptive') {
                    url = '/api/admin/adaptive-questions?mode=practice&';
                    if (topic) url += `topic=${topic}&`;
                    if (difficulty) url += `level_band=${difficulty}`;
                } else if (currentQuestionType === 'sec') {
                    url = '/api/admin/adaptive-questions?mode=jc_exam&';
                    if (topic) url += `topic=${topic}&`;
                    if (difficulty) url += `difficulty_band=${difficulty}`;
                } else {
                    url = '/api/admin/all-questions?';
                    if (topic) url += `topic=${topic}&`;
                    if (difficulty) url += `difficulty=${difficulty}`;
                }

                const response = await fetch(url);
                allQuestionsData = await response.json();

                displayQuestions(allQuestionsData);
            } catch (error) {
                console.error('Error loading questions:', error);
                document.getElementById('questionsList').innerHTML = '<div class="text-center text-red-500 py-8">Error loading questions</div>';
            }
        }

        function filterQuestionsLocally() {
            const searchTerm = document.getElementById('searchQuestion').value.toLowerCase();

            if (!searchTerm) {
                displayQuestions(allQuestionsData);
                return;
            }

            const filtered = allQuestionsData.filter(q =>
                q.question.toLowerCase().includes(searchTerm) ||
                q.options.some(opt => opt.toLowerCase().includes(searchTerm))
            );

            displayQuestions(filtered);
        }

        function displayQuestions(questions) {
            const container = document.getElementById('questionsList');
            const countEl = document.getElementById('questionCount');
            const bulkBar = document.getElementById('bulkActionsBar');
            const duplicateInfo = document.getElementById('duplicateInfo');
            const selectDuplicatesBtn = document.getElementById('selectDuplicatesBtn');

            countEl.textContent = questions.length;
            
            // Hide duplicate-specific elements
            duplicateInfo.classList.add('hidden');
            selectDuplicatesBtn.classList.add('hidden');

            if (questions.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8"><i class="fas fa-search text-4xl mb-3"></i><p>No questions found</p></div>';
                bulkBar.classList.add('hidden');
                return;
            }

            // Show bulk actions bar when questions are displayed (only for legacy)
            if (currentQuestionType === 'legacy') {
                bulkBar.classList.remove('hidden');
                clearSelection();
            } else {
                bulkBar.classList.add('hidden');
            }

            container.innerHTML = questions.map((q, index) => {
                const isAdaptive = q.is_adaptive || currentQuestionType === 'adaptive' || currentQuestionType === 'sec';
                const isSec = currentQuestionType === 'sec';
                
                const difficultyColors = {
                    'beginner': 'bg-green-100 text-green-800',
                    'intermediate': 'bg-yellow-100 text-yellow-800',
                    'advanced': 'bg-red-100 text-red-800',
                    'mastery': 'bg-purple-100 text-purple-800',
                    'foundation': 'bg-green-100 text-green-800',
                    'ordinary': 'bg-blue-100 text-blue-800',
                    'higher': 'bg-red-100 text-red-800'
                };

                const topicIcons = {
                    'arithmetic': 'fa-calculator',
                    'fractions': 'fa-divide',
                    'decimals': 'fa-percent',
                    'percentages': 'fa-percent',
                    'multiplication_division': 'fa-times',
                    'number_systems': 'fa-hashtag',
                    'bodmas': 'fa-list-ol',
                    'patterns': 'fa-th',
                    'introductory_algebra': 'fa-superscript',
                    'functions': 'fa-chart-line',
                    'surds': 'fa-square-root-alt',
                    'sets': 'fa-circle-notch',
                    'complex_numbers_intro': 'fa-infinity',
                    'complex_numbers_expanded': 'fa-infinity',
                    'complex_numbers': 'fa-infinity',
                    'descriptive_statistics': 'fa-chart-bar',
                    'probability': 'fa-dice',
                    'geometry': 'fa-shapes',
                    'trigonometry': 'fa-drafting-compass',
                    'algebra': 'fa-function'
                };

                // Handle adaptive vs legacy differences
                const difficulty = isAdaptive ? (q.level_band || q.difficulty || 'beginner') : q.difficulty;
                const hasImage = isAdaptive ? q.has_svg : (q.image_url || q.has_image);
                const hasHint = q.hint_text || q.has_hint;

                if (isAdaptive) {
                    // Adaptive/SEC question card
                    const badgeClass = isSec ? 'bg-blue-100 text-blue-800' : 'bg-purple-100 text-purple-800';
                    const badgeIcon = isSec ? 'fa-graduation-cap' : 'fa-bolt';
                    const badgeText = isSec ? 'SEC EXAM' : 'ADAPTIVE';
                    const borderColor = isSec ? 'border-blue-500' : 'border-purple-500';
                    
                    return `
                        <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow question-card border-l-4 ${borderColor}" data-question-id="${q.id}">
                            <div class="flex justify-between items-start mb-4">
                                <div class="flex items-start gap-3 flex-1">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-2 flex-wrap">
                                            <span class="${badgeClass} px-3 py-1 rounded-full text-sm font-semibold">
                                                <i class="fas ${badgeIcon} mr-1"></i>${badgeText}
                                            </span>
                                            <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">
                                                <i class="fas ${topicIcons[q.topic] || 'fa-book'} mr-1"></i>${q.topic}
                                            </span>
                                            <span class="${difficultyColors[difficulty] || difficultyColors[q.difficulty_band] || 'bg-gray-100 text-gray-800'} px-3 py-1 rounded-full text-sm font-semibold">
                                                ${(q.difficulty_band || difficulty || 'unknown').charAt(0).toUpperCase() + (q.difficulty_band || difficulty || 'unknown').slice(1)}
                                            </span>
                                            <span class="bg-indigo-100 text-indigo-800 px-2 py-1 rounded text-xs">
                                                Level ${q.level || '?'}
                                            </span>
                                            <span class="text-gray-500 text-sm">ID: ${q.id}</span>
                                            ${q.has_svg ? '<span class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-xs" title="Has SVG visual"><i class="fas fa-image"></i> SVG</span>' : ''}
                                        </div>
                                    </div>
                                </div>
                                <button onclick="openAdaptiveQuestionEditor(${q.id})" class="${isSec ? 'bg-blue-600 hover:bg-blue-700' : 'bg-purple-600 hover:bg-purple-700'} text-white px-4 py-2 rounded-lg">
                                    <i class="fas fa-edit mr-2"></i>Edit
                                </button>
                            </div>

                            ${q.has_svg && q.image_svg ? `<div class="mb-4 text-center bg-gray-50 p-4 rounded-lg">${q.image_svg}</div>` : ''}

                            <div class="mb-4">
                                <div class="font-semibold text-gray-700 mb-2">Question:</div>
                                <div class="text-gray-800 bg-gray-50 p-3 rounded-lg">${q.question || q.question_text}</div>
                            </div>

                            <div class="grid grid-cols-2 gap-3 mb-4">
                                ${q.options.map((opt, i) => `
                                    <div class="flex items-center gap-2 p-2 rounded ${i === q.correct ? 'bg-green-50 border-2 border-green-500' : 'bg-gray-50'}">
                                        <span class="font-semibold ${i === q.correct ? 'text-green-700' : 'text-gray-600'}">
                                            ${String.fromCharCode(65 + i)})
                                        </span>
                                        <span class="${i === q.correct ? 'text-green-700 font-semibold' : 'text-gray-700'}">
                                            ${opt}
                                        </span>
                                        ${i === q.correct ? '<i class="fas fa-check text-green-600 ml-auto"></i>' : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    // Legacy question card (original code)
                    return `
                        <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow question-card" data-question-id="${q.id}">
                            <div class="flex justify-between items-start mb-4">
                                <div class="flex items-start gap-3 flex-1">
                                    <label class="flex items-center cursor-pointer mt-1">
                                        <input type="checkbox" class="question-checkbox w-5 h-5 rounded border-gray-300 text-purple-600 focus:ring-purple-500" 
                                               data-question-id="${q.id}" onchange="updateSelectionCount()">
                                    </label>
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-2 flex-wrap">
                                            <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">
                                                <i class="fas ${topicIcons[q.topic] || 'fa-book'} mr-1"></i>${q.topic.charAt(0).toUpperCase() + q.topic.slice(1)}
                                            </span>
                                            <span class="${difficultyColors[q.difficulty]} px-3 py-1 rounded-full text-sm font-semibold">
                                                ${q.difficulty.charAt(0).toUpperCase() + q.difficulty.slice(1)}
                                            </span>
                                            <span class="text-gray-500 text-sm">ID: ${q.id}</span>
                                            ${hasImage ? '<span class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-xs" title="Has image"><i class="fas fa-image"></i></span>' : ''}
                                            ${hasHint ? '<span class="bg-yellow-50 text-yellow-600 px-2 py-1 rounded text-xs" title="Has hint"><i class="fas fa-lightbulb"></i></span>' : ''}
                                        </div>
                                    </div>
                                </div>
                                <button onclick="openQuestionEditor(${q.id})" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                                    <i class="fas fa-edit mr-2"></i>Edit
                                </button>
                            </div>

                            ${hasImage ? `<div class="mb-4 ml-8"><img src="${q.image_url}" alt="Question image" class="max-h-32 rounded-lg border"></div>` : ''}

                            <div class="mb-4 ml-8">
                                <div class="font-semibold text-gray-700 mb-2">Question:</div>
                                <div class="text-gray-800 bg-gray-50 p-3 rounded-lg">${q.question}</div>
                            </div>

                            <div class="grid grid-cols-2 gap-3 mb-4 ml-8">
                                ${q.options.map((opt, i) => `
                                    <div class="flex items-center gap-2 p-2 rounded ${i === q.correct ? 'bg-green-50 border-2 border-green-500' : 'bg-gray-50'}">
                                        <span class="font-semibold ${i === q.correct ? 'text-green-700' : 'text-gray-600'}">
                                            ${String.fromCharCode(65 + i)})
                                        </span>
                                        <span class="${i === q.correct ? 'text-green-700 font-semibold' : 'text-gray-700'}">
                                            ${opt}
                                        </span>
                                        ${i === q.correct ? '<i class="fas fa-check text-green-600 ml-auto"></i>' : ''}
                                    </div>
                                `).join('')}
                            </div>

                            <div class="bg-blue-50 p-3 rounded-lg ml-8">
                                <div class="font-semibold text-blue-900 text-sm mb-1">Explanation:</div>
                                <div class="text-blue-800 text-sm">${q.explanation}</div>
                            </div>
                            
                            ${hasHint ? `
                            <div class="mt-3 bg-yellow-50 p-3 rounded-lg ml-8">
                                <div class="font-semibold text-yellow-900 text-sm mb-1"><i class="fas fa-lightbulb mr-1"></i>Hint (-${q.hint_penalty || 50}%):</div>
                                <div class="text-yellow-800 text-sm">${q.hint_text}</div>
                            </div>
                            ` : ''}
                        </div>
                    `;
                }
            }).join('');
        }

        // Open adaptive question editor
        async function openAdaptiveQuestionEditor(questionId) {
            try {
                const response = await fetch(`/api/admin/adaptive-question/${questionId}`);
                const data = await response.json();
                const q = data.question;

                // Populate adaptive edit modal
                document.getElementById('adaptiveEditQuestionId').value = q.id;
                document.getElementById('adaptiveEditQuestionText').value = q.question_text || '';
                document.getElementById('adaptiveEditOptionA').value = q.option_a || '';
                document.getElementById('adaptiveEditOptionB').value = q.option_b || '';
                document.getElementById('adaptiveEditOptionC').value = q.option_c || '';
                document.getElementById('adaptiveEditOptionD').value = q.option_d || '';
                document.getElementById('adaptiveEditCorrectAnswer').value = q.correct_answer || 'A';
                document.getElementById('adaptiveEditTopic').textContent = q.topic || 'Unknown';
                document.getElementById('adaptiveEditLevel').textContent = `Level ${q.level || '?'} (${q.level_band || 'Unknown'})`;
                document.getElementById('adaptiveEditNotes').value = '';
                
                // Show SVG if present
                const svgContainer = document.getElementById('adaptiveEditSvgPreview');
                if (q.image_svg) {
                    svgContainer.innerHTML = q.image_svg;
                    svgContainer.style.display = 'block';
                } else {
                    svgContainer.style.display = 'none';
                }

                // Show any pending flags
                const flagsHtml = data.flags && data.flags.length > 0 ? `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                        <div class="font-semibold text-red-800 mb-2">
                            <i class="fas fa-flag mr-2"></i>${data.flags.filter(f => f.status === 'pending').length} Pending Flag(s):
                        </div>
                        ${data.flags.filter(f => f.status === 'pending').map(f => `
                            <div class="text-sm text-red-700 mb-1">
                                <span class="font-semibold">${f.flag_type}:</span> ${f.description}
                            </div>
                        `).join('')}
                    </div>
                ` : '';
                document.getElementById('adaptiveEditQuestionFlags').innerHTML = flagsHtml;

                // Show modal
                document.getElementById('adaptiveEditQuestionModal').classList.remove('hidden');
                document.getElementById('adaptiveEditQuestionModal').classList.add('flex');
            } catch (error) {
                console.error('Error loading adaptive question:', error);
                alert('Error loading question details');
            }
        }

        function hideAdaptiveEditModal() {
            document.getElementById('adaptiveEditQuestionModal').classList.add('hidden');
            document.getElementById('adaptiveEditQuestionModal').classList.remove('flex');
        }

        // Save adaptive question edits
        async function saveAdaptiveQuestion() {
            const questionId = document.getElementById('adaptiveEditQuestionId').value;
            
            const data = {
                question_text: document.getElementById('adaptiveEditQuestionText').value,
                option_a: document.getElementById('adaptiveEditOptionA').value,
                option_b: document.getElementById('adaptiveEditOptionB').value,
                option_c: document.getElementById('adaptiveEditOptionC').value,
                option_d: document.getElementById('adaptiveEditOptionD').value,
                correct_answer: document.getElementById('adaptiveEditCorrectAnswer').value,
                admin_notes: document.getElementById('adaptiveEditNotes').value
            };
            
            try {
                const response = await fetch(`/api/admin/adaptive-question/${questionId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    alert('Adaptive question updated successfully!');
                    hideAdaptiveEditModal();
                    loadQuestionsByFilter();
                } else {
                    const error = await response.json();
                    alert(error.error || 'Failed to update question');
                }
            } catch (error) {
                console.error('Error saving adaptive question:', error);
                alert('Error saving question');
            }
        }

        async function openQuestionEditor(questionId) {
            try {
                const response = await fetch(`/api/admin/question/${questionId}`);
                const data = await response.json();
                const q = data.question;

                // Populate form
                document.getElementById('editQuestionId').value = q.id;
                document.getElementById('editTopic').value = q.topic;
                document.getElementById('editDifficulty').value = q.difficulty;
                document.getElementById('editQuestionText').value = q.question;
                document.getElementById('editOptionA').value = q.options[0];
                document.getElementById('editOptionB').value = q.options[1];
                document.getElementById('editOptionC').value = q.options[2];
                document.getElementById('editOptionD').value = q.options[3];
                document.getElementById('editCorrectAnswer').value = q.correct;
                document.getElementById('editExplanation').value = q.explanation;
                document.getElementById('editNotes').value = '';
                
                // Load image and hint data
                loadQuestionImageAndHint(q);

                // Show any pending flags
                const flagsHtml = data.flags && data.flags.length > 0 ? data.flags.filter(f => f.status === 'pending').map(f => `
                    <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg mb-2">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-sm font-semibold">${f.user_name}</span>
                            <span class="text-xs text-gray-600">${f.flag_type}</span>
                        </div>
                        <div class="text-sm text-gray-700">"${f.description}"</div>
                    </div>
                `).join('') : '<div class="text-sm text-gray-600">No pending flags</div>';

                document.getElementById('editQuestionFlags').innerHTML = `
                    <div class="mb-4">
                        <div class="font-semibold mb-2">Pending Flags:</div>
                        ${flagsHtml}
                    </div>
                `;

                // Store flag IDs for resolution
                flagsToResolve = data.flags ? data.flags.filter(f => f.status === 'pending').map(f => f.id) : [];

                // Show edit history
                if (data.edit_history && data.edit_history.length > 0) {
                    const historyHtml = `
                        <div class="border-t pt-4 mt-4">
                            <h3 class="font-semibold mb-3">Edit History</h3>
                            <div class="space-y-2 max-h-40 overflow-y-auto">
                                ${data.edit_history.map(edit => `
                                    <div class="text-sm p-2 bg-gray-50 rounded">
                                        <div class="font-semibold">${edit.edited_by} - ${new Date(edit.edited_at).toLocaleString()}</div>
                                        ${edit.edit_notes ? `<div class="text-gray-600">${edit.edit_notes}</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    document.getElementById('editHistory').innerHTML = historyHtml;
                } else {
                    document.getElementById('editHistory').innerHTML = '';
                }

                // Show modal
                document.getElementById('editQuestionModal').classList.remove('hidden');
                document.getElementById('editQuestionModal').classList.add('flex');
            } catch (error) {
                console.error('Error loading question:', error);
                alert('Error loading question details');
            }
        }

        // ==================== QUESTION FLAG FUNCTIONS ====================

        let currentFilteredFlags = [];
        let currentQuestionId = null;
        let flagsToResolve = [];

        async function loadQuestionManagement() {
            await loadFlagStatistics();
            await loadPendingFlagsCount();
            await filterFlags('pending');
        }

        async function loadFlagStatistics() {
            try {
                const response = await fetch('/api/admin/flags/statistics');
                const stats = await response.json();

                document.getElementById('statPendingFlags').textContent = stats.pending_flags;
                document.getElementById('statFlaggedQuestions').textContent = stats.flagged_questions;
                document.getElementById('statResolvedFlags').textContent = stats.resolved_flags;
                document.getElementById('statTotalEdits').textContent = stats.total_edits;
            } catch (error) {
                console.error('Error loading flag statistics:', error);
            }
        }

        async function loadPendingFlagsCount() {
            try {
                const response = await fetch('/api/admin/flags/statistics');
                const stats = await response.json();

                const badge = document.getElementById('pendingFlagsCount');
                if (stats.pending_flags > 0) {
                    badge.textContent = stats.pending_flags;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error loading pending flags count:', error);
            }
        }

        async function filterFlags(status) {
            // Update filter button styles
            document.querySelectorAll('.flag-filter').forEach(btn => {
                btn.classList.remove('border-red-600', 'border-green-600', 'border-gray-600', 'border-blue-600');
                btn.classList.add('text-gray-600');
            });

            const activeBtn = document.getElementById('filter' + status.charAt(0).toUpperCase() + status.slice(1));
            activeBtn.classList.remove('text-gray-600');
            activeBtn.classList.add('text-gray-800');

            if (status === 'pending') activeBtn.classList.add('border-red-600');
            else if (status === 'resolved') activeBtn.classList.add('border-green-600');
            else if (status === 'dismissed') activeBtn.classList.add('border-gray-600');
            else activeBtn.classList.add('border-blue-600');

            // Load flags
            try {
                const url = status === 'all' ? '/api/admin/flags/all' : `/api/admin/flags/all?status=${status}`;
                const response = await fetch(url);
                currentFilteredFlags = await response.json();

                displayFlags(currentFilteredFlags);
            } catch (error) {
                console.error('Error loading flags:', error);
            }
        }

        function displayFlags(flags) {
            const container = document.getElementById('flagsList');

            if (flags.length === 0) {
                container.innerHTML = '<div class="bg-white rounded-lg shadow-md p-8 text-center text-gray-600">No flags found</div>';
                return;
            }

            container.innerHTML = flags.map(flag => {
                const statusColor = flag.status === 'pending' ? 'red' : flag.status === 'resolved' ? 'green' : 'gray';
                const typeIcons = {
                    'incorrect': 'fa-times-circle',
                    'ambiguous': 'fa-question-circle',
                    'typo': 'fa-spell-check',
                    'other': 'fa-exclamation-circle'
                };
                
                // Determine question type (legacy, adaptive, or SEC)
                const isAdaptive = flag.is_adaptive || flag.question?.is_adaptive;
                const isSec = flag.question?.mode === 'jc_exam';
                
                // Question type badge
                let typeBadge = '';
                let editFunction = '';
                let editBtnClass = 'bg-blue-600 hover:bg-blue-700';
                
                if (isSec) {
                    typeBadge = '<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-semibold"><i class="fas fa-graduation-cap mr-1"></i>SEC EXAM</span>';
                    editFunction = `openAdaptiveQuestionEditor(${flag.question_id})`;
                    editBtnClass = 'bg-blue-600 hover:bg-blue-700';
                } else if (isAdaptive) {
                    typeBadge = '<span class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs font-semibold"><i class="fas fa-bolt mr-1"></i>ADAPTIVE</span>';
                    editFunction = `openAdaptiveQuestionEditor(${flag.question_id})`;
                    editBtnClass = 'bg-purple-600 hover:bg-purple-700';
                } else {
                    typeBadge = '<span class="bg-gray-100 text-gray-800 px-2 py-1 rounded text-xs font-semibold"><i class="fas fa-database mr-1"></i>LEGACY</span>';
                    editFunction = `openEditQuestion(${flag.question_id})`;
                    editBtnClass = 'bg-blue-600 hover:bg-blue-700';
                }

                return `
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2 flex-wrap">
                                    <span class="bg-${statusColor}-100 text-${statusColor}-800 px-3 py-1 rounded-full text-sm font-semibold">
                                        ${flag.status.toUpperCase()}
                                    </span>
                                    <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">
                                        <i class="fas ${typeIcons[flag.flag_type]}"></i> ${flag.flag_type}
                                    </span>
                                    ${typeBadge}
                                    ${flag.question?.topic ? `<span class="bg-indigo-50 text-indigo-700 px-2 py-1 rounded text-xs">${flag.question.topic}</span>` : ''}
                                </div>
                                <div class="text-sm text-gray-600">
                                    Reported by <strong>${flag.user_name}</strong> on ${new Date(flag.created_at).toLocaleDateString()}
                                </div>
                            </div>
                        </div>

                        <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                            <div class="font-semibold mb-2">Question:</div>
                            <div class="text-gray-700 mb-3">${flag.question.question}</div>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                ${flag.question.options.map((opt, i) => `
                                    <div class="${i === flag.question.correct ? 'text-green-600 font-semibold' : ''}">
                                        ${String.fromCharCode(65 + i)}) ${opt}
                                        ${i === flag.question.correct ? '<i class="fas fa-check ml-1"></i>' : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="font-semibold mb-1">Issue Description:</div>
                            <div class="text-gray-700 italic">"${flag.description}"</div>
                        </div>

                        ${flag.admin_notes ? `
                            <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                                <div class="font-semibold text-sm mb-1">Admin Notes:</div>
                                <div class="text-sm text-gray-700">${flag.admin_notes}</div>
                            </div>
                        ` : ''}

                        ${flag.status === 'pending' ? `
                            <div class="flex gap-3">
                                <button onclick="${editFunction}"
                                        class="flex-1 ${editBtnClass} text-white py-2 rounded-lg">
                                    <i class="fas fa-edit mr-2"></i>Edit Question
                                </button>
                                <button onclick="dismissFlag(${flag.id}, ${isAdaptive || isSec})"
                                        class="flex-1 bg-gray-400 text-white py-2 rounded-lg hover:bg-gray-500">
                                    <i class="fas fa-ban mr-2"></i>Dismiss Flag
                                </button>
                            </div>
                        ` : `
                            <div class="text-sm text-gray-600">
                                ${flag.status === 'resolved' ?
                                    `‚úì Resolved by ${flag.resolver_name} on ${new Date(flag.resolved_at).toLocaleDateString()}` :
                                    `‚úó Dismissed on ${new Date(flag.resolved_at).toLocaleDateString()}`
                                }
                            </div>
                        `}
                    </div>
                `;
            }).join('');
        }

        async function openEditQuestion(questionId) {
            currentQuestionId = questionId;

            try {
                const response = await fetch(`/api/admin/question/${questionId}`);
                const data = await response.json();

                // Populate form
                document.getElementById('editQuestionId').value = questionId;
                document.getElementById('editTopic').value = data.question.topic;
                document.getElementById('editDifficulty').value = data.question.difficulty;
                document.getElementById('editQuestionText').value = data.question.question;
                document.getElementById('editOptionA').value = data.question.options[0];
                document.getElementById('editOptionB').value = data.question.options[1];
                document.getElementById('editOptionC').value = data.question.options[2];
                document.getElementById('editOptionD').value = data.question.options[3];
                document.getElementById('editCorrectAnswer').value = data.question.correct;
                document.getElementById('editExplanation').value = data.question.explanation;
                document.getElementById('editNotes').value = '';
                
                // Load image and hint data
                loadQuestionImageAndHint(data.question);
                
                // Log for debugging
                console.log('Loaded question:', data.question.topic, data.question.difficulty, 'Image:', data.question.image_url);

                // Show flags for this question
                const flagsHtml = data.flags.filter(f => f.status === 'pending').map(f => `
                    <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg mb-2">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-sm font-semibold">${f.user_name}</span>
                            <span class="text-xs text-gray-600">${f.flag_type}</span>
                        </div>
                        <div class="text-sm text-gray-700">"${f.description}"</div>
                    </div>
                `).join('');

                document.getElementById('editQuestionFlags').innerHTML = flagsHtml || '<div class="text-sm text-gray-600">No pending flags for this question</div>';

                // Store flag IDs to resolve
                flagsToResolve = data.flags.filter(f => f.status === 'pending').map(f => f.id);

                // Show edit history
                if (data.edit_history.length > 0) {
                    const historyHtml = `
                        <div class="border-t pt-4">
                            <h3 class="font-semibold mb-3">Edit History</h3>
                            <div class="space-y-2">
                                ${data.edit_history.map(edit => `
                                    <div class="text-sm p-2 bg-gray-50 rounded">
                                        <div class="font-semibold">${edit.edited_by} - ${new Date(edit.edited_at).toLocaleString()}</div>
                                        ${edit.edit_notes ? `<div class="text-gray-600">${edit.edit_notes}</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    document.getElementById('editHistory').innerHTML = historyHtml;
                } else {
                    document.getElementById('editHistory').innerHTML = '';
                }

                // Show modal
                document.getElementById('editQuestionModal').classList.remove('hidden');
                document.getElementById('editQuestionModal').classList.add('flex');
            } catch (error) {
                console.error('Error loading question:', error);
                alert('Error loading question details');
            }
        }

        function hideEditModal() {
            document.getElementById('editQuestionModal').classList.add('hidden');
            document.getElementById('editQuestionModal').classList.remove('flex');
            currentQuestionId = null;
            flagsToResolve = [];
            // Clear image/hint fields
            clearImagePreview();
            document.getElementById('editHintText').value = '';
            document.getElementById('editHintPenalty').value = '50';
        }

        async function deleteQuestion() {
            const questionId = document.getElementById('editQuestionId').value;
            const questionText = document.getElementById('editQuestionText').value;
            
            if (!questionId) {
                alert('No question selected');
                return;
            }
            
            // Show confirmation dialog with question preview
            const confirmMessage = `Are you sure you want to DELETE this question?\n\n"${questionText.substring(0, 100)}${questionText.length > 100 ? '...' : ''}"\n\nThis action CANNOT be undone!`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Double confirmation for safety
            if (!confirm('This is your final warning. Click OK to permanently delete this question.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/question/${questionId}/delete`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Question deleted successfully');
                    hideEditModal();
                    // Refresh the questions list if viewing flagged questions
                    if (typeof loadFlaggedQuestions === 'function') {
                        loadFlaggedQuestions();
                    }
                    // Refresh topics list to update counts
                    if (typeof loadTopicsAdmin === 'function') {
                        loadTopicsAdmin();
                    }
                    // Refresh questions list in manage tab
                    if (typeof loadQuestionsByFilter === 'function') {
                        loadQuestionsByFilter();
                    }
                } else {
                    alert('Error deleting question: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Network error: ' + error.message);
            }
        }

        // ==================== BULK SELECTION FUNCTIONS ====================
        
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllQuestions');
            const checkboxes = document.querySelectorAll('.question-checkbox');
            
            checkboxes.forEach(cb => {
                cb.checked = selectAllCheckbox.checked;
            });
            
            updateSelectionCount();
        }
        
        function updateSelectionCount() {
            const checkboxes = document.querySelectorAll('.question-checkbox:checked');
            const count = checkboxes.length;
            const countEl = document.getElementById('selectedCount');
            const deleteBtn = document.getElementById('bulkDeleteBtn');
            const selectAllCheckbox = document.getElementById('selectAllQuestions');
            
            countEl.textContent = `${count} selected`;
            deleteBtn.disabled = count === 0;
            
            // Update "select all" checkbox state
            const totalCheckboxes = document.querySelectorAll('.question-checkbox').length;
            if (count === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (count === totalCheckboxes) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
        }
        
        function clearSelection() {
            const checkboxes = document.querySelectorAll('.question-checkbox');
            const selectAllCheckbox = document.getElementById('selectAllQuestions');
            
            checkboxes.forEach(cb => cb.checked = false);
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            }
            
            updateSelectionCount();
        }
        
        function getSelectedQuestionIds() {
            const checkboxes = document.querySelectorAll('.question-checkbox:checked');
            return Array.from(checkboxes).map(cb => parseInt(cb.dataset.questionId));
        }
        
        async function deleteSelectedQuestions() {
            const selectedIds = getSelectedQuestionIds();
            
            if (selectedIds.length === 0) {
                alert('No questions selected');
                return;
            }
            
            // Get some question info for the confirmation
            const selectedCards = document.querySelectorAll('.question-card');
            let previewText = '';
            let count = 0;
            selectedCards.forEach(card => {
                const id = parseInt(card.dataset.questionId);
                if (selectedIds.includes(id) && count < 3) {
                    const questionDiv = card.querySelector('.text-gray-800.bg-gray-50');
                    if (questionDiv) {
                        const text = questionDiv.textContent.substring(0, 50);
                        previewText += `‚Ä¢ ${text}...\n`;
                        count++;
                    }
                }
            });
            
            if (selectedIds.length > 3) {
                previewText += `‚Ä¢ ... and ${selectedIds.length - 3} more\n`;
            }
            
            // Confirmation
            const confirmMessage = `Are you sure you want to DELETE ${selectedIds.length} question(s)?\n\n${previewText}\nThis action CANNOT be undone!`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Double confirmation for bulk delete
            if (!confirm(`FINAL WARNING: You are about to permanently delete ${selectedIds.length} question(s). Click OK to proceed.`)) {
                return;
            }
            
            // Show progress
            const deleteBtn = document.getElementById('bulkDeleteBtn');
            const originalText = deleteBtn.innerHTML;
            deleteBtn.disabled = true;
            deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Deleting...';
            
            try {
                const response = await fetch('/api/admin/questions/bulk-delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question_ids: selectedIds })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Successfully deleted ${result.deleted} question(s).${result.failed > 0 ? ` ${result.failed} failed.` : ''}`);
                    
                    // Refresh the questions list
                    loadQuestionsByFilter();
                    
                    // Refresh topics list to update counts
                    if (typeof loadTopicsAdmin === 'function') {
                        loadTopicsAdmin();
                    }
                } else {
                    alert('Error deleting questions: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Network error: ' + error.message);
            } finally {
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalText;
            }
        }

        // ==================== DUPLICATE FINDER FUNCTIONS ====================
        
        async function findDuplicateQuestions() {
            const topic = document.getElementById('filterTopic').value;
            const container = document.getElementById('questionsList');
            const bulkBar = document.getElementById('bulkActionsBar');
            const duplicateInfo = document.getElementById('duplicateInfo');
            const duplicateCount = document.getElementById('duplicateCount');
            
            // Show loading state
            container.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-4xl text-orange-500 mb-3"></i>
                    <p class="text-gray-600">Scanning for duplicate questions...</p>
                </div>
            `;
            
            try {
                let url = '/api/admin/questions/find-duplicates';
                if (topic) {
                    url += `?topic=${encodeURIComponent(topic)}`;
                }
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.error) {
                    container.innerHTML = `<div class="text-center text-red-500 py-8"><i class="fas fa-exclamation-circle text-4xl mb-3"></i><p>${result.error}</p></div>`;
                    return;
                }
                
                if (!result.duplicate_groups || result.duplicate_groups.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-green-600 py-8">
                            <i class="fas fa-check-circle text-4xl mb-3"></i>
                            <p class="font-semibold">No duplicate questions found!</p>
                            <p class="text-gray-500 mt-2">${topic ? `Scanned ${result.total_scanned || 0} questions in "${topic}"` : `Scanned ${result.total_scanned || 0} questions across all topics`}</p>
                        </div>
                    `;
                    duplicateInfo.classList.add('hidden');
                    bulkBar.classList.add('hidden');
                    return;
                }
                
                // Show duplicate info
                duplicateInfo.classList.remove('hidden');
                duplicateCount.textContent = result.duplicate_groups.length;
                
                // Show bulk actions bar and Select All Duplicates button
                bulkBar.classList.remove('hidden');
                document.getElementById('selectDuplicatesBtn').classList.remove('hidden');
                clearSelection();
                
                // Update question count
                const totalDuplicates = result.duplicate_groups.reduce((sum, group) => sum + group.questions.length, 0);
                document.getElementById('questionCount').textContent = totalDuplicates;
                
                // Display grouped duplicates
                container.innerHTML = result.duplicate_groups.map((group, groupIndex) => {
                    const difficultyColors = {
                        'beginner': 'bg-green-100 text-green-800',
                        'intermediate': 'bg-yellow-100 text-yellow-800',
                        'advanced': 'bg-red-100 text-red-800'
                    };
                    
                    return `
                        <div class="bg-orange-50 border-2 border-orange-300 rounded-lg p-4 mb-4">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-copy text-orange-500"></i>
                                    <span class="font-bold text-orange-700">Duplicate Group ${groupIndex + 1}</span>
                                    <span class="bg-orange-200 text-orange-800 px-2 py-1 rounded text-sm">${group.questions.length} copies</span>
                                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm">${group.topic}</span>
                                </div>
                                <button onclick="selectDuplicateGroup(${groupIndex}, true)" class="text-sm bg-orange-200 text-orange-800 px-3 py-1 rounded hover:bg-orange-300">
                                    Select All But First
                                </button>
                            </div>
                            <div class="bg-white p-3 rounded mb-3 text-sm text-gray-700">
                                <strong>Question:</strong> ${group.question_text.substring(0, 150)}${group.question_text.length > 150 ? '...' : ''}
                            </div>
                            <div class="space-y-2">
                                ${group.questions.map((q, qIndex) => `
                                    <div class="flex items-center gap-3 p-2 rounded ${qIndex === 0 ? 'bg-green-50 border border-green-300' : 'bg-gray-50'} question-card" data-question-id="${q.id}" data-group-index="${groupIndex}">
                                        <input type="checkbox" class="question-checkbox w-5 h-5 rounded border-gray-300 text-purple-600 focus:ring-purple-500" 
                                               data-question-id="${q.id}" onchange="updateSelectionCount()">
                                        <span class="text-gray-500 text-sm w-16">ID: ${q.id}</span>
                                        <span class="${difficultyColors[q.difficulty]} px-2 py-1 rounded text-xs">${q.difficulty}</span>
                                        ${q.image_url ? '<span class="text-blue-500 text-xs"><i class="fas fa-image"></i></span>' : ''}
                                        ${qIndex === 0 ? '<span class="bg-green-200 text-green-800 px-2 py-1 rounded text-xs ml-auto">KEEP (oldest)</span>' : '<span class="bg-red-100 text-red-600 px-2 py-1 rounded text-xs ml-auto">duplicate</span>'}
                                        <button onclick="openQuestionEditor(${q.id})" class="text-purple-600 hover:text-purple-800 text-sm">
                                            <i class="fas fa-edit"></i> View
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                container.innerHTML = `<div class="text-center text-red-500 py-8"><i class="fas fa-exclamation-circle text-4xl mb-3"></i><p>Error: ${error.message}</p></div>`;
            }
        }
        
        function selectDuplicateGroup(groupIndex, skipFirst = true) {
            // Select all questions in a duplicate group except the first one
            const groupCards = document.querySelectorAll(`.question-card[data-group-index="${groupIndex}"]`);
            
            groupCards.forEach((card, index) => {
                const checkbox = card.querySelector('.question-checkbox');
                if (checkbox) {
                    // Skip first if requested (to keep the original)
                    checkbox.checked = skipFirst ? (index > 0) : true;
                }
            });
            
            updateSelectionCount();
        }
        
        function selectAllDuplicates() {
            // Select all duplicates except the first in each group
            const allGroups = document.querySelectorAll('.question-card[data-group-index]');
            const groupIndices = [...new Set([...allGroups].map(el => el.dataset.groupIndex))];
            
            groupIndices.forEach(groupIndex => {
                selectDuplicateGroup(parseInt(groupIndex), true);
            });
        }

        // ==================== INVALID OPTIONS FINDER FUNCTIONS ====================
        
        async function findInvalidOptions() {
            const topic = document.getElementById('filterTopic').value;
            const difficulty = document.getElementById('filterDifficulty').value;
            const container = document.getElementById('questionsList');
            const bulkBar = document.getElementById('bulkActionsBar');
            const invalidOptionsInfo = document.getElementById('invalidOptionsInfo');
            const invalidOptionsCount = document.getElementById('invalidOptionsCount');
            const duplicateInfo = document.getElementById('duplicateInfo');
            
            // Hide duplicate info
            duplicateInfo.classList.add('hidden');
            document.getElementById('selectDuplicatesBtn').classList.add('hidden');
            
            // Show loading state
            container.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-4xl text-red-500 mb-3"></i>
                    <p class="text-gray-600">Scanning for questions with invalid options...</p>
                </div>
            `;
            
            try {
                // Load questions
                let url = '/api/admin/all-questions?';
                if (topic) url += `topic=${topic}&`;
                if (difficulty) url += `difficulty=${difficulty}`;
                
                const response = await fetch(url);
                const questions = await response.json();
                
                // Find questions with non-distinct options
                const invalidQuestions = questions.filter(q => {
                    if (!q.options || q.options.length !== 4) return true; // Missing options
                    
                    // Normalize options for comparison (trim, lowercase)
                    const normalized = q.options.map(opt => 
                        (opt || '').toString().trim().toLowerCase()
                    );
                    
                    // Check for empty options
                    if (normalized.some(opt => opt === '')) return true;
                    
                    // Check for duplicates
                    const uniqueOptions = new Set(normalized);
                    return uniqueOptions.size !== 4;
                });
                
                if (invalidQuestions.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-green-600 py-8">
                            <i class="fas fa-check-circle text-4xl mb-3"></i>
                            <p class="font-semibold">All questions have 4 distinct options!</p>
                            <p class="text-gray-500 mt-2">Scanned ${questions.length} questions</p>
                        </div>
                    `;
                    invalidOptionsInfo.classList.add('hidden');
                    bulkBar.classList.add('hidden');
                    return;
                }
                
                // Show invalid options info
                invalidOptionsInfo.classList.remove('hidden');
                invalidOptionsCount.textContent = invalidQuestions.length;
                
                // Show bulk actions bar
                bulkBar.classList.remove('hidden');
                document.getElementById('selectInvalidOptionsBtn').classList.remove('hidden');
                clearSelection();
                
                // Update question count
                document.getElementById('questionCount').textContent = invalidQuestions.length;
                
                // Store for selection
                window.invalidOptionsQuestionIds = invalidQuestions.map(q => q.id);
                
                // Display invalid questions with highlighting
                const difficultyColors = {
                    'beginner': 'bg-green-100 text-green-800',
                    'intermediate': 'bg-yellow-100 text-yellow-800',
                    'advanced': 'bg-red-100 text-red-800'
                };
                
                container.innerHTML = `
                    <div class="bg-red-50 border-2 border-red-300 rounded-lg p-4 mb-4">
                        <div class="flex items-center gap-2 mb-3">
                            <i class="fas fa-exclamation-triangle text-red-500"></i>
                            <span class="font-bold text-red-700">Questions with Invalid Options</span>
                            <span class="bg-red-200 text-red-800 px-2 py-1 rounded text-sm">${invalidQuestions.length} found</span>
                        </div>
                        <p class="text-sm text-red-600 mb-4">These questions have duplicate, empty, or missing options and need to be fixed.</p>
                    </div>
                ` + invalidQuestions.map(q => {
                    // Identify which options are problematic
                    const normalized = q.options.map(opt => (opt || '').toString().trim().toLowerCase());
                    const optionIssues = q.options.map((opt, i) => {
                        const optNorm = (opt || '').toString().trim().toLowerCase();
                        if (optNorm === '') return 'empty';
                        // Check if this option appears elsewhere
                        const firstIndex = normalized.indexOf(optNorm);
                        if (firstIndex !== i) return 'duplicate';
                        return 'ok';
                    });
                    
                    return `
                        <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow question-card border-2 border-red-300" data-question-id="${q.id}" data-invalid-options="true">
                            <div class="flex justify-between items-start mb-4">
                                <div class="flex items-start gap-3 flex-1">
                                    <label class="flex items-center cursor-pointer mt-1">
                                        <input type="checkbox" class="question-checkbox w-5 h-5 rounded border-gray-300 text-purple-600 focus:ring-purple-500" 
                                               data-question-id="${q.id}" onchange="updateSelectionCount()">
                                    </label>
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-2 flex-wrap">
                                            <span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-semibold">
                                                <i class="fas fa-exclamation-triangle mr-1"></i>Invalid Options
                                            </span>
                                            <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">
                                                ${q.topic}
                                            </span>
                                            <span class="${difficultyColors[q.difficulty]} px-3 py-1 rounded-full text-sm font-semibold">
                                                ${q.difficulty}
                                            </span>
                                            <span class="text-gray-500 text-sm">ID: ${q.id}</span>
                                        </div>
                                    </div>
                                </div>
                                <button onclick="openQuestionEditor(${q.id})" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                                    <i class="fas fa-edit mr-2"></i>Edit
                                </button>
                            </div>

                            <div class="mb-4 ml-8">
                                <div class="font-semibold text-gray-700 mb-2">Question:</div>
                                <div class="text-gray-800 bg-gray-50 p-3 rounded-lg">${q.question}</div>
                            </div>

                            <div class="grid grid-cols-2 gap-3 mb-4 ml-8">
                                ${q.options.map((opt, i) => {
                                    const issue = optionIssues[i];
                                    const isCorrect = i === q.correct;
                                    let bgClass = 'bg-gray-50';
                                    let borderClass = '';
                                    let icon = '';
                                    
                                    if (issue === 'empty') {
                                        bgClass = 'bg-red-100';
                                        borderClass = 'border-2 border-red-500';
                                        icon = '<i class="fas fa-times-circle text-red-500 ml-auto" title="Empty option"></i>';
                                    } else if (issue === 'duplicate') {
                                        bgClass = 'bg-orange-100';
                                        borderClass = 'border-2 border-orange-500';
                                        icon = '<i class="fas fa-copy text-orange-500 ml-auto" title="Duplicate option"></i>';
                                    } else if (isCorrect) {
                                        bgClass = 'bg-green-50';
                                        borderClass = 'border-2 border-green-500';
                                        icon = '<i class="fas fa-check text-green-600 ml-auto"></i>';
                                    }
                                    
                                    return `
                                        <div class="flex items-center gap-2 p-2 rounded ${bgClass} ${borderClass}">
                                            <span class="font-semibold ${isCorrect ? 'text-green-700' : 'text-gray-600'}">
                                                ${String.fromCharCode(65 + i)})
                                            </span>
                                            <span class="${isCorrect ? 'text-green-700 font-semibold' : 'text-gray-700'}">
                                                ${opt || '<em class="text-red-500">(empty)</em>'}
                                            </span>
                                            ${icon}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                container.innerHTML = `<div class="text-center text-red-500 py-8"><i class="fas fa-exclamation-circle text-4xl mb-3"></i><p>Error: ${error.message}</p></div>`;
            }
        }
        
        function selectAllInvalidOptions() {
            // Select all questions with invalid options
            if (window.invalidOptionsQuestionIds) {
                window.invalidOptionsQuestionIds.forEach(id => {
                    const checkbox = document.querySelector(`.question-checkbox[data-question-id="${id}"]`);
                    if (checkbox) checkbox.checked = true;
                });
                updateSelectionCount();
            }
        }

        // ==================== IMAGE HANDLING FUNCTIONS ====================
        
        function previewQuestionImage(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check file size
            if (file.size > 2 * 1024 * 1024) {
                alert('Image too large. Maximum 2MB allowed.');
                event.target.value = '';
                return;
            }
            
            // Show local preview
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('editImagePreviewImg').src = e.target.result;
                document.getElementById('editImagePreview').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
            
            // Upload to server
            uploadQuestionImage(file);
        }
        
        async function uploadQuestionImage(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('question_id', document.getElementById('editQuestionId').value || 'new');
            formData.append('topic', document.getElementById('editTopic').value || 'general');
            
            try {
                const response = await fetch('/api/admin/questions/upload-image', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('editImageUrl').value = result.path;
                    console.log('Image uploaded:', result.path);
                } else {
                    alert('Error uploading image: ' + result.error);
                    clearImagePreview();
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('Error uploading image');
                clearImagePreview();
            }
        }
        
        function removeQuestionImage() {
            const currentUrl = document.getElementById('editImageUrl').value;
            
            // Delete from server if it exists
            if (currentUrl) {
                fetch('/api/admin/questions/delete-image', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ image_path: currentUrl })
                }).catch(err => console.error('Error deleting image:', err));
            }
            
            clearImagePreview();
        }
        
        function clearImagePreview() {
            document.getElementById('editImagePreview').classList.add('hidden');
            document.getElementById('editImagePreviewImg').src = '';
            document.getElementById('editImageUrl').value = '';
            document.getElementById('editImageCaption').value = '';
            document.getElementById('editImageFile').value = '';
        }
        
        function loadQuestionImageAndHint(question) {
            // Load image if present
            if (question.image_url) {
                document.getElementById('editImageUrl').value = question.image_url;
                document.getElementById('editImagePreviewImg').src = question.image_url;
                document.getElementById('editImagePreview').classList.remove('hidden');
            } else {
                clearImagePreview();
            }
            
            // Load caption
            document.getElementById('editImageCaption').value = question.image_caption || '';
            
            // Load hint
            document.getElementById('editHintText').value = question.hint_text || '';
            document.getElementById('editHintPenalty').value = question.hint_penalty || '50';
        }

        // ==================== END IMAGE HANDLING ====================

        document.getElementById('editQuestionForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const questionId = document.getElementById('editQuestionId').value;
            const questionData = {
                topic: document.getElementById('editTopic').value,
                difficulty: document.getElementById('editDifficulty').value,
                question_text: document.getElementById('editQuestionText').value,
                option_a: document.getElementById('editOptionA').value,
                option_b: document.getElementById('editOptionB').value,
                option_c: document.getElementById('editOptionC').value,
                option_d: document.getElementById('editOptionD').value,
                correct_answer: parseInt(document.getElementById('editCorrectAnswer').value),
                explanation: document.getElementById('editExplanation').value,
                // Image fields
                image_url: document.getElementById('editImageUrl').value || null,
                image_caption: document.getElementById('editImageCaption').value || null,
                // Hint fields
                hint_text: document.getElementById('editHintText').value || null,
                hint_penalty: parseInt(document.getElementById('editHintPenalty').value) || 50,
                // Edit tracking
                notes: document.getElementById('editNotes').value,
                resolve_flag_ids: flagsToResolve
            };

            try {
                const response = await fetch(`/api/admin/question/${questionId}/edit`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(questionData)
                });

                if (response.ok) {
                    alert('Question updated successfully!');
                    hideEditModal();
                    // Refresh both tabs
                    await loadQuestionsByFilter();
                    await loadQuestionManagement();
                } else {
                    alert('Error updating question');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error updating question');
            }
        });

        async function dismissFlag(flagId, isAdaptive = false) {
            const notes = prompt('Enter reason for dismissing this flag (optional):');
            if (notes === null) return; // User cancelled

            try {
                // Use different endpoint for adaptive questions
                const endpoint = isAdaptive 
                    ? `/api/admin/flag/${flagId}/dismiss?adaptive=true`
                    : `/api/admin/flag/${flagId}/dismiss`;
                    
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ notes, is_adaptive: isAdaptive })
                });

                if (response.ok) {
                    alert('Flag dismissed');
                    await loadQuestionManagement();
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    alert('Error dismissing flag: ' + (errorData.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error dismissing flag');
            }
        }

        // Load pending flags count on page load
        window.addEventListener('load', function() {
            loadPendingFlagsCount();
            checkNewFeedback();
            // Refresh count every 30 seconds
            setInterval(loadPendingFlagsCount, 30000);
            setInterval(checkNewFeedback, 60000); // Check feedback every minute
        });

        // Check for new feedback count
        async function checkNewFeedback() {
            try {
                const response = await fetch('/api/admin/feedback?status=new&per_page=1');
                const data = await response.json();
                const count = data.counts?.new || 0;
                const badge = document.getElementById('newFeedbackCount');
                if (badge) {
                    if (count > 0) {
                        badge.textContent = count;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            } catch (error) {
                console.log('Could not check feedback count');
            }
        }

        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // ==================== TOPIC MANAGEMENT FUNCTIONS ====================
        
        let strandsData = [];
        let topicsData = [];
        let currentTutorialData = {};
        
        // STRANDS
        async function loadStrandsAdmin() {
            try {
                const response = await fetch('/api/admin/strands');
                strandsData = await response.json();
                renderStrandsTable();
                populateStrandDropdowns();
            } catch (error) {
                console.error('Error loading strands:', error);
                document.getElementById('strandsTableBody').innerHTML = 
                    '<tr><td colspan="6" class="text-center py-4 text-red-600">Error loading strands</td></tr>';
            }
        }
        
        function renderStrandsTable() {
            const tbody = document.getElementById('strandsTableBody');
            if (strandsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">No strands found. Add one to get started.</td></tr>';
                return;
            }
            
            tbody.innerHTML = strandsData.map(s => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-3">${s.sort_order}</td>
                    <td class="px-4 py-3 text-2xl">${s.icon || 'üìö'}</td>
                    <td class="px-4 py-3 font-medium">${s.name}</td>
                    <td class="px-4 py-3">
                        <span class="inline-block w-6 h-6 rounded" style="background-color: ${s.color}"></span>
                        <code class="ml-2 text-xs">${s.color}</code>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600">${s.description || '-'}</td>
                    <td class="px-4 py-3">
                        <button onclick="moveStrand(${s.id}, 'up')" class="text-gray-500 hover:text-gray-700 mr-1" title="Move Up">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button onclick="moveStrand(${s.id}, 'down')" class="text-gray-500 hover:text-gray-700 mr-2" title="Move Down">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button onclick="editStrand(${s.id})" class="text-blue-600 hover:text-blue-800 mr-2">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteStrand(${s.id})" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        function openStrandModal(strand = null) {
            document.getElementById('strandModalTitle').textContent = strand ? 'Edit Strand' : 'Add Strand';
            document.getElementById('strandId').value = strand?.id || '';
            document.getElementById('strandName').value = strand?.name || '';
            document.getElementById('strandIcon').value = strand?.icon || 'üìö';
            document.getElementById('strandColor').value = strand?.color || '#667eea';
            document.getElementById('strandDescription').value = strand?.description || '';
            document.getElementById('strandSortOrder').value = strand?.sort_order || 0;
            document.getElementById('strandModal').classList.remove('hidden');
        }
        
        function closeStrandModal() {
            document.getElementById('strandModal').classList.add('hidden');
        }
        
        function editStrand(id) {
            const strand = strandsData.find(s => s.id === id);
            if (strand) openStrandModal(strand);
        }
        
        async function deleteStrand(id) {
            if (!confirm('Are you sure you want to delete this strand? Topics must be reassigned first.')) return;
            
            try {
                const response = await fetch(`/api/admin/strands/${id}`, { method: 'DELETE' });
                const result = await response.json();
                
                if (response.ok) {
                    alert('Strand deleted successfully');
                    loadStrandsAdmin();
                } else {
                    alert(result.error || 'Failed to delete strand');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error deleting strand');
            }
        }
        
        async function moveStrand(id, direction) {
            try {
                const response = await fetch(`/api/admin/strands/${id}/reorder`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ direction })
                });
                
                if (response.ok) {
                    loadStrandsAdmin();
                }
            } catch (error) {
                console.error('Error moving strand:', error);
            }
        }
        
        document.getElementById('strandForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('strandId').value;
            const data = {
                name: document.getElementById('strandName').value,
                icon: document.getElementById('strandIcon').value,
                color: document.getElementById('strandColor').value,
                description: document.getElementById('strandDescription').value,
                sort_order: parseInt(document.getElementById('strandSortOrder').value) || 0
            };
            
            try {
                const url = id ? `/api/admin/strands/${id}` : '/api/admin/strands';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    closeStrandModal();
                    loadStrandsAdmin();
                } else {
                    alert(result.error || 'Failed to save strand');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error saving strand');
            }
        });
        
        function populateStrandDropdowns() {
            const options = '<option value="">Select a strand...</option>' + 
                strandsData.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            
            document.getElementById('topicStrandSelect').innerHTML = options;
            document.getElementById('topicStrandFilter').innerHTML = '<option value="">All Strands</option>' +
                strandsData.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        }
        
        // TOPICS
        async function loadTopicsAdmin() {
            try {
                const response = await fetch('/api/admin/topics-management');
                topicsData = await response.json();
                
                const filter = document.getElementById('topicStrandFilter').value;
                let filtered = topicsData;
                if (filter) {
                    filtered = topicsData.filter(t => t.strand_id == filter);
                }
                
                renderTopicsTable(filtered);
            } catch (error) {
                console.error('Error loading topics:', error);
                document.getElementById('topicsTableBody').innerHTML = 
                    '<tr><td colspan="9" class="text-center py-4 text-red-600">Error loading topics. Make sure migration has been run.</td></tr>';
            }
        }
        
        function renderTopicsTable(topics) {
            const tbody = document.getElementById('topicsTableBody');
            if (topics.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-gray-500">No topics found.</td></tr>';
                return;
            }
            
            tbody.innerHTML = topics.map(t => `
                <tr class="border-b hover:bg-gray-50 ${!t.is_visible ? 'opacity-50' : ''}">
                    <td class="px-4 py-3">${t.sort_order}</td>
                    <td class="px-4 py-3"><i class="fas fa-${t.icon || 'book'} text-xl text-gray-600"></i></td>
                    <td class="px-4 py-3 font-mono text-sm">${t.topic_id}</td>
                    <td class="px-4 py-3 font-medium">${t.display_name}</td>
                    <td class="px-4 py-3 text-sm">${t.strand_name || '<span class="text-gray-400">Unassigned</span>'}</td>
                    <td class="px-4 py-3">
                        <span class="${t.question_count > 0 ? 'text-green-600' : 'text-red-600'}">${t.question_count}</span>
                    </td>
                    <td class="px-4 py-3">
                        <span class="${t.tutorial_count > 0 ? 'text-green-600' : 'text-gray-400'}">${t.tutorial_count}/3</span>
                    </td>
                    <td class="px-4 py-3">
                        <button onclick="toggleTopicVisibility(${t.id}, ${!t.is_visible})" 
                                class="${t.is_visible ? 'text-green-600' : 'text-gray-400'} hover:opacity-75">
                            <i class="fas ${t.is_visible ? 'fa-eye' : 'fa-eye-slash'}"></i>
                        </button>
                    </td>
                    <td class="px-4 py-3">
                        <button onclick="moveTopic(${t.id}, 'up')" class="text-gray-500 hover:text-gray-700 mr-1" title="Move Up">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button onclick="moveTopic(${t.id}, 'down')" class="text-gray-500 hover:text-gray-700 mr-2" title="Move Down">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button onclick="editTopic(${t.id})" class="text-blue-600 hover:text-blue-800 mr-2" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="openTutorialModal(${t.id}, '${t.topic_id}', '${t.display_name}')" class="text-green-600 hover:text-green-800 mr-2" title="Tutorials">
                            <i class="fas fa-book-open"></i>
                        </button>
                        <button onclick="deleteTopic(${t.id})" class="text-red-600 hover:text-red-800" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        function openTopicModal(topic = null) {
            document.getElementById('topicModalTitle').textContent = topic ? 'Edit Topic' : 'Add Topic';
            document.getElementById('topicDbId').value = topic?.id || '';
            document.getElementById('topicIdInput').value = topic?.topic_id || '';
            document.getElementById('topicIdInput').disabled = !!topic; // Can't change topic_id after creation
            document.getElementById('topicDisplayName').value = topic?.display_name || '';
            document.getElementById('topicIcon').value = topic?.icon || 'book';
            document.getElementById('topicStrandSelect').value = topic?.strand_id || '';
            document.getElementById('topicSortOrder').value = topic?.sort_order || 0;
            document.getElementById('topicVisible').checked = topic?.is_visible !== false;
            document.getElementById('topicModal').classList.remove('hidden');
        }
        
        function closeTopicModal() {
            document.getElementById('topicModal').classList.add('hidden');
        }
        
        function editTopic(id) {
            const topic = topicsData.find(t => t.id === id);
            if (topic) openTopicModal(topic);
        }
        
        async function toggleTopicVisibility(id, newVisibility) {
            try {
                const response = await fetch(`/api/admin/topics-management/${id}/visibility`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_visible: newVisibility })
                });
                
                if (response.ok) {
                    loadTopicsAdmin();
                } else {
                    const result = await response.json();
                    alert(result.error || 'Failed to toggle visibility');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        async function deleteTopic(id) {
            if (!confirm('Are you sure? This will only work if no questions exist for this topic.')) return;
            
            try {
                const response = await fetch(`/api/admin/topics-management/${id}`, { method: 'DELETE' });
                const result = await response.json();
                
                if (response.ok) {
                    alert('Topic deleted successfully');
                    loadTopicsAdmin();
                } else {
                    alert(result.error || 'Failed to delete topic');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error deleting topic');
            }
        }
        
        async function moveTopic(id, direction) {
            try {
                const response = await fetch(`/api/admin/topics-management/${id}/reorder`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ direction })
                });
                
                if (response.ok) {
                    loadTopicsAdmin().then(() => populateGeneratorTopics());
                }
            } catch (error) {
                console.error('Error moving topic:', error);
            }
        }
        
        document.getElementById('topicForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('topicDbId').value;
            const data = {
                topic_id: document.getElementById('topicIdInput').value,
                display_name: document.getElementById('topicDisplayName').value,
                icon: document.getElementById('topicIcon').value,
                strand_id: document.getElementById('topicStrandSelect').value || null,
                sort_order: parseInt(document.getElementById('topicSortOrder').value) || 0,
                is_visible: document.getElementById('topicVisible').checked
            };
            
            try {
                const url = id ? `/api/admin/topics-management/${id}` : '/api/admin/topics-management';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    closeTopicModal();
                    loadTopicsAdmin();
                } else {
                    alert(result.error || 'Failed to save topic');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error saving topic');
            }
        });
        
        // TUTORIALS
        let currentTutorialTopicId = null;
        let currentTutorials = {};
        
        async function openTutorialModal(topicDbId, topicId, displayName) {
            currentTutorialTopicId = topicDbId;
            document.getElementById('tutorialModalTitle').textContent = `Tutorials for ${displayName}`;
            document.getElementById('tutorialTopicName').textContent = `Topic: ${displayName} (${topicId})`;
            document.getElementById('tutorialTopicId').value = topicDbId;
            
            // Load existing tutorials
            try {
                const response = await fetch(`/api/admin/tutorials/${topicDbId}`);
                const tutorials = await response.json();
                
                currentTutorials = {};
                tutorials.forEach(t => {
                    currentTutorials[t.difficulty] = t;
                });
                
                // Show beginner tab by default
                showTutorialTab('beginner');
                document.getElementById('tutorialModal').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading tutorials:', error);
                alert('Error loading tutorials');
            }
        }
        
        function closeTutorialModal() {
            document.getElementById('tutorialModal').classList.add('hidden');
            currentTutorialTopicId = null;
            currentTutorials = {};
        }
        
        function showTutorialTab(difficulty) {
            // Update tab styling
            ['beginner', 'intermediate', 'advanced'].forEach(d => {
                const tab = document.getElementById(`tutorialTab${d.charAt(0).toUpperCase() + d.slice(1)}`);
                if (d === difficulty) {
                    tab.classList.add('border-b-2', 'border-green-500', 'text-green-600');
                    tab.classList.remove('text-gray-500');
                } else {
                    tab.classList.remove('border-b-2', 'border-green-500', 'text-green-600');
                    tab.classList.add('text-gray-500');
                }
            });
            
            // Update form fields
            document.getElementById('tutorialDifficulty').value = difficulty;
            
            const tutorial = currentTutorials[difficulty];
            document.getElementById('tutorialId').value = tutorial?.id || '';
            document.getElementById('tutorialTitle').value = tutorial?.title || '';
            document.getElementById('tutorialIntroduction').value = tutorial?.introduction || '';
            document.getElementById('tutorialPrinciples').value = tutorial?.principles ? JSON.stringify(tutorial.principles, null, 2) : '';
            document.getElementById('tutorialExamples').value = tutorial?.examples ? JSON.stringify(tutorial.examples, null, 2) : '';
            document.getElementById('tutorialTips').value = tutorial?.tips ? JSON.stringify(tutorial.tips, null, 2) : '';
        }
        
        async function deleteTutorial() {
            const id = document.getElementById('tutorialId').value;
            if (!id) {
                alert('No tutorial to delete');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this tutorial?')) return;
            
            try {
                const response = await fetch(`/api/admin/tutorials/${id}`, { method: 'DELETE' });
                
                if (response.ok) {
                    const difficulty = document.getElementById('tutorialDifficulty').value;
                    delete currentTutorials[difficulty];
                    showTutorialTab(difficulty);
                    loadTopicsAdmin(); // Refresh tutorial count
                } else {
                    const result = await response.json();
                    alert(result.error || 'Failed to delete tutorial');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error deleting tutorial');
            }
        }
        
        document.getElementById('tutorialForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('tutorialId').value;
            const difficulty = document.getElementById('tutorialDifficulty').value;
            
            // Parse JSON fields
            let principles, examples, tips;
            try {
                principles = document.getElementById('tutorialPrinciples').value ? 
                    JSON.parse(document.getElementById('tutorialPrinciples').value) : [];
                examples = document.getElementById('tutorialExamples').value ? 
                    JSON.parse(document.getElementById('tutorialExamples').value) : [];
                tips = document.getElementById('tutorialTips').value ? 
                    JSON.parse(document.getElementById('tutorialTips').value) : [];
            } catch (parseError) {
                alert('Invalid JSON in one of the fields. Please check the format.');
                return;
            }
            
            const data = {
                topic_id: currentTutorialTopicId,
                difficulty: difficulty,
                title: document.getElementById('tutorialTitle').value,
                introduction: document.getElementById('tutorialIntroduction').value,
                principles: principles,
                examples: examples,
                tips: tips
            };
            
            try {
                const url = id ? `/api/admin/tutorials/${id}` : '/api/admin/tutorials';
                const method = id ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('Tutorial saved successfully');
                    // Refresh
                    const resp = await fetch(`/api/admin/tutorials/${currentTutorialTopicId}`);
                    const tutorials = await resp.json();
                    currentTutorials = {};
                    tutorials.forEach(t => {
                        currentTutorials[t.difficulty] = t;
                    });
                    showTutorialTab(difficulty);
                    loadTopicsAdmin(); // Refresh tutorial count
                } else {
                    alert(result.error || 'Failed to save tutorial');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error saving tutorial');
            }
        });
        
        // ==================== QUESTION GENERATOR FUNCTIONS ====================
        
        // Check API key status on load
        async function checkApiKeyStatus() {
            const statusEl = document.getElementById('apiKeyStatus');
            try {
                const response = await fetch('/api/admin/check-api-key');
                
                if (!response.ok) {
                    // HTTP error - show status code
                    const errorText = await response.text();
                    console.error('API key check failed:', response.status, errorText);
                    statusEl.textContent = `‚úó Error (${response.status})`;
                    statusEl.className = 'text-sm px-3 py-1 rounded-full bg-red-100 text-red-700';
                    statusEl.title = errorText || 'Server error - check console';
                    return;
                }
                
                const result = await response.json();
                console.log('API key check result:', result);  // Debug logging
                
                if (result.configured && result.valid) {
                    statusEl.textContent = '‚úì API Key Configured';
                    statusEl.className = 'text-sm px-3 py-1 rounded-full bg-green-100 text-green-700';
                } else if (result.configured) {
                    statusEl.textContent = '‚ö† API Key Invalid';
                    statusEl.className = 'text-sm px-3 py-1 rounded-full bg-yellow-100 text-yellow-700';
                    statusEl.title = result.error || 'Key is configured but validation failed';
                } else {
                    statusEl.textContent = '‚úó API Key Not Configured';
                    statusEl.className = 'text-sm px-3 py-1 rounded-full bg-red-100 text-red-700';
                    // Show debug info if available
                    let debugInfo = result.error || 'Add ANTHROPIC_API_KEY to environment variables';
                    if (result.debug_env_keys && result.debug_env_keys.length > 0) {
                        debugInfo += ` | Found env keys: ${result.debug_env_keys.join(', ')}`;
                    } else if (result.debug_env_keys) {
                        debugInfo += ' | No ANTHROPIC or API env vars found';
                    }
                    statusEl.title = debugInfo;
                    console.log('API Key Debug:', debugInfo);
                }
            } catch (error) {
                console.error('Error checking API key:', error);
                statusEl.textContent = '‚úó Check Failed';
                statusEl.className = 'text-sm px-3 py-1 rounded-full bg-red-100 text-red-700';
                statusEl.title = error.message || 'Network or parsing error';
            }
        }
        
        // Populate generator topic dropdown
        function populateGeneratorTopics() {
            const select = document.getElementById('generatorTopicSelect');
            select.innerHTML = '<option value="">-- Select a Topic --</option>' +
                topicsData.map(t => `<option value="${t.topic_id}" data-name="${t.display_name}">${t.display_name} (${t.topic_id})</option>`).join('');
        }
        
        // When topic is selected, show current question counts
        async function onGeneratorTopicChange() {
            const topicId = document.getElementById('generatorTopicSelect').value;
            const countsDiv = document.getElementById('currentQuestionCounts');
            
            if (!topicId) {
                countsDiv.classList.add('hidden');
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/question-counts/${topicId}`);
                const result = await response.json();
                
                document.getElementById('countBeginner').textContent = result.counts.beginner || 0;
                document.getElementById('countIntermediate').textContent = result.counts.intermediate || 0;
                document.getElementById('countAdvanced').textContent = result.counts.advanced || 0;
                countsDiv.classList.remove('hidden');
            } catch (error) {
                console.error('Error fetching counts:', error);
            }
        }
        
        // Generate questions
        async function generateQuestions() {
            const topicId = document.getElementById('generatorTopicSelect').value;
            const topicName = document.getElementById('generatorTopicSelect').selectedOptions[0]?.dataset?.name || topicId;
            
            if (!topicId) {
                alert('Please select a topic first');
                return;
            }
            
            const beginnerDesc = document.getElementById('beginnerDescription').value.trim();
            const intermediateDesc = document.getElementById('intermediateDescription').value.trim();
            const advancedDesc = document.getElementById('advancedDescription').value.trim();
            
            if (!beginnerDesc || !intermediateDesc || !advancedDesc) {
                alert('Please provide descriptions for all three difficulty levels');
                return;
            }
            
            const beginnerCount = parseInt(document.getElementById('beginnerCount').value) || 40;
            const intermediateCount = parseInt(document.getElementById('intermediateCount').value) || 40;
            const advancedCount = parseInt(document.getElementById('advancedCount').value) || 40;
            
            // Show progress
            const progressDiv = document.getElementById('generatorProgress');
            const resultDiv = document.getElementById('generatorResult');
            const generateBtn = document.getElementById('generateBtn');
            
            progressDiv.classList.remove('hidden');
            resultDiv.classList.add('hidden');
            generateBtn.disabled = true;
            
            // Animate progress bar (fake progress since we don't have real-time updates)
            let progress = 0;
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            const progressInterval = setInterval(() => {
                if (progress < 90) {
                    progress += Math.random() * 10;
                    progressBar.style.width = Math.min(progress, 90) + '%';
                    
                    if (progress < 30) {
                        progressText.textContent = 'Generating beginner questions...';
                    } else if (progress < 60) {
                        progressText.textContent = 'Generating intermediate questions...';
                    } else {
                        progressText.textContent = 'Generating advanced questions...';
                    }
                }
            }, 2000);
            
            try {
                const response = await fetch('/api/admin/generate-questions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic_id: topicId,
                        topic_name: topicName,
                        beginner_description: beginnerDesc,
                        beginner_count: beginnerCount,
                        intermediate_description: intermediateDesc,
                        intermediate_count: intermediateCount,
                        advanced_description: advancedDesc,
                        advanced_count: advancedCount
                    })
                });
                
                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                
                const result = await response.json();
                
                progressDiv.classList.add('hidden');
                generateBtn.disabled = false;
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <h4 class="font-semibold text-green-700 mb-2"><i class="fas fa-check-circle mr-2"></i>Success!</h4>
                            <p class="text-green-700">${result.message}</p>
                            <div class="mt-2 text-sm">
                                <p><strong>Final counts:</strong></p>
                                <ul class="list-disc list-inside ml-2">
                                    <li>Beginner: ${result.counts.beginner} questions</li>
                                    <li>Intermediate: ${result.counts.intermediate} questions</li>
                                    <li>Advanced: ${result.counts.advanced} questions</li>
                                    <li><strong>Total: ${result.total} questions</strong></li>
                                </ul>
                            </div>
                        </div>
                    `;
                    resultDiv.classList.remove('hidden');
                    
                    // Refresh topic counts
                    onGeneratorTopicChange();
                    loadTopicsAdmin();
                } else {
                    resultDiv.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <h4 class="font-semibold text-red-700 mb-2"><i class="fas fa-exclamation-circle mr-2"></i>Error</h4>
                            <p class="text-red-700">${result.error || 'Unknown error occurred'}</p>
                        </div>
                    `;
                    resultDiv.classList.remove('hidden');
                }
            } catch (error) {
                clearInterval(progressInterval);
                progressDiv.classList.add('hidden');
                generateBtn.disabled = false;
                
                resultDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <h4 class="font-semibold text-red-700 mb-2"><i class="fas fa-exclamation-circle mr-2"></i>Error</h4>
                        <p class="text-red-700">Network error: ${error.message}</p>
                    </div>
                `;
                resultDiv.classList.remove('hidden');
            }
        }
        
        // Initialize question generator when tab is shown
        function initQuestionGenerator() {
            checkApiKeyStatus();
            populateGeneratorTopics();
            loadChartQuestionCounts();
            loadGeometryQuestionCounts();
            loadPatternsQuestionCounts();
            loadCoordinateQuestionCounts();
            loadSDTQuestionCounts();
            loadCurrencyQuestionCounts();
            loadSetsQuestionCounts();
            loadPercentagesQuestionCounts();
            loadProbabilityQuestionCounts();
        }
        
        // =================================================================
        // CHART QUESTION GENERATOR FUNCTIONS
        // =================================================================
        
        // Load current chart question counts
        async function loadChartQuestionCounts() {
            try {
                const response = await fetch('/api/admin/question-counts/descriptive_statistics');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('chartCountBeginner').textContent = data.beginner || 0;
                    document.getElementById('chartCountIntermediate').textContent = data.intermediate || 0;
                    document.getElementById('chartCountAdvanced').textContent = data.advanced || 0;
                }
            } catch (error) {
                console.log('Could not load chart question counts');
            }
        }
        
        // Generate chart questions
        async function generateChartQuestions() {
            // Get selected chart types
            const chartTypes = [];
            if (document.getElementById('chartTypeBar').checked) chartTypes.push('bar');
            if (document.getElementById('chartTypePie').checked) chartTypes.push('pie');
            if (document.getElementById('chartTypeLine').checked) chartTypes.push('line');
            if (document.getElementById('chartTypeHistogram').checked) chartTypes.push('histogram');
            
            if (chartTypes.length === 0) {
                alert('Please select at least one chart type');
                return;
            }
            
            // Get selected difficulties
            const difficulties = [];
            if (document.getElementById('chartDiffBeginner').checked) difficulties.push('beginner');
            if (document.getElementById('chartDiffIntermediate').checked) difficulties.push('intermediate');
            if (document.getElementById('chartDiffAdvanced').checked) difficulties.push('advanced');
            
            if (difficulties.length === 0) {
                alert('Please select at least one difficulty level');
                return;
            }
            
            const chartsPerType = parseInt(document.getElementById('chartsPerType').value) || 3;
            
            // Show progress
            const progressDiv = document.getElementById('chartGeneratorProgress');
            const resultDiv = document.getElementById('chartGeneratorResult');
            const generateBtn = document.getElementById('chartGenerateBtn');
            
            progressDiv.classList.remove('hidden');
            resultDiv.classList.add('hidden');
            generateBtn.disabled = true;
            
            try {
                const response = await fetch('/api/admin/generate-chart-questions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chart_types: chartTypes,
                        difficulties: difficulties,
                        charts_per_type: chartsPerType
                    })
                });
                
                const result = await response.json();
                
                progressDiv.classList.add('hidden');
                generateBtn.disabled = false;
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <h4 class="font-semibold text-green-700 mb-2"><i class="fas fa-check-circle mr-2"></i>Success!</h4>
                            <p class="text-green-700">${result.message}</p>
                            <div class="mt-3 text-sm">
                                <p><strong>Descriptive Statistics question counts:</strong></p>
                                <ul class="list-disc list-inside ml-2 mt-1">
                                    <li class="text-green-600">Beginner: ${result.counts.beginner} questions</li>
                                    <li class="text-yellow-600">Intermediate: ${result.counts.intermediate} questions</li>
                                    <li class="text-red-600">Advanced: ${result.counts.advanced} questions</li>
                                    <li><strong>Total: ${result.total} questions</strong></li>
                                </ul>
                            </div>
                            ${result.sample_questions && result.sample_questions.length > 0 ? `
                                <div class="mt-3">
                                    <p class="text-sm font-medium text-gray-700">Sample questions generated:</p>
                                    <ul class="text-xs text-gray-600 mt-1 max-h-32 overflow-y-auto">
                                        ${result.sample_questions.map(q => `
                                            <li class="flex items-center gap-2 py-1">
                                                <span class="px-2 py-0.5 rounded text-white text-xs ${
                                                    q.type === 'bar' ? 'bg-blue-500' :
                                                    q.type === 'pie' ? 'bg-green-500' :
                                                    q.type === 'line' ? 'bg-purple-500' : 'bg-orange-500'
                                                }">${q.type}</span>
                                                <span class="px-2 py-0.5 rounded text-xs ${
                                                    q.difficulty === 'beginner' ? 'bg-green-100 text-green-700' :
                                                    q.difficulty === 'intermediate' ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'
                                                }">${q.difficulty}</span>
                                                <span>${q.question}</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    resultDiv.classList.remove('hidden');
                    
                    // Refresh counts
                    loadChartQuestionCounts();
                    loadTopicsAdmin();
                } else {
                    resultDiv.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <h4 class="font-semibold text-red-700 mb-2"><i class="fas fa-exclamation-circle mr-2"></i>Error</h4>
                            <p class="text-red-700">${result.error || 'Unknown error occurred'}</p>
                            ${result.error && result.error.includes('matplotlib') ? `
                                <p class="mt-2 text-sm text-gray-600">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    The chart generator requires matplotlib. Run this in PythonAnywhere bash: 
                                    <code class="bg-gray-200 px-2 py-1 rounded">pip install matplotlib --user</code>
                                </p>
                            ` : ''}
                        </div>
                    `;
                    resultDiv.classList.remove('hidden');
                }
            } catch (error) {
                progressDiv.classList.add('hidden');
                generateBtn.disabled = false;
                
                resultDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <h4 class="font-semibold text-red-700 mb-2"><i class="fas fa-exclamation-circle mr-2"></i>Error</h4>
                        <p class="text-red-700">Network error: ${error.message}</p>
                    </div>
                `;
                resultDiv.classList.remove('hidden');
            }
        }
        
        // =================================================================
        // GEOMETRY QUESTION GENERATOR FUNCTIONS
        // =================================================================
        
        // Load current geometry question counts
        async function loadGeometryQuestionCounts() {
            try {
                const response = await fetch('/api/admin/question-counts/geometry');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('geomCountBeginner').textContent = data.beginner || 0;
                    document.getElementById('geomCountIntermediate').textContent = data.intermediate || 0;
                    document.getElementById('geomCountAdvanced').textContent = data.advanced || 0;
                }
            } catch (error) {
                console.log('Could not load geometry question counts');
            }
        }
        
        // Generate geometry questions
        async function generateGeometryQuestions() {
            // Get selected shape types
            const shapeTypes = [];
            if (document.getElementById('shapeTypeTriangle').checked) shapeTypes.push('triangle');
            if (document.getElementById('shapeTypeRectangle').checked) shapeTypes.push('rectangle');
            if (document.getElementById('shapeTypeCircle').checked) shapeTypes.push('circle');
            if (document.getElementById('shapeTypeAngle').checked) shapeTypes.push('angle');
            
            if (shapeTypes.length === 0) {
                alert('Please select at least one shape type');
                return;
            }
            
            // Get selected difficulties
            const difficulties = [];
            if (document.getElementById('geomDiffBeginner').checked) difficulties.push('beginner');
            if (document.getElementById('geomDiffIntermediate').checked) difficulties.push('intermediate');
            if (document.getElementById('geomDiffAdvanced').checked) difficulties.push('advanced');
            
            if (difficulties.length === 0) {
                alert('Please select at least one difficulty level');
                return;
            }
            
            const shapesPerType = parseInt(document.getElementById('shapesPerType').value) || 3;
            
            // Show progress
            const progressDiv = document.getElementById('geomGeneratorProgress');
            const resultDiv = document.getElementById('geomGeneratorResult');
            const generateBtn = document.getElementById('geomGenerateBtn');
            
            progressDiv.classList.remove('hidden');
            resultDiv.classList.add('hidden');
            generateBtn.disabled = true;
            
            try {
                const response = await fetch('/api/admin/generate-geometry-questions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        shape_types: shapeTypes,
                        difficulties: difficulties,
                        shapes_per_type: shapesPerType
                    })
                });
                
                const result = await response.json();
                
                progressDiv.classList.add('hidden');
                generateBtn.disabled = false;
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <h4 class="font-semibold text-green-700 mb-2"><i class="fas fa-check-circle mr-2"></i>Success!</h4>
                            <p class="text-green-700">${result.message}</p>
                            <div class="mt-3 text-sm">
                                <p><strong>Geometry question counts:</strong></p>
                                <ul class="list-disc list-inside ml-2 mt-1">
                                    <li class="text-green-600">Beginner: ${result.counts.beginner} questions</li>
                                    <li class="text-yellow-600">Intermediate: ${result.counts.intermediate} questions</li>
                                    <li class="text-red-600">Advanced: ${result.counts.advanced} questions</li>
                                    <li><strong>Total: ${result.total} questions</strong></li>
                                </ul>
                            </div>
                            ${result.sample_questions && result.sample_questions.length > 0 ? `
                                <div class="mt-3">
                                    <p class="text-sm font-medium text-gray-700">Sample questions generated:</p>
                                    <ul class="text-xs text-gray-600 mt-1 max-h-32 overflow-y-auto">
                                        ${result.sample_questions.map(q => `
                                            <li class="flex items-center gap-2 py-1">
                                                <span class="px-2 py-0.5 rounded text-white text-xs ${
                                                    q.type === 'triangle' ? 'bg-blue-500' :
                                                    q.type === 'rectangle' ? 'bg-pink-500' :
                                                    q.type === 'circle' ? 'bg-yellow-500' : 'bg-purple-500'
                                                }">${q.type}</span>
                                                <span class="px-2 py-0.5 rounded text-xs ${
                                                    q.difficulty === 'beginner' ? 'bg-green-100 text-green-700' :
                                                    q.difficulty === 'intermediate' ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'
                                                }">${q.difficulty}</span>
                                                <span>${q.question}</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    resultDiv.classList.remove('hidden');
                    
                    // Refresh counts
                    loadGeometryQuestionCounts();
                    loadTopicsAdmin();
                } else {
                    resultDiv.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <h4 class="font-semibold text-red-700 mb-2"><i class="fas fa-exclamation-circle mr-2"></i>Error</h4>
                            <p class="text-red-700">${result.error || 'Unknown error occurred'}</p>
                            ${result.error && result.error.includes('matplotlib') ? `
                                <p class="mt-2 text-sm text-gray-600">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    The geometry generator requires matplotlib. Run this in PythonAnywhere bash: 
                                    <code class="bg-gray-200 px-2 py-1 rounded">pip install matplotlib --user</code>
                                </p>
                            ` : ''}
                        </div>
                    `;
                    resultDiv.classList.remove('hidden');
                }
            } catch (error) {
                progressDiv.classList.add('hidden');
                generateBtn.disabled = false;
                
                resultDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <h4 class="font-semibold text-red-700 mb-2"><i class="fas fa-exclamation-circle mr-2"></i>Error</h4>
                        <p class="text-red-700">Network error: ${error.message}</p>
                    </div>
                `;
                resultDiv.classList.remove('hidden');
            }
        }
        
        // =================================================================
        // PATTERNS QUESTION GENERATOR FUNCTIONS
        // =================================================================
        
        // Load current patterns question counts
        async function loadPatternsQuestionCounts() {
            try {
                const response = await fetch('/api/admin/question-counts/patterns');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('patternCountBeginner').textContent = data.beginner || 0;
                    document.getElementById('patternCountIntermediate').textContent = data.intermediate || 0;
                    document.getElementById('patternCountAdvanced').textContent = data.advanced || 0;
                }
            } catch (error) {
                console.log('Could not load patterns question counts');
            }
        }
        
        // Generate patterns questions
        async function generatePatternsQuestions() {
            // Get selected pattern types
            const patternTypes = [];
            if (document.getElementById('patternTypeDot').checked) patternTypes.push('dot');
            if (document.getElementById('patternTypeLinear').checked) patternTypes.push('linear');
            if (document.getElementById('patternTypeStaircase').checked) patternTypes.push('staircase');
            if (document.getElementById('patternTypeShape').checked) patternTypes.push('shape');
            if (document.getElementById('patternTypeTile').checked) patternTypes.push('tile');
            
            if (patternTypes.length === 0) {
                alert('Please select at least one pattern type');
                return;
            }
            
            // Get selected difficulties
            const difficulties = [];
            if (document.getElementById('patternDiffBeginner').checked) difficulties.push('beginner');
            if (document.getElementById('patternDiffIntermediate').checked) difficulties.push('intermediate');
            if (document.getElementById('patternDiffAdvanced').checked) difficulties.push('advanced');
            
            if (difficulties.length === 0) {
                alert('Please select at least one difficulty level');
                return;
            }
            
            const patternsPerType = parseInt(document.getElementById('patternsPerType').value) || 2;
            
            // Show progress
            const progressDiv = document.getElementById('patternsGeneratorProgress');
            const resultDiv = document.getElementById('patternsGeneratorResult');
            const generateBtn = document.getElementById('patternsGenerateBtn');
            
            progressDiv.classList.remove('hidden');
            resultDiv.classList.add('hidden');
            generateBtn.disabled = true;
            
            try {
                const response = await fetch('/api/admin/generate-pattern-questions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pattern_types: patternTypes,
                        difficulties: difficulties,
                        patterns_per_type: patternsPerType
                    })
                });
                
                const result = await response.json();
                
                progressDiv.classList.add('hidden');
                generateBtn.disabled = false;
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <h4 class="font-semibold text-green-700 mb-2"><i class="fas fa-check-circle mr-2"></i>Success!</h4>
                            <p class="text-green-700">${result.message}</p>
                            <div class="mt-3 text-sm">
                                <p><strong>Patterns question counts:</strong></p>
                                <ul class="list-disc list-inside ml-2 mt-1">
                                    <li class="text-green-600">Beginner: ${result.counts.beginner} questions</li>
                                    <li class="text-yellow-600">Intermediate: ${result.counts.intermediate} questions</li>
                                    <li class="text-red-600">Advanced: ${result.counts.advanced} questions</li>
                                    <li><strong>Total: ${result.total} questions</strong></li>
                                </ul>
                            </div>
                            ${result.sample_questions && result.sample_questions.length > 0 ? `
                                <div class="mt-3">
                                    <p class="text-sm font-medium text-gray-700">Sample questions generated:</p>
                                    <ul class="text-xs text-gray-600 mt-1 max-h-32 overflow-y-auto">
                                        ${result.sample_questions.map(q => `
                                            <li class="flex items-center gap-2 py-1">
                                                <span class="px-2 py-0.5 rounded text-white text-xs ${
                                                    q.type === 'dot' ? 'bg-blue-500' :
                                                    q.type === 'linear' ? 'bg-green-500' :
                                                    q.type === 'staircase' ? 'bg-orange-500' :
                                                    q.type === 'shape' ? 'bg-red-500' : 'bg-purple-500'
                                                }">${q.type}</span>
                                                <span class="px-2 py-0.5 rounded text-xs ${
                                                    q.difficulty === 'beginner' ? 'bg-green-100 text-green-700' :
                                                    q.difficulty === 'intermediate' ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'
                                                }">${q.difficulty}</span>
                                                <span>${q.question}</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    resultDiv.classList.remove('hidden');
                    
                    // Refresh counts
                    loadPatternsQuestionCounts();
                    loadTopicsAdmin();
                } else {
                    resultDiv.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <h4 class="font-semibold text-red-700 mb-2"><i class="fas fa-exclamation-circle mr-2"></i>Error</h4>
                            <p class="text-red-700">${result.error || 'Unknown error occurred'}</p>
                        </div>
                    `;
                    resultDiv.classList.remove('hidden');
                }
            } catch (error) {
                progressDiv.classList.add('hidden');
                generateBtn.disabled = false;
                
                resultDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <h4 class="font-semibold text-red-700 mb-2"><i class="fas fa-exclamation-circle mr-2"></i>Error</h4>
                        <p class="text-red-700">Network error: ${error.message}</p>
                    </div>
                `;
                resultDiv.classList.remove('hidden');
            }
        }
        
        // =================================================================
        // COORDINATE GEOMETRY GENERATOR FUNCTIONS
        // =================================================================
        
        function loadCoordinateQuestionCounts() {
            fetch('/api/admin/question-counts/coordinate_geometry')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('coordCountBeginner').textContent = data.beginner || 0;
                    document.getElementById('coordCountIntermediate').textContent = data.intermediate || 0;
                    document.getElementById('coordCountAdvanced').textContent = data.advanced || 0;
                })
                .catch(err => {
                    console.log('Could not load coordinate counts:', err);
                });
        }
        
        async function generateCoordinateQuestions() {
            // Gather selected topic types
            const topicTypes = [];
            if (document.getElementById('coordPoint').checked) topicTypes.push('point');
            if (document.getElementById('coordDistance').checked) topicTypes.push('distance');
            if (document.getElementById('coordMidpoint').checked) topicTypes.push('midpoint');
            if (document.getElementById('coordSlope').checked) topicTypes.push('slope');
            if (document.getElementById('coordEquation').checked) topicTypes.push('equation');
            if (document.getElementById('coordParallel').checked) topicTypes.push('parallel');
            
            // Gather selected difficulties
            const difficulties = [];
            if (document.getElementById('coordDiffBeginner').checked) difficulties.push('beginner');
            if (document.getElementById('coordDiffIntermediate').checked) difficulties.push('intermediate');
            if (document.getElementById('coordDiffAdvanced').checked) difficulties.push('advanced');
            
            const problemsPerType = parseInt(document.getElementById('coordProblemsPerType').value) || 2;
            
            // Validation
            if (topicTypes.length === 0) {
                alert('Please select at least one topic type');
                return;
            }
            if (difficulties.length === 0) {
                alert('Please select at least one difficulty level');
                return;
            }
            
            const generateBtn = document.getElementById('coordGenerateBtn');
            const progressDiv = document.getElementById('coordGeneratorProgress');
            const resultDiv = document.getElementById('coordGeneratorResult');
            
            generateBtn.disabled = true;
            progressDiv.classList.remove('hidden');
            resultDiv.classList.add('hidden');
            
            try {
                const response = await fetch('/api/admin/generate-coordinate-questions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic_types: topicTypes,
                        difficulties: difficulties,
                        problems_per_type: problemsPerType
                    })
                });
                
                const result = await response.json();
                
                progressDiv.classList.add('hidden');
                generateBtn.disabled = false;
                
                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="bg-teal-50 border border-teal-200 rounded-lg p-4">
                            <h4 class="font-semibold text-teal-700 mb-2"><i class="fas fa-check-circle mr-2"></i>Success!</h4>
                            <p class="text-teal-700">${result.message}</p>
                            <div class="mt-2 text-sm text-teal-600">
                                <strong>New totals:</strong> 
                                Beginner: ${result.counts.beginner}, 
                                Intermediate: ${result.counts.intermediate}, 
                                Advanced: ${result.counts.advanced}
                                (Total: ${result.total})
                            </div>
                            ${result.sample_questions && result.sample_questions.length > 0 ? `
                                <div class="mt-3">
                                    <p class="text-sm font-medium text-gray-700">Sample questions generated:</p>
                                    <ul class="text-xs text-gray-600 mt-1 max-h-32 overflow-y-auto">
                                        ${result.sample_questions.map(q => `
                                            <li class="flex items-center gap-2 py-1">
                                                <span class="px-2 py-0.5 rounded text-white text-xs ${
                                                    q.type === 'point' ? 'bg-pink-500' :
                                                    q.type === 'distance' ? 'bg-blue-500' :
                                                    q.type === 'midpoint' ? 'bg-orange-500' :
                                                    q.type === 'slope' ? 'bg-green-500' :
                                                    q.type === 'equation' ? 'bg-purple-500' : 'bg-teal-500'
                                                }">${q.type}</span>
                                                <span class="px-2 py-0.5 rounded text-xs ${
                                                    q.difficulty === 'beginner' ? 'bg-green-100 text-green-700' :
                                                    q.difficulty === 'intermediate' ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'
                                                }">${q.difficulty}</span>
                                                <span>${q.question}</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    resultDiv.classList.remove('hidden');
                    
                    // Refresh counts
                    loadCoordinateQuestionCounts();
                    loadTopicsAdmin();
                } else {
                    resultDiv.innerHTML = `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <h4 class="font-semibold text-red-700 mb-2"><i class="fas fa-exclamation-circle mr-2"></i>Error</h4>
                            <p class="text-red-700">${result.error || 'Unknown error occurred'}</p>
                        </div>
                    `;
                    resultDiv.classList.remove('hidden');
                }
            } catch (error) {
                progressDiv.classList.add('hidden');
                generateBtn.disabled = false;
                
                resultDiv.innerHTML = `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <h4 class="font-semibold text-red-700 mb-2"><i class="fas fa-exclamation-circle mr-2"></i>Error</h4>
                        <p class="text-red-700">Network error: ${error.message}</p>
                    </div>
                `;
                resultDiv.classList.remove('hidden');
            }
        }

        // =================================================================
        // SPEED, DISTANCE, TIME QUESTION GENERATOR FUNCTIONS
        // =================================================================
        
        async function loadSDTQuestionCounts() {
            try {
                const response = await fetch('/api/admin/sdt-generator-status');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('sdtCountBeginner').textContent = data.counts?.beginner || 0;
                    document.getElementById('sdtCountIntermediate').textContent = data.counts?.intermediate || 0;
                    document.getElementById('sdtCountAdvanced').textContent = data.counts?.advanced || 0;
                }
            } catch (err) {
                console.log('Could not load SDT counts:', err);
            }
        }
        
        async function generateSDTQuestions() {
            const questionTypes = [];
            if (document.getElementById('sdtTypeSpeed').checked) questionTypes.push('find_speed');
            if (document.getElementById('sdtTypeDistance').checked) questionTypes.push('find_distance');
            if (document.getElementById('sdtTypeTime').checked) questionTypes.push('find_time');
            if (document.getElementById('sdtTypeGraph').checked) questionTypes.push('graph_reading');
            if (document.getElementById('sdtTypeComparison').checked) questionTypes.push('comparison');
            if (document.getElementById('sdtTypeConversion').checked) questionTypes.push('unit_conversion');
            
            const difficulties = [];
            if (document.getElementById('sdtDiffBeginner').checked) difficulties.push('beginner');
            if (document.getElementById('sdtDiffIntermediate').checked) difficulties.push('intermediate');
            if (document.getElementById('sdtDiffAdvanced').checked) difficulties.push('advanced');
            
            const questionsPerType = parseInt(document.getElementById('sdtQuestionsPerType').value) || 3;
            
            if (questionTypes.length === 0 || difficulties.length === 0) {
                alert('Please select at least one question type and difficulty');
                return;
            }
            
            const btn = document.getElementById('sdtGenerateBtn');
            const progress = document.getElementById('sdtGeneratorProgress');
            const result = document.getElementById('sdtGeneratorResult');
            
            btn.disabled = true;
            progress.classList.remove('hidden');
            result.classList.add('hidden');
            
            try {
                const response = await fetch('/api/admin/generate-sdt-questions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question_types: questionTypes, difficulties, questions_per_type: questionsPerType })
                });
                
                const data = await response.json();
                progress.classList.add('hidden');
                btn.disabled = false;
                
                if (data.success) {
                    result.innerHTML = `<div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <p class="text-green-700"><i class="fas fa-check-circle mr-2"></i>${data.message}</p>
                        <p class="text-sm text-green-600 mt-2">Beginner: ${data.counts.beginner} | Intermediate: ${data.counts.intermediate} | Advanced: ${data.counts.advanced}</p>
                    </div>`;
                    loadSDTQuestionCounts();
                    loadTopicsAdmin();
                } else {
                    result.innerHTML = `<div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <p class="text-red-700"><i class="fas fa-exclamation-circle mr-2"></i>${data.error || 'Error occurred'}</p>
                    </div>`;
                }
                result.classList.remove('hidden');
            } catch (error) {
                progress.classList.add('hidden');
                btn.disabled = false;
                result.innerHTML = `<div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <p class="text-red-700">Network error: ${error.message}</p>
                </div>`;
                result.classList.remove('hidden');
            }
        }
        
        // =================================================================
        // CURRENCY QUESTION GENERATOR FUNCTIONS
        // =================================================================
        
        async function loadCurrencyQuestionCounts() {
            try {
                const response = await fetch('/api/admin/currency-generator-status');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('currencyCountBeginner').textContent = data.counts?.beginner || 0;
                    document.getElementById('currencyCountIntermediate').textContent = data.counts?.intermediate || 0;
                    document.getElementById('currencyCountAdvanced').textContent = data.counts?.advanced || 0;
                }
            } catch (err) {
                console.log('Could not load currency counts:', err);
            }
        }
        
        async function generateCurrencyQuestions() {
            const questionTypes = [];
            if (document.getElementById('currencyTypeCents').checked) questionTypes.push('cents_euro');
            if (document.getElementById('currencyTypeCoins').checked) questionTypes.push('count_coins');
            if (document.getElementById('currencyTypeChange').checked) questionTypes.push('making_change');
            if (document.getElementById('currencyTypeShopping').checked) questionTypes.push('shopping_total');
            if (document.getElementById('currencyTypeExchange').checked) questionTypes.push('exchange_rate');
            if (document.getElementById('currencyTypeDiscount').checked) questionTypes.push('discount');
            
            const difficulties = [];
            if (document.getElementById('currencyDiffBeginner').checked) difficulties.push('beginner');
            if (document.getElementById('currencyDiffIntermediate').checked) difficulties.push('intermediate');
            if (document.getElementById('currencyDiffAdvanced').checked) difficulties.push('advanced');
            
            const questionsPerType = parseInt(document.getElementById('currencyQuestionsPerType').value) || 3;
            
            if (questionTypes.length === 0 || difficulties.length === 0) {
                alert('Please select at least one question type and difficulty');
                return;
            }
            
            const btn = document.getElementById('currencyGenerateBtn');
            const progress = document.getElementById('currencyGeneratorProgress');
            const result = document.getElementById('currencyGeneratorResult');
            
            btn.disabled = true;
            progress.classList.remove('hidden');
            result.classList.add('hidden');
            
            try {
                const response = await fetch('/api/admin/generate-currency-questions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question_types: questionTypes, difficulties, questions_per_type: questionsPerType })
                });
                
                const data = await response.json();
                progress.classList.add('hidden');
                btn.disabled = false;
                
                if (data.success) {
                    result.innerHTML = `<div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <p class="text-green-700"><i class="fas fa-check-circle mr-2"></i>${data.message}</p>
                        <p class="text-sm text-green-600 mt-2">Beginner: ${data.counts.beginner} | Intermediate: ${data.counts.intermediate} | Advanced: ${data.counts.advanced}</p>
                    </div>`;
                    loadCurrencyQuestionCounts();
                    loadTopicsAdmin();
                } else {
                    result.innerHTML = `<div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <p class="text-red-700"><i class="fas fa-exclamation-circle mr-2"></i>${data.error || 'Error occurred'}</p>
                    </div>`;
                }
                result.classList.remove('hidden');
            } catch (error) {
                progress.classList.add('hidden');
                btn.disabled = false;
                result.innerHTML = `<div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <p class="text-red-700">Network error: ${error.message}</p>
                </div>`;
                result.classList.remove('hidden');
            }
        }

        // =================================================================
        // SETS QUESTION GENERATOR FUNCTIONS
        // =================================================================
        
        async function loadSetsQuestionCounts() {
            try {
                const response = await fetch('/api/admin/question-counts/sets');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('setsCountBeginner').textContent = data.beginner || 0;
                    document.getElementById('setsCountIntermediate').textContent = data.intermediate || 0;
                    document.getElementById('setsCountAdvanced').textContent = data.advanced || 0;
                }
            } catch (err) {
                console.log('Could not load sets counts:', err);
            }
        }
        
        async function generateSetsQuestions() {
            const questionTypes = [];
            if (document.getElementById('setsTypeSurvey').checked) questionTypes.push('survey');
            if (document.getElementById('setsTypeNumber').checked) questionTypes.push('number');
            if (document.getElementById('setsTypeNotation').checked) questionTypes.push('notation');
            
            const difficulties = [];
            if (document.getElementById('setsDiffBeginner').checked) difficulties.push('beginner');
            if (document.getElementById('setsDiffIntermediate').checked) difficulties.push('intermediate');
            if (document.getElementById('setsDiffAdvanced').checked) difficulties.push('advanced');
            
            const setsPerType = parseInt(document.getElementById('setsSetsPerType').value) || 3;
            
            if (questionTypes.length === 0 || difficulties.length === 0) {
                alert('Please select at least one question type and difficulty');
                return;
            }
            
            const btn = document.getElementById('setsGenerateBtn');
            const progress = document.getElementById('setsGeneratorProgress');
            const result = document.getElementById('setsGeneratorResult');
            
            btn.disabled = true;
            progress.classList.remove('hidden');
            result.classList.add('hidden');
            
            try {
                const response = await fetch('/api/admin/generate-sets-questions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question_types: questionTypes, difficulties, sets_per_type: setsPerType })
                });
                
                const data = await response.json();
                progress.classList.add('hidden');
                btn.disabled = false;
                
                if (data.success) {
                    result.innerHTML = `<div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <p class="text-green-700"><i class="fas fa-check-circle mr-2"></i>${data.message}</p>
                        <p class="text-sm text-green-600 mt-2">Beginner: ${data.counts.beginner} | Intermediate: ${data.counts.intermediate} | Advanced: ${data.counts.advanced}</p>
                    </div>`;
                    loadSetsQuestionCounts();
                    loadTopicsAdmin();
                } else {
                    result.innerHTML = `<div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <p class="text-red-700"><i class="fas fa-exclamation-circle mr-2"></i>${data.error || 'Error occurred'}</p>
                    </div>`;
                }
                result.classList.remove('hidden');
            } catch (error) {
                progress.classList.add('hidden');
                btn.disabled = false;
                result.innerHTML = `<div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <p class="text-red-700">Network error: ${error.message}</p>
                </div>`;
                result.classList.remove('hidden');
            }
        }

        // =================================================================
        // PERCENTAGES QUESTION GENERATOR FUNCTIONS
        // =================================================================
        
        async function loadPercentagesQuestionCounts() {
            try {
                const response = await fetch('/api/admin/question-counts/percentages');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('pctCountBeginner').textContent = data.beginner || 0;
                    document.getElementById('pctCountIntermediate').textContent = data.intermediate || 0;
                    document.getElementById('pctCountAdvanced').textContent = data.advanced || 0;
                }
            } catch (err) {
                console.log('Could not load percentages counts:', err);
            }
        }
        
        async function generatePercentagesQuestions() {
            const questionTypes = [];
            if (document.getElementById('pctTypeBasic').checked) questionTypes.push('basic');
            if (document.getElementById('pctTypeIncDec').checked) questionTypes.push('increase_decrease');
            if (document.getElementById('pctTypeProfitLoss').checked) questionTypes.push('profit_loss');
            if (document.getElementById('pctTypeVAT').checked) questionTypes.push('vat');
            if (document.getElementById('pctTypeCompound').checked) questionTypes.push('compound_interest');
            if (document.getElementById('pctTypeValue').checked) questionTypes.push('value_for_money');
            
            const difficulties = [];
            if (document.getElementById('pctDiffBeginner').checked) difficulties.push('beginner');
            if (document.getElementById('pctDiffIntermediate').checked) difficulties.push('intermediate');
            if (document.getElementById('pctDiffAdvanced').checked) difficulties.push('advanced');
            
            const setsPerType = parseInt(document.getElementById('pctSetsPerType').value) || 3;
            
            if (questionTypes.length === 0 || difficulties.length === 0) {
                alert('Please select at least one question type and difficulty');
                return;
            }
            
            const btn = document.getElementById('pctGenerateBtn');
            const progress = document.getElementById('pctGeneratorProgress');
            const result = document.getElementById('pctGeneratorResult');
            
            btn.disabled = true;
            progress.classList.remove('hidden');
            result.classList.add('hidden');
            
            try {
                const response = await fetch('/api/admin/generate-percentages-questions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question_types: questionTypes, difficulties, sets_per_type: setsPerType })
                });
                
                const data = await response.json();
                progress.classList.add('hidden');
                btn.disabled = false;
                
                if (data.success) {
                    result.innerHTML = `<div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <p class="text-green-700"><i class="fas fa-check-circle mr-2"></i>${data.message}</p>
                        <p class="text-sm text-green-600 mt-2">Beginner: ${data.counts.beginner} | Intermediate: ${data.counts.intermediate} | Advanced: ${data.counts.advanced}</p>
                    </div>`;
                    loadPercentagesQuestionCounts();
                    loadTopicsAdmin();
                } else {
                    result.innerHTML = `<div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <p class="text-red-700"><i class="fas fa-exclamation-circle mr-2"></i>${data.error || 'Error occurred'}</p>
                    </div>`;
                }
                result.classList.remove('hidden');
            } catch (error) {
                progress.classList.add('hidden');
                btn.disabled = false;
                result.innerHTML = `<div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <p class="text-red-700">Network error: ${error.message}</p>
                </div>`;
                result.classList.remove('hidden');
            }
        }

        // =================================================================
        // PROBABILITY QUESTION GENERATOR FUNCTIONS
        // =================================================================
        
        async function loadProbabilityQuestionCounts() {
            try {
                const response = await fetch('/api/admin/question-counts/probability');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('probCountBeginner').textContent = data.beginner || 0;
                    document.getElementById('probCountIntermediate').textContent = data.intermediate || 0;
                    document.getElementById('probCountAdvanced').textContent = data.advanced || 0;
                }
            } catch (err) {
                console.log('Could not load probability counts:', err);
            }
        }
        
        async function generateProbabilityQuestions() {
            const questionTypes = [];
            if (document.getElementById('probTypeBasic').checked) questionTypes.push('basic');
            if (document.getElementById('probTypeDice').checked) questionTypes.push('dice');
            if (document.getElementById('probTypeCoins').checked) questionTypes.push('coins');
            if (document.getElementById('probTypeCards').checked) questionTypes.push('cards');
            if (document.getElementById('probTypeBags').checked) questionTypes.push('bags');
            if (document.getElementById('probTypeExpected').checked) questionTypes.push('expected_frequency');
            if (document.getElementById('probTypeRelative').checked) questionTypes.push('relative_frequency');
            if (document.getElementById('probTypeCombined').checked) questionTypes.push('combined_events');
            
            const difficulties = [];
            if (document.getElementById('probDiffBeginner').checked) difficulties.push('beginner');
            if (document.getElementById('probDiffIntermediate').checked) difficulties.push('intermediate');
            if (document.getElementById('probDiffAdvanced').checked) difficulties.push('advanced');
            
            const setsPerType = parseInt(document.getElementById('probSetsPerType').value) || 3;
            
            if (questionTypes.length === 0 || difficulties.length === 0) {
                alert('Please select at least one question type and difficulty');
                return;
            }
            
            const btn = document.getElementById('probGenerateBtn');
            const progress = document.getElementById('probGeneratorProgress');
            const result = document.getElementById('probGeneratorResult');
            
            btn.disabled = true;
            progress.classList.remove('hidden');
            result.classList.add('hidden');
            
            try {
                const response = await fetch('/api/admin/generate-probability-questions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question_types: questionTypes, difficulties, sets_per_type: setsPerType })
                });
                
                const data = await response.json();
                progress.classList.add('hidden');
                btn.disabled = false;
                
                if (data.success) {
                    result.innerHTML = `<div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <p class="text-green-700"><i class="fas fa-check-circle mr-2"></i>${data.message}</p>
                        <p class="text-sm text-green-600 mt-2">Beginner: ${data.counts.beginner} | Intermediate: ${data.counts.intermediate} | Advanced: ${data.counts.advanced}</p>
                    </div>`;
                    loadProbabilityQuestionCounts();
                    loadTopicsAdmin();
                } else {
                    result.innerHTML = `<div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <p class="text-red-700"><i class="fas fa-exclamation-circle mr-2"></i>${data.error || 'Error occurred'}</p>
                    </div>`;
                }
                result.classList.remove('hidden');
            } catch (error) {
                progress.classList.add('hidden');
                btn.disabled = false;
                result.innerHTML = `<div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <p class="text-red-700">Network error: ${error.message}</p>
                </div>`;
                result.classList.remove('hidden');
            }
        }

        
        // =================================================================
        // USER ANALYTICS FUNCTIONS
        // =================================================================
        
        function loadAnalytics() {
            fetch('/api/admin/analytics/overview')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('total-registered').textContent = data.registered_users;
                    document.getElementById('total-repeat-guests').textContent = data.repeat_guests;
                    document.getElementById('inactive-guests').textContent = data.inactive_guests;
                    document.getElementById('total-casual').textContent = data.casual_sessions_today;
                    
                    if (data.inactive_guests > 0) {
                        document.getElementById('cleanup-alert').style.display = 'block';
                        document.getElementById('cleanup-status').textContent = 
                            `${data.inactive_guests} guest codes ready for cleanup`;
                    }
                });
        }
        
        function loadRegisteredUsers() {
            fetch('/api/admin/analytics/registered-users')
                .then(r => r.json())
                .then(users => {
                    const tbody = document.getElementById('registered-users-table');
                    if (users.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center">No users</td></tr>';
                        return;
                    }
                    tbody.innerHTML = users.map(u => `
                        <tr>
                            <td>${u.full_name}</td>
                            <td>${u.email}</td>
                            <td><span class="badge badge-primary">${u.points}</span></td>
                            <td>${formatDate(u.last_active)}</td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="viewUserDetail('registered',${u.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                });
        }
        
        function loadRepeatGuests() {
            fetch('/api/admin/analytics/repeat-guests')
                .then(r => r.json())
                .then(guests => {
                    const tbody = document.getElementById('repeat-guests-table');
                    if (guests.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center">No guests</td></tr>';
                        return;
                    }
                    tbody.innerHTML = guests.map(g => `
                        <tr>
                            <td><code>${g.guest_code}</code></td>
                            <td>${g.nickname || '-'}</td>
                            <td><span class="badge badge-success">${g.total_score}</span></td>
                            <td>${formatDate(g.last_active)}</td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="viewUserDetail('guest','${g.guest_code}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${g.days_inactive > 60 ? `
                                    <button class="btn btn-sm btn-danger" onclick="recycleGuest('${g.guest_code}')">
                                        <i class="fas fa-recycle"></i>
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `).join('');
                });
        }
        
        function loadInactiveUsers() {
            fetch('/api/admin/analytics/inactive-users')
                .then(r => r.json())
                .then(inactive => {
                    const tbody = document.getElementById('inactive-users-table');
                    if (inactive.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center">No inactive users</td></tr>';
                        return;
                    }
                    tbody.innerHTML = inactive.map(u => `
                        <tr>
                            <td><span class="badge badge-secondary">${u.type}</span></td>
                            <td>${u.identifier}</td>
                            <td>${u.days_inactive}d</td>
                            <td>${u.points}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="recycleGuest('${u.identifier}')">
                                    <i class="fas fa-recycle"></i> Recycle
                                </button>
                            </td>
                        </tr>
                    `).join('');
                });
        }
        
        function viewUserDetail(type, id) {
            fetch(`/api/admin/analytics/user-detail?type=${type}&id=${id}`)
                .then(r => r.json())
                .then(data => {
                    let html = '';
                    if (type === 'registered') {
                        html = `<h5>${data.full_name}</h5>
                                <p>Email: ${data.email}<br>Points: ${data.points}<br>Level: ${data.level}</p>
                                <h6>Recent Activity:</h6>${data.recent_activity}`;
                    } else {
                        html = `<h5>Guest: ${data.guest_code}</h5>
                                <p>Nickname: ${data.nickname || 'None'}<br>Points: ${data.total_score}<br>
                                Quizzes: ${data.quizzes_completed}</p>
                                <h6>Recent:</h6>${data.recent_quizzes}`;
                    }
                    alert(html.replace(/<[^>]*>/g, '\n'));
                });
        }
        
        function recycleGuest(code) {
            if (!confirm(`Recycle guest code ${code}? This permanently deletes all data.`)) return;
            
            fetch('/api/admin/analytics/recycle-guest', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({guest_code: code})
            })
            .then(r => r.json())
            .then(result => {
                alert(result.success ? 'Recycled successfully!' : 'Error: ' + result.error);
                refreshAnalytics();
            });
        }
        
        function runCleanupNow() {
            if (!confirm('Run cleanup now? This will recycle all inactive guest codes (60+ days).')) return;
            
            fetch('/api/admin/analytics/run-cleanup', {method: 'POST'})
                .then(r => r.json())
                .then(result => {
                    alert(`Cleanup complete! Recycled ${result.recycled_count} guest codes.`);
                    refreshAnalytics();
                });
        }
        
        function showCleanupSettings() {
            alert('Cleanup settings: Use /api/admin/analytics/cleanup-settings to configure automatic cleanup.');
        }
        
        function refreshAnalytics() {
            loadAnalytics();
            loadRegisteredUsers();
            loadRepeatGuests();
            loadInactiveUsers();
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return 'Never';
            const date = new Date(dateStr);
            const now = new Date();
            const diff = Math.floor((now - date) / (1000 * 60 * 60 * 24));
            if (diff === 0) return 'Today';
            if (diff === 1) return 'Yesterday';
            if (diff < 7) return `${diff}d ago`;
            return date.toLocaleDateString();
        }
        
        // ==================== NEW USER ANALYTICS FUNCTIONS (MAIN TAB) ====================
        
        function loadUserAnalyticsData() {
            console.log('Loading User Analytics data...');
            loadAnalyticsOverview();
            loadAnalyticsRegisteredUsers();
            loadAnalyticsRepeatGuests();
            loadAnalyticsInactiveUsers();
        }
        
        function loadAnalyticsOverview() {
            fetch('/api/admin/analytics/overview')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('analytics-total-registered').textContent = data.registered_users || 0;
                    document.getElementById('analytics-total-repeat-guests').textContent = data.repeat_guests || 0;
                    document.getElementById('analytics-inactive-guests').textContent = data.inactive_guests || 0;
                    document.getElementById('analytics-total-casual').textContent = data.casual_sessions_today || 0;
                    
                    // Show cleanup banner if there are inactive guests
                    const cleanupAlert = document.getElementById('analytics-cleanup-alert');
                    if (data.inactive_guests > 0) {
                        cleanupAlert.classList.remove('hidden');
                        document.getElementById('analytics-cleanup-status').textContent = 
                            `${data.inactive_guests} guest code(s) inactive 60+ days ready for cleanup`;
                    } else {
                        cleanupAlert.classList.add('hidden');
                    }
                })
                .catch(err => console.error('Error loading analytics overview:', err));
        }
        
        function loadAnalyticsRegisteredUsers() {
            fetch('/api/admin/analytics/registered-users')
                .then(r => r.json())
                .then(data => {
                    const tbody = document.getElementById('analytics-registered-users-table');
                    // Check if it's an error response
                    if (data && data.error) {
                        tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-500">API Error: ${data.error}</td></tr>`;
                        console.error('API Error:', data);
                        return;
                    }
                    if (!data || !Array.isArray(data) || data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No registered users found</td></tr>';
                        return;
                    }
                    tbody.innerHTML = data.map(u => `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2">${u.full_name || 'N/A'}</td>
                            <td class="px-4 py-2">${u.email || 'N/A'}</td>
                            <td class="px-4 py-2"><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm">${u.points || 0}</span></td>
                            <td class="px-4 py-2 text-sm text-gray-600">${formatDate(u.last_active)}</td>
                            <td class="px-4 py-2">
                                <button onclick="viewAnalyticsUserDetail('registered',${u.id})" class="bg-cyan-500 hover:bg-cyan-600 text-white px-2 py-1 rounded text-sm">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                })
                .catch(err => {
                    console.error('Fetch error:', err);
                    document.getElementById('analytics-registered-users-table').innerHTML = 
                        `<tr><td colspan="5" class="text-center py-4 text-red-500">Fetch Error: ${err.message}</td></tr>`;
                });
        }
        
        function loadAnalyticsRepeatGuests() {
            fetch('/api/admin/analytics/repeat-guests')
                .then(r => r.json())
                .then(data => {
                    const tbody = document.getElementById('analytics-repeat-guests-table');
                    // Check if it's an error response
                    if (data && data.error) {
                        tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-500">API Error: ${data.error}</td></tr>`;
                        console.error('API Error:', data);
                        return;
                    }
                    if (!data || !Array.isArray(data) || data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No repeat guests found</td></tr>';
                        return;
                    }
                    tbody.innerHTML = data.map(g => `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2"><code class="bg-gray-100 px-2 py-1 rounded">${g.guest_code}</code></td>
                            <td class="px-4 py-2">${g.nickname || '-'}</td>
                            <td class="px-4 py-2"><span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm">${g.total_score || 0}</span></td>
                            <td class="px-4 py-2 text-sm text-gray-600">${formatDate(g.last_active)}</td>
                            <td class="px-4 py-2">
                                <button onclick="viewAnalyticsUserDetail('guest','${g.guest_code}')" class="bg-cyan-500 hover:bg-cyan-600 text-white px-2 py-1 rounded text-sm mr-1">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${g.days_inactive > 60 ? `
                                    <button onclick="recycleAnalyticsGuest('${g.guest_code}')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm">
                                        <i class="fas fa-recycle"></i>
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `).join('');
                })
                .catch(err => {
                    console.error('Fetch error:', err);
                    document.getElementById('analytics-repeat-guests-table').innerHTML = 
                        `<tr><td colspan="5" class="text-center py-4 text-red-500">Fetch Error: ${err.message}</td></tr>`;
                });
        }
        
        function loadAnalyticsInactiveUsers() {
            fetch('/api/admin/analytics/inactive-users')
                .then(r => r.json())
                .then(data => {
                    const tbody = document.getElementById('analytics-inactive-users-table');
                    // Check if it's an error response
                    if (data && data.error) {
                        tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-500">API Error: ${data.error}</td></tr>`;
                        console.error('API Error:', data);
                        return;
                    }
                    if (!data || !Array.isArray(data) || data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No inactive users (60+ days) found</td></tr>';
                        return;
                    }
                    tbody.innerHTML = data.map(u => `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2"><span class="bg-gray-200 text-gray-700 px-2 py-1 rounded text-sm">${u.type}</span></td>
                            <td class="px-4 py-2">${u.identifier}</td>
                            <td class="px-4 py-2 text-orange-600 font-semibold">${u.days_inactive}d</td>
                            <td class="px-4 py-2">${u.points || 0}</td>
                            <td class="px-4 py-2">
                                <button onclick="recycleAnalyticsGuest('${u.identifier}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                                    <i class="fas fa-recycle mr-1"></i>Recycle
                                </button>
                            </td>
                        </tr>
                    `).join('');
                })
                .catch(err => {
                    console.error('Fetch error:', err);
                    document.getElementById('analytics-inactive-users-table').innerHTML = 
                        `<tr><td colspan="5" class="text-center py-4 text-red-500">Fetch Error: ${err.message}</td></tr>`;
                });
        }
        
        function showAnalyticsSubTab(tab) {
            // Hide all sub-contents
            document.querySelectorAll('.analytics-sub-content').forEach(el => el.classList.add('hidden'));
            // Remove active styling from all sub-tabs
            document.querySelectorAll('.analytics-sub-tab').forEach(el => {
                el.classList.remove('border-blue-600', 'text-blue-600', 'border-b-2');
                el.classList.add('text-gray-600');
            });
            
            // Show selected content
            const contentId = 'analytics' + tab.charAt(0).toUpperCase() + tab.slice(1) + 'Content';
            const content = document.getElementById(contentId);
            if (content) {
                content.classList.remove('hidden');
            }
            
            // Style selected tab
            const tabBtn = document.getElementById('analytics' + tab.charAt(0).toUpperCase() + tab.slice(1) + 'Tab');
            if (tabBtn) {
                tabBtn.classList.add('border-blue-600', 'text-blue-600', 'border-b-2');
                tabBtn.classList.remove('text-gray-600');
            }
        }
        
        function viewAnalyticsUserDetail(type, id) {
            fetch(`/api/admin/analytics/user-detail?type=${type}&id=${id}`)
                .then(r => r.json())
                .then(data => {
                    let msg = '';
                    if (type === 'registered') {
                        msg = `User: ${data.full_name}\nEmail: ${data.email}\nPoints: ${data.points}\nLevel: ${data.level}\n\nRecent Activity:\n${data.recent_activity || 'None'}`;
                    } else {
                        msg = `Guest Code: ${data.guest_code}\nNickname: ${data.nickname || 'None'}\nPoints: ${data.total_score}\nQuizzes: ${data.quizzes_completed}\n\nRecent Quizzes:\n${data.recent_quizzes || 'None'}`;
                    }
                    alert(msg.replace(/<[^>]*>/g, ''));
                })
                .catch(err => alert('Error loading user details'));
        }
        
        function recycleAnalyticsGuest(code) {
            if (!confirm(`Recycle guest code "${code}"?\n\nThis permanently deletes:\n- All quiz attempts\n- All badges\n- All progress data\n\nThis cannot be undone.`)) return;
            
            fetch('/api/admin/analytics/recycle-guest', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({guest_code: code})
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    alert('Guest code recycled successfully!');
                    loadUserAnalyticsData(); // Refresh all data
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            })
            .catch(err => alert('Error recycling guest code'));
        }
        
        function runAnalyticsCleanup() {
            if (!confirm('Run bulk cleanup?\n\nThis will permanently delete ALL guest codes inactive for 60+ days.\n\nThis cannot be undone.')) return;
            
            fetch('/api/admin/analytics/run-cleanup', {method: 'POST'})
                .then(r => r.json())
                .then(result => {
                    alert(`Cleanup complete!\n\nRecycled ${result.recycled_count || 0} guest code(s).`);
                    loadUserAnalyticsData(); // Refresh all data
                })
                .catch(err => alert('Error running cleanup'));
        }
        
        // End of analytics functions

        // ==================== PUZZLE OF THE WEEK FUNCTIONS ====================
        
        let allPuzzlesData = [];
        let activePuzzleId = null;
        let currentWeek = null;
        let currentYear = null;

        async function loadPuzzleData() {
            try {
                const response = await fetch('/api/admin/puzzles');
                const data = await response.json();
                
                // Check for API error
                if (data.error) {
                    console.error('API returned error:', data.error);
                    document.getElementById('puzzle-library-table').innerHTML = 
                        `<tr><td colspan="6" class="text-center py-8 text-red-500">API Error: ${data.error}</td></tr>`;
                }
                
                allPuzzlesData = data.puzzles || [];
                currentWeek = data.current_week;
                currentYear = data.current_year;
                
                // Update current week display
                document.getElementById('puzzle-current-week').textContent = `Week ${currentWeek}`;
                document.getElementById('puzzle-current-year').textContent = currentYear;
                
                // Set default values in the create form
                document.getElementById('puzzle-week').value = currentWeek;
                document.getElementById('puzzle-year').value = currentYear;
                
                // Find active puzzle for current week
                const activePuzzle = allPuzzlesData.find(p => 
                    p.week_number === currentWeek && 
                    p.year === currentYear && 
                    p.is_active
                );
                
                if (activePuzzle) {
                    activePuzzleId = activePuzzle.id;
                    document.getElementById('puzzle-active-status').innerHTML = `<i class="fas fa-check-circle mr-2"></i>Active: "${activePuzzle.title}"`;
                    showActivePuzzle(activePuzzle);
                    document.getElementById('active-puzzle-section').classList.remove('hidden');
                    document.getElementById('no-active-puzzle-alert').classList.add('hidden');
                } else {
                    activePuzzleId = null;
                    document.getElementById('puzzle-active-status').innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>No active puzzle`;
                    document.getElementById('active-puzzle-section').classList.add('hidden');
                    document.getElementById('no-active-puzzle-alert').classList.remove('hidden');
                }
                
                // Render puzzle library
                renderPuzzleLibrary();
                
            } catch (error) {
                console.error('Error loading puzzles:', error);
                document.getElementById('puzzle-current-week').textContent = `Week ??`;
                document.getElementById('puzzle-current-year').textContent = '????';
                document.getElementById('puzzle-active-status').innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i>Error loading`;
                document.getElementById('puzzle-library-table').innerHTML = 
                    `<tr><td colspan="6" class="text-center py-8 text-red-500">Error loading puzzles: ${error.message}</td></tr>`;
            }
        }

        function showActivePuzzle(puzzle) {
            // Show puzzle content
            const puzzlePreview = document.getElementById('active-puzzle-preview');
            if (puzzle.puzzle_type === 'image' && puzzle.puzzle_image) {
                puzzlePreview.innerHTML = `<img src="${puzzle.puzzle_image}" alt="Puzzle" class="max-w-full rounded">`;
            } else if (puzzle.puzzle_text) {
                puzzlePreview.innerHTML = `<pre class="whitespace-pre-wrap font-mono text-sm">${escapeHtml(puzzle.puzzle_text)}</pre>`;
            } else {
                puzzlePreview.innerHTML = '<p class="text-gray-500 italic">No puzzle content</p>';
            }
            
            // Show answer content
            const answerPreview = document.getElementById('active-answer-preview');
            if (puzzle.answer_image) {
                answerPreview.innerHTML = `<img src="${puzzle.answer_image}" alt="Answer" class="max-w-full rounded">`;
            } else if (puzzle.answer_text) {
                answerPreview.innerHTML = `<pre class="whitespace-pre-wrap font-mono text-sm">${escapeHtml(puzzle.answer_text)}</pre>`;
            } else {
                answerPreview.innerHTML = '<p class="text-gray-500 italic">No answer content</p>';
            }
            
            // Update stats
            document.getElementById('active-puzzle-views').textContent = puzzle.view_count || 0;
            document.getElementById('active-puzzle-reveals').textContent = puzzle.reveal_count || 0;
            document.getElementById('active-puzzle-hints').textContent = puzzle.hint_view_count || 0;
            
            // Load detailed stats for unique users
            loadActivePuzzleStats(puzzle.id);
        }

        async function loadActivePuzzleStats(puzzleId) {
            try {
                const response = await fetch(`/api/admin/puzzles/${puzzleId}/stats`);
                const stats = await response.json();
                document.getElementById('active-puzzle-users').textContent = stats.unique_users || 0;
            } catch (error) {
                console.error('Error loading puzzle stats:', error);
            }
        }

        function renderPuzzleLibrary() {
            const tbody = document.getElementById('puzzle-library-table');
            
            if (allPuzzlesData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500">No puzzles yet. Create your first puzzle!</td></tr>';
                return;
            }
            
            tbody.innerHTML = allPuzzlesData.map(puzzle => {
                const isCurrentWeek = puzzle.week_number === currentWeek && puzzle.year === currentYear;
                const statusBadge = puzzle.is_active 
                    ? '<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-semibold"><i class="fas fa-check-circle mr-1"></i>Live</span>'
                    : isCurrentWeek 
                        ? '<span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-xs font-semibold">Ready</span>'
                        : '<span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-semibold">Scheduled</span>';
                
                const typeBadge = puzzle.puzzle_type === 'image'
                    ? '<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs"><i class="fas fa-image mr-1"></i>Image</span>'
                    : '<span class="bg-purple-100 text-purple-700 px-2 py-1 rounded text-xs"><i class="fas fa-font mr-1"></i>Text</span>';
                
                return `
                    <tr class="hover:bg-gray-50 ${isCurrentWeek ? 'bg-purple-50' : ''}">
                        <td class="px-4 py-3">
                            <span class="font-semibold">Week ${puzzle.week_number}</span>
                            <span class="text-gray-500">, ${puzzle.year}</span>
                            ${isCurrentWeek ? '<span class="ml-2 text-purple-600 text-xs">(Current)</span>' : ''}
                        </td>
                        <td class="px-4 py-3">
                            <div class="font-medium">${escapeHtml(puzzle.title)}</div>
                            ${puzzle.description ? `<div class="text-sm text-gray-500">${escapeHtml(puzzle.description.substring(0, 50))}${puzzle.description.length > 50 ? '...' : ''}</div>` : ''}
                        </td>
                        <td class="px-4 py-3">${typeBadge}</td>
                        <td class="px-4 py-3">${statusBadge}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">
                            <i class="fas fa-eye mr-1"></i>${puzzle.view_count || 0}
                            <i class="fas fa-check-circle ml-2 mr-1"></i>${puzzle.reveal_count || 0}
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex gap-1">
                                <button onclick="viewPuzzleStats(${puzzle.id})" class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs hover:bg-blue-200" title="View Stats">
                                    <i class="fas fa-chart-bar"></i>
                                </button>
                                <button onclick="editPuzzle(${puzzle.id})" class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded text-xs hover:bg-yellow-200" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                ${!puzzle.is_active ? `
                                    <button onclick="activatePuzzle(${puzzle.id})" class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs hover:bg-green-200" title="Activate">
                                        <i class="fas fa-play"></i>
                                    </button>
                                ` : `
                                    <button onclick="deactivatePuzzle(${puzzle.id})" class="bg-orange-100 text-orange-700 px-2 py-1 rounded text-xs hover:bg-orange-200" title="Deactivate">
                                        <i class="fas fa-stop"></i>
                                    </button>
                                `}
                                <button onclick="deletePuzzle(${puzzle.id})" class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs hover:bg-red-200" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function openPuzzleModal(puzzleId = null) {
            document.getElementById('puzzle-modal').classList.remove('hidden');
            document.getElementById('puzzle-form').reset();
            
            // Reset image previews
            document.getElementById('puzzle-image-preview').classList.add('hidden');
            document.getElementById('answer-image-preview').classList.add('hidden');
            document.getElementById('puzzle-image-path').value = '';
            document.getElementById('answer-image-path').value = '';
            
            if (puzzleId) {
                // Edit mode
                const puzzle = allPuzzlesData.find(p => p.id === puzzleId);
                if (puzzle) {
                    document.getElementById('puzzle-modal-title').textContent = 'Edit Puzzle';
                    document.getElementById('puzzle-id').value = puzzle.id;
                    document.getElementById('puzzle-title').value = puzzle.title || '';
                    document.getElementById('puzzle-type').value = puzzle.puzzle_type || 'image';
                    document.getElementById('puzzle-week').value = puzzle.week_number;
                    document.getElementById('puzzle-year').value = puzzle.year;
                    document.getElementById('puzzle-description').value = puzzle.description || '';
                    document.getElementById('puzzle-text').value = puzzle.puzzle_text || '';
                    document.getElementById('answer-text').value = puzzle.answer_text || '';
                    document.getElementById('puzzle-hint').value = puzzle.hint || '';
                    document.getElementById('puzzle-active').checked = puzzle.is_active;
                    
                    // Show existing images
                    if (puzzle.puzzle_image) {
                        document.getElementById('puzzle-image-path').value = puzzle.puzzle_image;
                        document.getElementById('puzzle-image-preview').classList.remove('hidden');
                        document.getElementById('puzzle-image-preview').querySelector('img').src = puzzle.puzzle_image;
                    }
                    if (puzzle.answer_image) {
                        document.getElementById('answer-image-path').value = puzzle.answer_image;
                        document.getElementById('answer-image-preview').classList.remove('hidden');
                        document.getElementById('answer-image-preview').querySelector('img').src = puzzle.answer_image;
                    }
                    
                    togglePuzzleType();
                }
            } else {
                // Create mode
                document.getElementById('puzzle-modal-title').textContent = 'Create New Puzzle';
                document.getElementById('puzzle-id').value = '';
                document.getElementById('puzzle-week').value = currentWeek;
                document.getElementById('puzzle-year').value = currentYear;
                togglePuzzleType();
            }
        }

        function closePuzzleModal() {
            document.getElementById('puzzle-modal').classList.add('hidden');
        }

        function togglePuzzleType() {
            const type = document.getElementById('puzzle-type').value;
            if (type === 'image') {
                document.getElementById('puzzle-image-section').classList.remove('hidden');
                document.getElementById('puzzle-text-section').classList.add('hidden');
            } else {
                document.getElementById('puzzle-image-section').classList.add('hidden');
                document.getElementById('puzzle-text-section').classList.remove('hidden');
            }
        }

        async function handlePuzzleImageUpload(input, imageType) {
            const file = input.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('type', imageType);
            
            try {
                const response = await fetch('/api/admin/puzzles/upload-image', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (imageType === 'puzzle') {
                        document.getElementById('puzzle-image-path').value = result.path;
                        document.getElementById('puzzle-image-preview').classList.remove('hidden');
                        document.getElementById('puzzle-image-preview').querySelector('img').src = result.path;
                    } else {
                        document.getElementById('answer-image-path').value = result.path;
                        document.getElementById('answer-image-preview').classList.remove('hidden');
                        document.getElementById('answer-image-preview').querySelector('img').src = result.path;
                    }
                } else {
                    alert('Upload failed: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('Upload failed. Please try again.');
            }
        }

        // Form submission
        document.getElementById('puzzle-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const puzzleId = document.getElementById('puzzle-id').value;
            const isEdit = !!puzzleId;
            
            const data = {
                title: document.getElementById('puzzle-title').value,
                description: document.getElementById('puzzle-description').value,
                puzzle_type: document.getElementById('puzzle-type').value,
                puzzle_image: document.getElementById('puzzle-image-path').value || null,
                puzzle_text: document.getElementById('puzzle-text').value || null,
                answer_image: document.getElementById('answer-image-path').value || null,
                answer_text: document.getElementById('answer-text').value || null,
                hint: document.getElementById('puzzle-hint').value || null,
                week_number: parseInt(document.getElementById('puzzle-week').value),
                year: parseInt(document.getElementById('puzzle-year').value),
                is_active: document.getElementById('puzzle-active').checked
            };
            
            try {
                const url = isEdit ? `/api/admin/puzzles/${puzzleId}` : '/api/admin/puzzles';
                const method = isEdit ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    closePuzzleModal();
                    loadPuzzleData();
                    alert(isEdit ? 'Puzzle updated successfully!' : 'Puzzle created successfully!');
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Save error:', error);
                alert('Error saving puzzle: ' + error.message);
            }
        });

        function editPuzzle(puzzleId) {
            openPuzzleModal(puzzleId);
        }

        async function activatePuzzle(puzzleId) {
            if (!confirm('Activate this puzzle? It will become the live puzzle for its week.')) return;
            
            try {
                const response = await fetch(`/api/admin/puzzles/${puzzleId}/activate`, {method: 'POST'});
                const result = await response.json();
                
                if (result.success) {
                    loadPuzzleData();
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Activate error:', error);
                alert('Error activating puzzle.');
            }
        }

        async function deactivatePuzzle(puzzleId) {
            if (!confirm('Deactivate this puzzle? Students will no longer see it.')) return;
            
            try {
                const response = await fetch(`/api/admin/puzzles/${puzzleId}/deactivate`, {method: 'POST'});
                const result = await response.json();
                
                if (result.success) {
                    loadPuzzleData();
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Deactivate error:', error);
                alert('Error deactivating puzzle.');
            }
        }

        async function deletePuzzle(puzzleId) {
            if (!confirm('Delete this puzzle? This cannot be undone.')) return;
            
            try {
                const response = await fetch(`/api/admin/puzzles/${puzzleId}`, {method: 'DELETE'});
                const result = await response.json();
                
                if (result.success) {
                    loadPuzzleData();
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Error deleting puzzle.');
            }
        }

        async function viewPuzzleStats(puzzleId) {
            try {
                const response = await fetch(`/api/admin/puzzles/${puzzleId}/stats`);
                const stats = await response.json();
                
                document.getElementById('stats-puzzle-title').textContent = stats.title;
                document.getElementById('stats-puzzle-week').textContent = `Week ${stats.week_number}, ${stats.year}`;
                document.getElementById('stats-views').textContent = stats.view_count || 0;
                document.getElementById('stats-reveals').textContent = stats.answer_reveals || 0;
                document.getElementById('stats-hints').textContent = stats.hints_viewed || 0;
                document.getElementById('stats-users').textContent = stats.unique_users || 0;
                
                // Calculate rates
                const revealRate = stats.unique_users > 0 
                    ? Math.round((stats.answer_reveals / stats.unique_users) * 100) 
                    : 0;
                const hintRate = stats.unique_users > 0 
                    ? Math.round((stats.hints_viewed / stats.unique_users) * 100) 
                    : 0;
                
                document.getElementById('stats-reveal-rate').textContent = `${revealRate}%`;
                document.getElementById('stats-hint-rate').textContent = `${hintRate}%`;
                
                document.getElementById('puzzle-stats-modal').classList.remove('hidden');
            } catch (error) {
                console.error('Stats error:', error);
                alert('Error loading puzzle stats.');
            }
        }

        function closePuzzleStatsModal() {
            document.getElementById('puzzle-stats-modal').classList.add('hidden');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // End of puzzle functions

        // ==================== SITE SETTINGS FUNCTIONS ====================
        
        async function loadSiteSettings() {
            try {
                const response = await fetch('/api/admin/site-settings');
                const settings = await response.json();
                
                // Update Full Account Login toggle state
                const toggle = document.getElementById('fullAccountLoginToggle');
                const statusText = document.getElementById('fullAccountLoginStatus');
                const summaryText = document.getElementById('settings-full-account');
                
                if (toggle) {
                    toggle.checked = settings.full_account_login_enabled;
                }
                if (statusText) {
                    statusText.textContent = settings.full_account_login_enabled ? 'Enabled' : 'Disabled';
                }
                if (summaryText) {
                    summaryText.textContent = settings.full_account_login_enabled ? 'ON' : 'OFF';
                }
                
                // Update Prize PIN Threshold
                const thresholdInput = document.getElementById('prizePinThreshold');
                const thresholdSummary = document.getElementById('settings-pin-threshold');
                
                if (thresholdInput) {
                    thresholdInput.value = settings.prize_pin_threshold || 2000;
                }
                if (thresholdSummary) {
                    thresholdSummary.textContent = settings.prize_pin_threshold || 2000;
                }
                
                console.log('Site settings loaded:', settings);
                
            } catch (error) {
                console.error('Error loading site settings:', error);
            }
        }
        
        async function toggleFullAccountLogin() {
            const toggle = document.getElementById('fullAccountLoginToggle');
            const enabled = toggle.checked;
            
            try {
                const response = await fetch('/api/admin/site-settings/full-account-login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ enabled: enabled })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update UI
                    document.getElementById('fullAccountLoginStatus').textContent = enabled ? 'Enabled' : 'Disabled';
                    document.getElementById('settings-full-account').textContent = enabled ? 'ON' : 'OFF';
                    
                    // Show notification
                    alert(result.message);
                } else {
                    // Revert toggle if failed
                    toggle.checked = !enabled;
                    alert('Error: ' + (result.error || 'Failed to update setting'));
                }
                
            } catch (error) {
                console.error('Error toggling full account login:', error);
                toggle.checked = !enabled;
                alert('Error updating setting. Please try again.');
            }
        }
        
        async function savePrizePinThreshold() {
            const thresholdInput = document.getElementById('prizePinThreshold');
            const threshold = parseInt(thresholdInput.value) || 2000;
            
            // Validate range
            if (threshold < 500 || threshold > 10000) {
                alert('Threshold must be between 500 and 10,000 points');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/site-settings/prize-pin-threshold', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ threshold: threshold })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update summary
                    document.getElementById('settings-pin-threshold').textContent = threshold;
                    alert(result.message);
                } else {
                    alert('Error: ' + (result.error || 'Failed to update threshold'));
                }
                
            } catch (error) {
                console.error('Error saving prize PIN threshold:', error);
                alert('Error updating setting. Please try again.');
            }
        }

        // End of site settings functions

        // ==================== ADDITIONAL RESOURCES MANAGEMENT ====================
        
        let resourcesData = [];
        let editingResourceId = null;
        
        // Category configuration
        const resourceCategories = {
            'online_tutorials': { label: 'üé¨ Online Tutorials', color: 'red', order: 0 },
            'maths_awareness': { label: 'üß† Maths Awareness', color: 'purple', order: 1 },
            'workbooks': { label: 'üìö Maths WorkBooks', color: 'blue', order: 2 },
            'worksheets': { label: 'üìù Proficiency Building - Worksheet', color: 'green', order: 3 },
            'exam_papers': { label: 'üìã Past Exam Paper and Exam Technique', color: 'orange', order: 4 },
            '': { label: '‚ùì Uncategorized', color: 'gray', order: 5 }
        };
        
        function getCategoryBadge(category) {
            const cat = resourceCategories[category] || resourceCategories[''];
            const colors = {
                'red': 'bg-red-100 text-red-700',
                'purple': 'bg-purple-100 text-purple-700',
                'blue': 'bg-blue-100 text-blue-700',
                'green': 'bg-green-100 text-green-700',
                'orange': 'bg-orange-100 text-orange-700',
                'gray': 'bg-gray-100 text-gray-700'
            };
            return `<span class="text-xs px-2 py-0.5 rounded-full ${colors[cat.color]}">${cat.label}</span>`;
        }
        
        async function loadResourcesList() {
            const container = document.getElementById('resourcesList');
            
            try {
                const response = await fetch('/api/admin/resources');
                const data = await response.json();
                resourcesData = data.resources || [];
                
                if (resourcesData.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 bg-gray-50 rounded-lg">
                            <i class="fas fa-external-link-alt text-5xl text-gray-300 mb-3"></i>
                            <h4 class="text-lg font-semibold text-gray-600 mb-2">No Resources Yet</h4>
                            <p class="text-gray-500">Add your first external learning resource above</p>
                        </div>
                    `;
                    return;
                }
                
                // Group resources by category
                const grouped = {};
                const categoryOrder = ['online_tutorials', 'maths_awareness', 'workbooks', 'worksheets', 'exam_papers', ''];
                
                categoryOrder.forEach(cat => {
                    grouped[cat] = resourcesData.filter(r => (r.category || '') === cat);
                });
                
                let html = '';
                categoryOrder.forEach(cat => {
                    const resources = grouped[cat];
                    if (resources.length === 0) return;
                    
                    const catInfo = resourceCategories[cat] || resourceCategories[''];
                    html += `
                        <div class="mb-6">
                            <h4 class="text-md font-bold text-gray-700 mb-3 flex items-center gap-2">
                                ${catInfo.label}
                                <span class="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full">${resources.length}</span>
                            </h4>
                            <div class="space-y-3">
                    `;
                    
                    resources.forEach(resource => {
                        html += `
                            <div class="border rounded-lg p-4 ${resource.is_active ? 'border-sky-200 bg-sky-50' : 'border-gray-200 bg-gray-50 opacity-60'}">
                                <div class="flex items-start justify-between gap-4">
                                    <div class="flex items-center gap-4 flex-1">
                                        ${resource.image_url ? `
                                            <img src="${resource.image_url}" alt="${resource.button_text}" 
                                                 class="w-16 h-16 object-cover rounded-lg border border-gray-200">
                                        ` : `
                                            <div class="w-16 h-16 bg-gray-200 rounded-lg flex items-center justify-center">
                                                <i class="fas fa-image text-gray-400 text-xl"></i>
                                            </div>
                                        `}
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2 mb-1 flex-wrap">
                                                <h4 class="font-bold text-gray-800">${resource.button_text}</h4>
                                                <span class="text-xs px-2 py-0.5 rounded-full ${resource.is_active ? 'bg-green-100 text-green-700' : 'bg-gray-200 text-gray-600'}">
                                                    ${resource.is_active ? 'Active' : 'Inactive'}
                                                </span>
                                            </div>
                                            <a href="${resource.link_url}" target="_blank" class="text-sm text-sky-600 hover:underline break-all">
                                                ${resource.link_url}
                                            </a>
                                            ${resource.popup_text ? `
                                                <p class="text-sm text-gray-600 mt-1 line-clamp-2">${resource.popup_text}</p>
                                            ` : ''}
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button onclick="toggleResourceActive(${resource.id})" 
                                                class="p-2 rounded-lg ${resource.is_active ? 'bg-yellow-100 hover:bg-yellow-200 text-yellow-700' : 'bg-green-100 hover:bg-green-200 text-green-700'}" 
                                                title="${resource.is_active ? 'Deactivate' : 'Activate'}">
                                            <i class="fas ${resource.is_active ? 'fa-eye-slash' : 'fa-eye'}"></i>
                                        </button>
                                        <button onclick="editResource(${resource.id})" 
                                                class="p-2 bg-sky-100 hover:bg-sky-200 text-sky-700 rounded-lg" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="deleteResource(${resource.id}, '${resource.button_text.replace(/'/g, "\\'")}')" 
                                                class="p-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg" title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="flex items-center gap-4 mt-3 pt-3 border-t border-gray-200 text-xs text-gray-500">
                                    ${getCategoryBadge(resource.category)}
                                    <span><i class="fas fa-sort mr-1"></i>Order: ${resource.display_order}</span>
                                    <span><i class="fas fa-calendar mr-1"></i>Added: ${new Date(resource.created_at).toLocaleDateString()}</span>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div></div>';
                });
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading resources:', error);
                container.innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-circle text-3xl mb-2"></i>
                        <p>Error loading resources</p>
                    </div>
                `;
            }
        }
        
        function previewResourceImage(input) {
            const preview = document.getElementById('resourceImagePreview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
                };
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.innerHTML = '<span class="text-gray-400 text-xs text-center">No image</span>';
            }
        }
        
        function resetResourceForm() {
            document.getElementById('addResourceForm').reset();
            document.getElementById('resourceImagePreview').innerHTML = '<span class="text-gray-400 text-xs text-center">No image</span>';
            editingResourceId = null;
            
            // Reset button text
            const submitBtn = document.querySelector('#addResourceForm button[type="submit"]');
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-plus mr-1"></i>Add Resource';
            }
        }
        
        // Form submission handler
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('addResourceForm');
            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await saveResource();
                });
            }
        });
        
        async function saveResource() {
            const buttonText = document.getElementById('resourceButtonText').value.trim();
            const linkUrl = document.getElementById('resourceLinkUrl').value.trim();
            const popupText = document.getElementById('resourcePopupText').value.trim();
            const category = document.getElementById('resourceCategory').value;
            const displayOrder = document.getElementById('resourceDisplayOrder').value || 1;
            const imageFile = document.getElementById('resourceImageFile').files[0];
            
            if (!buttonText || !linkUrl) {
                alert('Please fill in Button Text and Link URL');
                return;
            }
            
            if (!category) {
                alert('Please select a Category');
                return;
            }
            
            const formData = new FormData();
            formData.append('button_text', buttonText);
            formData.append('link_url', linkUrl);
            formData.append('popup_text', popupText);
            formData.append('category', category);
            formData.append('display_order', displayOrder);
            if (imageFile) {
                formData.append('image', imageFile);
            }
            if (editingResourceId) {
                formData.append('id', editingResourceId);
            }
            
            try {
                const url = editingResourceId 
                    ? `/api/admin/resources/${editingResourceId}`
                    : '/api/admin/resources';
                const method = editingResourceId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(editingResourceId ? 'Resource updated successfully!' : 'Resource added successfully!');
                    resetResourceForm();
                    loadResourcesList();
                } else {
                    alert('Error: ' + (result.error || 'Failed to save resource'));
                }
            } catch (error) {
                console.error('Error saving resource:', error);
                alert('Error saving resource. Please try again.');
            }
        }
        
        function editResource(id) {
            const resource = resourcesData.find(r => r.id === id);
            if (!resource) return;
            
            editingResourceId = id;
            document.getElementById('resourceButtonText').value = resource.button_text;
            document.getElementById('resourceLinkUrl').value = resource.link_url;
            document.getElementById('resourcePopupText').value = resource.popup_text || '';
            document.getElementById('resourceCategory').value = resource.category || '';
            document.getElementById('resourceDisplayOrder').value = resource.display_order || 1;
            
            if (resource.image_url) {
                document.getElementById('resourceImagePreview').innerHTML = 
                    `<img src="${resource.image_url}" class="w-full h-full object-cover">`;
            }
            
            // Update button text to indicate editing
            const submitBtn = document.querySelector('#addResourceForm button[type="submit"]');
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-save mr-1"></i>Update Resource';
            }
            
            // Scroll to form
            document.getElementById('addResourceForm').scrollIntoView({ behavior: 'smooth' });
        }
        
        async function toggleResourceActive(id) {
            try {
                const response = await fetch(`/api/admin/resources/${id}/toggle`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    loadResourcesList();
                } else {
                    alert('Error: ' + (result.error || 'Failed to toggle resource'));
                }
            } catch (error) {
                console.error('Error toggling resource:', error);
                alert('Error toggling resource. Please try again.');
            }
        }
        
        async function deleteResource(id, name) {
            if (!confirm(`Are you sure you want to delete "${name}"?`)) return;
            
            try {
                const response = await fetch(`/api/admin/resources/${id}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('Resource deleted successfully!');
                    loadResourcesList();
                } else {
                    alert('Error: ' + (result.error || 'Failed to delete resource'));
                }
            } catch (error) {
                console.error('Error deleting resource:', error);
                alert('Error deleting resource. Please try again.');
            }
        }
        
        // ==================== END ADDITIONAL RESOURCES MANAGEMENT ====================

        // ==================== RAFFLE MANAGEMENT FUNCTIONS ====================
        
        let currentRaffleId = null;
        let rafflesData = [];
        
        async function loadRaffles() {
            try {
                const response = await fetch('/api/admin/raffles');
                rafflesData = await response.json();
                renderRafflesList();
                updateRaffleStats();
            } catch (error) {
                console.error('Error loading raffles:', error);
                document.getElementById('raffles-list').innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-circle text-4xl mb-3"></i>
                        <p>Error loading raffles</p>
                    </div>
                `;
            }
        }
        
        function updateRaffleStats() {
            const active = rafflesData.filter(r => r.is_active).length;
            const totalEntries = rafflesData.reduce((sum, r) => sum + (r.active_entries || 0), 0);
            const totalDraws = rafflesData.reduce((sum, r) => sum + (r.total_draws || 0), 0);
            const totalPoints = rafflesData.reduce((sum, r) => sum + ((r.active_entries || 0) * r.entry_cost), 0);
            
            document.getElementById('raffle-stat-active').textContent = active;
            document.getElementById('raffle-stat-entries').textContent = totalEntries;
            document.getElementById('raffle-stat-draws').textContent = totalDraws;
            document.getElementById('raffle-stat-points').textContent = totalPoints.toLocaleString();
        }
        
        function renderRafflesList() {
            const container = document.getElementById('raffles-list');
            
            if (rafflesData.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 bg-gray-50 rounded-lg">
                        <i class="fas fa-ticket-alt text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">No Raffles Yet</h3>
                        <p class="text-gray-500 mb-4">Create your first raffle to get started!</p>
                        <button onclick="openCreateRaffleModal()" class="bg-pink-600 text-white px-6 py-2 rounded-lg hover:bg-pink-700">
                            <i class="fas fa-plus mr-2"></i>Create Raffle
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = rafflesData.map(raffle => `
                <div class="bg-white rounded-lg shadow-md p-6 ${raffle.is_active ? '' : 'opacity-60'}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="text-3xl">${raffle.emoji || 'üéüÔ∏è'}</span>
                                <div>
                                    <h3 class="text-lg font-bold">${raffle.name}</h3>
                                    <span class="text-sm ${raffle.is_active ? 'text-green-600' : 'text-gray-500'}">
                                        <i class="fas fa-circle text-xs mr-1"></i>
                                        ${raffle.is_active ? 'Active' : 'Inactive'}
                                    </span>
                                </div>
                            </div>
                            ${raffle.description ? `<p class="text-gray-600 mb-2">${raffle.description}</p>` : ''}
                            <div class="flex flex-wrap gap-4 text-sm">
                                <span class="bg-pink-100 text-pink-700 px-3 py-1 rounded-full">
                                    <i class="fas fa-coins mr-1"></i>${raffle.entry_cost} points/entry
                                </span>
                                <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full">
                                    <i class="fas fa-users mr-1"></i>${raffle.active_entries || 0} entries
                                </span>
                                <span class="bg-purple-100 text-purple-700 px-3 py-1 rounded-full">
                                    <i class="fas fa-trophy mr-1"></i>${raffle.total_draws || 0} draws
                                </span>
                                <span class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full">
                                    <i class="fas fa-clock mr-1"></i>${raffle.draw_frequency || 'weekly'}
                                </span>
                            </div>
                            <div class="mt-3 p-3 bg-yellow-50 rounded-lg">
                                <span class="font-semibold text-yellow-800"><i class="fas fa-gift mr-1"></i>Prize:</span>
                                <span class="text-yellow-900">${raffle.prize_description}</span>
                            </div>
                        </div>
                        <div class="flex flex-col gap-2 ml-4">
                            <button onclick="openDrawConfirmModal(${raffle.id}, ${raffle.active_entries || 0})" 
                                    class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 ${raffle.active_entries > 0 ? '' : 'opacity-50 cursor-not-allowed'}"
                                    ${raffle.active_entries > 0 ? '' : 'disabled'}>
                                <i class="fas fa-random mr-1"></i>Draw
                            </button>
                            <button onclick="viewRaffleEntries(${raffle.id})" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                <i class="fas fa-list mr-1"></i>Entries
                            </button>
                            <button onclick="editRaffle(${raffle.id})" class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600">
                                <i class="fas fa-edit mr-1"></i>Edit
                            </button>
                            <button onclick="toggleRaffleStatus(${raffle.id}, ${raffle.is_active})" 
                                    class="${raffle.is_active ? 'bg-gray-500 hover:bg-gray-600' : 'bg-green-500 hover:bg-green-600'} text-white px-4 py-2 rounded-lg">
                                <i class="fas fa-${raffle.is_active ? 'pause' : 'play'} mr-1"></i>
                                ${raffle.is_active ? 'Pause' : 'Resume'}
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function openCreateRaffleModal() {
            currentRaffleId = null;
            document.getElementById('raffleModalTitle').textContent = 'Create New Raffle';
            document.getElementById('raffleForm').reset();
            document.getElementById('raffleId').value = '';
            document.getElementById('raffleEmoji').value = 'üéüÔ∏è';
            document.getElementById('raffleEntryCost').value = '100';
            document.getElementById('raffleMaxEntries').value = '10';
            document.getElementById('raffleDrawDay').value = '5';
            document.getElementById('raffleDrawTime').value = '15:00';
            document.getElementById('raffleActive').checked = true;
            document.getElementById('raffleAutoDraw').checked = false;
            document.getElementById('raffleModal').classList.remove('hidden');
        }
        
        function editRaffle(raffleId) {
            const raffle = rafflesData.find(r => r.id === raffleId);
            if (!raffle) return;
            
            currentRaffleId = raffleId;
            document.getElementById('raffleModalTitle').textContent = 'Edit Raffle';
            document.getElementById('raffleId').value = raffleId;
            document.getElementById('raffleName').value = raffle.name;
            document.getElementById('raffleEmoji').value = raffle.emoji || 'üéüÔ∏è';
            document.getElementById('raffleDescription').value = raffle.description || '';
            document.getElementById('rafflePrize').value = raffle.prize_description;
            document.getElementById('raffleEntryCost').value = raffle.entry_cost;
            document.getElementById('raffleMaxEntries').value = raffle.max_entries_per_student || 10;
            document.getElementById('raffleFrequency').value = raffle.draw_frequency || 'weekly';
            document.getElementById('raffleActive').checked = raffle.is_active;
            document.getElementById('raffleAutoDraw').checked = raffle.auto_draw_enabled;
            document.getElementById('raffleModal').classList.remove('hidden');
        }
        
        function closeRaffleModal() {
            document.getElementById('raffleModal').classList.add('hidden');
            currentRaffleId = null;
        }
        
        async function saveRaffle(event) {
            event.preventDefault();
            
            const data = {
                name: document.getElementById('raffleName').value,
                emoji: document.getElementById('raffleEmoji').value || 'üéüÔ∏è',
                description: document.getElementById('raffleDescription').value,
                prize_description: document.getElementById('rafflePrize').value,
                entry_cost: parseInt(document.getElementById('raffleEntryCost').value),
                max_entries_per_student: parseInt(document.getElementById('raffleMaxEntries').value) || 10,
                draw_frequency: document.getElementById('raffleFrequency').value,
                draw_day_of_week: parseInt(document.getElementById('raffleDrawDay').value),
                draw_time: document.getElementById('raffleDrawTime').value,
                is_active: document.getElementById('raffleActive').checked,
                auto_draw_enabled: document.getElementById('raffleAutoDraw').checked
            };
            
            try {
                const raffleId = document.getElementById('raffleId').value;
                const url = raffleId ? `/api/admin/raffles/${raffleId}` : '/api/admin/raffles';
                const method = raffleId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success || result.raffle_id) {
                    closeRaffleModal();
                    loadRaffles();
                    alert(raffleId ? 'Raffle updated successfully!' : 'Raffle created successfully!');
                } else {
                    alert('Error: ' + (result.error || 'Failed to save raffle'));
                }
            } catch (error) {
                console.error('Error saving raffle:', error);
                alert('Error saving raffle. Please try again.');
            }
        }
        
        async function toggleRaffleStatus(raffleId, currentStatus) {
            try {
                const response = await fetch(`/api/admin/raffles/${raffleId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: !currentStatus })
                });
                
                const result = await response.json();
                if (result.success) {
                    loadRaffles();
                } else {
                    alert('Error: ' + (result.error || 'Failed to update raffle'));
                }
            } catch (error) {
                console.error('Error toggling raffle:', error);
                alert('Error updating raffle status.');
            }
        }
        
        function openDrawConfirmModal(raffleId, entryCount) {
            currentRaffleId = raffleId;
            document.getElementById('drawConfirmEntries').textContent = `${entryCount} entries in this raffle`;
            document.getElementById('drawConfirmModal').classList.remove('hidden');
        }
        
        function closeDrawConfirmModal() {
            document.getElementById('drawConfirmModal').classList.add('hidden');
            currentRaffleId = null;
        }
        
        async function confirmDraw() {
            if (!currentRaffleId) return;
            
            closeDrawConfirmModal();
            
            try {
                const response = await fetch(`/api/admin/raffles/${currentRaffleId}/draw`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.success && result.winner) {
                    document.getElementById('winnerName').textContent = result.winner.name;
                    document.getElementById('winnerDetails').textContent = result.winner.class || 'Guest User';
                    document.getElementById('winnerPrize').textContent = `Prize: ${result.prize || 'See raffle details'}`;
                    document.getElementById('winnerModal').classList.remove('hidden');
                    loadRaffles();
                    loadRaffleWinners();
                } else if (result.error) {
                    alert('Draw failed: ' + result.error);
                } else {
                    alert('No entries to draw from!');
                }
            } catch (error) {
                console.error('Error performing draw:', error);
                alert('Error performing draw. Please try again.');
            }
        }
        
        function closeWinnerModal() {
            document.getElementById('winnerModal').classList.add('hidden');
        }
        
        async function viewRaffleEntries(raffleId) {
            const raffle = rafflesData.find(r => r.id === raffleId);
            document.getElementById('entriesModalTitle').textContent = `Entries: ${raffle ? raffle.name : 'Raffle'}`;
            document.getElementById('entriesModal').classList.remove('hidden');
            
            try {
                const response = await fetch(`/api/admin/raffles/${raffleId}/entries`);
                const entries = await response.json();
                
                if (entries.length === 0) {
                    document.getElementById('entriesModalContent').innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-3"></i>
                            <p>No entries yet</p>
                        </div>
                    `;
                    return;
                }
                
                // Group entries by student
                const grouped = {};
                entries.forEach(e => {
                    const key = e.student_name || e.guest_code || 'Unknown';
                    if (!grouped[key]) {
                        grouped[key] = { count: 0, entries: [], isGuest: !!e.guest_code };
                    }
                    grouped[key].count++;
                    grouped[key].entries.push(e);
                });
                
                const sortedStudents = Object.entries(grouped).sort((a, b) => b[1].count - a[1].count);
                
                document.getElementById('entriesModalContent').innerHTML = `
                    <div class="mb-4 text-sm text-gray-600">
                        Total: ${entries.length} entries from ${sortedStudents.length} participants
                    </div>
                    <div class="space-y-2 max-h-96 overflow-y-auto">
                        ${sortedStudents.map(([name, data]) => `
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <div>
                                    <span class="font-semibold">${name}</span>
                                    ${data.isGuest ? '<span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded ml-2">Guest</span>' : ''}
                                </div>
                                <span class="bg-pink-100 text-pink-700 px-3 py-1 rounded-full font-semibold">
                                    ${data.count} ${data.count === 1 ? 'entry' : 'entries'}
                                </span>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Error loading entries:', error);
                document.getElementById('entriesModalContent').innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-circle text-4xl mb-3"></i>
                        <p>Error loading entries</p>
                    </div>
                `;
            }
        }
        
        function closeEntriesModal() {
            document.getElementById('entriesModal').classList.add('hidden');
        }
        
        async function loadRaffleWinners() {
            try {
                const response = await fetch('/api/admin/raffles/winners');
                const winners = await response.json();
                
                const tbody = document.getElementById('raffle-winners-tbody');
                
                if (!winners || winners.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No winners yet</td></tr>';
                    return;
                }
                
                tbody.innerHTML = winners.slice(0, 10).map(w => `
                    <tr class="border-t">
                        <td class="px-4 py-3 text-sm">${formatDate(w.drawn_at)}</td>
                        <td class="px-4 py-3">
                            <span class="mr-1">${w.emoji || 'üéüÔ∏è'}</span>
                            ${w.raffle_name}
                        </td>
                        <td class="px-4 py-3 font-semibold text-green-600">${w.winner_name}</td>
                        <td class="px-4 py-3 text-sm">${w.prize_description || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${w.total_entries || '-'}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading winners:', error);
            }
        }
        
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IE', { day: 'numeric', month: 'short', year: 'numeric' });
        }
        
        async function runAutoDraw() {
            const resultDiv = document.getElementById('auto-draw-result');
            const contentDiv = document.getElementById('auto-draw-result-content');
            
            resultDiv.classList.remove('hidden');
            contentDiv.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Running auto-draw check...';
            
            try {
                const response = await fetch('/api/admin/raffles/auto-draw', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (result.error) {
                    contentDiv.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i>Error: ${result.error}`;
                } else {
                    let html = `
                        <div class="font-semibold mb-2">
                            <i class="fas fa-check-circle mr-2"></i>Auto-draw complete!
                        </div>
                        <div class="flex gap-4 mb-2">
                            <span><i class="fas fa-search mr-1"></i>${result.checked || 0} checked</span>
                            <span><i class="fas fa-trophy mr-1"></i>${result.drawn || 0} drawn</span>
                            <span><i class="fas fa-forward mr-1"></i>${result.skipped || 0} skipped</span>
                        </div>
                    `;
                    
                    if (result.details && result.details.length > 0) {
                        html += '<div class="text-xs mt-2 max-h-32 overflow-y-auto">';
                        result.details.forEach(d => {
                            const icon = d.action === 'drawn' ? 'check text-green-300' : 
                                        d.action === 'error' ? 'times text-red-300' : 'minus text-gray-300';
                            html += `<div><i class="fas fa-${icon} mr-1"></i>${d.raffle}: ${d.reason}</div>`;
                        });
                        html += '</div>';
                    }
                    
                    contentDiv.innerHTML = html;
                    
                    // Reload raffles and winners
                    if (result.drawn > 0) {
                        loadRaffles();
                        loadRaffleWinners();
                    }
                }
                
            } catch (error) {
                console.error('Error running auto-draw:', error);
                contentDiv.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i>Error: ${error.message}`;
            }
        }
        
        // ==================== END RAFFLE FUNCTIONS ====================

        // ==================== EMAIL REPORTS FUNCTIONS ====================
        
        let emailReportSettings = {};
        let distributionList = [];

        async function loadEmailReportsData() {
            try {
                await Promise.all([
                    loadDistributionList(),
                    loadReportSettings(),
                    loadReportHistory()
                ]);
            } catch (error) {
                console.error('Error loading email reports data:', error);
            }
        }

        async function loadDistributionList() {
            try {
                const response = await fetch('/api/admin/email-reports/distribution-list');
                const data = await response.json();
                
                distributionList = data.recipients || [];
                renderDistributionList();
            } catch (error) {
                console.error('Error loading distribution list:', error);
                document.getElementById('distributionListTable').innerHTML = `
                    <tr><td colspan="7" class="px-4 py-8 text-center text-red-500">
                        <i class="fas fa-exclamation-triangle mr-2"></i>Error loading recipients
                    </td></tr>
                `;
            }
        }

        function renderDistributionList() {
            const tbody = document.getElementById('distributionListTable');
            
            if (distributionList.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">
                        <i class="fas fa-users mr-2"></i>No recipients yet. Add someone to start sending reports.
                    </td></tr>
                `;
                return;
            }
            
            // Group by email (a person might have multiple report types)
            const grouped = {};
            distributionList.forEach(r => {
                if (!grouped[r.email]) {
                    grouped[r.email] = {
                        id: r.id,
                        email: r.email,
                        name: r.recipient_name,
                        is_active: r.is_active,
                        daily: false,
                        weekly: false,
                        monthly: false
                    };
                }
                if (r.report_type === 'daily' || r.report_type === 'all') grouped[r.email].daily = true;
                if (r.report_type === 'weekly' || r.report_type === 'all') grouped[r.email].weekly = true;
                if (r.report_type === 'monthly' || r.report_type === 'all') grouped[r.email].monthly = true;
            });
            
            tbody.innerHTML = Object.values(grouped).map(r => `
                <tr class="${r.is_active ? '' : 'bg-gray-100 opacity-60'}">
                    <td class="px-4 py-3 font-medium">${r.name || '-'}</td>
                    <td class="px-4 py-3">${r.email}</td>
                    <td class="px-4 py-3 text-center">
                        ${r.daily ? '<span class="text-green-600"><i class="fas fa-check-circle"></i></span>' : '<span class="text-gray-300"><i class="fas fa-minus-circle"></i></span>'}
                    </td>
                    <td class="px-4 py-3 text-center">
                        ${r.weekly ? '<span class="text-green-600"><i class="fas fa-check-circle"></i></span>' : '<span class="text-gray-300"><i class="fas fa-minus-circle"></i></span>'}
                    </td>
                    <td class="px-4 py-3 text-center">
                        ${r.monthly ? '<span class="text-green-600"><i class="fas fa-check-circle"></i></span>' : '<span class="text-gray-300"><i class="fas fa-minus-circle"></i></span>'}
                    </td>
                    <td class="px-4 py-3 text-center">
                        ${r.is_active 
                            ? '<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">Active</span>' 
                            : '<span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs">Paused</span>'}
                    </td>
                    <td class="px-4 py-3 text-center">
                        <button onclick="toggleRecipientStatus('${r.email}')" class="text-gray-500 hover:text-amber-600 mx-1" title="${r.is_active ? 'Pause' : 'Activate'}">
                            <i class="fas fa-${r.is_active ? 'pause' : 'play'}"></i>
                        </button>
                        <button onclick="deleteRecipient('${r.email}')" class="text-gray-500 hover:text-red-600 mx-1" title="Remove">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadReportSettings() {
            try {
                const response = await fetch('/api/admin/email-reports/settings');
                emailReportSettings = await response.json();
                
                // Update UI
                document.getElementById('reportSchoolName').value = emailReportSettings.school_name || 'Palmerstown Community School';
                document.getElementById('reportReplyToEmail').value = emailReportSettings.reply_to_email || '';
                document.getElementById('enableDailyReport').checked = emailReportSettings.daily_report_enabled !== 'false';
                document.getElementById('enableWeeklyReport').checked = emailReportSettings.weekly_report_enabled !== 'false';
                document.getElementById('enableMonthlyReport').checked = emailReportSettings.monthly_report_enabled !== 'false';
                
                // Update status cards
                document.getElementById('dailyReportStatus').textContent = emailReportSettings.daily_report_enabled !== 'false' ? 'Enabled' : 'Disabled';
                document.getElementById('weeklyReportStatus').textContent = emailReportSettings.weekly_report_enabled !== 'false' ? 'Enabled' : 'Disabled';
                document.getElementById('monthlyReportStatus').textContent = emailReportSettings.monthly_report_enabled !== 'false' ? 'Enabled' : 'Disabled';
                
            } catch (error) {
                console.error('Error loading report settings:', error);
            }
        }

        async function loadReportHistory() {
            try {
                const response = await fetch('/api/admin/email-reports/history');
                const data = await response.json();
                
                const container = document.getElementById('reportHistoryList');
                
                if (!data.history || data.history.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-4 text-gray-500">
                            <i class="fas fa-inbox mr-2"></i>No reports sent yet
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = data.history.slice(0, 10).map(h => {
                    const typeColors = {
                        daily: 'blue',
                        weekly: 'green',
                        monthly: 'purple'
                    };
                    const color = typeColors[h.report_type] || 'gray';
                    const statusIcon = h.status === 'sent' ? 'check-circle text-green-500' : 'exclamation-circle text-red-500';
                    
                    return `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div class="flex items-center gap-3">
                                <span class="bg-${color}-100 text-${color}-800 px-2 py-1 rounded text-xs font-semibold uppercase">${h.report_type}</span>
                                <span class="text-gray-600">${new Date(h.sent_at).toLocaleString()}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-sm text-gray-500">${h.recipients_count} recipients</span>
                                <i class="fas fa-${statusIcon}"></i>
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading report history:', error);
            }
        }

        function showAddRecipientModal() {
            document.getElementById('addRecipientForm').reset();
            document.getElementById('addRecipientModal').classList.remove('hidden');
            document.getElementById('addRecipientModal').classList.add('flex');
        }

        function hideAddRecipientModal() {
            document.getElementById('addRecipientModal').classList.add('hidden');
            document.getElementById('addRecipientModal').classList.remove('flex');
        }

        async function addRecipient(event) {
            event.preventDefault();
            
            const name = document.getElementById('recipientName').value.trim();
            const email = document.getElementById('recipientEmail').value.trim();
            const subDaily = document.getElementById('subDaily').checked;
            const subWeekly = document.getElementById('subWeekly').checked;
            const subMonthly = document.getElementById('subMonthly').checked;
            
            if (!email) {
                alert('Please enter an email address');
                return;
            }
            
            if (!subDaily && !subWeekly && !subMonthly) {
                alert('Please select at least one report type');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/email-reports/distribution-list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        recipient_name: name,
                        email: email,
                        daily: subDaily,
                        weekly: subWeekly,
                        monthly: subMonthly
                    })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to add recipient');
                }
                
                hideAddRecipientModal();
                await loadDistributionList();
                alert('‚úÖ Recipient added successfully!');
                
            } catch (error) {
                console.error('Error adding recipient:', error);
                alert('Error: ' + error.message);
            }
        }

        async function toggleRecipientStatus(email) {
            try {
                const response = await fetch('/api/admin/email-reports/distribution-list/toggle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to toggle status');
                }
                
                await loadDistributionList();
                
            } catch (error) {
                console.error('Error toggling recipient:', error);
                alert('Error: ' + error.message);
            }
        }

        async function deleteRecipient(email) {
            if (!confirm(`Remove ${email} from all distribution lists?`)) return;
            
            try {
                const response = await fetch('/api/admin/email-reports/distribution-list', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to remove recipient');
                }
                
                await loadDistributionList();
                
            } catch (error) {
                console.error('Error deleting recipient:', error);
                alert('Error: ' + error.message);
            }
        }

        async function saveReportSettings() {
            try {
                const settings = {
                    school_name: document.getElementById('reportSchoolName').value.trim(),
                    reply_to_email: document.getElementById('reportReplyToEmail').value.trim(),
                    daily_report_enabled: document.getElementById('enableDailyReport').checked ? 'true' : 'false',
                    weekly_report_enabled: document.getElementById('enableWeeklyReport').checked ? 'true' : 'false',
                    monthly_report_enabled: document.getElementById('enableMonthlyReport').checked ? 'true' : 'false'
                };
                
                const response = await fetch('/api/admin/email-reports/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                
                if (!response.ok) {
                    throw new Error('Failed to save settings');
                }
                
                await loadReportSettings();
                alert('‚úÖ Settings saved successfully!');
                
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('Error: ' + error.message);
            }
        }

        async function sendTestReport() {
            const reportType = document.getElementById('testReportType').value;
            const email = document.getElementById('testReportEmail').value.trim();
            
            if (!email) {
                alert('Please enter an email address');
                return;
            }
            
            if (!confirm(`Send a test ${reportType} report to ${email}?`)) return;
            
            try {
                const response = await fetch('/api/admin/email-reports/send-test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        report_type: reportType,
                        email: email
                    })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to send test report');
                }
                
                alert(`‚úÖ Test ${reportType} report sent to ${email}!`);
                await loadReportHistory();
                
            } catch (error) {
                console.error('Error sending test report:', error);
                alert('Error: ' + error.message);
            }
        }

        // ==================== END EMAIL REPORTS FUNCTIONS ====================
    </script>
</body>
</html>
